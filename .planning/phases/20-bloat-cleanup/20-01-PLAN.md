---
phase: 20-bloat-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/App.tsx
  - maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Monitoring pages (Metrics, Traces, Errors, Circuit Breakers, Rate Limits, Query Performance) are not accessible in production builds"
    - "Monitoring sidebar section is not visible in production builds"
    - "Monitoring pages remain accessible in development mode for debugging"
    - "No monitoring page files or service files are deleted"
  artifacts:
    - path: "maguey-gate-scanner/src/App.tsx"
      provides: "Monitoring routes gated behind requireDev"
      contains: "requireDev"
    - path: "maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx"
      provides: "MONITORING sidebar section gated behind import.meta.env.DEV"
      contains: "import.meta.env.DEV"
  key_links:
    - from: "maguey-gate-scanner/src/App.tsx"
      to: "ProtectedRoute requireDev prop"
      via: "requireDev flag on monitoring routes"
      pattern: "requireDev.*allowedRoles.*owner"
    - from: "maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx"
      to: "import.meta.env.DEV"
      via: "conditional section rendering"
      pattern: "import\\.meta\\.env\\.DEV"
---

<objective>
Gate 6 monitoring pages behind `requireDev` in routes and hide the MONITORING sidebar section in production builds.

Purpose: Remove developer-focused monitoring UI from the owner-facing production app without deleting any code. The 6 monitoring pages (Metrics, Traces, Errors, Circuit Breakers, Rate Limits, Query Performance) are internal debugging tools that clutter the production dashboard.

Output: Monitoring routes show `<Unauthorized />` in production, MONITORING sidebar section hidden in production.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@maguey-gate-scanner/src/App.tsx
@maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx
@maguey-gate-scanner/src/components/ProtectedRoute.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate monitoring routes behind requireDev in App.tsx</name>
  <files>maguey-gate-scanner/src/App.tsx</files>
  <action>
In `maguey-gate-scanner/src/App.tsx`, update all 6 monitoring routes (lines 97-103) to include the `requireDev` prop on their `<ProtectedRoute>` wrappers. This is the exact same pattern already used for the `/test-qr` route on line 95.

Change each monitoring route from:
```tsx
<Route path="/monitoring/metrics" element={<ProtectedRoute allowedRoles={['owner', 'promoter']}><MetricsPage /></ProtectedRoute>} />
```
To:
```tsx
<Route path="/monitoring/metrics" element={<ProtectedRoute requireDev allowedRoles={['owner', 'promoter']}><MetricsPage /></ProtectedRoute>} />
```

Apply this to all 6 routes:
- `/monitoring/metrics`
- `/monitoring/traces`
- `/monitoring/errors`
- `/monitoring/circuit-breakers`
- `/monitoring/rate-limits`
- `/monitoring/query-performance`

Update the comment above these routes from `{/* Monitoring Routes - Owner/Promoter only */}` to `{/* DEV-ONLY: Monitoring Routes - Hidden in production */}`.

Do NOT remove the import statements for these pages — they are tree-shaken in production if `requireDev` blocks rendering.
  </action>
  <verify>
Run `grep -c "requireDev" maguey-gate-scanner/src/App.tsx` — should return 7 (1 for test-qr + 6 for monitoring routes). Run `grep "monitoring/" maguey-gate-scanner/src/App.tsx` to confirm all 6 routes have `requireDev`.
  </verify>
  <done>All 6 monitoring routes include `requireDev` prop. In production builds, navigating to any `/monitoring/*` path shows the Unauthorized page. In dev mode, routes work normally for owner/promoter roles.</done>
</task>

<task type="auto">
  <name>Task 2: Hide MONITORING sidebar section in production builds</name>
  <files>maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx</files>
  <action>
In `maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx`, add a `devOnly` property to the MONITORING sidebar section definition (around line 73-84).

Step 1: Add `devOnly?: boolean` to the section type. The `sidebarSections` array uses inline object literals, so add a `devOnly: true` property to the MONITORING section object:

```tsx
{
  title: "MONITORING",
  ownerOnly: true,
  devOnly: true, // Only show in development mode
  items: [
    // ... existing items unchanged
  ],
},
```

Step 2: Update the `filteredSections` logic (around line 118-124) to also filter out `devOnly` sections in production:

Change from:
```tsx
const filteredSections = sidebarSections
  .filter((section) => !section.ownerOnly || role === 'owner')
```

To:
```tsx
const filteredSections = sidebarSections
  .filter((section) => !(section as any).devOnly || import.meta.env.DEV)
  .filter((section) => !section.ownerOnly || role === 'owner')
```

Note: Use `(section as any).devOnly` since the type is inferred from the array literal. Alternatively, you can type the `devOnly` inline — either approach is fine as long as TypeScript compiles.
  </action>
  <verify>
Run `grep "devOnly" maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx` to confirm the property exists. Run `grep "import.meta.env.DEV" maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx` to confirm the filter exists. Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit 2>&1 | head -20` to check for type errors.
  </verify>
  <done>MONITORING sidebar section is hidden from the sidebar in production builds. In dev mode, the section appears for owner users as before. No sidebar items, files, or services deleted.</done>
</task>

</tasks>

<verification>
1. `grep -c "requireDev" maguey-gate-scanner/src/App.tsx` returns 7
2. `grep "devOnly" maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx` shows devOnly property
3. `grep "import.meta.env.DEV" maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx` shows DEV check in filter
4. All monitoring page files still exist in `src/pages/monitoring/`
5. All monitoring service files still exist in `src/lib/`
6. TypeScript compiles without errors
</verification>

<success_criteria>
- 6 monitoring routes gated behind `requireDev` (production: Unauthorized page; dev: works normally)
- MONITORING sidebar section hidden in production (dev: visible for owner role)
- Zero files deleted
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/20-bloat-cleanup/20-01-SUMMARY.md`
</output>
