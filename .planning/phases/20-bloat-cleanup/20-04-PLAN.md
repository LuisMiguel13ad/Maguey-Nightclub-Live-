---
phase: 20-bloat-cleanup
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/pages/Scanner.tsx
  - maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx
autonomous: true

must_haves:
  truths:
    - "NFC scan mode is hidden behind a feature flag in production Scanner page"
    - "NFC toggle button in FullScreenScanner is hidden behind the same feature flag"
    - "QR and Manual scan modes work unchanged in both dev and production"
    - "Dead code components (IDVerificationModal, OverrideActivationModal, OverrideReasonModal, LowBatteryModal) confirmed not imported — left in place"
  artifacts:
    - path: "maguey-gate-scanner/src/pages/Scanner.tsx"
      provides: "Scanner page with NFC mode gated behind feature flag"
      contains: "VITE_ENABLE_NFC"
    - path: "maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx"
      provides: "FullScreenScanner with NFC toggle gated behind feature flag"
      contains: "VITE_ENABLE_NFC"
  key_links:
    - from: "maguey-gate-scanner/src/pages/Scanner.tsx"
      to: "NFC mode type and rendering"
      via: "feature flag check before NFC UI"
      pattern: "VITE_ENABLE_NFC"
    - from: "maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx"
      to: "NFC toggle button"
      via: "feature flag check before toggle rendering"
      pattern: "VITE_ENABLE_NFC"
---

<objective>
Gate NFC scan mode behind a feature flag and confirm dead code component status for IDVerificationModal, OverrideActivationModal, OverrideReasonModal, and LowBatteryModal.

Purpose: NFC scanning is not yet functional for production use (requires NFC hardware tags that Maguey does not currently have). Hiding it reduces scanner UI complexity. The 4 dead code components have zero runtime impact (not imported anywhere for rendering), so per the no-deletion constraint they are left in place.

Output: NFC hidden in production scanner, dead code status confirmed in summary.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@maguey-gate-scanner/src/pages/Scanner.tsx
@maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx
@maguey-gate-scanner/src/components/NFCScanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate NFC scan mode behind VITE_ENABLE_NFC feature flag</name>
  <files>maguey-gate-scanner/src/pages/Scanner.tsx, maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx</files>
  <action>
**Feature flag pattern:** Use `import.meta.env.VITE_ENABLE_NFC === 'true'` as the flag. When the env var is not set or not 'true', NFC UI is hidden. This allows enabling NFC later by adding `VITE_ENABLE_NFC=true` to `.env`.

**In `maguey-gate-scanner/src/pages/Scanner.tsx`:**

1. Add a constant near the top of the component (inside the Scanner function, before state declarations):
```tsx
const nfcEnabled = import.meta.env.VITE_ENABLE_NFC === 'true';
```

2. Find the NFC mode tab/button in the bottom scanner mode selector (around line 1055). The NFC button renders unconditionally. Wrap it:
```tsx
{nfcEnabled && (
  <button ... onClick={() => handleModeChange("nfc")} ...>
    ...NFC...
  </button>
)}
```

3. Find the NFC view rendering block (around line 987-1010, the `{scanMode === "nfc" && (...)}` block). Add the feature flag check:
```tsx
{nfcEnabled && scanMode === "nfc" && (
  // ... existing NFC view content unchanged
)}
```

4. In the `ScanMode` type definition (line 70: `type ScanMode = "manual" | "qr" | "nfc"`), leave the type unchanged — "nfc" remains a valid type. The flag only controls UI visibility, not the type system.

**In `maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx`:**

1. Add the same constant inside the component:
```tsx
const nfcEnabled = import.meta.env.VITE_ENABLE_NFC === 'true';
```

2. Find the NFC toggle button (around line 371, the `{nfcAvailable && (...)}` block). Add the feature flag:
```tsx
{nfcEnabled && nfcAvailable && (
  // ... existing NFC toggle unchanged
)}
```

3. Find the NFC scanner rendering (around line 227, the `scanMethod === "nfc"` conditional). Add the flag:
```tsx
{nfcEnabled && scanMethod === "nfc" ? (
  // ... existing NFC scanner view unchanged
) : null}
```

Make sure the existing conditional flow still works. If there's an if/else between QR and NFC rendering, the QR branch should become the default when NFC is disabled.

Do NOT delete the NFCScanner component, its import, or any NFC-related types/functions. Only wrap the UI rendering in the feature flag check.
  </action>
  <verify>
Run `grep -c "VITE_ENABLE_NFC" maguey-gate-scanner/src/pages/Scanner.tsx` — should return at least 3 (constant + 2 UI gates). Run `grep -c "VITE_ENABLE_NFC" maguey-gate-scanner/src/components/scanner/FullScreenScanner.tsx` — should return at least 3 (constant + 2 UI gates). Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit 2>&1 | head -20` to check for type errors.
  </verify>
  <done>NFC scan mode is hidden in production (no VITE_ENABLE_NFC env var set). Adding `VITE_ENABLE_NFC=true` to `.env` re-enables NFC. QR and Manual modes work unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Verify and document dead code component status</name>
  <files>maguey-gate-scanner/src/pages/Scanner.tsx</files>
  <action>
Verify that these 4 components are truly dead code (not imported for rendering anywhere):

1. `IDVerificationModal.tsx` — Search entire `src/` for `import.*IDVerificationModal`. It IS imported in `IDVerificationModal.tsx` itself (self-reference in its own file) and in `scanner-service.ts` (which imports the SERVICE, not the component). Verify the COMPONENT is not rendered in any page or parent component.

2. `OverrideActivationModal.tsx` — Search for `import.*OverrideActivationModal`. Should return 0 matches outside its own file.

3. `OverrideReasonModal.tsx` — Search for `import.*OverrideReasonModal`. Should return 0 matches outside its own file.

4. `LowBatteryModal.tsx` — Search for `import.*LowBatteryModal`. Should return 0 matches outside its own file.

For each component, run `grep -r "import.*{ComponentName}" maguey-gate-scanner/src/ --include="*.tsx" --include="*.ts"` and document the results.

**Per the no-deletion constraint:** Do NOT delete these files. They have zero runtime impact (tree-shaken if not imported). Document their dead code status in the plan summary.

**Note on IDVerificationModal:** It IS imported by `scanner-service.ts` (the service function, not the React component), and by `Dashboard.tsx` (for stats display via `getIDVerificationStats`). These are SERVICE imports, not component renders. The modal COMPONENT itself (`<IDVerificationModal />`) is not rendered in any page. Confirm this is still the case and document it.

No file modifications needed for this task — it is a verification/documentation task. The output goes into the plan summary.
  </action>
  <verify>
Run these 4 searches and confirm results match expectations:
- `grep -r "IDVerificationModal" maguey-gate-scanner/src/ --include="*.tsx" -l` — should show only IDVerificationModal.tsx itself (component file)
- `grep -r "OverrideActivationModal" maguey-gate-scanner/src/ --include="*.tsx" -l` — should show only OverrideActivationModal.tsx
- `grep -r "OverrideReasonModal" maguey-gate-scanner/src/ --include="*.tsx" -l` — should show only OverrideReasonModal.tsx
- `grep -r "LowBatteryModal" maguey-gate-scanner/src/ --include="*.tsx" -l` — should show only LowBatteryModal.tsx
  </verify>
  <done>Dead code status confirmed for all 4 components: IDVerificationModal, OverrideActivationModal, OverrideReasonModal, LowBatteryModal. None are rendered in any page. Files left in place per no-deletion constraint (zero runtime impact). Status documented in plan summary.</done>
</task>

</tasks>

<verification>
1. NFC mode hidden in Scanner.tsx when VITE_ENABLE_NFC is not set
2. NFC toggle hidden in FullScreenScanner.tsx when VITE_ENABLE_NFC is not set
3. QR and Manual scan modes work unchanged
4. NFCScanner component file still exists (not deleted)
5. 4 dead code components confirmed: not rendered anywhere
6. 4 dead code component files still exist (not deleted)
7. TypeScript compiles without errors
</verification>

<success_criteria>
- NFC scan mode gated behind `VITE_ENABLE_NFC` env var (default: hidden)
- QR and Manual modes fully functional
- Dead code components confirmed and documented (not deleted)
- Zero files deleted, zero functional regressions
</success_criteria>

<output>
After completion, create `.planning/phases/20-bloat-cleanup/20-04-SUMMARY.md`
</output>
