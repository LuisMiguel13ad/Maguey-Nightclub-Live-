---
phase: 10-load-testing-performance
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - load-tests/scenarios/ticket-purchase.js
autonomous: true

must_haves:
  truths:
    - "100 concurrent VUs can create checkout sessions without errors"
    - "p95 response time stays under 500ms"
    - "Error rate remains below 1%"
    - "All successful requests return valid Stripe checkout URLs"
  artifacts:
    - path: "load-tests/scenarios/ticket-purchase.js"
      provides: "k6 load test for 100 concurrent ticket purchases"
      min_lines: 80
  key_links:
    - from: "load-tests/scenarios/ticket-purchase.js"
      to: "load-tests/config/thresholds.js"
      via: "import getThresholds"
      pattern: "import.*thresholds"
    - from: "load-tests/scenarios/ticket-purchase.js"
      to: "/functions/v1/create-checkout-session"
      via: "http.post"
      pattern: "create-checkout-session"
---

<objective>
Create k6 load test for 100 concurrent ticket purchases against the create-checkout-session Edge Function.

Purpose: Validate success criteria #1 - "System handles 100 concurrent ticket purchases without errors". This is the highest-load scenario in the system and validates payment flow scalability.

Output: `load-tests/scenarios/ticket-purchase.js` - executable k6 test script.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-load-testing-performance/10-CONTEXT.md
@.planning/phases/10-load-testing-performance/10-RESEARCH.md
@maguey-pass-lounge/load-tests/payment-load.k6.js (existing pattern - 50 VUs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ticket purchase load test for 100 concurrent VUs</name>
  <files>load-tests/scenarios/ticket-purchase.js</files>
  <action>
Create k6 load test script that validates 100 concurrent checkout session creation.

Follow the pattern from RESEARCH.md:
- Use ramping-vus executor to gradually reach 100 VUs
- Import shared helpers from helpers/ directory
- Import thresholds from config/
- Include warm-up phase (30s ramp to 100)
- Hold at 100 VUs for 2 minutes
- Graceful ramp-down (30s)
- Track custom metrics: checkout_duration, error_rate
- Use check() for response validation
- Include textSummary for readable output

```javascript
// Ticket Purchase Load Test - 100 Concurrent VUs
// Tests: POST /functions/v1/create-checkout-session
// Target: p95 < 500ms, error rate < 1%

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';
import { getThresholds } from '../config/thresholds.js';
import { getHeaders, getBaseUrl } from '../helpers/auth.js';
import { generateTicketPayload } from '../helpers/data-generators.js';

// Custom metrics
const errorRate = new Rate('purchase_errors');
const checkoutDuration = new Trend('checkout_duration');

// Test configuration
export const options = {
  scenarios: {
    purchase: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '30s', target: 100 },  // Ramp up to 100 VUs
        { duration: '2m', target: 100 },   // Hold at 100 for 2 minutes
        { duration: '30s', target: 0 },    // Ramp down
      ],
      gracefulRampDown: '10s',
    },
  },
  thresholds: {
    ...getThresholds('purchase'),
    'checkout_duration': ['p(95)<500'],  // Custom metric threshold
    'purchase_errors': ['rate<0.01'],
  },
};

export default function() {
  const baseUrl = getBaseUrl();
  const headers = getHeaders();
  const payload = generateTicketPayload(__VU, __ITER);

  const startTime = Date.now();

  const response = http.post(
    `${baseUrl}/functions/v1/create-checkout-session`,
    JSON.stringify(payload),
    { headers, timeout: '30s' }
  );

  const duration = Date.now() - startTime;
  checkoutDuration.add(duration);

  // Validate response
  const success = check(response, {
    'status is 200': (r) => r.status === 200,
    'has checkout URL': (r) => {
      try {
        const body = JSON.parse(r.body);
        return body.url && body.url.includes('checkout.stripe.com');
      } catch {
        return false;
      }
    },
    'response under 500ms': () => duration < 500,
    'response under 1s': () => duration < 1000,
  });

  errorRate.add(!success);

  if (!success && response.status !== 200) {
    console.log(`[VU ${__VU}] Failed: ${response.status} - ${response.body?.substring(0, 200)}`);
  }

  // Realistic delay between purchases
  sleep(Math.random() * 2 + 0.5);
}

// Summary report
export function handleSummary(data) {
  const metrics = data.metrics;
  const thresholdResults = Object.entries(data.thresholds || {})
    .map(([name, result]) => `  ${result.ok ? 'PASS' : 'FAIL'} ${name}`)
    .join('\n');

  const summary = `
================================================================================
                    TICKET PURCHASE LOAD TEST RESULTS
================================================================================

Configuration:
  Target VUs:     100 concurrent users
  Duration:       ~3 minutes (30s ramp + 2m hold + 30s ramp down)
  Endpoint:       POST /functions/v1/create-checkout-session

Results:
  Total Requests: ${metrics.http_reqs?.values?.count || 0}
  Failed:         ${metrics.http_req_failed?.values?.passes || 0}
  Error Rate:     ${((metrics.purchase_errors?.values?.rate || 0) * 100).toFixed(2)}%

Response Times:
  Average:        ${Math.round(metrics.checkout_duration?.values?.avg || 0)}ms
  P95:            ${Math.round(metrics.checkout_duration?.values?.['p(95)'] || 0)}ms
  P99:            ${Math.round(metrics.checkout_duration?.values?.['p(99)'] || 0)}ms
  Max:            ${Math.round(metrics.checkout_duration?.values?.max || 0)}ms

Thresholds:
${thresholdResults}

================================================================================
`;

  return {
    'stdout': summary,
    'load-tests/results/ticket-purchase-results.json': JSON.stringify(data, null, 2),
  };
}
```

Key differences from existing 50 VU test:
- 100 VUs instead of 50
- Uses shared helpers instead of inline definitions
- Stricter threshold (p95 < 500ms instead of 5s per CONTEXT.md)
- More detailed summary output
- Results saved to results/ directory
  </action>
  <verify>k6 run --dry-run load-tests/scenarios/ticket-purchase.js (validates syntax)</verify>
  <done>k6 test script for 100 concurrent ticket purchases with p95 < 500ms threshold</done>
</task>

<task type="auto">
  <name>Task 2: Create results directory</name>
  <files>load-tests/results/.gitkeep</files>
  <action>
Create results directory for test output files with .gitkeep to track the directory but ignore results:

```bash
mkdir -p load-tests/results
touch load-tests/results/.gitkeep
```

Add to .gitignore (if not already present):
```
# Load test results
load-tests/results/*.json
```
  </action>
  <verify>Directory exists: ls load-tests/results/</verify>
  <done>Results directory created with .gitkeep</done>
</task>

</tasks>

<verification>
- [ ] `load-tests/scenarios/ticket-purchase.js` exists and is valid JavaScript
- [ ] Script imports from helpers/ and config/ directories
- [ ] Options specify 100 VUs with ramping executor
- [ ] Thresholds include p95 < 500ms
- [ ] Results directory exists at load-tests/results/
- [ ] handleSummary outputs to results directory
</verification>

<success_criteria>
- k6 test script validates 100 concurrent checkout session creation
- p95 threshold set to 500ms per CONTEXT.md
- Error rate threshold < 1%
- Script uses shared helpers from 10-01
- Results output to load-tests/results/ for CI integration
</success_criteria>

<output>
After completion, create `.planning/phases/10-load-testing-performance/10-02-SUMMARY.md`
</output>
