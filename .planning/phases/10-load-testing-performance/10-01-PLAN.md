---
phase: 10-load-testing-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - load-tests/config/thresholds.js
  - load-tests/helpers/auth.js
  - load-tests/helpers/stripe-signature.js
  - load-tests/helpers/data-generators.js
  - load-tests/data/test-config.json
  - package.json
autonomous: true
user_setup:
  - service: k6
    why: "Load testing tool"
    env_vars: []
    dashboard_config:
      - task: "Install k6"
        location: "Terminal: brew install k6"

must_haves:
  truths:
    - "k6 is installed and accessible via CLI"
    - "Shared threshold configuration exists for all test scenarios"
    - "Helper functions generate valid Supabase auth headers"
    - "Stripe webhook signature generation is available"
    - "Test data generators create unique, realistic payloads"
  artifacts:
    - path: "load-tests/config/thresholds.js"
      provides: "Shared threshold definitions for p95, error rates"
      exports: ["thresholds", "scenarioThresholds"]
    - path: "load-tests/helpers/auth.js"
      provides: "Supabase authentication header generation"
      exports: ["getHeaders", "getServiceHeaders"]
    - path: "load-tests/helpers/stripe-signature.js"
      provides: "HMAC-SHA256 Stripe webhook signature"
      exports: ["generateStripeSignature"]
    - path: "load-tests/helpers/data-generators.js"
      provides: "Test data factories for tickets, webhooks, scans"
      exports: ["generateTicketPayload", "generateWebhookEvent", "generateScanPayload"]
  key_links:
    - from: "load-tests/helpers/auth.js"
      to: "ENV variables"
      via: "__ENV.SUPABASE_URL, __ENV.SUPABASE_ANON_KEY"
      pattern: "__ENV\\.SUPABASE"
    - from: "load-tests/helpers/stripe-signature.js"
      to: "k6/crypto"
      via: "import crypto"
      pattern: "crypto\\.hmac"
---

<objective>
Set up k6 load testing infrastructure with shared configuration and helper utilities.

Purpose: Establish consistent test configuration, authentication helpers, and data generators that all load test scenarios will reuse. This prevents duplication and ensures uniform thresholds across all Phase 10 tests.

Output: `load-tests/` directory structure with reusable modules for subsequent test plans.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-load-testing-performance/10-CONTEXT.md
@.planning/phases/10-load-testing-performance/10-RESEARCH.md
@maguey-pass-lounge/load-tests/payment-load.k6.js (existing pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared threshold configuration</name>
  <files>load-tests/config/thresholds.js</files>
  <action>
Create threshold configuration module exporting standardized performance criteria:

```javascript
// Shared threshold definitions for all k6 load tests
export const thresholds = {
  // Global thresholds (from CONTEXT.md)
  http_req_duration: ['p(95)<500'],  // p95 < 500ms
  http_req_failed: ['rate<0.01'],    // Error rate < 1%
  checks: ['rate>0.95'],             // 95% of checks must pass
};

// Scenario-specific threshold overrides
export const scenarioThresholds = {
  purchase: {
    'http_req_duration{scenario:purchase}': ['p(95)<500'],
    'http_req_failed{scenario:purchase}': ['rate<0.01'],
  },
  scanner: {
    'http_req_duration{scenario:scanner}': ['p(95)<200'],  // Scanner must be faster
    'http_req_failed{scenario:scanner}': ['rate<0.001'],   // Near-zero errors
  },
  dashboard: {
    'http_req_duration{scenario:dashboard}': ['p(95)<3000'],  // Dashboard < 3s
    'http_req_failed{scenario:dashboard}': ['rate<0.01'],
  },
  webhook: {
    'http_req_duration{scenario:webhook}': ['p(95)<1000'],  // Webhooks allow 1s
    'http_req_failed{scenario:webhook}': ['rate<0.01'],
  },
};

// Merge base thresholds with scenario-specific
export function getThresholds(scenario) {
  return {
    ...thresholds,
    ...(scenarioThresholds[scenario] || {}),
  };
}
```
  </action>
  <verify>File exists at load-tests/config/thresholds.js with exported functions</verify>
  <done>Threshold configuration module created with p95 < 500ms default and scenario-specific overrides</done>
</task>

<task type="auto">
  <name>Task 2: Create authentication and data helper modules</name>
  <files>
    load-tests/helpers/auth.js
    load-tests/helpers/stripe-signature.js
    load-tests/helpers/data-generators.js
    load-tests/data/test-config.json
  </files>
  <action>
Create helper modules for k6 tests.

**load-tests/helpers/auth.js:**
```javascript
// Supabase authentication helpers for k6 load tests

export function getHeaders() {
  const anonKey = __ENV.SUPABASE_ANON_KEY;
  if (!anonKey) {
    console.warn('SUPABASE_ANON_KEY not set');
  }
  return {
    'Content-Type': 'application/json',
    'apikey': anonKey || '',
    'Authorization': `Bearer ${anonKey || ''}`,
  };
}

export function getServiceHeaders() {
  const serviceKey = __ENV.SUPABASE_SERVICE_ROLE_KEY;
  if (!serviceKey) {
    console.warn('SUPABASE_SERVICE_ROLE_KEY not set');
  }
  return {
    'Content-Type': 'application/json',
    'apikey': serviceKey || '',
    'Authorization': `Bearer ${serviceKey || ''}`,
  };
}

export function getBaseUrl() {
  return __ENV.SUPABASE_URL || 'http://localhost:54321';
}
```

**load-tests/helpers/stripe-signature.js:**
```javascript
// Stripe webhook signature generation for k6 load tests
import crypto from 'k6/crypto';

export function generateStripeSignature(payload, secret) {
  const timestamp = Math.floor(Date.now() / 1000);
  const signedPayload = `${timestamp}.${payload}`;

  // k6 crypto.hmac for HMAC-SHA256
  const signature = crypto.hmac('sha256', secret, signedPayload, 'hex');

  return `t=${timestamp},v1=${signature}`;
}
```

**load-tests/helpers/data-generators.js:**
```javascript
// Test data factories for k6 load tests

export function generateTicketPayload(vuId, iter) {
  const uniqueId = `${Date.now()}_${vuId}_${iter}`;
  const eventId = __ENV.TEST_EVENT_ID || 'test-event-id';

  return {
    eventId,
    tickets: [{
      ticketTypeId: 'general-admission',
      quantity: 1,
      unitPrice: 2500,
      unitFee: 500,
      displayName: 'General Admission',
    }],
    customerEmail: `loadtest_${uniqueId}@test.maguey.com`,
    customerName: `Load Test ${uniqueId}`,
    totalAmount: 3000,
    successUrl: 'https://test.maguey.com/success',
    cancelUrl: 'https://test.maguey.com/cancel',
  };
}

export function generateWebhookEvent(vuId, iter) {
  const uniqueId = `${Date.now()}_${vuId}_${iter}`;
  const eventId = __ENV.TEST_EVENT_ID || 'test-event-id';

  return {
    id: `evt_loadtest_${uniqueId}`,
    type: 'checkout.session.completed',
    created: Math.floor(Date.now() / 1000),
    data: {
      object: {
        id: `cs_test_${uniqueId}`,
        payment_intent: `pi_test_${uniqueId}`,
        payment_status: 'paid',
        amount_total: 3000,
        currency: 'usd',
        customer_email: `loadtest_${uniqueId}@test.maguey.com`,
        metadata: {
          orderId: `order_${uniqueId}`,
          eventId,
          customerEmail: `loadtest_${uniqueId}@test.maguey.com`,
          customerName: `Load Test ${uniqueId}`,
          tickets: JSON.stringify([{
            ticketTypeId: 'general-admission',
            quantity: 1,
            unitPrice: 2500,
            displayName: 'GA',
          }]),
        },
      },
    },
  };
}

export function generateScanPayload(ticketId, scannerId) {
  return {
    p_ticket_id: ticketId,
    p_scanned_by: scannerId || __ENV.TEST_SCANNER_ID || '00000000-0000-0000-0000-000000000001',
    p_device_id: `loadtest_device_${__VU}`,
    p_scan_method: 'qr',
  };
}
```

**load-tests/data/test-config.json:**
```json
{
  "description": "Test configuration for k6 load tests",
  "scenarios": {
    "purchase": {
      "targetVUs": 100,
      "rampUpDuration": "30s",
      "holdDuration": "2m",
      "rampDownDuration": "30s"
    },
    "scanner": {
      "targetVUs": 10,
      "duration": "1m"
    },
    "dashboard": {
      "targetVUs": 20,
      "duration": "3m"
    },
    "webhook": {
      "burstCount": 50,
      "burstDuration": "10s"
    }
  },
  "envVars": [
    "SUPABASE_URL",
    "SUPABASE_ANON_KEY",
    "SUPABASE_SERVICE_ROLE_KEY",
    "TEST_EVENT_ID",
    "STRIPE_WEBHOOK_SECRET"
  ]
}
```
  </action>
  <verify>All helper files exist and export their functions correctly</verify>
  <done>Auth helpers, Stripe signature generator, data factories, and test config created</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json with k6 test scripts</name>
  <files>package.json</files>
  <action>
Add comprehensive k6 load test scripts to root package.json:

```json
{
  "scripts": {
    "load-test:purchase": "k6 run load-tests/scenarios/ticket-purchase.js",
    "load-test:scanner": "k6 run load-tests/scenarios/scanner-burst.js",
    "load-test:dashboard": "k6 run load-tests/scenarios/dashboard-load.js",
    "load-test:webhook": "k6 run load-tests/scenarios/webhook-burst.js",
    "load-test:all": "npm run load-test:purchase && npm run load-test:scanner && npm run load-test:dashboard && npm run load-test:webhook",
    "load-test:quick": "k6 run --vus 5 --duration 30s load-tests/scenarios/ticket-purchase.js"
  }
}
```

Merge these scripts with existing scripts in package.json. Do not remove existing scripts.
  </action>
  <verify>npm run load-test:all --help shows the command is recognized (or run npm run to list scripts)</verify>
  <done>k6 load test npm scripts added for all scenarios plus combined runner</done>
</task>

</tasks>

<verification>
- [ ] `load-tests/config/thresholds.js` exports thresholds and getThresholds function
- [ ] `load-tests/helpers/auth.js` exports getHeaders and getServiceHeaders
- [ ] `load-tests/helpers/stripe-signature.js` exports generateStripeSignature
- [ ] `load-tests/helpers/data-generators.js` exports all three generator functions
- [ ] `load-tests/data/test-config.json` contains valid JSON configuration
- [ ] `package.json` contains all load-test:* scripts
</verification>

<success_criteria>
- All helper modules created with proper exports
- Threshold configuration covers all four test scenarios (purchase, scanner, dashboard, webhook)
- npm scripts ready for running individual and combined load tests
- Directory structure matches RESEARCH.md recommended layout
</success_criteria>

<output>
After completion, create `.planning/phases/10-load-testing-performance/10-01-SUMMARY.md`
</output>
