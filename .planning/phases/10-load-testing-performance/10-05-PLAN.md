---
phase: 10-load-testing-performance
plan: 05
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - load-tests/scenarios/webhook-burst.js
autonomous: true

must_haves:
  truths:
    - "50 webhook events process within 10 seconds without timeouts"
    - "All webhooks return 200 status (success or idempotent duplicate)"
    - "Error rate remains below 1%"
    - "Stripe signature validation succeeds for generated events"
  artifacts:
    - path: "load-tests/scenarios/webhook-burst.js"
      provides: "k6 load test for 50 webhook events burst"
      min_lines: 100
  key_links:
    - from: "load-tests/scenarios/webhook-burst.js"
      to: "/functions/v1/stripe-webhook"
      via: "http.post"
      pattern: "stripe-webhook"
    - from: "load-tests/scenarios/webhook-burst.js"
      to: "load-tests/helpers/stripe-signature.js"
      via: "import generateStripeSignature"
      pattern: "generateStripeSignature"
---

<objective>
Create k6 load test for 50 webhook events burst against the stripe-webhook Edge Function.

Purpose: Validate success criteria #4 - "Webhook processing handles burst of 50 events without timeouts". Simulates event end rush when many purchases complete simultaneously.

Output: `load-tests/scenarios/webhook-burst.js` - executable k6 test with signature generation.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-load-testing-performance/10-CONTEXT.md
@.planning/phases/10-load-testing-performance/10-RESEARCH.md
@maguey-pass-lounge/load-tests/webhook-load.k6.js (existing pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook burst load test</name>
  <files>load-tests/scenarios/webhook-burst.js</files>
  <action>
Create k6 load test script that validates 50 webhook events burst processing.

Test scenarios:
1. **Burst test** - 50 unique webhook events in 10 seconds
2. **Idempotency test** - Duplicate webhook handling

```javascript
// Webhook Burst Load Test - 50 Events in 10 Seconds
// Tests: POST /functions/v1/stripe-webhook
// Target: All processed without timeouts, error rate < 1%

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend, Counter } from 'k6/metrics';
import { getThresholds } from '../config/thresholds.js';
import { getBaseUrl } from '../helpers/auth.js';
import { generateStripeSignature } from '../helpers/stripe-signature.js';
import { generateWebhookEvent } from '../helpers/data-generators.js';

// Custom metrics
const errorRate = new Rate('webhook_errors');
const webhookDuration = new Trend('webhook_duration');
const processedCount = new Counter('webhooks_processed');
const duplicateCount = new Counter('duplicates_handled');
const timeoutCount = new Counter('timeouts');

export const options = {
  scenarios: {
    // Scenario 1: Burst of 50 unique webhooks in 10 seconds
    webhook_burst: {
      executor: 'constant-arrival-rate',
      rate: 5,              // 5 requests per second
      timeUnit: '1s',
      duration: '10s',      // For 10 seconds = 50 total requests
      preAllocatedVUs: 10,
      maxVUs: 20,
      exec: 'uniqueWebhooks',
    },
    // Scenario 2: Test idempotency with duplicate webhooks
    idempotency_test: {
      executor: 'per-vu-iterations',
      vus: 5,
      iterations: 3,  // Each VU sends same event 3 times
      startTime: '15s',
      exec: 'duplicateWebhooks',
    },
  },
  thresholds: {
    ...getThresholds('webhook'),
    'webhook_duration': ['p(95)<1000'],  // Webhooks allow 1s
    'webhook_errors': ['rate<0.01'],
    'timeouts': ['count<1'],  // Zero timeouts
  },
};

// Scenario 1: Unique webhook events
export function uniqueWebhooks() {
  const baseUrl = getBaseUrl();
  const webhookSecret = __ENV.STRIPE_WEBHOOK_SECRET || 'whsec_test_secret';

  // Generate unique webhook event
  const event = generateWebhookEvent(__VU, __ITER);
  const payload = JSON.stringify(event);

  // Generate valid Stripe signature
  const signature = generateStripeSignature(payload, webhookSecret);

  const headers = {
    'Content-Type': 'application/json',
    'stripe-signature': signature,
  };

  const startTime = Date.now();

  const response = http.post(
    `${baseUrl}/functions/v1/stripe-webhook`,
    payload,
    {
      headers,
      timeout: '30s',
      tags: { name: 'webhook_burst' },
    }
  );

  const duration = Date.now() - startTime;
  webhookDuration.add(duration);

  // Check for timeout
  if (duration >= 30000) {
    timeoutCount.add(1);
    console.log(`[VU ${__VU}] TIMEOUT: Webhook took ${duration}ms`);
  }

  const success = check(response, {
    'status is 200': (r) => r.status === 200,
    'has received: true': (r) => {
      try {
        const body = JSON.parse(r.body);
        return body.received === true;
      } catch {
        return false;
      }
    },
    'response under 5s': () => duration < 5000,
  });

  if (success) {
    processedCount.add(1);
  }
  errorRate.add(!success);

  if (!success) {
    console.log(`[VU ${__VU}] Webhook failed: ${response.status} - ${response.body?.substring(0, 200)}`);
  }

  // Small delay between requests (but still rapid for burst testing)
  sleep(0.1);
}

// Scenario 2: Test idempotency - same event sent multiple times
export function duplicateWebhooks() {
  const baseUrl = getBaseUrl();
  const webhookSecret = __ENV.STRIPE_WEBHOOK_SECRET || 'whsec_test_secret';

  // All VUs in this scenario use a shared event ID (per VU to avoid cross-VU conflicts)
  const sharedEventId = `evt_idempotency_${__VU}_${Math.floor(Date.now() / 60000)}`;

  const event = {
    id: sharedEventId,
    type: 'checkout.session.completed',
    created: Math.floor(Date.now() / 1000),
    data: {
      object: {
        id: `cs_test_idempotency_${__VU}`,
        payment_intent: `pi_test_idempotency_${__VU}`,
        payment_status: 'paid',
        amount_total: 3000,
        currency: 'usd',
        customer_email: `idempotency_${__VU}@test.maguey.com`,
        metadata: {
          orderId: `order_idempotency_${__VU}`,
          eventId: __ENV.TEST_EVENT_ID || 'test-event-id',
          customerEmail: `idempotency_${__VU}@test.maguey.com`,
          customerName: `Idempotency Test ${__VU}`,
          tickets: JSON.stringify([{
            ticketTypeId: 'general-admission',
            quantity: 1,
            unitPrice: 2500,
            displayName: 'GA',
          }]),
        },
      },
    },
  };

  const payload = JSON.stringify(event);
  const signature = generateStripeSignature(payload, webhookSecret);

  const headers = {
    'Content-Type': 'application/json',
    'stripe-signature': signature,
  };

  const response = http.post(
    `${baseUrl}/functions/v1/stripe-webhook`,
    payload,
    { headers, timeout: '30s' }
  );

  const success = check(response, {
    'duplicate returns 200': (r) => r.status === 200,
  });

  // Track duplicates
  if (response.status === 200) {
    try {
      const body = JSON.parse(response.body);
      if (body.duplicate || body.cached || body.message?.includes('already processed')) {
        duplicateCount.add(1);
      }
    } catch {
      // First request creates, subsequent are duplicates
      // All should return 200 regardless
    }
  }

  errorRate.add(!success);
  sleep(0.2);
}

// Summary report
export function handleSummary(data) {
  const metrics = data.metrics;
  const thresholdResults = Object.entries(data.thresholds || {})
    .map(([name, result]) => `  ${result.ok ? 'PASS' : 'FAIL'} ${name}`)
    .join('\n');

  const summary = `
================================================================================
                      WEBHOOK BURST LOAD TEST RESULTS
================================================================================

Configuration:
  Burst Test:      50 unique webhooks in 10 seconds (5/sec)
  Idempotency:     5 VUs x 3 iterations each
  Endpoint:        POST /functions/v1/stripe-webhook

Results:
  Total Processed: ${metrics.webhooks_processed?.values?.count || 0}
  Timeouts:        ${metrics.timeouts?.values?.count || 0}
  Error Rate:      ${((metrics.webhook_errors?.values?.rate || 0) * 100).toFixed(2)}%

Response Times:
  Average:         ${Math.round(metrics.webhook_duration?.values?.avg || 0)}ms
  P95:             ${Math.round(metrics.webhook_duration?.values?.['p(95)'] || 0)}ms
  P99:             ${Math.round(metrics.webhook_duration?.values?.['p(99)'] || 0)}ms
  Max:             ${Math.round(metrics.webhook_duration?.values?.max || 0)}ms

Idempotency:
  Duplicates handled: ${metrics.duplicates_handled?.values?.count || 0}
  (All duplicates should return 200 - webhook is idempotent)

Thresholds:
${thresholdResults}

================================================================================
`;

  return {
    'stdout': summary,
    'load-tests/results/webhook-burst-results.json': JSON.stringify(data, null, 2),
  };
}
```

Key features:
- Uses constant-arrival-rate executor for precise 5 req/sec rate
- 50 events in 10 seconds simulates event end rush
- Generates valid Stripe webhook signatures
- Tests idempotency with duplicate event handling
- Tracks timeouts explicitly (zero tolerance)
  </action>
  <verify>k6 run --dry-run load-tests/scenarios/webhook-burst.js validates syntax</verify>
  <done>Webhook burst test with 50 events in 10 seconds and idempotency check created</done>
</task>

</tasks>

<verification>
- [ ] `load-tests/scenarios/webhook-burst.js` exists and is valid JavaScript
- [ ] Uses constant-arrival-rate executor for 5 req/sec
- [ ] Generates valid Stripe signatures using helper
- [ ] Idempotency test sends same event multiple times
- [ ] Timeout tracking with zero tolerance threshold
- [ ] Summary shows processed count, timeouts, and duplicates
</verification>

<success_criteria>
- k6 test sends 50 webhook events in 10 seconds
- Stripe signature generation integrated from helpers
- Idempotency test validates duplicate webhook handling
- Zero timeouts allowed per success criteria
- Error rate threshold < 1%
</success_criteria>

<output>
After completion, create `.planning/phases/10-load-testing-performance/10-05-SUMMARY.md`
</output>
