---
phase: 18
plan: 18-03
title: "Log failed scans to server scan_logs"
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/lib/simple-scanner.ts
autonomous: true
---

# Plan 18-03: Log failed scans to server scan_logs

## Objective
Log ALL scan rejections (invalid QR, not found, unsigned, already scanned) to the `scan_logs` table for a complete audit trail.

## Requirements
- R22: Failed scans not logged to server scan_logs

## Tasks

<task id="1">
Add `hashInput()` helper to simple-scanner.ts that hashes scan input via `crypto.subtle.digest('SHA-256')` for secure logging (don't store raw QR data).
</task>

<task id="2">
Add `logFailedScan()` function to simple-scanner.ts that inserts into scan_logs with `scan_success: false`, device_id, scan_method, and metadata (error details, input hash). Wrapped in try/catch to never block scan flow.
</task>

<task id="3">
Add fire-and-forget `logFailedScan()` calls at each rejection point in `scanTicket()`:
- Invalid/tampered QR → `invalid_signature` / `invalid_format`
- No token → `invalid_input`
- Unsigned QR → `unsigned_qr`
- Not found → `not_found`
- Already scanned (non-VIP) → `already_scanned`
</task>

## Verification
- [ ] Invalid QR scan creates scan_logs row with scan_result='invalid_format', scan_success=false
- [ ] Unknown ticket ID creates row with scan_result='not_found'
- [ ] Already-scanned ticket creates row with scan_result='already_scanned'
- [ ] Successful scans still log with scan_success=true (unchanged)
- [ ] No scan flow is delayed by logging

## must_haves
- All failed scans logged to scan_logs table
- Logging never blocks or delays scan response
