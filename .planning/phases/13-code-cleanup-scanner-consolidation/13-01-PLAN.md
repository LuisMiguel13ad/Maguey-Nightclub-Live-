---
phase: 13-code-cleanup-scanner-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/lib/scanner-service.ts
  - maguey-gate-scanner/src/lib/__tests__/test-utils.ts
  - maguey-gate-scanner/src/__tests__/setup-integration.ts
  - maguey-gate-scanner/src/__tests__/integration/test-helpers.ts
  - maguey-gate-scanner/src/lib/__tests__/scanner-service.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "scanner-service.ts validateQRSignature produces base64 signatures matching the webhook's generateQrSignature output"
    - "All test helper generateQRSignature/generateValidQRSignature functions produce base64 signatures"
    - "All scanner tests pass with consolidated base64 signature logic"
    - "No @noble/hashes imports remain in scanner-service.ts"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/scanner-service.ts"
      provides: "Base64 QR signature validation using crypto.subtle"
      contains: "crypto.subtle.importKey"
    - path: "maguey-gate-scanner/src/lib/__tests__/test-utils.ts"
      provides: "Base64 test signature generation"
      contains: "crypto.subtle"
    - path: "maguey-gate-scanner/src/__tests__/setup-integration.ts"
      provides: "Base64 integration test signature generation"
      contains: "crypto.subtle"
    - path: "maguey-gate-scanner/src/__tests__/integration/test-helpers.ts"
      provides: "Base64 integration helper signature generation"
      contains: "crypto.subtle"
  key_links:
    - from: "maguey-gate-scanner/src/lib/scanner-service.ts"
      to: "maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts"
      via: "Both use HMAC-SHA256 with base64 encoding"
      pattern: "base64"
    - from: "maguey-gate-scanner/src/lib/scanner-service.ts"
      to: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      via: "Both now use crypto.subtle + base64 (same algorithm)"
      pattern: "bufferToBase64|btoa"
---

<objective>
Consolidate QR signature validation to use base64 encoding everywhere, matching the production webhook (stripe-webhook generateQrSignature uses base64Encode) and the production scanner (simple-scanner.ts uses bufferToBase64).

Purpose: Eliminate the dual QR signature implementation where scanner-service.ts uses hex encoding (@noble/hashes bytesToHex) while the webhook and simple-scanner both use base64. This mismatch is tech debt identified in the v1.0 milestone audit.

Output: Single consistent base64 signature algorithm across all scanner code and test utilities, with @noble/hashes dependency removed from scanner-service.ts.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md

# Source of truth — webhook signature generation (base64):
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts (lines 133-148: generateQrSignature using crypto.subtle + base64Encode)

# Production scanner — already base64:
@maguey-gate-scanner/src/lib/simple-scanner.ts (lines 66-117: bufferToBase64 + crypto.subtle)

# NFC service — already base64:
@maguey-gate-scanner/src/lib/nfc-service.ts (lines 239-256: btoa + crypto.subtle)

# Files to modify:
@maguey-gate-scanner/src/lib/scanner-service.ts (lines 1-3, 96-130: hex-based validateQRSignature)
@maguey-gate-scanner/src/lib/__tests__/test-utils.ts (lines 8-10, 197-216: hex generateQRSignature/validateQRSignature)
@maguey-gate-scanner/src/__tests__/setup-integration.ts (lines 10-12, 39-43: hex generateQRSignature)
@maguey-gate-scanner/src/__tests__/integration/test-helpers.ts (lines 11-13, 35-46, 352-359: hex signatures)
@maguey-gate-scanner/src/lib/__tests__/scanner-service.test.ts (lines 1-17, 282-340: tests using hex utils)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert scanner-service.ts validateQRSignature from hex to base64</name>
  <files>maguey-gate-scanner/src/lib/scanner-service.ts</files>
  <action>
Replace the hex-based validateQRSignature implementation with a base64-based one using `crypto.subtle`, matching the pattern from simple-scanner.ts.

**Step 1 — Remove @noble/hashes imports (lines 1-3):**
Remove these three imports:
```
import { hmac } from '@noble/hashes/hmac';
import { sha256 } from '@noble/hashes/sha256';
import { bytesToHex, utf8ToBytes } from '@noble/hashes/utils';
```

**Step 2 — Rewrite validateQRSignature (lines 96-130):**
Replace the hex-based implementation with:
```typescript
export const validateQRSignature = async (
  qrToken: string,
  signature: string
): Promise<boolean> => {
  if (!qrToken || !signature) return false;

  const log = logger.child({ qrToken: redact(qrToken) });

  try {
    const encoder = new TextEncoder();
    const key = await crypto.subtle.importKey(
      'raw',
      encoder.encode(qrSigningSecret),
      { name: 'HMAC', hash: 'SHA-256' },
      false,
      ['sign']
    );

    const signatureBuffer = await crypto.subtle.sign(
      'HMAC',
      key,
      encoder.encode(qrToken)
    );

    // Convert to base64 — matching webhook and simple-scanner
    const expectedSignature = btoa(
      String.fromCharCode(...new Uint8Array(signatureBuffer))
    );

    const isValid = timingSafeEqual(signature, expectedSignature);

    if (!isValid) {
      log.warn('QR signature validation failed');

      // Track invalid QR error (keep existing ScanError tracking)
      const scanError = new ScanError(
        ScanErrorType.INVALID_QR,
        'Invalid QR code signature',
        {
          context: {
            qrToken: redact(qrToken),
            traceId: getCurrentTraceContext()?.traceId,
          },
        }
      );
      // ... (preserve rest of error tracking code unchanged)
    }

    return isValid;
  } catch (error) {
    // ... (preserve existing catch block unchanged)
  }
};
```

Key changes:
- Use `crypto.subtle.importKey` + `crypto.subtle.sign` instead of `hmac(sha256, ...)` from @noble/hashes
- Use `btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)))` instead of `bytesToHex(...)`
- Remove `.toLowerCase()` from comparison since base64 is case-sensitive (unlike hex)
- Keep all existing error tracking, logging, and ScanError handling intact
- Keep the existing `timingSafeEqual` helper function (it works fine with base64 strings)

**IMPORTANT:** Do NOT change anything below the validateQRSignature function. The rest of scanner-service.ts (scanTicket, lookupTicketByQR, etc.) is unaffected.
  </action>
  <verify>
Run TypeScript compilation to verify no type errors:
```bash
cd maguey-gate-scanner && npx tsc --noEmit src/lib/scanner-service.ts 2>&1 | head -20
```
Verify no @noble/hashes imports remain:
```bash
grep -n "@noble/hashes" maguey-gate-scanner/src/lib/scanner-service.ts
```
(Should return no matches)
  </verify>
  <done>scanner-service.ts uses crypto.subtle + base64 for QR signature validation, all @noble/hashes imports removed, existing error tracking preserved</done>
</task>

<task type="auto">
  <name>Task 2: Update all test utilities to generate base64 signatures and run tests</name>
  <files>
    maguey-gate-scanner/src/lib/__tests__/test-utils.ts
    maguey-gate-scanner/src/__tests__/setup-integration.ts
    maguey-gate-scanner/src/__tests__/integration/test-helpers.ts
    maguey-gate-scanner/src/lib/__tests__/scanner-service.test.ts
  </files>
  <action>
Convert all test signature generation from hex (@noble/hashes bytesToHex) to base64 (crypto.subtle + btoa).

**File 1: `src/lib/__tests__/test-utils.ts`**

Remove @noble/hashes imports (lines 8-10):
```
import { hmac } from '@noble/hashes/hmac'
import { sha256 } from '@noble/hashes/sha256'
import { bytesToHex, utf8ToBytes } from '@noble/hashes/utils'
```

Rewrite `generateQRSignature` (line 197-201) to use crypto.subtle + base64:
```typescript
export async function generateQRSignature(qrToken: string, secret: string = TEST_QR_SECRET): Promise<string> {
  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw',
    encoder.encode(secret),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(qrToken));
  return btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)));
}
```

Note: This changes from sync to async. Update `validateQRSignature` (line 206-216) accordingly:
```typescript
export async function validateQRSignature(
  qrToken: string,
  signature: string | null | undefined,
  secret: string = TEST_QR_SECRET
): Promise<boolean> {
  if (!qrToken || !signature) {
    return false
  }
  const expected = await generateQRSignature(qrToken, secret)
  return signature === expected
}
```

**File 2: `src/__tests__/setup-integration.ts`**

Remove @noble/hashes imports (lines 10-12):
```
import { hmac } from '@noble/hashes/hmac';
import { sha256 } from '@noble/hashes/sha256';
import { bytesToHex, utf8ToBytes } from '@noble/hashes/utils';
```

Rewrite `generateQRSignature` (lines 39-43) to async base64:
```typescript
async function generateQRSignature(qrToken: string): Promise<string> {
  const secret = getQRSigningSecret();
  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw',
    encoder.encode(secret),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(qrToken));
  return btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)));
}
```

Update all callers of `generateQRSignature` in this file to use `await`.

**File 3: `src/__tests__/integration/test-helpers.ts`**

Remove @noble/hashes imports (lines 11-13):
```
import { hmac } from '@noble/hashes/hmac';
import { sha256 } from '@noble/hashes/sha256';
import { bytesToHex, utf8ToBytes } from '@noble/hashes/utils';
```

Rewrite `generateValidQRSignature` (lines 35-46) to async base64:
```typescript
export async function generateValidQRSignature(
  qrToken: string,
  secret?: string
): Promise<string> {
  const signingSecret = secret ||
    process.env.VITE_QR_SIGNING_SECRET ||
    import.meta.env?.VITE_QR_SIGNING_SECRET ||
    'test-qr-signing-secret-for-integration-tests';

  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw',
    encoder.encode(signingSecret),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(qrToken));
  return btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)));
}
```

Update `validateQRSignature` (lines 352-359) to async:
```typescript
export async function validateQRSignature(
  qrToken: string,
  signature: string,
  secret?: string
): Promise<boolean> {
  const expectedSignature = await generateValidQRSignature(qrToken, secret);
  return signature === expectedSignature;
}
```

Update all callers to use `await`.

**File 4: `src/lib/__tests__/scanner-service.test.ts`**

The test file imports `generateQRSignature` and `validateQRSignature` from test-utils. Since these are now async:
- Add `await` before all calls to `generateQRSignature(...)` and `validateQRSignature(...)`
- Update test descriptions: change "case-insensitive for hex signatures" to "produces consistent base64 signatures" since base64 IS case-sensitive
- Remove the case-insensitivity test (lines 327-333) — base64 is case-sensitive, unlike hex. Replace with a test verifying the base64 output format contains valid base64 characters (A-Z, a-z, 0-9, +, /, =).
- Ensure all test callbacks are `async` where they call these functions

**CRITICAL:** After converting sync functions to async, scan all callers in these test files for any that are NOT awaited. Every `generateQRSignature()` and `validateQRSignature()` call must be awaited.
  </action>
  <verify>
Run the scanner test suite:
```bash
cd maguey-gate-scanner && npx vitest run src/lib/__tests__/scanner-service.test.ts --reporter=verbose 2>&1 | tail -30
```
Verify no @noble/hashes imports remain in test files:
```bash
grep -rn "@noble/hashes" maguey-gate-scanner/src/lib/__tests__/test-utils.ts maguey-gate-scanner/src/__tests__/setup-integration.ts maguey-gate-scanner/src/__tests__/integration/test-helpers.ts
```
(Should return no matches)
  </verify>
  <done>All test utilities generate base64 signatures matching production, all scanner tests pass, no @noble/hashes imports remain in test files</done>
</task>

</tasks>

<verification>
1. No `@noble/hashes` imports remain in `scanner-service.ts` or any test utility files
2. `npx vitest run` passes all scanner tests
3. The signature algorithm in `scanner-service.ts` matches exactly: `crypto.subtle.importKey` -> `crypto.subtle.sign` -> `btoa(String.fromCharCode(...new Uint8Array(...)))`
4. This matches `simple-scanner.ts` (bufferToBase64) and `stripe-webhook` (base64Encode) output
5. `batch-scan-service.ts` imports `scanTicket` from scanner-service (not validateQRSignature directly), so no changes needed there
</verification>

<success_criteria>
- Single base64 QR signature implementation used across scanner-service.ts, simple-scanner.ts, nfc-service.ts, and all test utilities
- All scanner tests pass with base64 signature logic
- No @noble/hashes imports remain in scanner-service.ts or test utility files
- Signature output matches what the stripe-webhook generateQrSignature produces
</success_criteria>

<output>
After completion, create `.planning/phases/13-code-cleanup-scanner-consolidation/13-01-SUMMARY.md`
</output>
