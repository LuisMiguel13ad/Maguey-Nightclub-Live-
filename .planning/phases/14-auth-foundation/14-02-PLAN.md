---
phase: 14-auth-foundation
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - maguey-gate-scanner/src/contexts/AuthContext.tsx
  - maguey-gate-scanner/src/lib/auth.ts
  - maguey-gate-scanner/src/pages/OwnerDashboard.tsx
  - maguey-gate-scanner/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "In production builds, AuthContext ONLY uses Supabase sessions — localStorage fallback never activates"
    - "In development mode (import.meta.env.DEV === true), localStorage fallback still works for testing"
    - "auth.ts setUserRole and getCurrentUserRole use localStorage only in DEV mode"
    - "OwnerDashboard.tsx and Dashboard.tsx auth checks use localStorage only in DEV mode"
    - "No localStorage auth leak in production builds"
  artifacts:
    - path: "maguey-gate-scanner/src/contexts/AuthContext.tsx"
      provides: "Auth provider gating localStorage behind DEV flag"
      contains: "import.meta.env.DEV"
    - path: "maguey-gate-scanner/src/lib/auth.ts"
      provides: "Role management gating localStorage behind DEV flag"
      contains: "import.meta.env.DEV"
    - path: "maguey-gate-scanner/src/pages/OwnerDashboard.tsx"
      provides: "Dashboard auth check gating localStorage behind DEV flag"
      contains: "import.meta.env.DEV"
    - path: "maguey-gate-scanner/src/pages/Dashboard.tsx"
      provides: "Employee dashboard auth check gating localStorage behind DEV flag"
      contains: "import.meta.env.DEV"
  key_links:
    - from: "maguey-gate-scanner/src/contexts/AuthContext.tsx"
      to: "supabase.auth.getSession()"
      via: "Primary auth source in all environments"
      pattern: "supabase\\.auth\\.getSession"
    - from: "maguey-gate-scanner/src/contexts/AuthContext.tsx"
      to: "localStorageService.getUser()"
      via: "Fallback ONLY when import.meta.env.DEV is true"
      pattern: "import\\.meta\\.env\\.DEV.*localStorageService"
---

<objective>
Gate all localStorage auth fallbacks behind `import.meta.env.DEV` so production builds ONLY use real Supabase sessions.

Purpose: The current AuthContext.tsx has a 3-tier fallback that always checks localStorage when Supabase session is null. This means production builds can be tricked into authenticating via localStorage manipulation. This plan ensures production builds reject localStorage auth entirely.

Output: Modified AuthContext.tsx, auth.ts, OwnerDashboard.tsx, and Dashboard.tsx — all localStorage auth paths gated behind `import.meta.env.DEV`.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-auth-foundation/14-CONTEXT.md
@.planning/phases/14-auth-foundation/14-01-SUMMARY.md

Key source files (read before modifying):
@maguey-gate-scanner/src/contexts/AuthContext.tsx
@maguey-gate-scanner/src/lib/auth.ts
@maguey-gate-scanner/src/pages/OwnerDashboard.tsx
@maguey-gate-scanner/src/pages/Dashboard.tsx

localStorage auth references found at:
- AuthContext.tsx lines 39-51 (refreshRole: !isSupabaseConfigured fallback)
- AuthContext.tsx lines 60-71 (refreshRole: session null fallback)
- AuthContext.tsx lines 82-93 (initAuth: double-check localStorage fallback)
- AuthContext.tsx lines 114-124 (onAuthStateChange: session null fallback)
- auth.ts lines 41-57 (setUserRole: !isSupabaseConfigured localStorage write)
- auth.ts lines 97-100 (getCurrentUserRole: !isSupabaseConfigured returns DEFAULT_ROLE)
- OwnerDashboard.tsx lines 186-211 (3 localStorage getUser checks)
- Dashboard.tsx lines 241-248 (1 localStorage getUser check)

NOTE: Do NOT modify Auth.tsx — demo button removal is Phase 15 scope.
NOTE: Do NOT modify OwnerPortalLayout.tsx, EmployeePortalLayout.tsx, Navigation.tsx, or RoleSwitcher.tsx — those use localStorageService.clearUser() and .setUser() for logout/role switching, which will be addressed when login flows are reworked in Phase 15.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate AuthContext.tsx localStorage fallback behind DEV</name>
  <files>maguey-gate-scanner/src/contexts/AuthContext.tsx</files>
  <action>
Modify `maguey-gate-scanner/src/contexts/AuthContext.tsx` to gate ALL localStorage fallbacks behind `import.meta.env.DEV`:

**refreshRole function (lines 38-73):**
- Lines 39-51 (`if (!isSupabaseConfigured())`): Wrap the localStorage path in `if (import.meta.env.DEV)`. If NOT DEV and NOT configured, set user to null and loading to false.
- Lines 60-71 (else block after `if (session?.user)`): Change from unconditional localStorage fallback to: `if (import.meta.env.DEV) { /* existing localStorage logic */ } else { setUser(null); setRole('employee'); }`

**initAuth function (lines 78-101):**
- Lines 82-93 (double-check localStorage block): Wrap the entire `if (isSupabaseConfigured() && mounted)` localStorage double-check in `if (import.meta.env.DEV)`. In production, if there is no session, that is the final answer — user is not authenticated.

**onAuthStateChange handler (lines 106-131):**
- Lines 114-124 (else block after `if (session?.user)`): Change from unconditional localStorage fallback to: `if (import.meta.env.DEV) { /* existing localStorage logic */ } else { setUser(null); setRole('employee'); }`

**Pattern for each gate:**
```typescript
// BEFORE:
const localUser = localStorageService.getUser();
if (localUser) { /* use it */ }

// AFTER:
if (import.meta.env.DEV) {
  const localUser = localStorageService.getUser();
  if (localUser) { /* use it */ }
} else {
  setUser(null);
  setRole('employee');
}
```

Keep all existing Supabase session logic unchanged. The primary path (Supabase getSession + onAuthStateChange) remains identical. Only the fallback paths are gated.
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit` to check for type errors. Search the file for `localStorageService.getUser()` — every occurrence should be inside an `import.meta.env.DEV` block.</verify>
  <done>AuthContext.tsx localStorage fallbacks are gated behind import.meta.env.DEV. In production builds, only Supabase sessions are used for authentication. In dev mode, localStorage fallback still works.</done>
</task>

<task type="auto">
  <name>Task 2: Gate auth.ts and dashboard pages localStorage behind DEV</name>
  <files>
    maguey-gate-scanner/src/lib/auth.ts
    maguey-gate-scanner/src/pages/OwnerDashboard.tsx
    maguey-gate-scanner/src/pages/Dashboard.tsx
  </files>
  <action>
**auth.ts:**
- `setUserRole` (lines 41-57): The `if (!isSupabaseConfigured())` block writes to localStorage. Gate it: `if (!isSupabaseConfigured() && import.meta.env.DEV)`. If not configured AND not DEV, throw an error: `throw new Error('Cannot set user role: Supabase not configured in production')`.
- `getCurrentUserRole` (lines 97-100): The `if (!isSupabaseConfigured())` returns DEFAULT_ROLE. Gate it: `if (!isSupabaseConfigured() && import.meta.env.DEV)`. If not configured AND not DEV, return null (user is not authenticated).

**OwnerDashboard.tsx (lines 186-211):**
Three locations use `localStorageService.getUser()` as auth fallback. Gate all three behind `import.meta.env.DEV`:

- Line 186-191: `if (!session)` block. Change to:
  ```typescript
  if (!session) {
    if (import.meta.env.DEV) {
      const localUser = localStorageService.getUser();
      if (localUser && (localUser.role === 'owner' || localUser.role === 'promoter')) {
        loadData();
        return;
      }
    }
    navigate("/auth");
    return;
  }
  ```

- Lines 196-201: catch block fallback. Same pattern — gate localStorage check behind DEV.
- Lines 205-211: else block (when Supabase not configured). Same pattern — gate behind DEV, otherwise navigate to /auth.

**Dashboard.tsx (lines 241-248):**
One location uses `localStorageService.getUser()` as auth fallback in the else block. Gate behind DEV:
```typescript
} else {
  if (import.meta.env.DEV) {
    const localUser = localStorageService.getUser();
    if (!localUser) {
      navigate("/auth");
      return;
    }
  } else {
    navigate("/auth");
    return;
  }
}
```
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit` to check for type errors. Search all 3 files for `localStorageService.getUser()` — every occurrence should be inside an `import.meta.env.DEV` block.</verify>
  <done>auth.ts, OwnerDashboard.tsx, and Dashboard.tsx all gate localStorage auth behind import.meta.env.DEV. Production builds never use localStorage for authentication.</done>
</task>

</tasks>

<verification>
1. `cd maguey-gate-scanner && npx tsc --noEmit` — no type errors
2. `grep -n 'localStorageService.getUser' src/contexts/AuthContext.tsx src/lib/auth.ts src/pages/OwnerDashboard.tsx src/pages/Dashboard.tsx` — every hit must be inside a DEV block
3. `grep -c 'import.meta.env.DEV' src/contexts/AuthContext.tsx` — should be 3-4 occurrences
4. `npm run dev --workspace=maguey-gate-scanner` — site starts without errors
</verification>

<success_criteria>
- Every `localStorageService.getUser()` call in AuthContext.tsx, auth.ts, OwnerDashboard.tsx, and Dashboard.tsx is gated behind `import.meta.env.DEV`
- Production builds (import.meta.env.DEV === false) ONLY use Supabase sessions
- Development builds retain full localStorage fallback for testing
- No TypeScript compilation errors
- Scanner site starts and runs in dev mode
</success_criteria>

<output>
After completion, create `.planning/phases/14-auth-foundation/14-02-SUMMARY.md`
</output>
