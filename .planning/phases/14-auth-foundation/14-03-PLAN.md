---
phase: 14-auth-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/auth/verify-credentials.ts
autonomous: true

must_haves:
  truths:
    - "All 3 sites share the same VITE_SUPABASE_URL value"
    - "All 3 sites share the same VITE_SUPABASE_ANON_KEY value"
    - "Stripe test keys (pk_test_, sk_test_) are validated as functional via Stripe API"
    - "Resend API key (re_) is validated as functional via Resend API"
    - "Script reports clear PASS/FAIL for each check"
  artifacts:
    - path: "scripts/auth/verify-credentials.ts"
      provides: "Automated environment and credential validation across all 3 sites"
      contains: "PASS"
  key_links:
    - from: "scripts/auth/verify-credentials.ts"
      to: "maguey-gate-scanner/.env, maguey-pass-lounge/.env, maguey-nights/.env"
      via: "dotenv loading each .env file and comparing values"
      pattern: "config.*path.*\\.env"
    - from: "scripts/auth/verify-credentials.ts"
      to: "Stripe API"
      via: "GET /v1/balance with sk_test_ key"
      pattern: "api\\.stripe\\.com"
    - from: "scripts/auth/verify-credentials.ts"
      to: "Resend API"
      via: "GET /api-keys with re_ key"
      pattern: "api\\.resend\\.com"
---

<objective>
Validate that all environment variables are consistent across the 3 sites and that external service credentials (Stripe, Resend) are actually functional.

Purpose: Misconfigured .env files across the monorepo cause subtle bugs (wrong Supabase project, missing keys). This script catches inconsistencies before they become production issues. Validates R35 (env consistency), R36 (Stripe keys), R37 (Resend key).

Output: A single TypeScript verification script that checks env consistency and validates external API keys.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-auth-foundation/14-CONTEXT.md

Current .env contents (from codebase analysis):
- maguey-gate-scanner/.env: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY, VITE_QR_SIGNING_SECRET, SUPABASE_SERVICE_ROLE_KEY
- maguey-pass-lounge/.env: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY, QR_SIGNING_SECRET, VITE_STRIPE_PUBLISHABLE_KEY, STRIPE_SECRET_KEY, EMAIL_API_KEY, STRIPE_WEBHOOK_SECRET, SUPABASE_SERVICE_ROLE_KEY, VITE_SCANNER_API_URL, VITE_EMAIL_FROM_ADDRESS, VITE_APP_URL
- maguey-nights/.env: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY, VITE_QR_SIGNING_SECRET, VITE_PURCHASE_SITE_URL

Root package.json has: tsx (^4.21.0), dotenv (^17.2.3) as devDependencies
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credential and env verification script</name>
  <files>scripts/auth/verify-credentials.ts</files>
  <action>
Create `scripts/auth/verify-credentials.ts` that performs three categories of checks:

**1. Environment Consistency (R35):**
- Load .env from all 3 sites using dotenv `config({ path, override: true })` into separate objects (NOT into process.env — parse them manually via `dotenv.parse(readFileSync(path))`).
- Check that `VITE_SUPABASE_URL` is identical across all 3 sites.
- Check that `VITE_SUPABASE_ANON_KEY` is identical across all 3 sites.
- Check that `VITE_SUPABASE_URL` starts with `https://` and contains `.supabase.co`.
- Check that `VITE_SUPABASE_ANON_KEY` is not empty and not a placeholder.
- Report any mismatches with the differing values.

**2. Stripe Key Validation (R36):**
- Read `STRIPE_SECRET_KEY` and `VITE_STRIPE_PUBLISHABLE_KEY` from maguey-pass-lounge/.env.
- Validate format: sk_test_ prefix on secret key, pk_test_ prefix on publishable key.
- Make a real API call to verify the secret key works: `fetch('https://api.stripe.com/v1/balance', { headers: { 'Authorization': 'Bearer sk_test_...' } })`. A 200 response means the key is valid. Any error means invalid.
- Report: key format valid, API call result (200 = functional, other = invalid).

**3. Resend Key Validation (R37):**
- Read `EMAIL_API_KEY` from maguey-pass-lounge/.env.
- Validate format: starts with `re_`.
- Make a real API call to verify the key works: `fetch('https://api.resend.com/api-keys', { headers: { 'Authorization': 'Bearer re_...' } })`. A 200 response means the key is valid.
- Report: key format valid, API call result.

**Output format:**
```
=== Environment Consistency ===
[PASS] VITE_SUPABASE_URL: consistent across all 3 sites
[PASS] VITE_SUPABASE_ANON_KEY: consistent across all 3 sites

=== Stripe Keys (maguey-pass-lounge) ===
[PASS] STRIPE_SECRET_KEY: format valid (sk_test_...)
[PASS] STRIPE_SECRET_KEY: API call successful (balance endpoint)
[PASS] VITE_STRIPE_PUBLISHABLE_KEY: format valid (pk_test_...)

=== Resend Key (maguey-pass-lounge) ===
[PASS] EMAIL_API_KEY: format valid (re_...)
[PASS] EMAIL_API_KEY: API call successful (api-keys endpoint)

=== Summary ===
7/7 checks passed
```

Use native `fetch` (available in Node 18+) for API calls. Do NOT install axios or node-fetch.
Use `import { readFileSync } from 'fs'` and `import { parse } from 'dotenv'` to read each .env independently.
Exit with code 0 if all pass, 1 if any fail.
Do NOT use emojis. Use [PASS], [FAIL], [WARN] markers.
  </action>
  <verify>Run `npx tsx scripts/auth/verify-credentials.ts` from the project root. All checks should show [PASS]. Script exits with code 0.</verify>
  <done>Verification script confirms: all 3 sites have consistent Supabase env vars, Stripe test keys are functional (API call succeeds), Resend API key is functional (API call succeeds).</done>
</task>

</tasks>

<verification>
1. `npx tsx scripts/auth/verify-credentials.ts` — exits 0, all checks pass
2. Intentionally corrupt a VITE_SUPABASE_URL in one .env to verify mismatch detection works (then revert)
3. Summary line shows N/N checks passed
</verification>

<success_criteria>
- Script validates VITE_SUPABASE_URL consistency across all 3 sites
- Script validates VITE_SUPABASE_ANON_KEY consistency across all 3 sites
- Script validates Stripe test keys via real API call
- Script validates Resend API key via real API call
- Clear PASS/FAIL output for every check
- Exit code 0 when all pass, 1 when any fail
</success_criteria>

<output>
After completion, create `.planning/phases/14-auth-foundation/14-03-SUMMARY.md`
</output>
