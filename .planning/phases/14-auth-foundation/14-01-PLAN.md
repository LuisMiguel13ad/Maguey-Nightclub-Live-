---
phase: 14-auth-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/auth/create-accounts.ts
  - scripts/auth/verify-accounts.ts
autonomous: true

must_haves:
  truths:
    - "Owner account info@magueynightclub.com exists in Supabase Auth with role:owner in user_metadata"
    - "Employee account Luismbadillo13@gmail.com exists in Supabase Auth with role:employee in user_metadata"
    - "Both accounts have email_confirm:true (no verification email needed)"
    - "Verification script confirms both accounts exist and have correct roles"
  artifacts:
    - path: "scripts/auth/create-accounts.ts"
      provides: "Programmatic Supabase Auth account creation for owner and employee"
      contains: "auth.admin.createUser"
    - path: "scripts/auth/verify-accounts.ts"
      provides: "Account existence and role verification"
      contains: "auth.admin.listUsers"
  key_links:
    - from: "scripts/auth/create-accounts.ts"
      to: "Supabase Auth"
      via: "supabase.auth.admin.createUser with service role key"
      pattern: "SUPABASE_SERVICE_ROLE_KEY"
    - from: "scripts/auth/verify-accounts.ts"
      to: "Supabase Auth"
      via: "supabase.auth.admin.listUsers filtered by email"
      pattern: "auth\\.admin\\.listUsers"
---

<objective>
Create real Supabase Auth accounts for the owner and employee, replacing the demo/localStorage-only auth that exists today.

Purpose: Phase 15 (login flows) and Phase 16 (route protection) require real Supabase Auth accounts to exist. This plan creates them programmatically using the admin API and verifies they are correct.

Output: Two TypeScript scripts in `scripts/auth/` — one to create accounts, one to verify them. Both accounts created in Supabase Auth with correct roles.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-auth-foundation/14-CONTEXT.md

Existing pattern to follow:
- maguey-gate-scanner/create-owner-account.ts (existing script, uses WRONG credentials — owner@maguey.club instead of info@magueynightclub.com)
- scripts/seed/seed-vip-reservation.ts (good pattern: root-level script using dotenv + tsx + ESM)
- Root package.json has tsx (^4.21.0), dotenv (^17.2.3), @supabase/supabase-js (^2.78.0) as dependencies

Environment:
- SUPABASE_SERVICE_ROLE_KEY exists in maguey-gate-scanner/.env
- VITE_SUPABASE_URL exists in all 3 site .env files
- Run scripts with: npx tsx scripts/auth/create-accounts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account provisioning script</name>
  <files>scripts/auth/create-accounts.ts</files>
  <action>
Create `scripts/auth/create-accounts.ts` that:

1. Loads env from `maguey-gate-scanner/.env` using dotenv (same pattern as `scripts/seed/seed-vip-reservation.ts` — use `import { config } from 'dotenv'` and `resolve` for path)
2. Creates a Supabase admin client using `VITE_SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` with `autoRefreshToken: false, persistSession: false`
3. Defines two accounts (per user decision — these are LOCKED):
   - Owner: email `info@magueynightclub.com`, password `MagueyNightclub123`, user_metadata `{ role: 'owner', full_name: 'Maguey Owner' }`
   - Employee: email `Luismbadillo13@gmail.com`, password `MagueyScanner123`, user_metadata `{ role: 'employee', full_name: 'Scanner Staff' }`
4. For each account, calls `supabase.auth.admin.createUser({ email, password, email_confirm: true, user_metadata })`. Note: `email_confirm: true` means the account is auto-verified, no verification email sent.
5. If creation fails with "already registered/exists" error, updates the existing user's metadata via `supabase.auth.admin.updateUserById(id, { user_metadata })` to ensure correct role. Find user by listing users and filtering by email.
6. Logs clear output: account email, role assigned, created vs updated status.
7. Uses ESM imports (import/export), not CommonJS require.
8. Exits with code 0 on success, 1 on failure.

Do NOT use emojis in the console output. Use plain text markers like [OK], [WARN], [ERROR].
  </action>
  <verify>Run `npx tsx scripts/auth/create-accounts.ts` from the project root. Both accounts should be created or updated successfully. Script exits with code 0.</verify>
  <done>Owner account (info@magueynightclub.com, role:owner) and employee account (Luismbadillo13@gmail.com, role:employee) exist in Supabase Auth with email_confirm:true and correct user_metadata.role values.</done>
</task>

<task type="auto">
  <name>Task 2: Create account verification script</name>
  <files>scripts/auth/verify-accounts.ts</files>
  <action>
Create `scripts/auth/verify-accounts.ts` that:

1. Loads env from `maguey-gate-scanner/.env` using dotenv (same pattern as Task 1).
2. Creates a Supabase admin client using `VITE_SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`.
3. Calls `supabase.auth.admin.listUsers()` to get all users.
4. Checks for both expected accounts:
   - `info@magueynightclub.com` — must have `user_metadata.role === 'owner'`
   - `Luismbadillo13@gmail.com` — must have `user_metadata.role === 'employee'`
5. For each account, verifies: exists, email_confirmed_at is set, user_metadata.role is correct.
6. Additionally, tests that each account can sign in by calling `supabase.auth.signInWithPassword({ email, password })` using the anon client (created with VITE_SUPABASE_ANON_KEY) to confirm passwords work.
7. Prints a summary table of results: email | exists | confirmed | role | can_sign_in.
8. Exits with code 0 if all checks pass, 1 if any fail.

Do NOT use emojis in console output. Use plain text like [PASS], [FAIL].
  </action>
  <verify>Run `npx tsx scripts/auth/verify-accounts.ts` from the project root. Both accounts should show [PASS] for all checks. Script exits with code 0.</verify>
  <done>Verification script confirms both accounts exist with correct roles and can sign in with their passwords.</done>
</task>

</tasks>

<verification>
1. `npx tsx scripts/auth/create-accounts.ts` — exits 0, both accounts created/updated
2. `npx tsx scripts/auth/verify-accounts.ts` — exits 0, all checks pass
3. Manual check: Go to Supabase Dashboard > Authentication > Users — both accounts visible with correct metadata
</verification>

<success_criteria>
- Owner account info@magueynightclub.com exists in Supabase Auth with role:owner
- Employee account Luismbadillo13@gmail.com exists in Supabase Auth with role:employee
- Both accounts auto-confirmed (no email verification needed)
- Both accounts can sign in with their specified passwords
- Scripts are idempotent (safe to re-run)
</success_criteria>

<output>
After completion, create `.planning/phases/14-auth-foundation/14-01-SUMMARY.md`
</output>
