---
phase: 04-vip-system-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/migrations/20260130000000_vip_state_transition_enforcement.sql
autonomous: true
user_setup: []

must_haves:
  truths:
    - "VIP reservation cannot transition backward (checked_in -> confirmed is rejected)"
    - "Invalid transitions raise database exception with clear error message"
    - "Valid forward transitions work normally (pending -> confirmed -> checked_in)"
  artifacts:
    - path: "maguey-pass-lounge/supabase/migrations/20260130000000_vip_state_transition_enforcement.sql"
      provides: "State transition trigger and validation"
      contains: "validate_vip_status_transition"
  key_links:
    - from: "vip_reservations UPDATE"
      to: "validate_vip_status_transition trigger"
      via: "BEFORE UPDATE trigger"
      pattern: "CREATE TRIGGER.*enforce_vip_status"
---

<objective>
Enforce forward-only state transitions for VIP reservations at the database level.

Purpose: Prevent data corruption from invalid status changes. Currently status transitions are only validated in application code, which can be bypassed or have bugs. Database-level enforcement guarantees data integrity.

Output: Migration with trigger that validates all VIP reservation status changes.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vip-system-reliability/04-CONTEXT.md
@.planning/phases/04-vip-system-reliability/04-RESEARCH.md
@maguey-pass-lounge/supabase/migrations/20260122000000_fix_vip_race_condition_and_rls.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state transition validation migration</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130000000_vip_state_transition_enforcement.sql</files>
  <action>
Create a migration that enforces forward-only VIP reservation status transitions using a PostgreSQL trigger.

**Valid transitions (from 04-CONTEXT.md):**
- pending -> confirmed (payment success)
- pending -> cancelled (payment failed/expired)
- pending -> expired (timeout)
- confirmed -> checked_in (first guest arrives)
- confirmed -> cancelled (owner cancellation pre-event only)
- checked_in -> completed (event ends)

**Implementation requirements:**
1. Create trigger function `validate_vip_status_transition()` that:
   - Allows if OLD.status = NEW.status (no change)
   - Validates transition against allowed pairs
   - Raises exception with clear message for invalid transitions
   - For confirmed -> cancelled, verify event hasn't started (JOIN with events table)

2. Create trigger `enforce_vip_status_transition` BEFORE UPDATE OF status ON vip_reservations

3. Use array-based transition validation (not separate transition table) for simplicity

4. Include SECURITY DEFINER for the function

5. Add comment explaining the state machine

**DO NOT:**
- Create a separate transition history table (overkill for this use case)
- Use enum type changes (status enum already exists)
- Block service_role from making any transitions
  </action>
  <verify>
```bash
# Apply migration locally
cd maguey-pass-lounge && npx supabase db push --local

# Test valid transition works
npx supabase db execute --local "
  INSERT INTO vip_reservations (event_id, event_vip_table_id, table_number, purchaser_name, purchaser_email, status, qr_code_token, amount_paid_cents, checked_in_guests)
  VALUES ('test-event', (SELECT id FROM event_vip_tables LIMIT 1), 1, 'Test User', 'test@example.com', 'pending', 'TEST-001', 10000, 0)
  RETURNING id;
"

# Confirm valid transition pending -> confirmed works
npx supabase db execute --local "
  UPDATE vip_reservations SET status = 'confirmed' WHERE qr_code_token = 'TEST-001';
"

# Confirm invalid transition confirmed -> pending is rejected
npx supabase db execute --local "
  UPDATE vip_reservations SET status = 'pending' WHERE qr_code_token = 'TEST-001';
" 2>&1 | grep -q "Invalid VIP" && echo "PASS: Invalid transition rejected"

# Cleanup
npx supabase db execute --local "DELETE FROM vip_reservations WHERE qr_code_token = 'TEST-001';"
```
  </verify>
  <done>
Migration file exists with trigger function. Valid transitions succeed, invalid transitions (e.g., confirmed -> pending) raise exception with message "Invalid VIP status transition".
  </done>
</task>

<task type="auto">
  <name>Task 2: Add transition audit logging</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130000000_vip_state_transition_enforcement.sql</files>
  <action>
Extend the migration to log all status transitions for debugging and audit purposes.

1. Add optional logging to an existing audit mechanism OR add a simple log entry to the trigger that captures:
   - reservation_id
   - old_status
   - new_status
   - transition_at timestamp
   - transition_by (from current_setting if available)

2. Use RAISE NOTICE for logging (visible in Supabase logs) rather than a separate table

3. The logging should NOT block or slow down the transition

**Example RAISE NOTICE:**
```sql
RAISE NOTICE 'VIP status transition: reservation=%, from=% to=%, at=%',
  OLD.id, OLD.status, NEW.status, NOW();
```

This keeps the implementation simple while providing visibility into transitions.
  </action>
  <verify>
Migration includes RAISE NOTICE statement for transition logging. Re-run migration push and confirm no errors.
  </verify>
  <done>
Trigger logs transition details via RAISE NOTICE. Supabase logs will capture all VIP status changes for debugging.
  </done>
</task>

</tasks>

<verification>
1. Migration applies without errors to local Supabase
2. Forward transitions (pending -> confirmed -> checked_in) work
3. Backward transitions (checked_in -> confirmed) are rejected with clear error
4. Transition logging visible in Supabase logs
</verification>

<success_criteria>
- Database trigger exists on vip_reservations status column
- Invalid state transitions raise exception (tested via psql)
- Valid transitions complete successfully
- No breaking changes to existing VIP booking/check-in flows
</success_criteria>

<output>
After completion, create `.planning/phases/04-vip-system-reliability/04-01-SUMMARY.md`
</output>
