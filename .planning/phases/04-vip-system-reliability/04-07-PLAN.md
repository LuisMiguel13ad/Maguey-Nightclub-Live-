---
phase: 04-vip-system-reliability
plan: 07
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - maguey-pass-lounge/supabase/migrations/20260130400000_unified_vip_checkout.sql
  - maguey-pass-lounge/supabase/functions/create-vip-payment-intent/index.ts
  - maguey-pass-lounge/src/pages/VIPBookingForm.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "VIP purchaser must select a GA ticket tier during VIP table checkout"
    - "VIP checkout creates BOTH VIP reservation AND GA ticket in single atomic transaction"
    - "Purchaser receives ONE QR code that grants entry + identifies as VIP host"
    - "VIP reservation links to purchaser's GA ticket via purchaser_ticket_id column"
  artifacts:
    - path: "maguey-pass-lounge/supabase/migrations/20260130400000_unified_vip_checkout.sql"
      provides: "Schema changes for unified VIP+GA checkout"
      contains: "purchaser_ticket_id"
    - path: "maguey-pass-lounge/supabase/functions/create-vip-payment-intent/index.ts"
      provides: "Edge function that creates both VIP reservation and GA ticket"
      contains: "create_unified_vip_checkout"
  key_links:
    - from: "VIPBookingForm checkout"
      to: "create-vip-payment-intent edge function"
      via: "fetch call"
      pattern: "create-vip-payment-intent"
    - from: "create-vip-payment-intent"
      to: "create_unified_vip_checkout RPC"
      via: "supabase.rpc"
      pattern: "create_unified_vip_checkout"
---

<objective>
Implement unified VIP checkout where purchaser buys GA ticket + VIP table in one transaction.

Purpose: Per 04-CONTEXT.md, "VIP table purchaser MUST buy a GA ticket at time of VIP table purchase. This creates ONE unified QR code that: grants entry + marks table as 'arrived' + identifies them as VIP."

Output: VIP checkout flow that creates both tickets atomically, with single QR code serving both purposes.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vip-system-reliability/04-CONTEXT.md
@.planning/phases/04-vip-system-reliability/04-RESEARCH.md
@maguey-pass-lounge/supabase/functions/create-vip-payment-intent/index.ts
@maguey-pass-lounge/src/pages/VIPBookingForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add purchaser_ticket_id to vip_reservations schema</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130400000_unified_vip_checkout.sql</files>
  <action>
Create migration to link VIP reservations to their purchaser's GA ticket.

**Schema changes:**
```sql
-- Add purchaser_ticket_id column to link VIP reservation to purchaser's GA ticket
ALTER TABLE vip_reservations
ADD COLUMN IF NOT EXISTS purchaser_ticket_id UUID REFERENCES tickets(id);

-- Create index for lookups
CREATE INDEX IF NOT EXISTS idx_vip_reservations_purchaser_ticket
ON vip_reservations(purchaser_ticket_id);

-- Comment explaining the relationship
COMMENT ON COLUMN vip_reservations.purchaser_ticket_id IS
'Links to the GA ticket automatically created for VIP purchaser during unified checkout. This ticket QR serves as both entry pass and VIP identification.';
```

**Also create the atomic RPC for unified checkout:**
```sql
-- Atomic function to create VIP reservation + GA ticket together
CREATE OR REPLACE FUNCTION create_unified_vip_checkout(
  p_event_id UUID,
  p_event_vip_table_id UUID,
  p_table_number INT,
  p_purchaser_name TEXT,
  p_purchaser_email TEXT,
  p_amount_paid_cents INT,
  p_ticket_tier_id UUID,
  p_ticket_price_cents INT,
  p_stripe_payment_intent_id TEXT DEFAULT NULL
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_reservation_id UUID;
  v_ticket_id UUID;
  v_qr_token TEXT;
  v_vip_pass_token TEXT;
BEGIN
  -- Generate tokens
  v_qr_token := encode(gen_random_bytes(32), 'hex');
  v_vip_pass_token := encode(gen_random_bytes(32), 'hex');

  -- 1. Create GA ticket for purchaser
  INSERT INTO tickets (
    event_id,
    ticket_tier_id,
    holder_name,
    holder_email,
    qr_code_token,
    price_paid_cents,
    status,
    purchase_date
  ) VALUES (
    p_event_id,
    p_ticket_tier_id,
    p_purchaser_name,
    p_purchaser_email,
    v_qr_token,
    p_ticket_price_cents,
    'valid',
    NOW()
  )
  RETURNING id INTO v_ticket_id;

  -- 2. Create VIP reservation linked to GA ticket
  INSERT INTO vip_reservations (
    event_id,
    event_vip_table_id,
    table_number,
    purchaser_name,
    purchaser_email,
    qr_code_token,
    amount_paid_cents,
    status,
    purchaser_ticket_id,
    stripe_payment_intent_id
  ) VALUES (
    p_event_id,
    p_event_vip_table_id,
    p_table_number,
    p_purchaser_name,
    p_purchaser_email,
    v_vip_pass_token,
    p_amount_paid_cents,
    'pending',  -- Will become 'confirmed' after payment webhook
    v_ticket_id,
    p_stripe_payment_intent_id
  )
  RETURNING id INTO v_reservation_id;

  -- 3. Mark table as reserved
  UPDATE event_vip_tables
  SET status = 'reserved', updated_at = NOW()
  WHERE id = p_event_vip_table_id;

  RETURN json_build_object(
    'success', TRUE,
    'reservation_id', v_reservation_id,
    'ticket_id', v_ticket_id,
    'qr_token', v_qr_token,  -- This is the unified QR code token
    'vip_pass_token', v_vip_pass_token
  );

EXCEPTION WHEN OTHERS THEN
  RETURN json_build_object(
    'success', FALSE,
    'error', SQLERRM
  );
END;
$$;

GRANT EXECUTE ON FUNCTION create_unified_vip_checkout TO authenticated, service_role;
```

The key insight: The purchaser's GA ticket QR code (`v_qr_token`) becomes the "unified QR" that the scanner will check for both entry AND VIP status.
  </action>
  <verify>
```bash
# Check migration file exists
test -f maguey-pass-lounge/supabase/migrations/20260130400000_unified_vip_checkout.sql && echo "Migration exists"

# Apply migration
cd maguey-pass-lounge && npx supabase db push --local

# Verify column added
npx supabase db execute --local "SELECT column_name FROM information_schema.columns WHERE table_name = 'vip_reservations' AND column_name = 'purchaser_ticket_id';"

# Verify function exists
npx supabase db execute --local "SELECT proname FROM pg_proc WHERE proname = 'create_unified_vip_checkout';"
```
  </verify>
  <done>
Migration applied. vip_reservations has purchaser_ticket_id column. create_unified_vip_checkout RPC function exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VIP payment intent edge function</name>
  <files>maguey-pass-lounge/supabase/functions/create-vip-payment-intent/index.ts</files>
  <action>
Modify the VIP payment intent edge function to:
1. Accept ticket_tier_id and ticket_price as additional parameters
2. Call create_unified_vip_checkout instead of creating only VIP reservation
3. Include total amount (VIP table + GA ticket) in Stripe payment intent

**Update request body parsing to include:**
```typescript
const {
  eventId,
  tableId,
  tableNumber,
  purchaserName,
  purchaserEmail,
  amountCents,
  // NEW: GA ticket info
  ticketTierId,
  ticketPriceCents,
} = await req.json();

// Validate ticket tier is provided
if (!ticketTierId || !ticketPriceCents) {
  return new Response(
    JSON.stringify({ error: 'GA ticket tier required for VIP purchase' }),
    { status: 400, headers: corsHeaders }
  );
}

// Total amount = VIP table + GA ticket
const totalAmountCents = amountCents + ticketPriceCents;
```

**Update Stripe payment intent creation:**
```typescript
const paymentIntent = await stripe.paymentIntents.create({
  amount: totalAmountCents,  // Combined VIP + GA price
  currency: 'usd',
  metadata: {
    type: 'vip_unified',  // Mark as unified checkout
    event_id: eventId,
    table_id: tableId,
    table_number: tableNumber.toString(),
    vip_amount_cents: amountCents.toString(),
    ticket_tier_id: ticketTierId,
    ticket_price_cents: ticketPriceCents.toString(),
    purchaser_name: purchaserName,
    purchaser_email: purchaserEmail,
  },
  // ... rest of config
});
```

**After payment intent creation, call unified checkout RPC:**
```typescript
const { data: checkoutResult, error: checkoutError } = await supabase.rpc(
  'create_unified_vip_checkout',
  {
    p_event_id: eventId,
    p_event_vip_table_id: tableId,
    p_table_number: tableNumber,
    p_purchaser_name: purchaserName,
    p_purchaser_email: purchaserEmail,
    p_amount_paid_cents: amountCents,
    p_ticket_tier_id: ticketTierId,
    p_ticket_price_cents: ticketPriceCents,
    p_stripe_payment_intent_id: paymentIntent.id,
  }
);

if (checkoutError || !checkoutResult.success) {
  // Cancel payment intent if checkout fails
  await stripe.paymentIntents.cancel(paymentIntent.id);
  return new Response(
    JSON.stringify({ error: checkoutResult?.error || 'Checkout failed' }),
    { status: 500, headers: corsHeaders }
  );
}
```

**Return the unified QR token:**
```typescript
return new Response(
  JSON.stringify({
    clientSecret: paymentIntent.client_secret,
    paymentIntentId: paymentIntent.id,
    reservationId: checkoutResult.reservation_id,
    ticketId: checkoutResult.ticket_id,
    qrToken: checkoutResult.qr_token,  // Unified QR code
    totalAmount: totalAmountCents,
  }),
  { status: 200, headers: corsHeaders }
);
```
  </action>
  <verify>
```bash
# Check edge function compiles
cd maguey-pass-lounge && npx supabase functions serve create-vip-payment-intent --no-verify-jwt &
sleep 3
kill %1

# Verify unified checkout params in function
grep -n "ticketTierId\|create_unified_vip_checkout\|vip_unified" supabase/functions/create-vip-payment-intent/index.ts
```
  </verify>
  <done>
Edge function accepts ticket tier, calculates combined total, calls create_unified_vip_checkout, returns unified QR token.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update VIPBookingForm to require GA ticket selection</name>
  <files>maguey-pass-lounge/src/pages/VIPBookingForm.tsx</files>
  <action>
Modify VIPBookingForm to require GA ticket tier selection during VIP checkout.

**Add ticket tier state:**
```typescript
const [selectedTicketTier, setSelectedTicketTier] = useState<TicketTier | null>(null);
const [ticketTiers, setTicketTiers] = useState<TicketTier[]>([]);

// Fetch ticket tiers for the event
useEffect(() => {
  const fetchTicketTiers = async () => {
    const { data } = await supabase
      .from('ticket_tiers')
      .select('*')
      .eq('event_id', eventId)
      .eq('status', 'active')
      .order('price', { ascending: true });
    if (data) setTicketTiers(data);
  };
  fetchTicketTiers();
}, [eventId]);
```

**Add ticket tier selection UI (before payment):**
```tsx
<div className="space-y-4">
  <h3 className="font-semibold">Select Your Entry Ticket</h3>
  <p className="text-sm text-muted-foreground">
    VIP tables include one entry ticket for the purchaser
  </p>
  <div className="grid gap-3">
    {ticketTiers.map((tier) => (
      <label
        key={tier.id}
        className={cn(
          "flex items-center justify-between p-4 border rounded-lg cursor-pointer",
          selectedTicketTier?.id === tier.id && "border-primary bg-primary/5"
        )}
      >
        <div className="flex items-center gap-3">
          <input
            type="radio"
            name="ticketTier"
            value={tier.id}
            checked={selectedTicketTier?.id === tier.id}
            onChange={() => setSelectedTicketTier(tier)}
            className="sr-only"
          />
          <div>
            <div className="font-medium">{tier.name}</div>
            <div className="text-sm text-muted-foreground">{tier.description}</div>
          </div>
        </div>
        <div className="font-semibold">${(tier.price / 100).toFixed(2)}</div>
      </label>
    ))}
  </div>
</div>
```

**Update total calculation display:**
```tsx
const tablePrice = selectedTable?.price || 0;
const ticketPrice = selectedTicketTier?.price || 0;
const totalPrice = tablePrice + ticketPrice;

// In the summary section:
<div className="space-y-2">
  <div className="flex justify-between">
    <span>VIP Table ({selectedTable?.tier})</span>
    <span>${(tablePrice / 100).toFixed(2)}</span>
  </div>
  <div className="flex justify-between">
    <span>Entry Ticket ({selectedTicketTier?.name})</span>
    <span>${(ticketPrice / 100).toFixed(2)}</span>
  </div>
  <div className="flex justify-between font-bold border-t pt-2">
    <span>Total</span>
    <span>${(totalPrice / 100).toFixed(2)}</span>
  </div>
</div>
```

**Update checkout handler to include ticket info:**
```typescript
const handleCheckout = async () => {
  if (!selectedTicketTier) {
    toast.error('Please select an entry ticket');
    return;
  }

  const response = await fetch(
    `${SUPABASE_URL}/functions/v1/create-vip-payment-intent`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${session.access_token}` },
      body: JSON.stringify({
        eventId,
        tableId: selectedTable.id,
        tableNumber: selectedTable.table_number,
        purchaserName: formData.name,
        purchaserEmail: formData.email,
        amountCents: tablePrice,
        ticketTierId: selectedTicketTier.id,
        ticketPriceCents: ticketPrice,
      }),
    }
  );
  // ... handle response
};
```

**Disable checkout button until ticket selected:**
```tsx
<Button
  onClick={handleCheckout}
  disabled={!selectedTable || !selectedTicketTier || isLoading}
>
  {isLoading ? 'Processing...' : `Pay $${(totalPrice / 100).toFixed(2)}`}
</Button>
```
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx tsc --noEmit

# Verify ticket tier selection in form
grep -n "selectedTicketTier\|ticketTierId\|Entry Ticket" src/pages/VIPBookingForm.tsx
```
  </verify>
  <done>
VIPBookingForm requires GA ticket selection. Total shows VIP table + GA ticket price. Checkout sends ticket tier to edge function.
  </done>
</task>

</tasks>

<verification>
1. VIP checkout requires selecting a GA ticket tier
2. Total price = VIP table price + GA ticket price
3. Single payment intent created for combined amount
4. Both VIP reservation and GA ticket created atomically
5. VIP reservation links to purchaser's GA ticket
6. Purchaser receives unified QR code (GA ticket QR)
</verification>

<success_criteria>
- Cannot complete VIP checkout without selecting GA ticket tier
- Payment amount includes both VIP table and GA ticket
- vip_reservations.purchaser_ticket_id populated after checkout
- Unified QR code (from GA ticket) used for entry and VIP identification
- No separate VIP-only QR code needed
</success_criteria>

<output>
After completion, create `.planning/phases/04-vip-system-reliability/04-07-SUMMARY.md`
</output>
