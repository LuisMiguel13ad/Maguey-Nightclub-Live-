---
phase: 04-vip-system-reliability
plan: 06
type: execute
wave: 3
depends_on: ["04-02", "04-05"]
files_modified:
  - maguey-gate-scanner/src/lib/simple-scanner.ts
  - maguey-gate-scanner/src/components/QrScanner.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GA ticket linked to VIP gets re-entry privilege (multiple scans allowed)"
    - "Regular GA ticket is one-time entry only"
    - "Scanner detects VIP-linked tickets and applies VIP re-entry policy"
    - "Linked ticket scan updates VIP reservation checked_in_guests count"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      provides: "GA scanner with VIP link detection"
      contains: "check_vip_linked_ticket_reentry"
  key_links:
    - from: "simple-scanner.ts processTicketScan"
      to: "check_vip_linked_ticket_reentry RPC"
      via: "supabase.rpc call"
      pattern: "check_vip_linked_ticket_reentry"
---

<objective>
Integrate VIP re-entry detection into the main GA ticket scanner so linked tickets get VIP treatment.

Purpose: Per 04-CONTEXT.md, linked VIP guests should be able to re-enter just like VIP hosts. The main QR scanner needs to detect if a GA ticket is linked to a VIP table and apply the re-entry policy accordingly.

Output: GA scanner that checks VIP linking and allows re-entry for linked tickets.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vip-system-reliability/04-CONTEXT.md
@.planning/phases/04-vip-system-reliability/04-RESEARCH.md
@.planning/phases/04-vip-system-reliability/04-02-PLAN.md
@maguey-gate-scanner/src/lib/simple-scanner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VIP link check to simple-scanner</name>
  <files>maguey-gate-scanner/src/lib/simple-scanner.ts</files>
  <action>
Modify simple-scanner.ts to check if a scanned GA ticket is linked to a VIP reservation.

**Add helper function:**
```typescript
interface VipLinkCheckResult {
  is_vip_linked: boolean;
  allow_reentry: boolean;
  vip_reservation_id?: string;
  table_name?: string;
}

async function checkVipLinkedTicket(ticketId: string): Promise<VipLinkCheckResult | null> {
  try {
    const { data, error } = await supabase.rpc('check_vip_linked_ticket_reentry', {
      p_ticket_id: ticketId
    });

    if (error) {
      console.error('[scanner] VIP link check error:', error);
      return null;
    }

    return data as VipLinkCheckResult;
  } catch (err) {
    console.error('[scanner] VIP link check failed:', err);
    return null;
  }
}
```

**In the main scan processing function, after fetching the ticket:**

1. Check if ticket is VIP-linked:
```typescript
const vipLinkResult = await checkVipLinkedTicket(ticket.id);
const isVipLinked = vipLinkResult?.is_vip_linked ?? false;
```

2. Modify the "already scanned" logic:
```typescript
// Current behavior: reject already-scanned tickets
if (ticket.status === 'scanned') {
  // NEW: Check if VIP-linked (re-entry allowed)
  if (isVipLinked && vipLinkResult.allow_reentry) {
    // Allow re-entry for VIP-linked tickets
    return {
      status: 'reentry',
      ticket,
      message: `Re-entry granted - ${vipLinkResult.table_name || 'VIP Guest'}`,
      vipInfo: {
        tableName: vipLinkResult.table_name,
        reservationId: vipLinkResult.vip_reservation_id,
      }
    };
  }

  // Regular GA: reject
  return {
    status: 'already_scanned',
    ticket,
    message: 'Ticket already used',
  };
}
```

3. On successful first scan, if VIP-linked, update the VIP reservation's checked_in_guests:
```typescript
if (isVipLinked && vipLinkResult.vip_reservation_id) {
  // Update VIP reservation checked_in_guests count
  const { error: vipUpdateError } = await supabase.rpc('increment_vip_checked_in', {
    p_reservation_id: vipLinkResult.vip_reservation_id
  });

  if (vipUpdateError) {
    console.warn('[scanner] Failed to update VIP checked_in_guests:', vipUpdateError);
    // Don't fail the scan - just log the warning
  }
}
```

**Note:** We may need to create the `increment_vip_checked_in` RPC function in 04-02 migration or create it here. If not in 04-02, add to this plan's action.
  </action>
  <verify>
```bash
cd maguey-gate-scanner && npx tsc --noEmit

# Check VIP link check is added
grep -n "checkVipLinkedTicket\|check_vip_linked_ticket_reentry" src/lib/simple-scanner.ts
```
  </verify>
  <done>
simple-scanner.ts checks VIP linking for all GA tickets. VIP-linked tickets get re-entry allowed, regular GA is one-time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add increment_vip_checked_in RPC if needed</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130100000_vip_reentry_support.sql</files>
  <action>
If not already in the 04-02 migration, add an RPC function to increment checked_in_guests for a VIP reservation.

**Check if already exists:**
```bash
grep "increment_vip_checked_in" maguey-pass-lounge/supabase/migrations/20260130100000_vip_reentry_support.sql
```

**If not present, add to the migration:**
```sql
-- Increment checked_in_guests for VIP reservation when linked ticket scans
CREATE OR REPLACE FUNCTION increment_vip_checked_in(p_reservation_id UUID)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_reservation RECORD;
BEGIN
  -- Lock and update
  SELECT * INTO v_reservation
  FROM vip_reservations
  WHERE id = p_reservation_id
  FOR UPDATE;

  IF NOT FOUND THEN
    RETURN json_build_object('success', FALSE, 'error', 'RESERVATION_NOT_FOUND');
  END IF;

  UPDATE vip_reservations
  SET
    checked_in_guests = checked_in_guests + 1,
    status = CASE WHEN status = 'confirmed' THEN 'checked_in' ELSE status END,
    checked_in_at = COALESCE(checked_in_at, NOW()),
    updated_at = NOW()
  WHERE id = p_reservation_id;

  RETURN json_build_object(
    'success', TRUE,
    'checked_in_guests', v_reservation.checked_in_guests + 1
  );
END;
$$;

GRANT EXECUTE ON FUNCTION increment_vip_checked_in TO authenticated, service_role;
```

This ensures that when a linked GA ticket is scanned, the parent VIP reservation's guest count updates properly.
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx supabase db push --local

# Verify function exists
npx supabase db execute --local "SELECT proname FROM pg_proc WHERE proname = 'increment_vip_checked_in';"
```
  </verify>
  <done>
increment_vip_checked_in RPC function exists for updating VIP reservation when linked ticket scans.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update scan result display for VIP-linked GA tickets</name>
  <files>maguey-gate-scanner/src/components/QrScanner.tsx</files>
  <action>
Update the main QrScanner or its result display to show VIP info when a linked ticket is scanned.

**If QrScanner passes results to a separate component, update that component.**

**Add to scan result type:**
```typescript
interface ScanResult {
  status: 'valid' | 'invalid' | 'already_scanned' | 'reentry';  // Add reentry
  ticket?: Ticket;
  message: string;
  vipInfo?: {
    tableName?: string;
    reservationId?: string;
  };
}
```

**Display logic for VIP-linked re-entry:**
When status is 'reentry' and vipInfo exists:
- Show green success overlay (same as valid)
- Display "RE-ENTRY - VIP GUEST"
- Show table name if available
- Play success sound

**Example display:**
```tsx
{result.status === 'reentry' && result.vipInfo && (
  <div className="text-center">
    <div className="text-lg font-bold">RE-ENTRY GRANTED</div>
    <div className="text-sm">VIP Guest - {result.vipInfo.tableName}</div>
  </div>
)}
```

This ensures VIP-linked GA tickets get the VIP treatment at the gate.
  </action>
  <verify>
```bash
cd maguey-gate-scanner && npx tsc --noEmit

# Check reentry handling in scanner display
grep -rn "reentry\|vipInfo" src/components/ | head -20
```
  </verify>
  <done>
QrScanner and result display handle VIP-linked re-entry with appropriate UI showing VIP guest status.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. GA ticket linked to VIP allows re-entry
3. Regular GA ticket rejected on second scan with "already used"
4. VIP-linked re-entry shows success with VIP table info
5. VIP reservation checked_in_guests updates when linked ticket scans
</verification>

<success_criteria>
- GA scanner checks VIP linking via check_vip_linked_ticket_reentry RPC
- Linked tickets get re-entry privilege (pass on second scan)
- Regular GA tickets are one-time only (rejected on second scan)
- VIP reservation guest count updates on linked ticket scan
- Scanner UI shows VIP guest status for linked tickets
</success_criteria>

<output>
After completion, create `.planning/phases/04-vip-system-reliability/04-06-SUMMARY.md`
</output>
