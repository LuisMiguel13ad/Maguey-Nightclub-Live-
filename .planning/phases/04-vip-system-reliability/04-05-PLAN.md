---
phase: 04-vip-system-reliability
plan: 05
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - maguey-gate-scanner/src/components/vip/VIPScanner.tsx
  - maguey-gate-scanner/src/components/VipTableGuestResult.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "VIP host sees full details on scan (table name, tier, guest count)"
    - "VIP re-entry shows 'Re-entry Granted' with last entry time"
    - "Linked guests see 'Guest of Table X' on scan"
    - "Scanner displays VIP treatment overlay (distinct from GA)"
  artifacts:
    - path: "maguey-gate-scanner/src/components/vip/VIPScanner.tsx"
      provides: "Updated scanner using re-entry function"
      contains: "processVipScanWithReentry"
    - path: "maguey-gate-scanner/src/components/VipTableGuestResult.tsx"
      provides: "Enhanced VIP result display"
      contains: "reentry"
  key_links:
    - from: "VIPScanner.tsx handleQRCode"
      to: "processVipScanWithReentry"
      via: "function call"
      pattern: "processVipScanWithReentry"
---

<objective>
Update VIP scanner to use the new re-entry function and show enhanced VIP details including re-entry status.

Purpose: Connect the new re-entry RPC function (04-02) to the scanner UI, showing VIP-specific treatment with full details for hosts and "Guest of Table X" for linked guests.

Output: VIPScanner using processVipScanWithReentry with enhanced result display.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vip-system-reliability/04-CONTEXT.md
@.planning/phases/04-vip-system-reliability/04-RESEARCH.md
@.planning/phases/04-vip-system-reliability/04-02-PLAN.md
@maguey-gate-scanner/src/components/vip/VIPScanner.tsx
@maguey-gate-scanner/src/components/VipTableGuestResult.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update VIPScanner to use re-entry function</name>
  <files>maguey-gate-scanner/src/components/vip/VIPScanner.tsx</files>
  <action>
Modify VIPScanner.tsx to use processVipScanWithReentry instead of checkInGuestPass.

**Import the new function:**
```typescript
import {
  getGuestPassByQrToken,
  processVipScanWithReentry,  // Add this
  verifyPassSignature
} from '@/lib/vip-tables-admin-service';
```

**Update scanResult state type to include re-entry:**
```typescript
const [scanResult, setScanResult] = useState<{
  status: 'valid' | 'used' | 'invalid' | 'reentry';  // Add 'reentry'
  entryType?: 'first_entry' | 'reentry';
  pass?: any;
  reservation?: any;
  message: string;
  lastEntryTime?: string;  // Add for re-entry display
} | null>(null);
```

**In handleQRCode, after getting pass and reservation, replace the check-in logic:**

Current (around line 279):
```typescript
// Check in the guest using atomic function
await checkInGuestPass(pass.id, user?.id || 'system');
```

Replace with:
```typescript
// Process scan with re-entry support
const scanResult = await processVipScanWithReentry(pass.id, user?.id || 'system');

if (!scanResult.success) {
  setScanResult({
    status: 'invalid',
    pass,
    reservation,
    message: scanResult.message || 'Failed to process VIP pass',
  });
  playError();
  return;
}

// Handle based on entry type
if (scanResult.entryType === 'reentry') {
  setScanResult({
    status: 'reentry',
    entryType: 'reentry',
    pass: { ...pass, status: 'checked_in' },
    reservation,
    message: 'Re-entry granted!',
    lastEntryTime: scanResult.lastEntryTime,
  });
  playSuccess();
  toast({
    title: 'VIP Re-entry',
    description: `Guest ${pass.guest_number} re-entered - ${tableName}`,
  });
} else {
  // First entry
  setScanResult({
    status: 'valid',
    entryType: 'first_entry',
    pass: { ...pass, status: 'checked_in' },
    reservation: {
      ...reservation,
      checked_in_guests: scanResult.checkedInGuests || (reservation.checked_in_guests || 0) + 1,
    },
    message: `Guest ${pass.guest_number} of ${totalGuests} checked in successfully!`,
  });
  playSuccess();
  toast({
    title: 'VIP Guest Checked In',
    description: `Guest ${pass.guest_number} checked in for ${tableName}`,
  });
}
```

**Remove the old "already checked in" handling since re-entry is now allowed:**
The code that sets `status: 'used'` when `pass.status === 'checked_in'` should be removed - we now handle this in processVipScanWithReentry.
  </action>
  <verify>
```bash
cd maguey-gate-scanner && npx tsc --noEmit

# Check function is imported
grep -n "processVipScanWithReentry" src/components/vip/VIPScanner.tsx
```
  </verify>
  <done>
VIPScanner uses processVipScanWithReentry. Handles both first_entry and reentry cases. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VipTableGuestResult for re-entry display</name>
  <files>maguey-gate-scanner/src/components/VipTableGuestResult.tsx</files>
  <action>
Enhance VipTableGuestResult.tsx to show different UI for re-entry vs first entry.

**Update the component props interface:**
```typescript
interface VipTableGuestResultProps {
  result: {
    status: 'valid' | 'used' | 'invalid' | 'reentry';
    entryType?: 'first_entry' | 'reentry';
    pass?: VipGuestPass;
    reservation?: VipReservation;
    message: string;
    lastEntryTime?: string;
  };
  onReset: () => void;
}
```

**Add re-entry display section:**

When `result.status === 'reentry'`:
- Show green/gold background (similar to valid but with re-entry indicator)
- Display "RE-ENTRY GRANTED" prominently
- Show last entry time formatted
- Show table info and guest details
- Use a different icon (RefreshCw from lucide-react for re-entry)

**Example re-entry UI:**
```tsx
{result.status === 'reentry' && (
  <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white">
    <div className="flex items-center justify-center gap-3 mb-4">
      <RefreshCw className="w-12 h-12" />
      <div className="text-center">
        <div className="text-2xl font-bold">RE-ENTRY GRANTED</div>
        <div className="text-sm opacity-90">VIP Guest</div>
      </div>
    </div>

    {result.lastEntryTime && (
      <div className="text-center mb-4 bg-white/20 rounded-lg p-2">
        <div className="text-xs opacity-75">Last Entry</div>
        <div className="font-semibold">
          {new Date(result.lastEntryTime).toLocaleTimeString()}
        </div>
      </div>
    )}

    {/* Table and guest info */}
    <div className="space-y-2">
      <div className="flex justify-between">
        <span>Table</span>
        <span className="font-bold">{result.reservation?.event_vip_table?.table_name}</span>
      </div>
      <div className="flex justify-between">
        <span>Guest</span>
        <span className="font-bold">#{result.pass?.guest_number}</span>
      </div>
    </div>
  </div>
)}
```

**Also differentiate linked guest display:**
When `pass.guest_number === 0` (linked ticket), show "Guest of Table X" instead of guest number.

**Import RefreshCw:**
```typescript
import { RefreshCw } from 'lucide-react';
```
  </action>
  <verify>
```bash
cd maguey-gate-scanner && npx tsc --noEmit

# Check re-entry handling
grep -n "reentry" src/components/VipTableGuestResult.tsx
```
  </verify>
  <done>
VipTableGuestResult shows distinct UI for re-entry with last entry time and "RE-ENTRY GRANTED" message.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add linked guest "Guest of Table X" display</name>
  <files>maguey-gate-scanner/src/components/VipTableGuestResult.tsx</files>
  <action>
Enhance display for linked GA tickets that are VIP guests.

**Detect linked guest:**
A linked guest has `pass.guest_number === 0` (mock pass from getGuestPassByQrToken fallback).

**Display logic:**
```typescript
const isLinkedGuest = result.pass?.guest_number === 0;
const guestDisplayText = isLinkedGuest
  ? `Guest of ${result.reservation?.event_vip_table?.table_name || 'VIP Table'}`
  : `Guest #${result.pass?.guest_number}`;
```

**For linked guests, show:**
- "VIP LINKED GUEST" as subtitle
- "Guest of Table X" instead of guest number
- Table name prominently
- Guest name if available (from pass.guest_name)

**Example:**
```tsx
{isLinkedGuest && (
  <div className="bg-white/10 rounded-lg p-3 text-center">
    <div className="text-lg font-bold">
      Guest of {result.reservation?.event_vip_table?.table_name}
    </div>
    {result.pass?.guest_name && (
      <div className="text-sm opacity-75">{result.pass.guest_name}</div>
    )}
  </div>
)}
```

This makes the scanner experience smooth for linked guests who purchased GA tickets through a VIP invite link.
  </action>
  <verify>
```bash
cd maguey-gate-scanner && npx tsc --noEmit

# Check linked guest handling
grep -n "guest_number === 0" src/components/VipTableGuestResult.tsx || grep -n "isLinkedGuest" src/components/VipTableGuestResult.tsx
```
  </verify>
  <done>
Linked guests display "Guest of Table X" instead of guest number. VIP host and linked guest have appropriate distinct displays.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. VIPScanner uses processVipScanWithReentry
3. First scan shows "Guest X checked in successfully"
4. Second scan shows "RE-ENTRY GRANTED" with last entry time
5. Linked guest scan shows "Guest of Table X"
6. All scan types play success sound
</verification>

<success_criteria>
- VIP re-entry displays correctly with last entry time
- First entry and re-entry have visually distinct but both positive UI
- Linked guests show "Guest of Table X" appropriately
- Scanner flows for all VIP types work without errors
- Audio feedback plays correctly for all entry types
</success_criteria>

<output>
After completion, create `.planning/phases/04-vip-system-reliability/04-05-SUMMARY.md`
</output>
