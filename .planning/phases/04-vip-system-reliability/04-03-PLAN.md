---
phase: 04-vip-system-reliability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/src/components/vip/VIPTableFloorPlan.tsx
  - maguey-pass-lounge/src/lib/vip-tables-service.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Floor plan updates automatically when reservation status changes"
    - "No page refresh needed to see table availability changes"
    - "Floor plan shows correct availability after VIP check-in"
    - "Cancellation immediately reflects in floor plan"
  artifacts:
    - path: "maguey-pass-lounge/src/components/vip/VIPTableFloorPlan.tsx"
      provides: "Realtime subscription for floor plan"
      contains: "supabase.channel"
    - path: "maguey-pass-lounge/src/lib/vip-tables-service.ts"
      provides: "Hook for realtime floor plan data"
      exports: ["useRealtimeFloorPlan"]
  key_links:
    - from: "VIPTableFloorPlan.tsx"
      to: "supabase.channel"
      via: "useEffect subscription"
      pattern: "postgres_changes.*vip_reservations"
---

<objective>
Add Supabase Realtime subscriptions to the VIP floor plan so it updates automatically when reservations change.

Purpose: Per VIP-04 requirement, floor plan should reflect real-time availability. Currently the floor plan only fetches on mount, requiring manual refresh to see changes. This causes staff confusion when tables are booked or checked-in.

Output: Floor plan component with realtime subscription that updates on reservation changes.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vip-system-reliability/04-CONTEXT.md
@.planning/phases/04-vip-system-reliability/04-RESEARCH.md
@maguey-pass-lounge/src/components/vip/VIPTableFloorPlan.tsx
@maguey-pass-lounge/src/lib/vip-tables-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useRealtimeFloorPlan hook</name>
  <files>maguey-pass-lounge/src/lib/vip-tables-service.ts</files>
  <action>
Add a custom React hook `useRealtimeFloorPlan` to vip-tables-service.ts that:
1. Fetches initial table data
2. Subscribes to vip_reservations changes for the event
3. Refetches data when changes occur
4. Cleans up subscription on unmount

**Hook signature:**
```typescript
export function useRealtimeFloorPlan(eventId: string): {
  tables: VipTableWithAvailability[];
  isLoading: boolean;
  error: Error | null;
  refetch: () => Promise<void>;
}
```

**Implementation:**
```typescript
import { useEffect, useState, useCallback } from 'react';

export function useRealtimeFloorPlan(eventId: string) {
  const [tables, setTables] = useState<VipTableWithAvailability[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  const fetchTables = useCallback(async () => {
    try {
      const data = await getAvailableTablesForEvent(eventId);
      setTables(data);
      setError(null);
    } catch (err) {
      setError(err instanceof Error ? err : new Error('Failed to fetch tables'));
    } finally {
      setIsLoading(false);
    }
  }, [eventId]);

  useEffect(() => {
    if (!eventId) return;

    // Initial fetch
    fetchTables();

    // Subscribe to realtime changes
    const channel = supabase
      .channel(`floor-plan-${eventId}`)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'vip_reservations',
        filter: `event_id=eq.${eventId}`
      }, (payload) => {
        console.log('[floor-plan] Reservation changed:', payload.eventType);
        fetchTables();
      })
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'event_vip_tables',
        filter: `event_id=eq.${eventId}`
      }, (payload) => {
        console.log('[floor-plan] Table updated:', payload.eventType);
        fetchTables();
      })
      .subscribe((status) => {
        console.log('[floor-plan] Subscription status:', status);
      });

    return () => {
      supabase.removeChannel(channel);
    };
  }, [eventId, fetchTables]);

  return { tables, isLoading, error, refetch: fetchTables };
}
```

**Ensure imports are at top of file:**
- Import useEffect, useState, useCallback from 'react'
- supabase client is already imported

**Note:** The getAvailableTablesForEvent function already exists in this file.
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx tsc --noEmit

# Verify export
grep -n "useRealtimeFloorPlan" src/lib/vip-tables-service.ts
```
  </verify>
  <done>
Hook useRealtimeFloorPlan exported from vip-tables-service.ts. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VIPTableFloorPlan to use realtime hook</name>
  <files>maguey-pass-lounge/src/components/vip/VIPTableFloorPlan.tsx</files>
  <action>
Modify VIPTableFloorPlan.tsx to use the new useRealtimeFloorPlan hook instead of receiving tables as props.

**Current interface:**
```typescript
interface VIPTableFloorPlanProps {
  tables: VipTableWithAvailability[];
  selectedTableId?: string;
  onSelectTable: (table: VipTableWithAvailability) => void;
  eventId: string;
  eventName: string;
}
```

**Updated interface:**
```typescript
interface VIPTableFloorPlanProps {
  eventId: string;
  eventName: string;
  selectedTableId?: string;
  onSelectTable: (table: VipTableWithAvailability) => void;
  // tables prop removed - now fetched internally with realtime
}
```

**Changes:**
1. Remove `tables` from props
2. Import and use `useRealtimeFloorPlan(eventId)` at component start
3. Add loading state UI (spinner or skeleton)
4. Add error state UI
5. Add visual indicator that data is live (small green dot or "Live" badge)

**Loading state:**
```tsx
if (isLoading) {
  return (
    <div className="flex items-center justify-center h-64">
      <Loader2 className="w-8 h-8 animate-spin text-primary" />
      <span className="ml-2">Loading floor plan...</span>
    </div>
  );
}
```

**Add "Live" indicator near title:**
```tsx
<div className="flex items-center gap-2">
  <span className="relative flex h-2 w-2">
    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
    <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
  </span>
  <span className="text-xs text-muted-foreground">Live</span>
</div>
```

**Import Loader2 from lucide-react.**
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx tsc --noEmit

# Check component compiles and uses hook
grep -n "useRealtimeFloorPlan" src/components/vip/VIPTableFloorPlan.tsx
```
  </verify>
  <done>
VIPTableFloorPlan uses useRealtimeFloorPlan hook. Shows loading state, error state, and "Live" indicator. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update parent components to remove tables prop</name>
  <files>maguey-pass-lounge/src/pages/VIPTablesPage.tsx</files>
  <action>
Update any parent components that pass `tables` prop to VIPTableFloorPlan.

Search for usages:
```bash
grep -rn "VIPTableFloorPlan" src/
```

For each usage:
1. Remove the `tables` prop (component now fetches internally)
2. Keep eventId, eventName, selectedTableId, onSelectTable props
3. Remove any local state/effects that were fetching tables for the floor plan (if the floor plan was the only consumer)

**Example change:**
```tsx
// Before
<VIPTableFloorPlan
  tables={tables}
  eventId={eventId}
  eventName={eventName}
  selectedTableId={selectedTableId}
  onSelectTable={handleSelectTable}
/>

// After
<VIPTableFloorPlan
  eventId={eventId}
  eventName={eventName}
  selectedTableId={selectedTableId}
  onSelectTable={handleSelectTable}
/>
```

**Note:** If parent still needs tables for other purposes (like a count or selector outside floor plan), keep that fetch logic separate. Only remove tables prop passed to VIPTableFloorPlan.
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx tsc --noEmit

# Ensure no TypeScript errors about missing tables prop
npm run build 2>&1 | grep -i "error" || echo "Build succeeded"
```
  </verify>
  <done>
Parent components updated to not pass tables prop. Application builds without TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Floor plan loads with loading spinner initially
3. Floor plan shows "Live" indicator
4. When a reservation is created (via another browser), floor plan updates automatically
5. When a reservation is cancelled, floor plan updates automatically
6. Console shows "[floor-plan] Reservation changed" on updates
</verification>

<success_criteria>
- VIPTableFloorPlan fetches its own data via useRealtimeFloorPlan hook
- Supabase Realtime subscription active for vip_reservations and event_vip_tables
- Floor plan updates within 1-2 seconds of reservation changes
- No manual refresh needed to see availability changes
- Visual "Live" indicator shows realtime is active
</success_criteria>

<output>
After completion, create `.planning/phases/04-vip-system-reliability/04-03-SUMMARY.md`
</output>
