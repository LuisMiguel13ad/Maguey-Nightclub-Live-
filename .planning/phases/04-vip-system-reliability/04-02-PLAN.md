---
phase: 04-vip-system-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/migrations/20260130100000_vip_reentry_support.sql
  - maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "VIP host can re-enter venue after first check-in (scan allowed multiple times)"
    - "Linked VIP guests can re-enter venue (same policy as host)"
    - "Re-entry displays 'Re-entry granted' with last entry time"
    - "Scanner logs all entry attempts including re-entries"
  artifacts:
    - path: "maguey-pass-lounge/supabase/migrations/20260130100000_vip_reentry_support.sql"
      provides: "RPC function for VIP scan with re-entry"
      exports: ["process_vip_scan_with_reentry"]
    - path: "maguey-gate-scanner/src/lib/vip-tables-admin-service.ts"
      provides: "TypeScript wrapper for re-entry scan"
      exports: ["processVipScanWithReentry"]
  key_links:
    - from: "VIPScanner.tsx"
      to: "processVipScanWithReentry"
      via: "function call on QR scan"
      pattern: "processVipScanWithReentry"
---

<objective>
Enable VIP re-entry by creating a new scan function that allows multiple entries for VIP hosts and linked guests.

Purpose: Per 04-CONTEXT.md, re-entry is a VIP perk. Currently the check_in_vip_guest_atomic function returns an error when a pass is already checked in. We need a separate function that handles re-entry gracefully while still tracking all entries.

Output: Database RPC function and TypeScript service function for VIP scans with re-entry support.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vip-system-reliability/04-CONTEXT.md
@.planning/phases/04-vip-system-reliability/04-RESEARCH.md
@maguey-pass-lounge/supabase/migrations/20260122000000_fix_vip_race_condition_and_rls.sql
@maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VIP re-entry RPC function</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130100000_vip_reentry_support.sql</files>
  <action>
Create a migration with a new RPC function `process_vip_scan_with_reentry` that handles both first entry and re-entry for VIP passes.

**Function signature:**
```sql
CREATE OR REPLACE FUNCTION process_vip_scan_with_reentry(
  p_pass_id UUID,
  p_scanned_by VARCHAR DEFAULT 'system'
)
RETURNS JSON
```

**Logic:**
1. Lock the pass row with FOR UPDATE (same as check_in_vip_guest_atomic)
2. If pass not found -> return error
3. If pass cancelled -> return error
4. Get reservation with FOR UPDATE
5. If reservation not in ('confirmed', 'checked_in') -> return error

**First entry case (pass.status = 'issued'):**
- Update pass to 'checked_in', set checked_in_at, checked_in_by
- Update reservation checked_in_guests count
- Update reservation status to 'checked_in' if first guest
- Return: { success: true, entry_type: 'first_entry', ... }

**Re-entry case (pass.status = 'checked_in'):**
- DO NOT change pass status (already checked_in)
- Log re-entry to vip_scan_logs table (create if needed)
- Return: { success: true, entry_type: 'reentry', last_entry_time: pass.checked_in_at, ... }

**Create vip_scan_logs table if not exists:**
```sql
CREATE TABLE IF NOT EXISTS vip_scan_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pass_id UUID REFERENCES vip_guest_passes(id),
  reservation_id UUID REFERENCES vip_reservations(id),
  scan_type VARCHAR(20) NOT NULL, -- 'first_entry', 'reentry'
  scanned_by VARCHAR(255),
  scanned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Return JSON structure:**
```json
{
  "success": true,
  "entry_type": "first_entry" | "reentry",
  "pass_id": "uuid",
  "reservation_id": "uuid",
  "guest_number": 1,
  "checked_in_guests": 2,
  "total_guests": 6,
  "last_entry_time": "2026-01-30T22:00:00Z" (for reentry only)
}
```

Grant EXECUTE to authenticated, service_role.
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx supabase db push --local

# Verify function exists
npx supabase db execute --local "SELECT proname FROM pg_proc WHERE proname = 'process_vip_scan_with_reentry';"
```
  </verify>
  <done>
Function process_vip_scan_with_reentry exists in database. vip_scan_logs table created for audit trail.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript wrapper function</name>
  <files>maguey-gate-scanner/src/lib/vip-tables-admin-service.ts</files>
  <action>
Add a new function `processVipScanWithReentry` to vip-tables-admin-service.ts that calls the RPC function.

**Interface (add near other interfaces):**
```typescript
export interface VipScanWithReentryResult {
  success: boolean;
  entryType: 'first_entry' | 'reentry';
  error?: string;
  message?: string;
  passId?: string;
  reservationId?: string;
  guestNumber?: number;
  checkedInGuests?: number;
  totalGuests?: number;
  lastEntryTime?: string;
}
```

**Function:**
```typescript
export async function processVipScanWithReentry(
  passId: string,
  scannedBy: string
): Promise<VipScanWithReentryResult> {
  const { data: result, error: rpcError } = await supabase.rpc(
    'process_vip_scan_with_reentry',
    {
      p_pass_id: passId,
      p_scanned_by: scannedBy,
    }
  );

  if (rpcError) {
    console.error('Error calling process_vip_scan_with_reentry:', rpcError);
    return {
      success: false,
      entryType: 'first_entry',
      error: 'RPC_ERROR',
      message: rpcError.message || 'Failed to process VIP scan',
    };
  }

  // Map snake_case to camelCase
  return {
    success: result.success,
    entryType: result.entry_type,
    error: result.error,
    message: result.message,
    passId: result.pass_id,
    reservationId: result.reservation_id,
    guestNumber: result.guest_number,
    checkedInGuests: result.checked_in_guests,
    totalGuests: result.total_guests,
    lastEntryTime: result.last_entry_time,
  };
}
```

Add the export to the file's exports section.
  </action>
  <verify>
```bash
# TypeScript compilation check
cd maguey-gate-scanner && npx tsc --noEmit

# Verify export exists
grep -n "processVipScanWithReentry" src/lib/vip-tables-admin-service.ts
```
  </verify>
  <done>
Function processVipScanWithReentry exported from vip-tables-admin-service.ts. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add re-entry support for linked GA tickets</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130100000_vip_reentry_support.sql</files>
  <action>
Extend the migration to also create a function for handling linked GA ticket re-entry.

When a linked GA ticket is scanned:
1. Check if ticket is in vip_linked_tickets table
2. If linked, apply VIP re-entry policy (allow multiple scans)
3. Log to vip_scan_logs with ticket_id reference

**Create function:**
```sql
CREATE OR REPLACE FUNCTION check_vip_linked_ticket_reentry(
  p_ticket_id UUID
)
RETURNS JSON
```

This function returns:
- `{ is_vip_linked: false }` if ticket not linked to VIP
- `{ is_vip_linked: true, allow_reentry: true, vip_reservation_id: "...", table_name: "..." }` if linked

The scanner will call this to determine if a GA ticket should get VIP re-entry privileges.
  </action>
  <verify>
```bash
cd maguey-pass-lounge && npx supabase db push --local

# Verify function exists
npx supabase db execute --local "SELECT proname FROM pg_proc WHERE proname = 'check_vip_linked_ticket_reentry';"
```
  </verify>
  <done>
Function check_vip_linked_ticket_reentry exists. Linked GA tickets can be checked for VIP re-entry privileges.
  </done>
</task>

</tasks>

<verification>
1. Migration applies without errors
2. process_vip_scan_with_reentry RPC function exists
3. First scan returns entry_type: 'first_entry' and updates pass status
4. Second scan of same pass returns entry_type: 'reentry' with last_entry_time
5. vip_scan_logs table records both entry types
6. TypeScript function compiles and exports correctly
</verification>

<success_criteria>
- VIP pass can be scanned multiple times without error
- First scan changes status to checked_in
- Subsequent scans return re-entry info without error
- All scans logged to vip_scan_logs for audit
- TypeScript types match RPC return values
</success_criteria>

<output>
After completion, create `.planning/phases/04-vip-system-reliability/04-02-SUMMARY.md`
</output>
