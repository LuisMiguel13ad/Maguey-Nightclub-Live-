---
phase: 16-route-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/components/ProtectedRoute.tsx
  - maguey-gate-scanner/src/pages/Unauthorized.tsx
autonomous: true

must_haves:
  truths:
    - "ProtectedRoute renders loading spinner while auth state resolves"
    - "ProtectedRoute redirects unauthenticated users to /auth with state.from preserved"
    - "ProtectedRoute shows 403 page when user role not in allowedRoles"
    - "ProtectedRoute blocks access when requireDev is true and build is production"
    - "ProtectedRoute renders children when all checks pass"
    - "Unauthorized page displays 403 with role-appropriate navigation buttons"
  artifacts:
    - path: "maguey-gate-scanner/src/components/ProtectedRoute.tsx"
      provides: "Auth + role + DEV guard wrapper component"
      exports: ["ProtectedRoute"]
    - path: "maguey-gate-scanner/src/pages/Unauthorized.tsx"
      provides: "403 Unauthorized error page"
      exports: ["default"]
  key_links:
    - from: "maguey-gate-scanner/src/components/ProtectedRoute.tsx"
      to: "maguey-gate-scanner/src/contexts/AuthContext.tsx"
      via: "useAuth() hook"
      pattern: "useAuth\\(\\)"
    - from: "maguey-gate-scanner/src/components/ProtectedRoute.tsx"
      to: "maguey-gate-scanner/src/lib/auth.ts"
      via: "UserRole type import"
      pattern: "import.*UserRole.*from.*auth"
    - from: "maguey-gate-scanner/src/components/ProtectedRoute.tsx"
      to: "react-router-dom"
      via: "Navigate with state.from and useLocation"
      pattern: "Navigate.*state.*from.*location"
---

<objective>
Create the ProtectedRoute wrapper component and 403 Unauthorized page for the maguey-gate-scanner app.

Purpose: These two components are the foundation for route protection (P0 blocker R06). ProtectedRoute handles authentication checks, role-based authorization, and DEV-only gating. Unauthorized provides a user-friendly 403 page when role checks fail.

Output: Two new files — `ProtectedRoute.tsx` (wrapper) and `Unauthorized.tsx` (error page) — ready for use in App.tsx route definitions.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@maguey-gate-scanner/src/contexts/AuthContext.tsx
@maguey-gate-scanner/src/lib/auth.ts
@maguey-gate-scanner/src/lib/auth-utils.ts
@maguey-gate-scanner/src/pages/NotFound.tsx
@maguey-pass-lounge/src/components/ProtectedRoute.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProtectedRoute wrapper component</name>
  <files>maguey-gate-scanner/src/components/ProtectedRoute.tsx</files>
  <action>
Create `maguey-gate-scanner/src/components/ProtectedRoute.tsx` with the following implementation:

**Interface:**
```typescript
interface ProtectedRouteProps {
  children: React.ReactNode;
  allowedRoles?: UserRole[];  // Optional: omit = any authenticated user
  requireDev?: boolean;       // Optional: gate behind import.meta.env.DEV
}
```

**Imports:**
- `useAuth` from `@/contexts/AuthContext`
- `UserRole` from `@/lib/auth`
- `Navigate, useLocation` from `react-router-dom`
- `Loader2` from `lucide-react`
- `Unauthorized` from `@/pages/Unauthorized` (lazy import not needed — small component)

**Logic flow (order matters):**

1. Call `useAuth()` to get `{ user, role, loading }` and `useLocation()` to get current path.

2. **Loading check:** If `loading` is true, render a full-screen centered spinner:
   ```tsx
   <div className="min-h-screen flex items-center justify-center bg-background">
     <Loader2 className="w-8 h-8 animate-spin text-primary" />
   </div>
   ```
   Use `bg-background` (matches scanner site theme, not `bg-gradient-dark` from maguey-pass-lounge).

3. **DEV mode check:** If `requireDev` is true AND `import.meta.env.DEV` is NOT true, render `<Unauthorized />`. This blocks /test-qr in production regardless of auth status. Check this BEFORE auth so the route is invisible in production.

4. **Authentication check:** If `!user`, redirect to `/auth` preserving the attempted URL:
   ```tsx
   <Navigate to="/auth" state={{ from: location }} replace />
   ```
   Redirect to `/auth` (not `/auth/employee` or `/auth/owner`). The `/auth` page in Phase 15 auto-redirects to `/auth/employee` which is the primary entry point. The `state.from` preserves the intended destination for post-login redirect.

5. **Role authorization check:** If `allowedRoles` is defined and the user's `role` is NOT in the array, render `<Unauthorized />`. If `allowedRoles` is undefined/not provided, skip this check (any authenticated user can access).

6. **All checks pass:** Render `<>{children}</>`.

**Export:** Named export `ProtectedRoute` (not default — consistent with wrapper component patterns).

**Per context decisions:**
- ProtectedRoute accepts role arrays per user decision (flexible `['owner']`, `['owner', 'promoter']`, etc.)
- Loading state shows spinner per user decision (prevents flash of login page)
- Redirect to /auth per user decision (standard pattern)
  </action>
  <verify>
Run TypeScript compilation check:
```bash
cd maguey-gate-scanner && npx tsc --noEmit src/components/ProtectedRoute.tsx 2>&1 | head -20
```
If tsc errors on isolated file, verify imports resolve correctly by checking the file exists and exports match.
  </verify>
  <done>
ProtectedRoute.tsx exists with: loading spinner, DEV check, auth redirect with state.from, role check with Unauthorized fallback, and children rendering. Named export `ProtectedRoute`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create 403 Unauthorized page</name>
  <files>maguey-gate-scanner/src/pages/Unauthorized.tsx</files>
  <action>
Create `maguey-gate-scanner/src/pages/Unauthorized.tsx` as a 403 error page.

**Structure:** Follow the same minimal pattern as NotFound.tsx but with 403-specific content.

**Imports:**
- `useAuth` from `@/contexts/AuthContext`
- `useNavigate` from `react-router-dom`
- `ShieldAlert, ArrowLeft, LogOut` from `lucide-react`
- `Button` from `@/components/ui/button`
- `supabase` from `@/lib/supabase`

**Layout:**
```tsx
<div className="flex min-h-screen items-center justify-center bg-background">
  <div className="text-center max-w-md mx-auto p-6">
    <ShieldAlert className="h-16 w-16 text-destructive mx-auto mb-4" />
    <h1 className="mb-2 text-4xl font-bold">403</h1>
    <p className="mb-2 text-xl text-muted-foreground">Access Denied</p>
    <p className="mb-6 text-sm text-muted-foreground">
      You don't have permission to access this page.
    </p>
    {/* Action buttons */}
  </div>
</div>
```

Use `bg-background` and `text-muted-foreground` (scanner site theme classes from tailwind config, dark theme compatible).

**Action buttons (role-aware):**
- Get `role` from `useAuth()`.
- If role is `'owner'` or `'promoter'`: Show "Back to Dashboard" button navigating to `/dashboard`.
- If role is `'employee'`: Show "Back to Scanner" button navigating to `/scanner`.
- If no user (edge case — DEV-only route in production): Show "Back to Login" button navigating to `/auth`.
- Always show a "Sign Out" button that calls `supabase.auth.signOut()` then navigates to `/auth`.

**Button styling:**
- Primary action (back to dashboard/scanner): `<Button variant="default">` with `ArrowLeft` icon.
- Sign out: `<Button variant="outline">` with `LogOut` icon.
- Stack buttons vertically with `space-y-3` for mobile-friendly layout.

**Export:** Default export (consistent with all other pages in the project).
  </action>
  <verify>
Verify the file exists and has correct structure:
```bash
ls -la maguey-gate-scanner/src/pages/Unauthorized.tsx
grep -c "403" maguey-gate-scanner/src/pages/Unauthorized.tsx
grep "export default" maguey-gate-scanner/src/pages/Unauthorized.tsx
```
  </verify>
  <done>
Unauthorized.tsx exists with: 403 heading, "Access Denied" message, role-aware navigation buttons (dashboard for owner, scanner for employee), and sign-out button. Default export.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Both files exist:
   - `maguey-gate-scanner/src/components/ProtectedRoute.tsx`
   - `maguey-gate-scanner/src/pages/Unauthorized.tsx`

2. ProtectedRoute has all 5 logic paths:
   - Loading → spinner
   - requireDev + production → Unauthorized
   - No user → Navigate to /auth with state.from
   - Wrong role → Unauthorized
   - All pass → children

3. Unauthorized page has role-aware buttons:
   - Owner → "Back to Dashboard"
   - Employee → "Back to Scanner"
   - Sign out → always present

4. TypeScript compiles without errors:
   ```bash
   cd maguey-gate-scanner && npx tsc --noEmit 2>&1 | grep -i error | head -10
   ```
</verification>

<success_criteria>
- ProtectedRoute.tsx created with auth guard, role guard, DEV guard, loading spinner, and redirect with state.from
- Unauthorized.tsx created with 403 UI and role-aware navigation
- Both files use scanner site theme (bg-background, text-muted-foreground)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-route-protection/16-01-SUMMARY.md`
</output>
