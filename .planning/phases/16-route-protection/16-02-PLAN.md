---
phase: 16-route-protection
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - maguey-gate-scanner/src/App.tsx
  - maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx
  - maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user visiting /dashboard is redirected to /auth"
    - "Unauthenticated user visiting /scanner is redirected to /auth"
    - "Employee visiting /dashboard sees 403 Unauthorized page"
    - "Owner can access /dashboard, /events, /analytics, and all owner routes"
    - "Owner can access /scanner (owner has superset access)"
    - "/test-qr is blocked in production builds"
    - "Post-login redirect respects attempted URL from state.from"
    - "Public routes (/, /auth, /auth/owner, /auth/employee) remain accessible without login"
  artifacts:
    - path: "maguey-gate-scanner/src/App.tsx"
      provides: "All 30+ routes wrapped with ProtectedRoute"
      contains: "ProtectedRoute"
    - path: "maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx"
      provides: "Post-login redirect using location.state.from"
      contains: "location.state"
    - path: "maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx"
      provides: "Post-login redirect using location.state.from"
      contains: "location.state"
  key_links:
    - from: "maguey-gate-scanner/src/App.tsx"
      to: "maguey-gate-scanner/src/components/ProtectedRoute.tsx"
      via: "import and JSX wrapping"
      pattern: "import.*ProtectedRoute"
    - from: "maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx"
      to: "react-router-dom"
      via: "useLocation for state.from"
      pattern: "location\\.state"
    - from: "maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx"
      to: "react-router-dom"
      via: "useLocation for state.from"
      pattern: "location\\.state"
---

<objective>
Wrap all 30+ routes in App.tsx with ProtectedRoute guards and add post-login redirect support to login pages.

Purpose: This is the final step for P0 blocker R06 (dashboard routes not protected at route level). After this plan, every sensitive route requires authentication and correct role to access.

Output: Modified App.tsx with all routes protected, and login pages that redirect users to their intended destination after authentication.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-route-protection/16-01-SUMMARY.md
@maguey-gate-scanner/src/App.tsx
@maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx
@maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx
@maguey-gate-scanner/src/components/ProtectedRoute.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap all routes in App.tsx with ProtectedRoute</name>
  <files>maguey-gate-scanner/src/App.tsx</files>
  <action>
Modify `maguey-gate-scanner/src/App.tsx` to wrap all protected routes with the ProtectedRoute component.

**Add imports at top of file:**
```typescript
import { ProtectedRoute } from "./components/ProtectedRoute";
import Unauthorized from "./pages/Unauthorized";
```

**Add Unauthorized route** (before the catch-all):
```typescript
<Route path="/unauthorized" element={<Unauthorized />} />
```

**Route wrapping rules — apply to EVERY route in App.tsx:**

**PUBLIC (4 routes — NO wrapper, leave as-is):**
```typescript
<Route path="/" element={<Index />} />
<Route path="/auth" element={<Auth />} />
<Route path="/auth/owner" element={<OwnerLogin />} />
<Route path="/auth/employee" element={<EmployeeLogin />} />
```

**EMPLOYEE (4 routes — auth required, any role):**
Wrap with `<ProtectedRoute>` (no allowedRoles = any authenticated user):
```typescript
<Route path="/scanner" element={<ProtectedRoute><Scanner /></ProtectedRoute>} />
<Route path="/guest-list" element={<ProtectedRoute><GuestListCheckIn /></ProtectedRoute>} />
<Route path="/scan/vip" element={<ProtectedRoute><VipScannerPage /></ProtectedRoute>} />
<Route path="/scan/vip/:eventId" element={<ProtectedRoute><VipScannerPage /></ProtectedRoute>} />
```

**OWNER (26 routes — auth required + owner/promoter role):**
Wrap with `<ProtectedRoute allowedRoles={['owner', 'promoter']}>`:

Per context decision: promoter treated as owner-equivalent for MVP.

Apply to ALL of these routes:
- `/dashboard` (OwnerDashboard)
- `/events` (EventManagement)
- `/analytics` (AdvancedAnalytics)
- `/audit-log` (AuditLog)
- `/security` (SecuritySettings)
- `/staff-scheduling` (StaffScheduling)
- `/team` (TeamManagement)
- `/devices` (DeviceManagement)
- `/door-counters` (DoorCounterManagement)
- `/branding` (Branding)
- `/fraud-investigation` (FraudInvestigation)
- `/queue` (QueueManagement)
- `/queue-status/:eventId` (QueueStatus)
- `/notifications/preferences` (NotificationPreferences)
- `/notifications/rules` (NotificationRules)
- `/notifications/analytics` (NotificationAnalytics)
- `/sites` (SiteManagement)
- `/customers` (CustomerManagement)
- `/waitlist` (WaitlistManagement)
- `/crew/settings` (CrewSettings)
- `/vip-tables` (VipTablesManagement)
- `/orders` (Orders)
- `/monitoring/metrics` (MetricsPage)
- `/monitoring/traces` (TracesPage)
- `/monitoring/errors` (ErrorsPage)
- `/monitoring/circuit-breakers` (CircuitBreakersPage)
- `/monitoring/rate-limits` (RateLimitsPage)
- `/monitoring/query-performance` (QueryPerformancePage)

Example format:
```typescript
<Route path="/dashboard" element={
  <ProtectedRoute allowedRoles={['owner', 'promoter']}>
    <OwnerDashboard />
  </ProtectedRoute>
} />
```

**DEV-ONLY (1 route — DEV mode + owner role):**
Per context decision: /test-qr gated behind import.meta.env.DEV. Per research recommendation: also require owner role.
```typescript
<Route path="/test-qr" element={
  <ProtectedRoute requireDev allowedRoles={['owner']}>
    <TestQrGenerator />
  </ProtectedRoute>
} />
```

**CATCH-ALL and UNAUTHORIZED (public — no wrapper):**
```typescript
<Route path="/unauthorized" element={<Unauthorized />} />
<Route path="*" element={<NotFound />} />
```

**Preserve:** Keep all existing imports, the `{/* ADD ALL CUSTOM ROUTES ABOVE THE CATCH-ALL "*" ROUTE */}` comment, and the `{/* Monitoring Routes */}` comment. Keep all other App structure (QueryClient, providers, ErrorBoundary, etc.) unchanged.
  </action>
  <verify>
Count protected routes:
```bash
cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live
grep -c "ProtectedRoute" maguey-gate-scanner/src/App.tsx
```
Expected: ~32 (31 route wrappings + 1 import line). Verify no public routes are accidentally wrapped:
```bash
grep -A1 'path="/auth"' maguey-gate-scanner/src/App.tsx
grep -A1 'path="/"' maguey-gate-scanner/src/App.tsx
```
These should NOT contain ProtectedRoute.
  </verify>
  <done>
App.tsx has all 31 protected routes wrapped: 4 employee routes with auth-only ProtectedRoute, 26 owner routes with allowedRoles={['owner', 'promoter']}, 1 dev route with requireDev + allowedRoles. 4 public routes and catch-all remain unwrapped. Unauthorized route added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add post-login redirect to OwnerLogin and EmployeeLogin</name>
  <files>
    maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx
    maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx
  </files>
  <action>
Enhance both login pages to redirect to the user's intended destination after successful login, using `location.state.from` set by ProtectedRoute.

**OwnerLogin.tsx changes:**

1. Add `useLocation` to the existing react-router-dom import:
   ```typescript
   import { useNavigate, useSearchParams, useLocation } from "react-router-dom";
   ```

2. Inside the component, after the existing `useNavigate()` call, add:
   ```typescript
   const location = useLocation();
   ```

3. Derive the redirect target:
   ```typescript
   const from = (location.state as any)?.from?.pathname || AUTH_ROUTES.OWNER_REDIRECT;
   ```

4. In `handleLogin`, replace the two instances of `navigate(AUTH_ROUTES.OWNER_REDIRECT)` (lines 141 and 156) with `navigate(from, { replace: true })`. The `replace: true` prevents back-button returning to login.

5. In the already-authenticated redirect `useEffect` (line 50), replace `navigate(AUTH_ROUTES.OWNER_REDIRECT)` with `navigate(from, { replace: true })`.

**EmployeeLogin.tsx changes:**

1. Add `useLocation` to the existing react-router-dom import:
   ```typescript
   import { useNavigate, useLocation } from "react-router-dom";
   ```

2. Inside the component, after the existing `useNavigate()` call, add:
   ```typescript
   const location = useLocation();
   const from = (location.state as any)?.from?.pathname;
   ```

3. In the already-authenticated redirect `useEffect` (lines 26-35), replace the hardcoded redirects with:
   ```typescript
   useEffect(() => {
     if (user) {
       if (from) {
         navigate(from, { replace: true });
       } else {
         const userRole = getUserRole(user);
         if (userRole === 'owner' || userRole === 'promoter') {
           navigate("/dashboard", { replace: true });
         } else {
           navigate("/scanner", { replace: true });
         }
       }
     }
   }, [user, navigate, from]);
   ```

4. In `handleLogin` success (lines 72-80), update the redirect logic:
   ```typescript
   // After successful login
   const userRole = getUserRole(data.user);
   if (from) {
     toast({ title: "Welcome!", description: "Redirecting..." });
     navigate(from, { replace: true });
   } else if (userRole === 'owner' || userRole === 'promoter') {
     toast({ title: "Welcome!", description: "Redirecting to dashboard." });
     navigate("/dashboard", { replace: true });
   } else {
     toast({ title: "Welcome!", description: "Ready to scan." });
     navigate("/scanner", { replace: true });
   }
   ```

**Key behavior:** When a user is redirected from a protected route (e.g., `/analytics`) to `/auth` → `/auth/employee`, the `state.from` is passed through. After login, the user lands on `/analytics` instead of the default `/scanner`.

**Important:** Only use `from` if it exists. If the user navigated directly to login (no state.from), fall back to role-based defaults.
  </action>
  <verify>
Verify state.from usage in both files:
```bash
cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live
grep "location.state" maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx
grep "location.state" maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx
grep "from" maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx | grep -v "import\|//\|Form\|from-"
grep "from" maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx | grep -v "import\|//\|Form\|from-"
```
Both files should reference location.state and use `from` for navigation.
  </verify>
  <done>
OwnerLogin.tsx redirects to `location.state.from.pathname` after login (falls back to /dashboard). EmployeeLogin.tsx redirects to `location.state.from.pathname` after login (falls back to role-based default). Both use `replace: true` on navigation.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Route protection count:**
   ```bash
   grep -c "ProtectedRoute" maguey-gate-scanner/src/App.tsx
   ```
   Should be ~32+ (import + 31 route usages).

2. **No public routes wrapped:**
   ```bash
   grep -B1 "ProtectedRoute" maguey-gate-scanner/src/App.tsx | grep -E 'path="/(auth|"|auth/owner|auth/employee)'
   ```
   Should return nothing (public routes not wrapped).

3. **Owner routes have role restriction:**
   ```bash
   grep "allowedRoles" maguey-gate-scanner/src/App.tsx | wc -l
   ```
   Should be 27 (26 owner routes + 1 dev route).

4. **Post-login redirect works:**
   ```bash
   grep "location.state" maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx
   grep "location.state" maguey-gate-scanner/src/pages/auth/EmployeeLogin.tsx
   ```
   Both should contain state.from references.

5. **TypeScript compiles:**
   ```bash
   cd maguey-gate-scanner && npx tsc --noEmit 2>&1 | grep -i error | head -10
   ```
</verification>

<success_criteria>
- All 31 protected routes in App.tsx wrapped with ProtectedRoute
- 4 public routes remain unwrapped
- 26 owner routes have allowedRoles={['owner', 'promoter']}
- 4 employee routes have auth-only protection (no allowedRoles)
- /test-qr has requireDev + allowedRoles={['owner']}
- /unauthorized route added
- OwnerLogin.tsx supports post-login redirect via state.from
- EmployeeLogin.tsx supports post-login redirect via state.from
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-route-protection/16-02-SUMMARY.md`
</output>
