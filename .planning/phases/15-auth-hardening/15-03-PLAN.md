---
phase: 15-auth-hardening
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - maguey-gate-scanner/src/pages/Auth.tsx
  - maguey-gate-scanner/src/pages/Index.tsx
  - maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx
  - maguey-gate-scanner/src/components/layout/EmployeePortalLayout.tsx
  - maguey-gate-scanner/src/components/Navigation.tsx
  - maguey-gate-scanner/src/pages/Scanner.tsx
autonomous: true

must_haves:
  truths:
    - "/auth redirects to /auth/employee by default"
    - "/auth?invite=TOKEN redirects to /auth/owner?invite=TOKEN"
    - "/auth?role=owner redirects to /auth/owner"
    - "URL hash fragments with access_token and type=recovery redirect to /auth/owner"
    - "No demo buttons, handleDemoLogin, quick access buttons, or promote-to-owner exist in production"
    - "Index.tsx buttons navigate directly to /auth/owner and /auth/employee"
    - "Owner sign-out navigates to /auth/owner"
    - "Employee sign-out navigates to /auth/employee"
    - "localStorage.clearUser() in sign-out handlers is gated behind import.meta.env.DEV"
  artifacts:
    - path: "maguey-gate-scanner/src/pages/Auth.tsx"
      provides: "Backward-compatible redirect from /auth to appropriate login page"
      contains: "navigate.*replace.*true"
    - path: "maguey-gate-scanner/src/pages/Index.tsx"
      provides: "Landing page with direct links to /auth/owner and /auth/employee"
      contains: "/auth/owner"
  key_links:
    - from: "maguey-gate-scanner/src/pages/Auth.tsx"
      to: "/auth/employee"
      via: "Default redirect for /auth"
      pattern: "/auth/employee"
    - from: "maguey-gate-scanner/src/pages/Auth.tsx"
      to: "/auth/owner"
      via: "Redirect for invitations, password resets, and role=owner"
      pattern: "/auth/owner"
---

<objective>
Replace Auth.tsx with a backward-compatible redirect component, update Index.tsx buttons, update all sign-out navigation targets, and gate remaining localStorage calls behind DEV.

Purpose: This eliminates ALL demo code (handleDemoLogin, quick access buttons, promote-to-owner) by replacing the 1,110-line Auth.tsx with a ~35-line redirect. It also ensures sign-out flows return users to the correct login page. This completes P0 requirement R08 (remove demo shortcuts).

Output: Modified Auth.tsx (replaced), Index.tsx, OwnerPortalLayout.tsx, EmployeePortalLayout.tsx, Navigation.tsx, and Scanner.tsx.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.0-ROADMAP.md
@.planning/phases/15-auth-hardening/15-CONTEXT.md
@.planning/phases/15-auth-hardening/15-RESEARCH.md

Key source files:
@maguey-gate-scanner/src/pages/Auth.tsx — Replace entirely (currently 1,110 lines)
@maguey-gate-scanner/src/pages/Index.tsx — Update button navigation targets
@maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx — Sign-out (line 111), localStorage (line 108)
@maguey-gate-scanner/src/components/layout/EmployeePortalLayout.tsx — Sign-out (line 65), localStorage (line 62)
@maguey-gate-scanner/src/components/Navigation.tsx — Sign-out (line 61), localStorage (line 55)
@maguey-gate-scanner/src/pages/Scanner.tsx — Sign-out (line 721)

LOCKED DECISIONS from 15-CONTEXT.md:
- /auth redirects to /auth/employee by default
- All demo functions gated behind import.meta.env.DEV
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Auth.tsx with redirect component</name>
  <files>maguey-gate-scanner/src/pages/Auth.tsx</files>
  <action>
Replace the ENTIRE content of `maguey-gate-scanner/src/pages/Auth.tsx` (1,110 lines) with a backward-compatible redirect component (~35 lines):

```typescript
import { useEffect } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";

/**
 * Legacy /auth route — redirects to the appropriate login page.
 *
 * Routing logic:
 * - /auth → /auth/employee (default, per 15-CONTEXT.md decision)
 * - /auth?invite=TOKEN → /auth/owner?invite=TOKEN
 * - /auth?token=X&type=recovery → /auth/owner?token=X&type=recovery
 * - /auth?role=owner → /auth/owner
 * - /auth?role=staff → /auth/employee
 * - Hash fragments with access_token + type=recovery → /auth/owner
 */
const Auth = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  useEffect(() => {
    const invite = searchParams.get('invite');
    const token = searchParams.get('token');
    const type = searchParams.get('type');
    const role = searchParams.get('role');
    const hash = window.location.hash;

    // Invitations go to owner page
    if (invite) {
      navigate(`/auth/owner?${searchParams.toString()}`, { replace: true });
      return;
    }

    // Password reset tokens go to owner page
    if ((token && type === 'recovery') || (hash && hash.includes('access_token') && hash.includes('type=recovery'))) {
      const hashPart = hash ? hash : '';
      navigate(`/auth/owner?${searchParams.toString()}${hashPart}`, { replace: true });
      return;
    }

    // Explicit role parameter
    if (role === 'owner') {
      navigate('/auth/owner', { replace: true });
      return;
    }

    // Default: employee login
    navigate('/auth/employee', { replace: true });
  }, [navigate, searchParams]);

  return null;
};

export default Auth;
```

This eliminates:
- handleDemoLogin (lines 351-577) — REMOVED
- handlePromoteToOwner (lines 579-611) — REMOVED
- Quick Access buttons (lines 656-816) — REMOVED
- Demo Login button (lines 1071-1086) — REMOVED
- Promote to Owner button (lines 1088-1103) — REMOVED
- All 1,110 lines of UI code — replaced with ~35 lines of redirect logic

The unused imports (Button, Input, Label, Card, etc.) are also removed since no UI is rendered.
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit`. Navigate to `/auth` in the browser — should redirect to `/auth/employee`.</verify>
  <done>Auth.tsx replaced with redirect component. All demo code eliminated. /auth routes to /auth/employee by default.</done>
</task>

<task type="auto">
  <name>Task 2: Update Index.tsx navigation targets</name>
  <files>maguey-gate-scanner/src/pages/Index.tsx</files>
  <action>
Update `maguey-gate-scanner/src/pages/Index.tsx` with three changes:

1. **Auto-redirect target** (line 13): Change `navigate("/auth", { replace: true })` to `navigate("/auth/employee", { replace: true })`

2. **Owner Login button** (line 43): Change `navigate("/auth?role=owner")` to `navigate("/auth/owner")`

3. **Staff Login button** (line 54): Change `navigate("/auth?role=staff")` to `navigate("/auth/employee")`

4. **Redirect text** (line 67): Change "Redirecting to login page..." to "Redirecting to staff login..."

All other styling and structure remains unchanged.
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit`. Navigate to `/` — "Owner Login" and "Staff Login" buttons should go to the correct pages.</verify>
  <done>Index.tsx updated. Owner button → /auth/owner, Staff button → /auth/employee, auto-redirect → /auth/employee.</done>
</task>

<task type="auto">
  <name>Task 3: Update sign-out targets and gate localStorage</name>
  <files>
    maguey-gate-scanner/src/components/layout/OwnerPortalLayout.tsx
    maguey-gate-scanner/src/components/layout/EmployeePortalLayout.tsx
    maguey-gate-scanner/src/components/Navigation.tsx
    maguey-gate-scanner/src/pages/Scanner.tsx
  </files>
  <action>
**OwnerPortalLayout.tsx (lines 104-112):**
1. Gate localStorage: Change line 108 from `localStorageService.clearUser()` to:
   ```typescript
   if (import.meta.env.DEV) {
     localStorageService.clearUser();
   }
   ```
2. Update sign-out navigation: Change line 111 from `navigate("/auth")` to `navigate("/auth/owner")`

**EmployeePortalLayout.tsx (lines 58-66):**
1. Gate localStorage: Change line 62 from `localStorageService.clearUser()` to:
   ```typescript
   if (import.meta.env.DEV) {
     localStorageService.clearUser();
   }
   ```
2. Update sign-out navigation: Change line 65 from `navigate("/auth")` to `navigate("/auth/employee")`

**Navigation.tsx (lines 51-61):**
1. Gate localStorage: Change line 55 from `localStorageService.clearUser()` to:
   ```typescript
   if (import.meta.env.DEV) {
     localStorageService.clearUser();
   }
   ```
2. Navigation.tsx sign-out target (line 61): Change `navigate("/auth")` to `navigate("/auth/employee")`
   (Navigation component is used by employee-facing pages)

**Scanner.tsx (line 721):**
1. Change `navigate("/auth")` to `navigate("/auth/employee")`
   (Scanner is employee-facing, so sign-out should return to employee login)

NOTE: Other pages with `navigate("/auth")` (OwnerDashboard, Dashboard, NotificationRules, NotificationAnalytics, CrewSettings) are auth-check redirects, not sign-out handlers. They work fine as-is because the Auth.tsx redirect component handles them. Do NOT modify those pages — they will be addressed by Phase 16 (route protection) which adds a centralized ProtectedRoute wrapper.
  </action>
  <verify>
Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit`.
Search for ungated localStorage.clearUser() calls:
`grep -n 'localStorageService.clearUser()' src/components/layout/OwnerPortalLayout.tsx src/components/layout/EmployeePortalLayout.tsx src/components/Navigation.tsx`
— every occurrence should be inside an `import.meta.env.DEV` block.
  </verify>
  <done>Sign-out targets updated (owner → /auth/owner, employee → /auth/employee). localStorage.clearUser() gated behind DEV in all sign-out handlers.</done>
</task>

</tasks>

<verification>
1. `cd maguey-gate-scanner && npx tsc --noEmit` — no TypeScript errors
2. `npm run dev --workspace=maguey-gate-scanner` — site starts without errors
3. `/auth` → redirects to `/auth/employee`
4. `/auth?invite=TOKEN` → redirects to `/auth/owner?invite=TOKEN`
5. `/auth?role=owner` → redirects to `/auth/owner`
6. `/` → "Owner Login" goes to `/auth/owner`, "Staff Login" goes to `/auth/employee`
7. Sign out from dashboard → navigates to `/auth/owner`
8. Sign out from scanner → navigates to `/auth/employee`
9. `grep -rn 'handleDemoLogin\|Demo Login\|Promote to Owner\|Quick Access' src/pages/Auth.tsx` — zero hits
10. `npm run build --workspace=maguey-gate-scanner` → production build succeeds with no demo code
</verification>

<success_criteria>
- Auth.tsx is ~35 lines (was 1,110) — only a redirect component
- All demo code (handleDemoLogin, quick access, promote-to-owner) is eliminated
- /auth backward compatibility: redirects with query params and hash fragments work
- Index.tsx buttons go directly to /auth/owner and /auth/employee
- Sign-out from owner pages → /auth/owner
- Sign-out from employee pages → /auth/employee
- localStorage.clearUser() gated behind DEV in all sign-out handlers
- No TypeScript compilation errors
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/15-auth-hardening/15-03-SUMMARY.md`
</output>
