---
phase: 15-auth-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/lib/auth-utils.ts
  - maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx
  - maguey-gate-scanner/src/App.tsx
  - maguey-gate-scanner/src/lib/invitation-service.ts
autonomous: true

must_haves:
  truths:
    - "Owner can log in at /auth/owner with email/password (info@magueynightclub.com)"
    - "After owner login, user is redirected to /dashboard"
    - "Password reset flow works from /auth/owner (request + confirmation)"
    - "Invitation signup works at /auth/owner?invite=TOKEN"
    - "If non-owner role logs in at /auth/owner, they are signed out with an error message"
    - "Already-authenticated owner visiting /auth/owner is redirected to /dashboard"
    - "Shared auth-utils.ts provides navigateByRole and password strength utilities"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/auth-utils.ts"
      provides: "Shared auth utilities for both login pages"
      contains: "navigateByRole"
    - path: "maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx"
      provides: "Dedicated owner login page with password reset and invitation support"
      contains: "signInWithPassword"
  key_links:
    - from: "maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx"
      to: "supabase.auth.signInWithPassword()"
      via: "Email/password login for owner account"
      pattern: "signInWithPassword"
    - from: "maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx"
      to: "supabase.auth.resetPasswordForEmail()"
      via: "Password reset request"
      pattern: "resetPasswordForEmail"
    - from: "maguey-gate-scanner/src/lib/invitation-service.ts"
      to: "/auth/owner?invite="
      via: "Updated invitation URL routing"
      pattern: "getInvitationUrl"
---

<objective>
Create the owner login page at `/auth/owner` with email/password authentication, password reset, and invitation signup support. Also create the shared auth-utils.ts module used by both login pages.

Purpose: Separate the owner login experience from the employee login. The owner needs a professional login form with password reset and invitation support for team management. This is part of P0 requirement R07.

Output: Two new files (`auth-utils.ts`, `OwnerLogin.tsx`), plus route addition in App.tsx and invitation URL update.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.0-ROADMAP.md
@.planning/phases/15-auth-hardening/15-CONTEXT.md
@.planning/phases/15-auth-hardening/15-RESEARCH.md

Key source files to reference:
@maguey-gate-scanner/src/pages/Auth.tsx — Current 1,110-line monolith (port login + password reset + invitation logic)
@maguey-gate-scanner/src/App.tsx — Route configuration (add /auth/owner)
@maguey-gate-scanner/src/lib/auth.ts — getUserRole, setUserRole, hasPermission
@maguey-gate-scanner/src/contexts/AuthContext.tsx — useAuth, useRole hooks
@maguey-gate-scanner/src/lib/invitation-service.ts — getInvitationUrl (line 300-302)

LOCKED DECISIONS from 15-CONTEXT.md:
- Owner: /auth/owner with email/password
- /auth redirects to /auth/employee by default
- Role-based redirect after login (owner → /dashboard)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared auth-utils.ts</name>
  <files>maguey-gate-scanner/src/lib/auth-utils.ts</files>
  <action>
Create `maguey-gate-scanner/src/lib/auth-utils.ts` with shared utilities extracted from Auth.tsx:

1. **`navigateByRole(userData: any, navigate: NavigateFunction): void`** — Extracted from Auth.tsx lines 44-56:
   - If no userData: navigate to `/scanner`
   - If role is `owner` or `promoter`: navigate to `/dashboard`
   - Otherwise: navigate to `/scanner`
   - Uses `getUserRole()` from `@/lib/auth`

2. **`calculatePasswordStrength(password: string): number`** — Extracted from Auth.tsx lines 58-73:
   - Returns 0-5 strength score
   - Checks: length >= 8, length >= 12, mixed case, digits, special chars

3. **Redirect path constants:**
   ```typescript
   export const AUTH_ROUTES = {
     OWNER_LOGIN: '/auth/owner',
     EMPLOYEE_LOGIN: '/auth/employee',
     OWNER_REDIRECT: '/dashboard',
     EMPLOYEE_REDIRECT: '/scanner',
   } as const;
   ```

4. **`getStrengthLabel(strength: number): string`** — Returns "Weak password" | "Medium strength" | "Strong password"

Import `NavigateFunction` from `react-router-dom`. Import `getUserRole` from `@/lib/auth`.
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit` to check for type errors.</verify>
  <done>auth-utils.ts created with navigateByRole, calculatePasswordStrength, AUTH_ROUTES constants, and getStrengthLabel.</done>
</task>

<task type="auto">
  <name>Task 2: Create OwnerLogin.tsx</name>
  <files>maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx</files>
  <action>
Create `maguey-gate-scanner/src/pages/auth/OwnerLogin.tsx`. This component handles 4 modes:
- **Login** (default): Email + password
- **Password reset request**: Email form
- **Password reset confirmation**: New password + confirm (from URL hash/token)
- **Invitation signup**: Full name + email + password (from `?invite=TOKEN`)

**Imports:**
- React hooks: `useState`, `useEffect`
- React Router: `useNavigate`, `useSearchParams`
- Supabase: `supabase` from `@/lib/supabase`, `isSupabaseConfigured` from `@/lib/supabase-config`
- Auth: `getUserRole`, `setUserRole` from `@/lib/auth`, `useAuth`, `useRole` from `@/contexts/AuthContext`
- Invitation: `validateInvitation`, `consumeInvitation` from `@/lib/invitation-service`
- Audit: `logAuditEvent` from `@/lib/audit-service`
- Auth utils: `navigateByRole`, `calculatePasswordStrength`, `getStrengthLabel`, `AUTH_ROUTES` from `@/lib/auth-utils`
- UI: `Button`, `Input`, `Label`, `Card/CardContent/CardDescription/CardHeader/CardTitle`, `Alert/AlertDescription` from shadcn
- Icons: `Crown`, `Lock`, `UserPlus`, `AlertCircle`, `Mail`, `CheckCircle2` from lucide-react
- Toast: `useToast` from `@/hooks/use-toast`

**Already-authenticated redirect (useEffect):**
- If `useAuth()` returns a user AND `useRole()` is `owner` or `promoter` AND not in a password reset/invitation flow: redirect to `/dashboard`

**Invitation validation (useEffect):**
- Port from Auth.tsx lines 76-104. If `?invite=TOKEN`: validate, set `inviteValid`, show signup form

**Hash fragment detection (useEffect):**
- Port from Auth.tsx lines 106-120. Detect `#access_token=...&type=recovery` → show password reset confirmation

**Login handler:**
- Port from Auth.tsx lines 219-262 with one addition:
- After successful login, check role via `getUserRole(data.user)`. If NOT `owner` or `promoter`:
  - Sign out: `await supabase.auth.signOut()`
  - Show error toast: "This account does not have owner access. Please use the staff login."
  - Return (do not navigate)
- If role IS owner/promoter: navigate to `/dashboard`

**Password reset request handler:**
- Port from Auth.tsx lines 122-155
- Update `redirectTo` to `${window.location.origin}/auth/owner` (was `/auth`)

**Password reset confirmation handler:**
- Port from Auth.tsx lines 157-212
- On success, navigate to `/auth/owner` (not `/auth`)

**Signup handler (invitation):**
- Port from Auth.tsx lines 263-338
- Only available when `inviteToken` is present and valid

**UI Layout:**
- Same Card-based layout as current Auth.tsx but with:
  - Title: "Owner Portal" with Crown icon
  - Description: "Business management & dashboard access"
  - NO Quick Access buttons
  - NO Demo Login button
  - NO "Need an account? Sign up" toggle (owner signup is invitation-only)
  - "Forgot your password?" link shown during login mode
  - Small link at bottom: "Staff login →" pointing to `/auth/employee`
- Password strength indicator for reset confirmation and invitation signup
- Same green gradient styling as current Auth.tsx

**State variables:** (simplified from current Auth.tsx — only what's needed)
- `mode`: 'login' | 'resetRequest' | 'resetConfirm' | 'signup'
- `email`, `password`, `confirmPassword`, `fullName`
- `loading`, `resetEmailSent`
- `inviteToken`, `inviteValid`, `inviteError`, `invitationData`, `validatingInvite`

Do NOT include any demo functions, quick access buttons, promote-to-owner, or handleDemoLogin.
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit` to verify no type errors. Manually check that navigating to `/auth/owner` in the browser renders the owner login form.</verify>
  <done>OwnerLogin.tsx created with login, password reset (request + confirmation), invitation signup, role validation, and already-authenticated redirect.</done>
</task>

<task type="auto">
  <name>Task 3: Add /auth/owner route and update invitation URL</name>
  <files>
    maguey-gate-scanner/src/App.tsx
    maguey-gate-scanner/src/lib/invitation-service.ts
  </files>
  <action>
**App.tsx:**
1. Add import: `import OwnerLogin from "./pages/auth/OwnerLogin";`
2. Add route after line 55 (`/auth` route): `<Route path="/auth/owner" element={<OwnerLogin />} />`

**invitation-service.ts:**
1. Find `getInvitationUrl` function (line 300-302)
2. Change the return value from:
   ```typescript
   return `${baseUrl}/auth?invite=${token}`;
   ```
   to:
   ```typescript
   return `${baseUrl}/auth/owner?invite=${token}`;
   ```
   This ensures invitation links go directly to the owner login page.
  </action>
  <verify>Run `cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-gate-scanner && npx tsc --noEmit`. Verify the route exists by checking App.tsx imports and route list.</verify>
  <done>/auth/owner route added to App.tsx. Invitation URLs now point to /auth/owner?invite=TOKEN.</done>
</task>

</tasks>

<verification>
1. `cd maguey-gate-scanner && npx tsc --noEmit` — no TypeScript errors
2. `npm run dev --workspace=maguey-gate-scanner` — site starts without errors
3. Navigate to `/auth/owner` — renders owner login form with Crown icon and "Owner Portal" title
4. Login with `info@magueynightclub.com` / `MagueyNightclub123` → redirects to `/dashboard`
5. Click "Forgot your password?" — shows email input for password reset
6. "Staff login" link navigates to `/auth/employee` (will 404 until Plan 15-02, that is OK)
7. Check `invitation-service.ts` — `getInvitationUrl` returns `/auth/owner?invite=TOKEN`
</verification>

<success_criteria>
- Owner can log in at /auth/owner with real Supabase credentials
- Non-owner users get error and are signed out when trying to login at /auth/owner
- Password reset flow sends email with correct redirect URL (/auth/owner)
- Invitation URLs route to /auth/owner
- Shared auth-utils.ts provides navigateByRole and password strength calculator
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-auth-hardening/15-01-SUMMARY.md`
</output>
