---
phase: 06-infrastructure-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/functions/health-check/index.ts
autonomous: true

must_haves:
  truths:
    - "Health endpoint returns status of all critical services"
    - "Database connectivity is verified with simple query"
    - "Stripe API reachability is confirmed"
    - "Resend API availability is checked"
    - "Response includes per-service response times"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/health-check/index.ts"
      provides: "Unified health check edge function"
      exports: ["serve"]
  key_links:
    - from: "health-check/index.ts"
      to: "Supabase database"
      via: "simple SELECT query"
      pattern: "supabase\\.from.*select.*limit\\(1\\)"
    - from: "health-check/index.ts"
      to: "Stripe API"
      via: "healthcheck endpoint"
      pattern: "api\\.stripe\\.com.*healthcheck"
    - from: "health-check/index.ts"
      to: "Resend API"
      via: "domains list"
      pattern: "api\\.resend\\.com.*domains"
---

<objective>
Create a unified health-check edge function that monitors all critical services

Purpose: Enable external monitoring tools (Uptime Robot, Cronitor) to check system health with a single endpoint
Output: Edge function at `/functions/v1/health-check` returning JSON health status
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-monitoring/06-CONTEXT.md
@.planning/phases/06-infrastructure-monitoring/06-RESEARCH.md
@maguey-pass-lounge/supabase/functions/verify-revenue/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health-check edge function</name>
  <files>maguey-pass-lounge/supabase/functions/health-check/index.ts</files>
  <action>
Create the health-check edge function following the pattern in RESEARCH.md:

1. Import dependencies:
   - `serve` from deno std http server
   - `createClient` from supabase-js (esm.sh)

2. Define response interface (from RESEARCH.md):
```typescript
interface HealthCheckResponse {
  status: 'healthy' | 'degraded' | 'unhealthy';
  timestamp: string;
  checks: {
    [service: string]: {
      status: 'healthy' | 'unhealthy';
      responseTime?: number;
      message?: string;
    };
  };
}
```

3. Create service check functions with 5s timeout using AbortController:

   **checkDatabase(supabase):**
   - Query `events` table with `.select('id').limit(1)`
   - Return healthy with responseTime if success
   - Return unhealthy with error message if fails

   **checkStripe():**
   - Fetch `https://api.stripe.com/healthcheck` (no auth needed)
   - Use AbortController with 5s timeout
   - Return healthy with responseTime if 200
   - Return unhealthy if timeout or non-200

   **checkResend():**
   - Fetch `https://api.resend.com/domains` with RESEND_API_KEY
   - Use AbortController with 5s timeout
   - Return healthy with responseTime if 200
   - Return unhealthy if timeout or non-200

4. Main handler:
   - Handle OPTIONS for CORS preflight
   - Initialize Supabase client with service role key
   - Run all checks in parallel with Promise.all
   - Add self-check: `edge_functions: { status: 'healthy' }`
   - Determine overall status:
     - All healthy = 'healthy'
     - Any unhealthy = 'unhealthy'
     - Mix = 'degraded'
   - Return JSON with 200 (healthy) or 503 (degraded/unhealthy)

5. CORS headers (from existing pattern):
```typescript
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};
```
  </action>
  <verify>Deploy function: `cd maguey-pass-lounge && supabase functions deploy health-check --no-verify-jwt`</verify>
  <done>Health-check endpoint returns JSON with status for database, stripe, resend, and edge_functions</done>
</task>

<task type="auto">
  <name>Task 2: Test health-check endpoint</name>
  <files>None (verification only)</files>
  <action>
Test the deployed health-check function:

1. Call endpoint with curl:
```bash
curl -s https://[PROJECT_REF].supabase.co/functions/v1/health-check | jq
```

2. Verify response structure:
   - `status` field is 'healthy', 'degraded', or 'unhealthy'
   - `timestamp` is valid ISO date
   - `checks.database.status` is present
   - `checks.stripe.status` is present
   - `checks.resend.status` is present
   - `checks.edge_functions.status` is present
   - Each check has `responseTime` (except edge_functions)

3. Verify HTTP status code:
   - 200 when all healthy
   - 503 when any unhealthy

4. Test CORS preflight:
```bash
curl -X OPTIONS https://[PROJECT_REF].supabase.co/functions/v1/health-check -H "Origin: http://localhost:5173"
```
  </action>
  <verify>All curl tests pass and return expected JSON structure</verify>
  <done>Health-check endpoint is publicly accessible and returns correct status for all services</done>
</task>

</tasks>

<verification>
- [ ] Health-check edge function exists at `maguey-pass-lounge/supabase/functions/health-check/index.ts`
- [ ] Function deployed to Supabase without JWT verification
- [ ] Endpoint returns JSON with status, timestamp, and checks object
- [ ] Database check verifies Supabase connection
- [ ] Stripe check verifies API reachability
- [ ] Resend check verifies email service availability
- [ ] Response times included for external services
- [ ] CORS headers allow cross-origin requests
</verification>

<success_criteria>
Hitting `/functions/v1/health-check` returns JSON like:
```json
{
  "status": "healthy",
  "timestamp": "2026-01-31T12:00:00Z",
  "checks": {
    "database": { "status": "healthy", "responseTime": 45 },
    "stripe": { "status": "healthy", "responseTime": 120 },
    "resend": { "status": "healthy", "responseTime": 85 },
    "edge_functions": { "status": "healthy" }
  }
}
```
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-monitoring/06-01-SUMMARY.md`
</output>
