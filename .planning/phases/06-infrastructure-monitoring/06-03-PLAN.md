---
phase: 06-infrastructure-monitoring
plan: 03
type: execute
wave: 2
depends_on: ["06-04"]
files_modified:
  - maguey-pass-lounge/supabase/functions/_shared/sentry.ts
  - maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
  - maguey-pass-lounge/supabase/functions/vip/webhook/index.ts
  - maguey-gate-scanner/src/main.tsx
  - maguey-nights/src/main.tsx
autonomous: true
user_setup:
  - service: sentry
    why: "Error tracking and monitoring"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Settings -> Client Keys (DSN)"
      - name: VITE_SENTRY_DSN
        source: "Same DSN as above (for frontend apps)"
    dashboard_config:
      - task: "Create Sentry project (if not exists)"
        location: "Sentry -> Create Project -> React / Deno"

must_haves:
  truths:
    - "Sentry captures errors in all three frontend apps"
    - "Sentry captures errors in critical edge functions"
    - "Error context includes user ID and request ID"
    - "Sentry flushes before edge function response"
    - "defaultIntegrations disabled in edge functions to prevent scope contamination"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/_shared/sentry.ts"
      provides: "Shared Sentry initialization for edge functions"
      exports: ["initSentry", "captureError", "setRequestContext"]
    - path: "maguey-gate-scanner/src/main.tsx"
      provides: "Gate scanner with Sentry"
      contains: "Sentry.init"
    - path: "maguey-nights/src/main.tsx"
      provides: "Nights site with Sentry"
      contains: "Sentry.init"
  key_links:
    - from: "_shared/sentry.ts"
      to: "Sentry API"
      via: "captureException"
      pattern: "Sentry\\.captureException"
    - from: "stripe-webhook/index.ts"
      to: "_shared/sentry.ts"
      via: "import captureError"
      pattern: "import.*captureError.*sentry"
    - from: "_shared/logger.ts"
      to: "_shared/sentry.ts"
      via: "error logging triggers Sentry"
      pattern: "captureError|Sentry"
---

<objective>
Extend Sentry error tracking to gate-scanner, nights, and edge functions

Purpose: Capture production errors with full context for debugging
Output: Sentry integrated in all apps and critical edge functions
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-monitoring/06-CONTEXT.md
@.planning/phases/06-infrastructure-monitoring/06-RESEARCH.md
@.planning/phases/06-infrastructure-monitoring/06-04-SUMMARY.md
@maguey-pass-lounge/src/main.tsx
@maguey-gate-scanner/src/main.tsx
@maguey-nights/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sentry shared module for edge functions</name>
  <files>maguey-pass-lounge/supabase/functions/_shared/sentry.ts</files>
  <action>
Create the Sentry shared module at `_shared/sentry.ts` (per RESEARCH.md):

```typescript
import * as Sentry from "https://deno.land/x/sentry/index.mjs";

let initialized = false;

export function initSentry() {
  if (initialized) return;

  const dsn = Deno.env.get("SENTRY_DSN");
  if (!dsn) {
    console.log("[Sentry] No DSN configured, skipping initialization");
    return;
  }

  Sentry.init({
    dsn,
    defaultIntegrations: false, // CRITICAL: Prevents scope contamination across concurrent requests
    tracesSampleRate: 0.1,
    environment: Deno.env.get("ENVIRONMENT") || "production",
  });

  initialized = true;
  console.log("[Sentry] Initialized");
}

export function setRequestContext(req: Request, requestId: string) {
  Sentry.setTag("region", Deno.env.get("SB_REGION") || "unknown");
  Sentry.setTag("execution_id", Deno.env.get("SB_EXECUTION_ID") || "unknown");
  Sentry.setTag("request_id", requestId);
  Sentry.setTag("url", new URL(req.url).pathname);
}

export function setUserContext(userId?: string, email?: string) {
  if (userId || email) {
    Sentry.setUser({ id: userId, email });
  }
}

export async function captureError(
  error: Error,
  context?: Record<string, unknown>
) {
  const dsn = Deno.env.get("SENTRY_DSN");
  if (!dsn) {
    console.error("[Sentry] Error not captured (no DSN):", error.message);
    return;
  }

  Sentry.captureException(error, { extra: context });
  await Sentry.flush(2000); // IMPORTANT: Flush before response ends
}

export { Sentry };
```

Note: Uses `https://deno.land/x/sentry/index.mjs` as per RESEARCH.md (npm:@sentry/deno also works).
  </action>
  <verify>File exists and exports initSentry, captureError, setRequestContext, setUserContext</verify>
  <done>Sentry shared module created with proper edge function patterns</done>
</task>

<task type="auto">
  <name>Task 2: Add Sentry to critical edge functions</name>
  <files>
    maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
    maguey-pass-lounge/supabase/functions/vip/webhook/index.ts
  </files>
  <action>
Add Sentry to webhook handlers (most critical for error tracking):

**For both stripe-webhook/index.ts and vip/webhook/index.ts:**

1. Add imports at top:
```typescript
import { initSentry, captureError, setRequestContext } from "../_shared/sentry.ts";
// For vip/webhook use: import { initSentry, captureError, setRequestContext } from "../../_shared/sentry.ts";
import { createLogger } from "../_shared/logger.ts";
// For vip/webhook use: import { createLogger } from "../../_shared/logger.ts";
```

2. Initialize Sentry at module level (before serve):
```typescript
initSentry();
```

3. At start of handler, set request context:
```typescript
const requestId = req.headers.get("x-request-id") || crypto.randomUUID();
const logger = createLogger(requestId);
setRequestContext(req, requestId);
```

4. Wrap main logic in try/catch, report errors to Sentry:
```typescript
try {
  // ... existing handler logic ...
} catch (error) {
  logger.error("Webhook error", { error: error.message });
  await captureError(error, {
    webhook_type: "stripe", // or "vip"
    requestId,
  });
  return new Response(
    JSON.stringify({ error: "Internal error" }),
    { status: 500, headers: corsHeaders }
  );
}
```

Important: The `await captureError()` ensures Sentry flushes before response.
  </action>
  <verify>Both webhook files import Sentry module and wrap handlers in try/catch with captureError</verify>
  <done>Critical webhooks report errors to Sentry with request context</done>
</task>

<task type="auto">
  <name>Task 3: Add Sentry to gate-scanner and nights frontends</name>
  <files>
    maguey-gate-scanner/src/main.tsx
    maguey-nights/src/main.tsx
  </files>
  <action>
Extend the existing pass-lounge Sentry pattern to gate-scanner and nights:

**Step 1: Install @sentry/react in both projects:**
```bash
cd maguey-gate-scanner && npm install @sentry/react
cd ../maguey-nights && npm install @sentry/react
```

**Step 2: Update gate-scanner/src/main.tsx:**

Add Sentry initialization before ReactDOM.createRoot:
```typescript
import * as Sentry from "@sentry/react";

// Initialize Sentry
const sentryDsn = import.meta.env.VITE_SENTRY_DSN;
if (sentryDsn) {
  Sentry.init({
    dsn: sentryDsn,
    environment: import.meta.env.MODE,
    tracesSampleRate: import.meta.env.MODE === 'production' ? 0.1 : 1.0,
    integrations: [
      Sentry.browserTracingIntegration(),
    ],
  });
}
```

Wrap App in ErrorBoundary (if not already):
```typescript
const root = createRoot(document.getElementById("root")!);
root.render(
  <StrictMode>
    <Sentry.ErrorBoundary fallback={<div>Something went wrong</div>}>
      <App />
    </Sentry.ErrorBoundary>
  </StrictMode>
);
```

**Step 3: Update nights/src/main.tsx:**

Same pattern as gate-scanner - add Sentry.init and ErrorBoundary.

**Step 4: Verify pass-lounge already has Sentry:**
Check that maguey-pass-lounge/src/main.tsx already initializes Sentry (per STACK.md it has @sentry/react 10.32.0).

Note: maguey-pass-lounge already has Sentry integrated per project stack analysis. Only gate-scanner and nights need updates.
  </action>
  <verify>npm install succeeds, both main.tsx files have Sentry.init and ErrorBoundary</verify>
  <done>All three frontend apps have Sentry error tracking</done>
</task>

</tasks>

<verification>
- [ ] `_shared/sentry.ts` exists with initSentry, captureError, setRequestContext exports
- [ ] defaultIntegrations: false set (critical for edge function safety)
- [ ] stripe-webhook imports and uses Sentry module
- [ ] vip/webhook imports and uses Sentry module
- [ ] Error handlers call await captureError() with context
- [ ] gate-scanner has @sentry/react installed
- [ ] gate-scanner main.tsx initializes Sentry
- [ ] nights has @sentry/react installed
- [ ] nights main.tsx initializes Sentry
- [ ] All apps use ErrorBoundary wrapper
</verification>

<success_criteria>
1. Thrown errors in stripe-webhook appear in Sentry dashboard with request_id tag
2. JavaScript errors in gate-scanner appear in Sentry dashboard
3. JavaScript errors in nights appear in Sentry dashboard
4. Error context includes environment, region, and request ID
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-monitoring/06-03-SUMMARY.md`
</output>
