---
phase: 06-infrastructure-monitoring
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/functions/_shared/logger.ts
  - maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
  - maguey-pass-lounge/supabase/functions/create-checkout-session/index.ts
autonomous: true

must_haves:
  truths:
    - "All edge function logs are structured JSON"
    - "Each log entry includes timestamp, level, requestId, and message"
    - "Request ID is consistent across all logs for a single request"
    - "Log levels are info, warn, and error"
    - "Context objects are included where relevant"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/_shared/logger.ts"
      provides: "Shared structured logging utility"
      exports: ["createLogger", "LogEntry"]
    - path: "maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts"
      provides: "Stripe webhook with structured logging"
      contains: "createLogger"
    - path: "maguey-pass-lounge/supabase/functions/create-checkout-session/index.ts"
      provides: "Checkout session with structured logging"
      contains: "createLogger"
  key_links:
    - from: "_shared/logger.ts"
      to: "console.log"
      via: "JSON.stringify output"
      pattern: "console\\.log\\(JSON\\.stringify"
    - from: "stripe-webhook/index.ts"
      to: "_shared/logger.ts"
      via: "import createLogger"
      pattern: "import.*createLogger.*logger"
---

<objective>
Create structured JSON logging utility for edge functions with request ID correlation

Purpose: Enable searchable, parseable logs in Supabase dashboard for debugging
Output: Shared logger module and structured logging in key edge functions
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-monitoring/06-CONTEXT.md
@.planning/phases/06-infrastructure-monitoring/06-RESEARCH.md
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
@maguey-pass-lounge/supabase/functions/create-checkout-session/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared logger module</name>
  <files>maguey-pass-lounge/supabase/functions/_shared/logger.ts</files>
  <action>
Create the structured logging utility at `_shared/logger.ts` (per RESEARCH.md pattern):

```typescript
/**
 * Structured logging utility for Supabase Edge Functions
 *
 * Usage:
 *   const requestId = req.headers.get("x-request-id") || crypto.randomUUID();
 *   const logger = createLogger(requestId);
 *   logger.info("Processing checkout", { eventId, ticketCount: 3 });
 */

export interface LogEntry {
  timestamp: string;
  level: 'info' | 'warn' | 'error';
  requestId: string;
  message: string;
  context?: Record<string, unknown>;
}

export interface Logger {
  info: (message: string, context?: Record<string, unknown>) => void;
  warn: (message: string, context?: Record<string, unknown>) => void;
  error: (message: string, context?: Record<string, unknown>) => void;
}

/**
 * Creates a logger instance bound to a specific request ID
 * All logs from this logger will share the same requestId for correlation
 */
export function createLogger(requestId: string): Logger {
  const log = (
    level: LogEntry['level'],
    message: string,
    context?: Record<string, unknown>
  ) => {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      requestId,
      message,
      ...(context && { context }),
    };

    // Output as single-line JSON for Supabase log parsing
    console.log(JSON.stringify(entry));
  };

  return {
    info: (message: string, context?: Record<string, unknown>) =>
      log('info', message, context),
    warn: (message: string, context?: Record<string, unknown>) =>
      log('warn', message, context),
    error: (message: string, context?: Record<string, unknown>) =>
      log('error', message, context),
  };
}

/**
 * Generate a request ID from the request headers or create a new one
 */
export function getRequestId(req: Request): string {
  return (
    req.headers.get("x-request-id") ||
    req.headers.get("x-correlation-id") ||
    crypto.randomUUID()
  );
}
```

Key design decisions:
- Single-line JSON for Supabase log parsing
- context is optional to keep simple logs clean
- getRequestId helper extracts or generates request ID
- Interface-based for type safety
  </action>
  <verify>File exists and exports createLogger, getRequestId, LogEntry, Logger</verify>
  <done>Structured logger module created with request ID correlation</done>
</task>

<task type="auto">
  <name>Task 2: Add structured logging to stripe-webhook</name>
  <files>maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts</files>
  <action>
Replace console.log/console.error calls with structured logger:

1. Add import at top:
```typescript
import { createLogger, getRequestId } from "../_shared/logger.ts";
```

2. At start of handler (after CORS check), create logger:
```typescript
const requestId = getRequestId(req);
const logger = createLogger(requestId);
```

3. Replace existing console.log/console.error calls:

OLD:
```typescript
console.log("Processing checkout.session.completed event");
```
NEW:
```typescript
logger.info("Processing checkout.session.completed", { eventType: event.type });
```

OLD:
```typescript
console.error("Error processing webhook:", error);
```
NEW:
```typescript
logger.error("Webhook processing failed", { error: error.message, eventType });
```

4. Add context to key operations:
```typescript
logger.info("Ticket created", { ticketId, eventId, email });
logger.info("Email queued", { emailType: "ticket_confirmation", ticketId });
logger.warn("Idempotency check: duplicate event", { eventId: stripeEvent.id });
```

5. Keep requestId available for error responses:
```typescript
return new Response(
  JSON.stringify({ error: "Processing failed", requestId }),
  { status: 500, headers: corsHeaders }
);
```
  </action>
  <verify>All console.log/error calls in stripe-webhook replaced with logger.info/warn/error</verify>
  <done>Stripe webhook has structured JSON logs with request ID correlation</done>
</task>

<task type="auto">
  <name>Task 3: Add structured logging to create-checkout-session</name>
  <files>maguey-pass-lounge/supabase/functions/create-checkout-session/index.ts</files>
  <action>
Add structured logging to checkout session creation:

1. Add import at top:
```typescript
import { createLogger, getRequestId } from "../_shared/logger.ts";
```

2. At start of handler, create logger:
```typescript
const requestId = getRequestId(req);
const logger = createLogger(requestId);
```

3. Log key operations:
```typescript
logger.info("Creating checkout session", {
  eventId: body.eventId,
  ticketTierId: body.ticketTierId,
  quantity: body.quantity,
});

logger.info("Checkout session created", {
  sessionId: session.id,
  amount: session.amount_total,
});
```

4. Log errors with context:
```typescript
logger.error("Failed to create checkout session", {
  error: error.message,
  eventId: body.eventId,
});
```

5. Add requestId to error responses for correlation:
```typescript
return new Response(
  JSON.stringify({ error: error.message, requestId }),
  { status: 500, headers: corsHeaders }
);
```
  </action>
  <verify>create-checkout-session uses logger for all console output</verify>
  <done>Checkout session creation has structured JSON logs</done>
</task>

</tasks>

<verification>
- [ ] `_shared/logger.ts` exists with createLogger and getRequestId exports
- [ ] LogEntry interface has timestamp, level, requestId, message, optional context
- [ ] Logger outputs single-line JSON via console.log
- [ ] stripe-webhook imports and uses createLogger
- [ ] stripe-webhook has consistent requestId across all logs
- [ ] create-checkout-session imports and uses createLogger
- [ ] Error responses include requestId for correlation
- [ ] No raw console.log/error calls remain in updated files
</verification>

<success_criteria>
1. Logs in Supabase dashboard are valid JSON
2. Searching by requestId finds all logs from a single request
3. Log levels (info, warn, error) are correctly set
4. Context objects provide relevant debugging info
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-monitoring/06-04-SUMMARY.md`
</output>
