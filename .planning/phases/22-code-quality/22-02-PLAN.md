---
phase: 22-code-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/src/contexts/AuthContext.tsx
  - maguey-pass-lounge/src/hooks/useAuthSession.ts
  - maguey-pass-lounge/src/hooks/useAuthMethods.ts
  - maguey-pass-lounge/src/hooks/useAuthProfile.ts
autonomous: true

must_haves:
  truths:
    - "All 22 consumer files continue importing useAuth from @/contexts/AuthContext without changes"
    - "AuthContextType interface preserved exactly (same shape, same methods)"
    - "AuthContext.tsx reduced to under 200 lines (provider shell + hook composition)"
    - "TypeScript build succeeds with zero errors"
  artifacts:
    - path: "maguey-pass-lounge/src/hooks/useAuthSession.ts"
      provides: "Session initialization, auth state listener, loading state, signUp, signIn, signOut, logActivity"
      contains: "export function useAuthSession"
    - path: "maguey-pass-lounge/src/hooks/useAuthMethods.ts"
      provides: "OAuth (Google, Facebook, Apple, GitHub), magic link, password reset, 2FA, phone stubs"
      contains: "export function useAuthMethods"
    - path: "maguey-pass-lounge/src/hooks/useAuthProfile.ts"
      provides: "updateProfile, uploadAvatar, resendVerification, updatePassword, updateEmail, getSessionStatus"
      contains: "export function useAuthProfile"
    - path: "maguey-pass-lounge/src/contexts/AuthContext.tsx"
      provides: "AuthProvider composition of 3 hooks, useAuth() export, AuthContextType interface"
      contains: "useAuthSession\\|useAuthMethods\\|useAuthProfile"
  key_links:
    - from: "maguey-pass-lounge/src/contexts/AuthContext.tsx"
      to: "maguey-pass-lounge/src/hooks/useAuthSession.ts"
      via: "hook composition in AuthProvider"
      pattern: "useAuthSession"
    - from: "maguey-pass-lounge/src/contexts/AuthContext.tsx"
      to: "maguey-pass-lounge/src/hooks/useAuthMethods.ts"
      via: "hook composition in AuthProvider"
      pattern: "useAuthMethods"
    - from: "maguey-pass-lounge/src/contexts/AuthContext.tsx"
      to: "maguey-pass-lounge/src/hooks/useAuthProfile.ts"
      via: "hook composition in AuthProvider"
      pattern: "useAuthProfile"
---

<objective>
Split the 840-line AuthContext.tsx into 3 focused custom hooks composed in a slim AuthProvider, preserving the exact AuthContextType interface and useAuth() hook for all 22 consumer files.

Purpose: AuthContext.tsx mixes session management, OAuth providers, 2FA, profile management, and phone auth stubs in a single 840-line file. Splitting into domain hooks improves testability, reduces cognitive load, and isolates auth concerns.

Output: 3 custom hooks + slimmed AuthContext.tsx (provider shell).
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@maguey-pass-lounge/src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract auth hooks from AuthContext.tsx</name>
  <files>
    maguey-pass-lounge/src/hooks/useAuthSession.ts
    maguey-pass-lounge/src/hooks/useAuthMethods.ts
    maguey-pass-lounge/src/hooks/useAuthProfile.ts
  </files>
  <action>
    Extract 3 custom hooks from AuthContext.tsx. Each hook receives `user` and `session` as parameters (or returns them) so they can be composed in AuthProvider.

    **useAuthSession.ts** (~250 lines — session init + core auth):
    - Move: All useState declarations (user, session, loading)
    - Move: useEffect for session initialization (lines ~62-126) — the `getSession()` + `onAuthStateChange` listener
    - Move: signUp() function (lines ~128-200) — includes password breach check, metadata
    - Move: signIn() function (lines ~200-247) — includes remember-me logic
    - Move: signOut() function — clears session state
    - Move: logActivity() function — logs auth activity to Supabase
    - Move: isSupabaseConfigured, demoUser constants
    - Returns: `{ user, session, loading, signUp, signIn, signOut, logActivity }`
    - Imports: supabase, checkPasswordBreach from @/lib/password-breach

    **useAuthMethods.ts** (~300 lines — OAuth + 2FA + magic link + phone):
    - Accepts: `user: User | null` parameter
    - Move: signInWithGoogle() (lines ~268-290)
    - Move: signInWithFacebook() (lines ~292-314)
    - Move: signInWithApple() (lines ~316-338)
    - Move: signInWithGithub() (lines ~340-342)
    - Move: resetPassword() (lines ~344-370)
    - Move: signInWithMagicLink() (lines ~372-398)
    - Move: verifyMagicLink() (lines ~400-419)
    - Move: enable2FA() (lines ~421-480)
    - Move: verify2FA() (lines ~482-530)
    - Move: disable2FA() (lines ~532-570)
    - Move: signInWithPhone() stub (lines ~776-785)
    - Move: verifyPhoneOTP() stub (lines ~786-795)
    - Returns: `{ signInWithGoogle, signInWithFacebook, signInWithApple, signInWithGithub, resetPassword, signInWithMagicLink, verifyMagicLink, enable2FA, verify2FA, disable2FA, signInWithPhone, verifyPhoneOTP }`
    - Imports: supabase

    **useAuthProfile.ts** (~200 lines — profile + email + session status):
    - Accepts: `user: User | null, session: Session | null` parameters
    - Move: updateProfile() (lines ~572-640)
    - Move: uploadAvatar() (lines ~642-686)
    - Move: resendVerification() (lines ~688-710)
    - Move: updatePassword() (lines ~712-734)
    - Move: updateEmail() (lines ~736-753)
    - Move: getSessionStatus() (lines ~755-774)
    - Move: checkPasswordBreach wrapper
    - Returns: `{ updateProfile, uploadAvatar, resendVerification, updatePassword, updateEmail, getSessionStatus, checkPasswordBreach: checkPasswordBreachWrapper }`
    - Imports: supabase, checkPasswordBreach from @/lib/password-breach

    CRITICAL: Copy function bodies verbatim. Do NOT change any function signatures, error handling, or return types. This is a pure extraction.

    Each hook file should:
    - Import types from '@supabase/supabase-js' (User, Session, AuthError)
    - Import supabase from '@/lib/supabase'
    - Export the hook as a named function
    - Use TypeScript types matching the AuthContextType interface methods
  </action>
  <verify>
    All 3 hook files exist and contain the expected exports.
    `cd maguey-pass-lounge && npx tsc --noEmit 2>&1 | head -30` — check for type errors in hooks.
  </verify>
  <done>3 custom hooks created with all auth logic extracted verbatim from AuthContext.tsx.</done>
</task>

<task type="auto">
  <name>Task 2: Slim AuthContext.tsx to compose hooks</name>
  <files>
    maguey-pass-lounge/src/contexts/AuthContext.tsx
  </files>
  <action>
    Replace AuthContext.tsx with a slim provider shell that:

    1. Keeps the AuthContextType interface definition (lines 11-38) — unchanged
    2. Keeps the AuthContext creation: `const AuthContext = createContext<AuthContextType | undefined>(undefined)`
    3. Keeps the useAuth() hook export (lines ~797-840) — unchanged
    4. Replaces the AuthProvider body with hook composition:

    ```typescript
    export function AuthProvider({ children }: { children: ReactNode }) {
      const { user, session, loading, signUp, signIn, signOut, logActivity } = useAuthSession();
      const {
        signInWithGoogle, signInWithFacebook, signInWithApple, signInWithGithub,
        resetPassword, signInWithMagicLink, verifyMagicLink,
        enable2FA, verify2FA, disable2FA,
        signInWithPhone, verifyPhoneOTP
      } = useAuthMethods(user);
      const {
        updateProfile, uploadAvatar,
        resendVerification, updatePassword, updateEmail,
        getSessionStatus, checkPasswordBreach: checkPasswordBreachFn
      } = useAuthProfile(user, session);

      const value: AuthContextType = {
        user, session, loading,
        signUp, signIn, signOut,
        signInWithGoogle, signInWithFacebook, signInWithApple, signInWithGithub,
        resetPassword, signInWithMagicLink, verifyMagicLink,
        enable2FA, verify2FA, disable2FA,
        updateProfile, uploadAvatar,
        logActivity, checkPasswordBreach: checkPasswordBreachFn,
        signInWithPhone, verifyPhoneOTP,
        resendVerification, updatePassword, updateEmail,
        getSessionStatus,
      };

      return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
    }
    ```

    5. Import the 3 hooks at the top:
    ```typescript
    import { useAuthSession } from '@/hooks/useAuthSession';
    import { useAuthMethods } from '@/hooks/useAuthMethods';
    import { useAuthProfile } from '@/hooks/useAuthProfile';
    ```

    6. Remove all old function implementations, useState calls, useEffect blocks, and constants that were moved to hooks.

    7. Run TypeScript build: `cd maguey-pass-lounge && npx tsc --noEmit`
    8. Run tests if they exist: `cd maguey-pass-lounge && npx vitest run --reporter=verbose 2>&1 | tail -20`

    The result should be AuthContext.tsx under 200 lines containing: imports, interface, context creation, AuthProvider (hook composition), and useAuth export.
  </action>
  <verify>
    `cd maguey-pass-lounge && npx tsc --noEmit` exits 0.
    `wc -l maguey-pass-lounge/src/contexts/AuthContext.tsx` shows under 200 lines.
    All 22 consumer files still import useAuth from '@/contexts/AuthContext' without changes.
  </verify>
  <done>AuthContext.tsx reduced to under 200 lines. 3 hooks composed in AuthProvider. All 22 consumer imports work unchanged. TypeScript build passes.</done>
</task>

</tasks>

<verification>
1. `cd maguey-pass-lounge && npx tsc --noEmit` — zero errors
2. `wc -l maguey-pass-lounge/src/contexts/AuthContext.tsx` — under 200 lines
3. `ls maguey-pass-lounge/src/hooks/useAuth*.ts | wc -l` — 3 hook files
4. `wc -l maguey-pass-lounge/src/hooks/useAuth*.ts` — each under 350 lines
5. All existing tests pass
</verification>

<success_criteria>
- AuthContext.tsx under 200 lines (provider shell only)
- 3 custom hooks created (useAuthSession, useAuthMethods, useAuthProfile)
- AuthContextType interface preserved exactly
- useAuth() hook works for all 22 consumer files
- TypeScript build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/22-code-quality/22-02-SUMMARY.md`
</output>
