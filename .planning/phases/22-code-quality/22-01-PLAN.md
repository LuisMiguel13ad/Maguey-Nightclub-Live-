---
phase: 22-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/src/lib/orders-service.ts
  - maguey-pass-lounge/src/lib/orders/index.ts
  - maguey-pass-lounge/src/lib/orders/types.ts
  - maguey-pass-lounge/src/lib/orders/order-creation.ts
  - maguey-pass-lounge/src/lib/orders/availability.ts
  - maguey-pass-lounge/src/lib/orders/ticket-insertion.ts
  - maguey-pass-lounge/src/lib/orders/email-refunds.ts
  - maguey-pass-lounge/src/lib/orders/queries.ts
  - maguey-pass-lounge/src/lib/orders/reporting.ts
  - maguey-pass-lounge/src/lib/orders/user-tickets.ts
autonomous: true

must_haves:
  truths:
    - "All 12 consumer files import from orders-service without changes (barrel re-exports preserve API)"
    - "orders-service.ts reduced to re-export barrel (under 50 lines)"
    - "Each domain module is under 500 lines and has a single concern"
    - "TypeScript build succeeds with zero errors"
  artifacts:
    - path: "maguey-pass-lounge/src/lib/orders/index.ts"
      provides: "Barrel re-exports of all 27 functions and 24 types"
      contains: "export.*from"
    - path: "maguey-pass-lounge/src/lib/orders/types.ts"
      provides: "All 24 type/interface exports"
      contains: "export type\\|export interface"
    - path: "maguey-pass-lounge/src/lib/orders/order-creation.ts"
      provides: "createOrderWithTickets, createOrderWithTicketsResult, createOrderWithSaga, mapCheckoutSelectionToLineItems, getSagaExecution, getRecentSagaExecutions"
    - path: "maguey-pass-lounge/src/lib/orders/availability.ts"
      provides: "checkLineItemsAvailability, validateLineItemsAvailability, getLineItemsAvailabilityMap"
    - path: "maguey-pass-lounge/src/lib/orders/ticket-insertion.ts"
      provides: "insertTicketsForOrder, insertTicketsForOrderBatch"
    - path: "maguey-pass-lounge/src/lib/orders/email-refunds.ts"
      provides: "resendTicket, requestRefund, getEmailCircuitStatus"
    - path: "maguey-pass-lounge/src/lib/orders/queries.ts"
      provides: "getOrders, getOrdersPaginated, getEventOrdersPaginated, getUserOrdersPaginated, getOrdersCursor, getTickets"
    - path: "maguey-pass-lounge/src/lib/orders/reporting.ts"
      provides: "getDashboardStats, getOrderSummary, getOrderReportRows"
    - path: "maguey-pass-lounge/src/lib/orders/user-tickets.ts"
      provides: "getUserTickets, getTicketById"
  key_links:
    - from: "maguey-pass-lounge/src/lib/orders-service.ts"
      to: "maguey-pass-lounge/src/lib/orders/index.ts"
      via: "re-export barrel"
      pattern: "export.*from.*orders"
    - from: "maguey-pass-lounge/src/lib/orders/index.ts"
      to: "maguey-pass-lounge/src/lib/orders/*.ts"
      via: "barrel re-exports all domain modules"
      pattern: "export.*from"
---

<objective>
Split the 2,598-line `orders-service.ts` into 7 focused domain modules under `orders/` directory with a barrel re-export that preserves the existing import API for all 12 consumer files.

Purpose: The monolithic orders-service.ts is the largest file in the codebase (2,598 lines, 51 exports). Splitting by domain reduces cognitive load, makes testing easier, and isolates changes to their domain.

Output: 7 domain modules + types file + barrel index + original file reduced to re-export.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@maguey-pass-lounge/src/lib/orders-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract types and create domain modules</name>
  <files>
    maguey-pass-lounge/src/lib/orders/types.ts
    maguey-pass-lounge/src/lib/orders/availability.ts
    maguey-pass-lounge/src/lib/orders/order-creation.ts
    maguey-pass-lounge/src/lib/orders/ticket-insertion.ts
    maguey-pass-lounge/src/lib/orders/email-refunds.ts
    maguey-pass-lounge/src/lib/orders/queries.ts
    maguey-pass-lounge/src/lib/orders/reporting.ts
    maguey-pass-lounge/src/lib/orders/user-tickets.ts
  </files>
  <action>
    Create `maguey-pass-lounge/src/lib/orders/` directory and extract from orders-service.ts:

    1. **types.ts** — All 24 type/interface exports (CheckoutSelectionItem, CheckoutSelectionRecord, OrderLineItem, CreateOrderInput, CreatedOrderResult, CreateOrderOptions, OrdersQueryOptions, AdminOrderRow, PaginatedOrderRow, OrderFilters, TicketsQueryOptions, AdminTicketRow, DashboardStats, OrderSummary, OrderReportRow, SummaryRange, UserTicket, and any other exported types). Copy the type definitions verbatim. Each module will import types from this file.

    2. **availability.ts** (~60 lines, around lines 292-353) — Extract: checkLineItemsAvailability(), validateLineItemsAvailability(), getLineItemsAvailabilityMap(). Internal imports: supabase, cache, logger, error-tracker, any types from types.ts.

    3. **order-creation.ts** (~400 lines, around lines 355-753) — Extract: mapCheckoutSelectionToLineItems(), createOrderWithTickets(), createOrderWithTicketsResult(), createOrderWithSaga(), getSagaExecution(), getRecentSagaExecutions(). This is the largest module. Internal imports: supabase, saga-executor, logger, monitoring, tracing, error-tracker, cache, types from types.ts, and availability functions from availability.ts.

    4. **ticket-insertion.ts** (~350 lines, around lines 1283-1625) — Extract: insertTicketsForOrder(), insertTicketsForOrderBatch(), and the internal generateHumanReadableTicketId() helper. Internal imports: supabase, ticket-generator, logger, types from types.ts.

    5. **email-refunds.ts** (~160 lines, around lines 1630-1788) — Extract: resendTicket(), requestRefund(), getEmailCircuitStatus(). Internal imports: supabase, email-queue, circuit-breaker, logger, types from types.ts.

    6. **queries.ts** (~265 lines, around lines 1805-2238) — Extract: getOrders(), getOrdersPaginated(), getEventOrdersPaginated(), getUserOrdersPaginated(), getOrdersCursor(), getTickets(). Internal imports: supabase, pagination, cache, logger, types from types.ts.

    7. **reporting.ts** (~150 lines, around lines 2240-2384) — Extract: getDashboardStats(), getOrderSummary(), getOrderReportRows(). Internal imports: supabase, cache, logger, types from types.ts.

    8. **user-tickets.ts** (~175 lines, around lines 2386-2596) — Extract: getUserTickets(), getTicketById(). Internal imports: supabase, logger, types from types.ts.

    For each module:
    - Copy the exact function body from orders-service.ts (preserve logic verbatim)
    - Add required imports at top (supabase, logger, etc. — use same `@/lib/` paths)
    - Import shared types from `./types` instead of defining inline
    - Export each function as named export
    - Preserve any internal helper functions used within the module (keep them non-exported in the same file)
    - Preserve existing JSDoc comments

    IMPORTANT: Do NOT modify any function signatures, return types, or logic. This is a pure extraction refactor.
  </action>
  <verify>
    Each new file exists and contains the expected exports. Run:
    `cd maguey-pass-lounge && npx tsc --noEmit 2>&1 | head -30`
    to check for type errors in the new modules.
  </verify>
  <done>7 domain modules + types.ts created with all 51 exports distributed by domain. No function signatures or logic changed.</done>
</task>

<task type="auto">
  <name>Task 2: Create barrel index and reduce orders-service.ts to re-exports</name>
  <files>
    maguey-pass-lounge/src/lib/orders/index.ts
    maguey-pass-lounge/src/lib/orders-service.ts
  </files>
  <action>
    1. Create `maguey-pass-lounge/src/lib/orders/index.ts` as barrel file:
       ```typescript
       // Domain modules
       export * from './types';
       export * from './availability';
       export * from './order-creation';
       export * from './ticket-insertion';
       export * from './email-refunds';
       export * from './queries';
       export * from './reporting';
       export * from './user-tickets';
       ```

    2. Replace the entire contents of `orders-service.ts` with re-exports from the barrel:
       ```typescript
       /**
        * Orders Service — Re-export barrel
        *
        * This file preserves backward compatibility for existing imports.
        * All logic has been split into domain modules under ./orders/
        *
        * Modules:
        *   types.ts          — Shared type definitions
        *   availability.ts   — Ticket availability checking
        *   order-creation.ts — Order + ticket creation, saga orchestration
        *   ticket-insertion.ts — Ticket generation and insertion
        *   email-refunds.ts  — Email resend, refund requests
        *   queries.ts        — Order/ticket listing and pagination
        *   reporting.ts      — Dashboard stats and reports
        *   user-tickets.ts   — Customer-facing ticket queries
        */
       export * from './orders';
       ```

    3. Verify all 12 consumer files still resolve their imports without changes:
       - pages/Account.tsx imports getUserTickets, UserTicket
       - pages/Ticket.tsx imports getTicketById, UserTicket
       - pages/admin/DashboardHome.tsx imports getDashboardStats
       - pages/admin/OrdersList.tsx imports getOrdersPaginated, getEventOrdersPaginated
       - pages/admin/Reports.tsx imports getOrderSummary, getOrderReportRows
       - pages/admin/TicketList.tsx imports getTickets
       - __tests__/integration/test-helpers.ts imports createOrderWithTickets, CreatedOrderResult, CreateOrderInput
       - __tests__/integration/order-flow.test.ts imports createOrderWithTickets, CreateOrderInput
       - lib/__tests__/orders-service.test.ts imports multiple functions
       - lib/test-n1-fix.ts imports availability functions
       - lib/test-n1-query-counter.ts imports availability functions
       - lib/test-pagination.ts imports pagination functions

       No consumer file changes needed — they all import from `@/lib/orders-service` which re-exports from `./orders`.

    4. Run TypeScript build check: `cd maguey-pass-lounge && npx tsc --noEmit`
       All imports must resolve. Zero type errors.

    5. If tests exist, run: `cd maguey-pass-lounge && npx vitest run --reporter=verbose 2>&1 | tail -20`
       Existing tests must pass without changes.
  </action>
  <verify>
    `cd maguey-pass-lounge && npx tsc --noEmit` exits 0.
    `wc -l maguey-pass-lounge/src/lib/orders-service.ts` shows under 50 lines.
    `ls maguey-pass-lounge/src/lib/orders/` shows 8 files (index.ts + 7 modules).
  </verify>
  <done>orders-service.ts reduced to ~15-line re-export barrel. All consumer imports work unchanged. TypeScript build passes. Tests pass.</done>
</task>

</tasks>

<verification>
1. `cd maguey-pass-lounge && npx tsc --noEmit` — zero errors
2. `wc -l maguey-pass-lounge/src/lib/orders-service.ts` — under 50 lines
3. `ls maguey-pass-lounge/src/lib/orders/ | wc -l` — 8 files
4. `wc -l maguey-pass-lounge/src/lib/orders/*.ts` — each module under 500 lines
5. All existing tests pass
</verification>

<success_criteria>
- orders-service.ts is under 50 lines (re-export only)
- 7 domain modules created in orders/ directory
- All 12 consumer files work without import changes
- TypeScript build succeeds
- Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-code-quality/22-01-SUMMARY.md`
</output>
