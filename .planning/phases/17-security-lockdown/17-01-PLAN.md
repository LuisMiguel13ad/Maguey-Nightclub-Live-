---
phase: 17-security-lockdown
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts
  - maguey-gate-scanner/src/lib/simple-scanner.ts
  - maguey-gate-scanner/src/lib/offline-ticket-cache.ts
  - maguey-nights/src/vite-env.d.ts
autonomous: true

must_haves:
  truths:
    - "verify-qr-signature Edge Function reads QR_SIGNING_SECRET from Deno.env.get(), never from client"
    - "Edge Function uses HMAC-SHA256 via Web Crypto API with constant-time comparison"
    - "Edge Function returns JSON { valid: boolean } with appropriate HTTP status codes"
    - "Edge Function uses shared CORS handler from _shared/cors.ts"
    - "simple-scanner.ts calls Edge Function for signature verification instead of client-side HMAC"
    - "simple-scanner.ts no longer reads VITE_QR_SIGNING_SECRET from import.meta.env"
    - "Verification failure returns false (fail-closed), never true"
    - "syncTicketCache fetches qr_signature column and populates CachedTicket.qrSignature"
    - "Offline scanning compares parsed QR signature against cached qr_signature value"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts"
      provides: "Server-side QR signature verification endpoint"
      exports: []
    - path: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      provides: "Scanner QR parsing with server-side verification"
      exports: ["findTicket", "findTicketForEvent", "scanTicket", "scanTicketOffline", "logScan", "getActiveEvents", "getEventNamesFromTickets", "getEventsFromTickets", "debugGetSampleTickets"]
    - path: "maguey-gate-scanner/src/lib/offline-ticket-cache.ts"
      provides: "Offline ticket cache with qr_signature population"
      exports: ["syncTicketCache", "validateOffline", "markAsScannedOffline", "resolveOfflineConflicts", "getPendingOfflineScans", "getConflictedScans", "getCacheStatus", "getAllCachedEvents", "getCheckedInCount", "clearEventCache", "clearOldCaches", "ensureCacheIsFresh", "getTicketFromCache", "findTicketByQrToken", "subscribeToCacheUpdates"]
  key_links:
    - from: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      to: "maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts"
      via: "HTTP POST to /functions/v1/verify-qr-signature"
      pattern: "fetch.*verify-qr-signature"
    - from: "maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts"
      to: "maguey-pass-lounge/supabase/functions/_shared/cors.ts"
      via: "import getCorsHeaders, handleCorsPreFlight"
      pattern: "import.*cors"
    - from: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      to: "maguey-gate-scanner/src/lib/offline-ticket-cache.ts"
      via: "Offline validation with cached signatures"
      pattern: "validateOffline"
---

<objective>
Move QR signature verification from client-side (VITE_QR_SIGNING_SECRET exposed in bundle) to server-side Edge Function. Update the scanner to call the Edge Function for online verification and use cached signatures for offline verification.

Purpose: This is the highest-priority P0 security blocker (R01). The HMAC signing secret is currently readable by anyone who inspects the client JavaScript bundle, allowing ticket forgery. After this plan, the secret lives only in server-side environment variables.

Output: A new `verify-qr-signature` Edge Function, updated `simple-scanner.ts` that calls it, and updated `offline-ticket-cache.ts` that caches signatures for offline use.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-security-lockdown/17-RESEARCH.md
@maguey-gate-scanner/src/lib/simple-scanner.ts
@maguey-gate-scanner/src/lib/offline-ticket-cache.ts
@maguey-gate-scanner/src/lib/supabase.ts
@maguey-pass-lounge/supabase/functions/_shared/cors.ts
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts (lines 130-170 for QR signing pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verify-qr-signature Edge Function</name>
  <files>maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts</files>
  <action>
Create the new Edge Function at `maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts`.

**Imports:**
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { getCorsHeaders, handleCorsPreFlight } from "../_shared/cors.ts";
```

**Implementation:**

1. **TextEncoder** at module level: `const textEncoder = new TextEncoder();`

2. **`verifySignature(token, signature, secret)` function:**
   - Import key via `crypto.subtle.importKey("raw", ...)` with HMAC SHA-256
   - Sign the token with `crypto.subtle.sign("HMAC", key, textEncoder.encode(token))`
   - Convert result to base64 via `btoa(String.fromCharCode(...new Uint8Array(signatureBuffer)))`
   - Constant-time comparison: check length equality first, then XOR accumulator loop
   - Return boolean
   - Wrap in try/catch, return `false` on any error (fail-closed)

3. **`serve()` handler:**
   - Handle CORS preflight: `const corsResponse = handleCorsPreFlight(req); if (corsResponse) return corsResponse;`
   - Only accept POST method. Return 405 for other methods.
   - Read `QR_SIGNING_SECRET` from `Deno.env.get("QR_SIGNING_SECRET")` (NOT `VITE_` prefix).
   - If secret not configured, return 500 with `{ valid: false, error: "Server configuration error" }`. Do NOT reveal what is missing.
   - Parse request body: `const { token, signature } = await req.json();`
   - Validate inputs: if `!token || !signature`, return 400 with `{ valid: false, error: "Missing token or signature" }`.
   - Call `verifySignature(token, signature, secret)`.
   - Return `{ valid: true }` or `{ valid: false }` with 200 status.
   - All responses include `{ ...getCorsHeaders(req), "Content-Type": "application/json" }`.
   - Wrap the entire body parsing and verification in try/catch. On error, return 400 with `{ valid: false, error: "Invalid request" }`.

**Security considerations:**
- Never log the secret value
- Never include the secret or expected signature in error responses
- Use constant-time comparison (XOR accumulator pattern from research)
- The function is intentionally simple and stateless
  </action>
  <verify>
Verify the file exists and has correct structure:
```bash
ls -la maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts
grep "QR_SIGNING_SECRET" maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts
grep "handleCorsPreFlight" maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts
grep "constant-time\|XOR\|result |=" maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts
```
Confirm: imports from `_shared/cors.ts`, reads secret from `Deno.env.get`, has constant-time comparison, returns JSON `{ valid }`.
  </verify>
  <done>
verify-qr-signature Edge Function exists with: CORS via shared handler, HMAC-SHA256 verification using Web Crypto API, constant-time comparison, fail-closed error handling, no secret exposure in responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update simple-scanner.ts to use server-side verification</name>
  <files>maguey-gate-scanner/src/lib/simple-scanner.ts</files>
  <action>
Modify `maguey-gate-scanner/src/lib/simple-scanner.ts` to replace client-side HMAC verification with server-side Edge Function calls.

**Changes:**

1. **Remove `getSigningSecret()` function** (lines 58-64). This function reads `VITE_QR_SIGNING_SECRET` from `import.meta.env` — the entire point is to remove this.

2. **Remove `bufferToBase64()` function** (lines 66-76). No longer needed since we are not doing client-side HMAC operations.

3. **Add Supabase URL/key helpers** near the top (after imports):
   ```typescript
   function getSupabaseUrl(): string {
     if (typeof import.meta !== 'undefined' && import.meta.env?.VITE_SUPABASE_URL) {
       return import.meta.env.VITE_SUPABASE_URL;
     }
     return '';
   }

   function getSupabaseAnonKey(): string {
     if (typeof import.meta !== 'undefined' && import.meta.env?.VITE_SUPABASE_ANON_KEY) {
       return import.meta.env.VITE_SUPABASE_ANON_KEY;
     }
     return '';
   }
   ```

4. **Replace `verifySignature()` function** (lines 78-117) with server-side call:
   ```typescript
   async function verifySignature(token: string, signature: string): Promise<boolean> {
     const supabaseUrl = getSupabaseUrl();
     const supabaseAnonKey = getSupabaseAnonKey();

     if (!supabaseUrl || !supabaseAnonKey) {
       console.error('[simple-scanner] Supabase not configured - cannot verify signature');
       return false; // Fail closed
     }

     try {
       const response = await fetch(`${supabaseUrl}/functions/v1/verify-qr-signature`, {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
           'apikey': supabaseAnonKey,
         },
         body: JSON.stringify({ token, signature }),
       });

       if (!response.ok) {
         console.error('[simple-scanner] Signature verification request failed:', response.status);
         return false; // Fail closed
       }

       const result = await response.json();
       return result.valid === true;
     } catch (error) {
       console.error('[simple-scanner] Signature verification error:', error);
       return false; // Fail closed - network error means reject
     }
   }
   ```

5. **Update `parseQrInput()` — no changes needed** to the function logic itself. It already calls `verifySignature()` and handles the result correctly. The only thing that changed is the implementation of `verifySignature()`.

6. **Prepare parseQrInput to return signatures for offline use (Plan 17-04 adds enforcement):**
   The offline signature enforcement (calling verifySignatureOffline) is handled by Plan 17-04. This task only prepares the data flow by including the signature in the parseQrInput return value.

   Update the `parseQrInput` return type to include the signature:
   ```typescript
   async function parseQrInput(input: string): Promise<{ token: string; isVerified: boolean; signature?: string; error?: string }>
   ```

   In the JSON parsing branch, after successful verification, include the signature in the return:
   ```typescript
   return { token: payload.token, isVerified: true, signature: payload.signature };
   ```

   And for the unsigned case:
   ```typescript
   return { token: payload.token, isVerified: false, signature: payload.signature };
   ```

7. **Keep `textEncoder` declaration** (line 50) — it is still used by other code that may reference it. Actually, check: after removing client-side HMAC, `textEncoder` is no longer used. Remove it.

**Important:** The `parseQrInput` function handles both online and offline paths. For online, it calls `verifySignature()` which now hits the Edge Function. For offline, signature comparison will be enforced by Plan 17-04 (which depends on this plan) using the `verifySignatureOffline()` function created in Task 3.

**Also remove VITE_QR_SIGNING_SECRET from maguey-nights:**
- Remove `VITE_QR_SIGNING_SECRET` from `maguey-nights/.env` (if present)
- Remove `VITE_QR_SIGNING_SECRET` from `maguey-nights/src/vite-env.d.ts` (if declared)
- The marketing site does NOT do QR verification, so no replacement is needed — just remove the secret to prevent client-bundle exposure.
  </action>
  <verify>
```bash
# Verify VITE_QR_SIGNING_SECRET is no longer referenced
grep "VITE_QR_SIGNING_SECRET" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should return nothing

# Verify server-side call exists
grep "verify-qr-signature" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should find the fetch URL

# Verify fail-closed pattern
grep "return false" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should find multiple fail-closed returns in verifySignature

# Verify no client-side crypto operations remain
grep "crypto.subtle" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should return nothing (crypto ops moved to Edge Function)
```
  </verify>
  <done>
simple-scanner.ts no longer reads VITE_QR_SIGNING_SECRET. verifySignature() calls the Edge Function via fetch. All error paths return false (fail-closed). parseQrInput returns signature for offline comparison.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update offline-ticket-cache.ts to cache and verify QR signatures</name>
  <files>maguey-gate-scanner/src/lib/offline-ticket-cache.ts</files>
  <action>
Modify `maguey-gate-scanner/src/lib/offline-ticket-cache.ts` to populate the existing `qrSignature` field during sync and support offline signature comparison.

**Changes:**

1. **Update `syncTicketCache()` SELECT query** (around line 140-153):
   Add `qr_signature` to the select list:
   ```typescript
   const { data: tickets, error: ticketsError } = await supabase
     .from('tickets')
     .select(
       `
       id,
       ticket_id,
       qr_code_data,
       qr_token,
       qr_signature,
       status,
       is_used,
       guest_name,
       attendee_name,
       ticket_type,
       scanned_at,
       scanned_by
     `
     )
     .eq('event_id', eventId);
   ```

2. **Update cache entry mapping** (around line 169-179):
   Add `qrSignature` to the `CachedTicket` object:
   ```typescript
   const cacheEntries: CachedTicket[] = (tickets || []).map((t) => ({
     ticketId: t.id,
     eventId,
     qrToken: t.qr_token || t.qr_code_data || t.ticket_id,
     qrSignature: t.qr_signature || undefined,
     status: t.is_used || t.status === 'scanned' ? 'scanned' : 'valid',
     guestName: t.guest_name || t.attendee_name || undefined,
     ticketType: t.ticket_type || 'General',
     scannedAt: t.scanned_at || undefined,
     scannedBy: t.scanned_by || undefined,
     syncedAt: now,
   }));
   ```

3. **Add a new export function for offline signature validation:**
   ```typescript
   /**
    * Verify a QR signature against cached value (for offline mode)
    * Returns true if signature matches cached value, false otherwise
    */
   export async function verifySignatureOffline(
     qrToken: string,
     signature: string
   ): Promise<boolean> {
     const ticket = await db.cachedTickets.where('qrToken').equals(qrToken).first();

     if (!ticket || !ticket.qrSignature) {
       // No cached signature to compare against
       return false;
     }

     // Simple string comparison (signatures are base64 strings)
     // No timing attack concern for offline cache comparison
     return ticket.qrSignature === signature;
   }
   ```

**Note:** The `CachedTicket` interface already has `qrSignature?: string` on line 20 — no interface changes needed. The Dexie schema also does not need updating since `qrSignature` is not an indexed field.
  </action>
  <verify>
```bash
# Verify qr_signature is in the SELECT query
grep "qr_signature" maguey-gate-scanner/src/lib/offline-ticket-cache.ts
# Should find it in the select query and in the mapping

# Verify the new export function exists
grep "verifySignatureOffline" maguey-gate-scanner/src/lib/offline-ticket-cache.ts
# Should find the function declaration
```
  </verify>
  <done>
offline-ticket-cache.ts fetches qr_signature during sync, populates CachedTicket.qrSignature in cache entries, and exports verifySignatureOffline() for offline signature comparison.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Edge Function exists and is well-formed:**
   - `maguey-pass-lounge/supabase/functions/verify-qr-signature/index.ts` exists
   - Reads `QR_SIGNING_SECRET` from `Deno.env.get()` (not `VITE_` prefix)
   - Uses shared CORS handler
   - Has constant-time comparison
   - Returns `{ valid: boolean }` JSON

2. **Client-side secret removed from ALL apps:**
   ```bash
   grep -r "VITE_QR_SIGNING_SECRET" maguey-gate-scanner/src/
   grep -r "VITE_QR_SIGNING_SECRET" maguey-nights/src/
   ```
   Both should return zero matches.

3. **Server-side verification integrated:**
   ```bash
   grep "verify-qr-signature" maguey-gate-scanner/src/lib/simple-scanner.ts
   ```
   Should find the Edge Function URL.

4. **Offline cache populates signatures:**
   ```bash
   grep "qr_signature" maguey-gate-scanner/src/lib/offline-ticket-cache.ts
   ```
   Should find it in SELECT query and cache mapping.

5. **TypeScript compiles:**
   ```bash
   cd maguey-gate-scanner && npx tsc --noEmit 2>&1 | grep -i error | head -10
   ```
</verification>

<success_criteria>
- verify-qr-signature Edge Function created with HMAC-SHA256 verification, shared CORS, fail-closed error handling
- simple-scanner.ts calls Edge Function instead of client-side crypto, no reference to VITE_QR_SIGNING_SECRET
- offline-ticket-cache.ts fetches qr_signature during sync and provides verifySignatureOffline()
- All error paths fail closed (return false, never true)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/17-security-lockdown/17-01-SUMMARY.md`
</output>
