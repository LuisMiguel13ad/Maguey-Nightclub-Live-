---
phase: 17-security-lockdown
plan: 04
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - maguey-gate-scanner/src/lib/simple-scanner.ts
autonomous: true

must_haves:
  truths:
    - "parseQrInput returns error when JSON QR payload has no signature field"
    - "Plain-text QR inputs (non-JSON) are rejected as unsigned"
    - "Manual entry (non-QR input) still works for ticket lookup by ID"
    - "Rejection reason is 'tampered' for unsigned QR codes"
    - "Offline scanning also rejects unsigned QR codes"
    - "scanTicket and scanTicketOffline both reject unsigned signatures"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      provides: "Scanner that rejects unsigned QR codes"
      exports: ["findTicket", "findTicketForEvent", "scanTicket", "scanTicketOffline", "logScan", "getActiveEvents", "getEventNamesFromTickets", "getEventsFromTickets", "debugGetSampleTickets"]
  key_links:
    - from: "maguey-gate-scanner/src/lib/simple-scanner.ts"
      to: "maguey-gate-scanner/src/lib/offline-ticket-cache.ts"
      via: "verifySignatureOffline for offline signature checks"
      pattern: "verifySignatureOffline"
---

<objective>
Reject unsigned QR codes in the scanner. Currently, QR payloads without a signature field and plain-text QR inputs are accepted and processed without signature verification. After this plan, only signed QR codes are accepted via QR/NFC scanning. Manual entry by ticket ID remains available as a staff fallback.

Purpose: This is P0/P1 blocker R23. Without this fix, anyone can create a fake QR code with just a ticket UUID and bypass HMAC verification entirely, defeating the purpose of QR signing.

Output: Updated `simple-scanner.ts` where `parseQrInput` rejects unsigned QR payloads and `scanTicket`/`scanTicketOffline` enforce signature requirements for QR/NFC scan methods.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-security-lockdown/17-RESEARCH.md
@.planning/phases/17-security-lockdown/17-01-PLAN.md
@maguey-gate-scanner/src/lib/simple-scanner.ts (AFTER 17-01 modifications)
@maguey-gate-scanner/src/lib/offline-ticket-cache.ts (AFTER 17-01 modifications)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reject unsigned QR codes in parseQrInput</name>
  <files>maguey-gate-scanner/src/lib/simple-scanner.ts</files>
  <action>
Modify `parseQrInput()` in `maguey-gate-scanner/src/lib/simple-scanner.ts` to reject QR payloads that lack a signature.

**IMPORTANT:** This plan builds on 17-01's changes. Read the file AFTER 17-01 has been applied.

**Change 1: Reject JSON payloads without signature**

In `parseQrInput`, the current code for a missing signature (around line 134-137 after 17-01) is:
```typescript
if (!payload.signature) {
  console.warn('[simple-scanner] QR payload missing signature');
  return { token: payload.token, isVerified: false };
}
```

Replace with:
```typescript
if (!payload.signature) {
  console.error('[simple-scanner] QR payload missing signature - rejecting unsigned QR code');
  return { token: '', isVerified: false, error: 'Unsigned QR code - ticket may be forged' };
}
```

This changes the behavior from "accept unsigned, mark as unverified" to "reject unsigned with error". Per the locked context decision: **Reject unsigned QR = return false not return true**.

**Change 2: Update scanTicket to enforce signature for QR/NFC methods**

In the `scanTicket()` function, after `parseQrInput` succeeds and before ticket lookup, add a check that enforces signature verification for automated scan methods:

```typescript
// Enforce signature verification for QR and NFC scans
// Manual entry bypasses this check (staff can type ticket IDs directly)
if (method !== 'manual' && !parsed.isVerified) {
  return {
    success: false,
    ticket: null,
    message: 'QR code is not signed - please use manual entry if this is a valid ticket',
    rejectionReason: 'tampered',
  };
}
```

Insert this block after the `if (!parsed.token)` check and before the `console.log('[simple-scanner] Searching for ticket...')` line.

**Change 3: Update scanTicketOffline to enforce signature for QR codes**

In `scanTicketOffline()`, after `parseQrInput` succeeds and before `validateOffline()`, add offline signature verification using the cached signature:

```typescript
// For offline mode, verify signature against cached value if available
if (parsed.signature && parsed.token) {
  const { verifySignatureOffline } = await import('./offline-ticket-cache');
  const signatureValid = await verifySignatureOffline(parsed.token, parsed.signature);
  if (!signatureValid) {
    console.error('[simple-scanner] Offline: Signature mismatch against cached value');
    return {
      success: false,
      ticket: null,
      message: 'QR code signature is invalid (offline verification)',
      rejectionReason: 'tampered',
      offlineValidated: true,
    };
  }
}
```

Insert this after the `if (!parsed.token)` check and before `console.log('[simple-scanner] Offline scan for token:...')`.

**Important considerations:**

- **Manual entry remains unrestricted.** Staff members typing ticket IDs at the door should not be blocked by signature requirements. The `method !== 'manual'` check ensures this.
- **Plain text QR codes** (non-JSON, just a UUID) will NOT match the JSON parsing branch and will fall through to the plain text return `{ token: trimmed, isVerified: false }`. These will then be caught by the `method !== 'manual' && !parsed.isVerified` check in `scanTicket()`.
- **The `isVerified` flag** becomes the enforcement mechanism: only signed and verified QR codes pass through for QR/NFC scan methods.
  </action>
  <verify>
```bash
# Verify unsigned QR rejection
grep "Unsigned QR code" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should find the error message

# Verify method-based enforcement
grep "method !== 'manual'" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should find the enforcement check

# Verify offline signature verification
grep "verifySignatureOffline" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should find the import and call

# Verify no 'return true' for missing signatures
grep -n "return true" maguey-gate-scanner/src/lib/simple-scanner.ts
# Should return nothing in the signature verification area

# TypeScript compile check
cd maguey-gate-scanner && npx tsc --noEmit 2>&1 | grep -i error | head -10
```
  </verify>
  <done>
parseQrInput rejects unsigned JSON QR payloads with error. scanTicket enforces signature verification for QR/NFC methods (manual entry bypassed). scanTicketOffline verifies signatures against cached values. All unsigned paths return false/error.
  </done>
</task>

</tasks>

<verification>
After task completes:

1. **Unsigned QR codes rejected:**
   - JSON QR without signature -> error "Unsigned QR code"
   - Plain text QR via QR/NFC scan -> error "QR code is not signed"

2. **Manual entry still works:**
   - Typing a ticket ID directly -> proceeds to lookup (no signature required)

3. **Offline verification uses cache:**
   ```bash
   grep "verifySignatureOffline" maguey-gate-scanner/src/lib/simple-scanner.ts
   ```

4. **No fail-open paths remain:**
   ```bash
   grep -n "return true" maguey-gate-scanner/src/lib/simple-scanner.ts
   ```
   Should only find `return true` in non-signature-related code (e.g., `markAsScannedOffline`).

5. **TypeScript compiles:**
   ```bash
   cd maguey-gate-scanner && npx tsc --noEmit 2>&1 | grep -i error | head -10
   ```
</verification>

<success_criteria>
- JSON QR payloads without signature are rejected with clear error message
- Plain-text QR inputs are rejected for QR/NFC scan methods
- Manual entry (method='manual') bypasses signature requirement
- Offline mode verifies signatures against cached values
- No fail-open paths remain (no 'return true' for missing/invalid signatures)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/17-security-lockdown/17-04-SUMMARY.md`
</output>
