---
phase: 17-security-lockdown
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/functions/_shared/cors.ts
  - maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
  - maguey-pass-lounge/supabase/functions/send-error-digest/index.ts
  - maguey-pass-lounge/supabase/functions/vip/create-payment-intent/index.ts
  - maguey-pass-lounge/supabase/functions/health-check/index.ts
  - maguey-pass-lounge/supabase/functions/verify-revenue/index.ts
  - maguey-pass-lounge/supabase/functions/cancel-event-with-refunds/index.ts
  - maguey-pass-lounge/supabase/functions/process-email-queue/index.ts
  - maguey-pass-lounge/supabase/functions/resend-webhook/index.ts
  - maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts
  - maguey-pass-lounge/supabase/functions/vip/confirmation/index.ts
  - maguey-pass-lounge/supabase/functions/check-availability/index.ts
autonomous: true

must_haves:
  truths:
    - "All 11 Edge Functions with hardcoded CORS '*' are migrated to shared _shared/cors.ts handler"
    - "Shared CORS handler supports extra allowed headers via optional parameter"
    - "stripe-webhook uses shared handler instead of its own duplicate getAllowedOrigin/getCorsHeaders"
    - "resend-webhook passes extra svix headers to shared CORS handler"
    - "No Edge Function contains hardcoded Access-Control-Allow-Origin: * (except example-with-security-headers.ts and test files)"
    - "CORS handler falls back to * only when ALLOWED_ORIGINS env var is not set (dev mode)"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/_shared/cors.ts"
      provides: "Shared CORS handler with optional extra headers support"
      exports: ["getAllowedOrigin", "getCorsHeaders", "handleCorsPreFlight"]
  key_links:
    - from: "maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts"
      to: "maguey-pass-lounge/supabase/functions/_shared/cors.ts"
      via: "import getCorsHeaders, handleCorsPreFlight"
      pattern: "import.*_shared/cors"
    - from: "maguey-pass-lounge/supabase/functions/resend-webhook/index.ts"
      to: "maguey-pass-lounge/supabase/functions/_shared/cors.ts"
      via: "import getCorsHeaders, handleCorsPreFlight"
      pattern: "import.*_shared/cors"
---

<objective>
Migrate all 11 Edge Functions from hardcoded `Access-Control-Allow-Origin: "*"` to the shared CORS handler in `_shared/cors.ts`, ensuring production CORS respects the `ALLOWED_ORIGINS` environment variable.

Purpose: This is P0 blocker R03. Currently 11 Edge Functions have hardcoded wildcard CORS, allowing any domain to call them. The shared handler already exists and supports `ALLOWED_ORIGINS` but is only used by 2 functions (create-checkout-session, confirm-vip-payment). This plan migrates the remaining 11.

Output: All Edge Functions use `_shared/cors.ts` for CORS. Setting `ALLOWED_ORIGINS` in Supabase Dashboard restricts all functions to production domains.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-security-lockdown/17-RESEARCH.md
@maguey-pass-lounge/supabase/functions/_shared/cors.ts
@maguey-pass-lounge/supabase/functions/create-checkout-session/index.ts (already migrated — reference pattern)
@maguey-pass-lounge/supabase/functions/health-check/index.ts (typical unmigrated function)
@maguey-pass-lounge/supabase/functions/resend-webhook/index.ts (needs extra headers)
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts (has duplicate CORS logic)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update shared CORS handler to support extra allowed headers</name>
  <files>maguey-pass-lounge/supabase/functions/_shared/cors.ts</files>
  <action>
Modify `maguey-pass-lounge/supabase/functions/_shared/cors.ts` to accept optional extra allowed headers.

**Why:** The `resend-webhook` function needs additional headers (`svix-id, svix-timestamp, svix-signature`) for Resend webhook signature verification. The `stripe-webhook` function needs `stripe-signature`. Rather than having these functions bypass the shared handler, the handler should support extra headers.

**Changes:**

1. **Update `getCorsHeaders()` to accept optional extra headers:**
   ```typescript
   /**
    * Get CORS headers for a request, using dynamic origin checking.
    * @param req The incoming request (used for origin matching)
    * @param extraAllowedHeaders Optional additional headers to allow (comma-separated string)
    */
   export function getCorsHeaders(req: Request, extraAllowedHeaders?: string) {
     const baseHeaders = "authorization, x-client-info, apikey, content-type";
     const allowHeaders = extraAllowedHeaders
       ? `${baseHeaders}, ${extraAllowedHeaders}`
       : baseHeaders;

     return {
       "Access-Control-Allow-Origin": getAllowedOrigin(req.headers.get("origin")),
       "Access-Control-Allow-Headers": allowHeaders,
     };
   }
   ```

2. **Update `handleCorsPreFlight()` to accept optional extra headers:**
   ```typescript
   /**
    * Handle CORS preflight (OPTIONS) request.
    * Returns a Response if this is a preflight, or null if it should be handled normally.
    * @param req The incoming request
    * @param extraAllowedHeaders Optional additional headers to allow
    */
   export function handleCorsPreFlight(req: Request, extraAllowedHeaders?: string): Response | null {
     if (req.method === "OPTIONS") {
       return new Response("ok", { headers: getCorsHeaders(req, extraAllowedHeaders) });
     }
     return null;
   }
   ```

3. **Keep `getAllowedOrigin()` unchanged** — it already works correctly with `ALLOWED_ORIGINS` env var.

**Note:** The `extraAllowedHeaders` parameter is optional, so existing callers (create-checkout-session, confirm-vip-payment) continue to work unchanged.
  </action>
  <verify>
```bash
grep "extraAllowedHeaders" maguey-pass-lounge/supabase/functions/_shared/cors.ts
# Should find the parameter in getCorsHeaders and handleCorsPreFlight
```
  </verify>
  <done>
Shared CORS handler supports optional extra headers parameter. Existing callers unaffected. New callers can pass additional allowed headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate 8 simple Edge Functions to shared CORS handler</name>
  <files>
    maguey-pass-lounge/supabase/functions/send-error-digest/index.ts
    maguey-pass-lounge/supabase/functions/health-check/index.ts
    maguey-pass-lounge/supabase/functions/verify-revenue/index.ts
    maguey-pass-lounge/supabase/functions/cancel-event-with-refunds/index.ts
    maguey-pass-lounge/supabase/functions/process-email-queue/index.ts
    maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts
    maguey-pass-lounge/supabase/functions/check-availability/index.ts
    maguey-pass-lounge/supabase/functions/vip/confirmation/index.ts
  </files>
  <action>
For each of the 8 functions listed, apply the same migration pattern:

**Step 1: Add import** — Add this import at the top (after existing imports):
```typescript
import { getCorsHeaders, handleCorsPreFlight } from "../_shared/cors.ts";
```

For functions inside `vip/` subdirectory (`vip/confirmation/index.ts`), use the correct relative path:
```typescript
import { getCorsHeaders, handleCorsPreFlight } from "../../_shared/cors.ts";
```

**Step 2: Remove hardcoded CORS object** — Delete the `const corsHeaders = { ... }` block that contains `"Access-Control-Allow-Origin": "*"`.

**Step 3: Update OPTIONS handler** — Replace:
```typescript
if (req.method === "OPTIONS") {
  return new Response("ok", { headers: corsHeaders });
}
```
With:
```typescript
const corsResponse = handleCorsPreFlight(req);
if (corsResponse) return corsResponse;
```

**Step 4: Update response headers** — Replace all occurrences of `{ ...corsHeaders, ... }` or `{ headers: corsHeaders }` with dynamic CORS:
```typescript
{ headers: { ...getCorsHeaders(req), "Content-Type": "application/json" } }
```

**Important notes per function:**

- **send-error-digest**: Uses `corsHeaders` in multiple return statements. Replace all occurrences.
- **health-check**: Uses `corsHeaders` in the final `return new Response(...)`. Replace with `getCorsHeaders(req)`.
- **verify-revenue**: Uses `corsHeaders` in all response paths. Replace all.
- **cancel-event-with-refunds**: Uses `corsHeaders` in multiple response paths. Replace all.
- **process-email-queue**: Uses `corsHeaders` in all response paths. Replace all.
- **notify-payment-failure**: Uses `corsHeaders` in OPTIONS and error responses. Replace all.
- **check-availability**: Uses `corsHeaders` in all response paths. Replace all.
- **vip/confirmation**: Uses `corsHeaders` in OPTIONS and all responses. Uses `../../_shared/cors.ts` import path. Replace all.

**Each function needs `req` to be accessible** where `getCorsHeaders(req)` is called. All 8 functions already pass `req` to their `serve()` handler, so this is available everywhere.
  </action>
  <verify>
```bash
# Verify no more hardcoded wildcard CORS in migrated functions
for f in send-error-digest health-check verify-revenue cancel-event-with-refunds process-email-queue notify-payment-failure check-availability; do
  echo "=== $f ==="
  grep -c '"Access-Control-Allow-Origin": "\*"' "maguey-pass-lounge/supabase/functions/$f/index.ts" || echo "0 (clean)"
  grep "_shared/cors" "maguey-pass-lounge/supabase/functions/$f/index.ts" || echo "MISSING IMPORT"
done
echo "=== vip/confirmation ==="
grep -c '"Access-Control-Allow-Origin": "\*"' "maguey-pass-lounge/supabase/functions/vip/confirmation/index.ts" || echo "0 (clean)"
grep "_shared/cors" "maguey-pass-lounge/supabase/functions/vip/confirmation/index.ts" || echo "MISSING IMPORT"
```
  </verify>
  <done>
All 8 simple Edge Functions migrated: hardcoded CORS removed, shared handler imported, OPTIONS uses handleCorsPreFlight, all responses use getCorsHeaders(req).
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate special Edge Functions (stripe-webhook, resend-webhook, vip/create-payment-intent)</name>
  <files>
    maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
    maguey-pass-lounge/supabase/functions/resend-webhook/index.ts
    maguey-pass-lounge/supabase/functions/vip/create-payment-intent/index.ts
  </files>
  <action>
These 3 functions need special handling because they have extra headers or duplicate CORS logic.

**stripe-webhook/index.ts:**

This function has a duplicate `getAllowedOrigin()` and `getCorsHeaders()` implementation (lines 92-121) that mirrors `_shared/cors.ts` but is local. It also has a `const corsHeaders` fallback (line 124-127).

1. Add import: `import { getCorsHeaders, handleCorsPreFlight } from "../_shared/cors.ts";`
2. **Remove** the local `getAllowedOrigin` function (lines 92-110).
3. **Remove** the local `baseCorsHeaders` constant (lines 113-115).
4. **Remove** the local `getCorsHeaders` function (lines 118-121). Since the shared handler is now imported with the same name, all existing `getCorsHeaders(req)` calls continue to work.
5. **Remove** the `const corsHeaders` fallback object (lines 124-127). Any remaining uses of `corsHeaders` must be replaced with `getCorsHeaders(req)`.
6. The function needs `stripe-signature` as an extra header. Update the CORS calls to pass extra headers:
   ```typescript
   const dynamicCorsHeaders = getCorsHeaders(req, "stripe-signature");
   ```
   And in the serve handler, update the OPTIONS check to:
   ```typescript
   const corsResponse = handleCorsPreFlight(req, "stripe-signature");
   if (corsResponse) return corsResponse;
   const dynamicCorsHeaders = getCorsHeaders(req, "stripe-signature");
   ```
7. Search for any remaining uses of `corsHeaders` (without the `dynamic` prefix) in the file and replace with `dynamicCorsHeaders` or `getCorsHeaders(req, "stripe-signature")`.

**resend-webhook/index.ts:**

This function needs extra headers for Svix signature verification: `svix-id, svix-timestamp, svix-signature`.

1. Add import: `import { getCorsHeaders, handleCorsPreFlight } from "../_shared/cors.ts";`
2. Remove the `const corsHeaders = { ... }` block (lines 6-10).
3. Define the extra headers constant: `const SVIX_HEADERS = "svix-id, svix-timestamp, svix-signature";`
4. Replace OPTIONS handler:
   ```typescript
   const corsResponse = handleCorsPreFlight(req, SVIX_HEADERS);
   if (corsResponse) return corsResponse;
   ```
5. Replace all `{ ...corsHeaders, ... }` with `{ ...getCorsHeaders(req, SVIX_HEADERS), ... }`.

**vip/create-payment-intent/index.ts:**

Standard migration (no extra headers needed).

1. Add import: `import { getCorsHeaders, handleCorsPreFlight } from "../../_shared/cors.ts";`
2. Remove the `const corsHeaders = { ... }` block (lines 11-14).
3. Replace OPTIONS handler with `handleCorsPreFlight(req)`.
4. Replace all `{ ...corsHeaders, ... }` or `{ headers: corsHeaders }` with `getCorsHeaders(req)`.
  </action>
  <verify>
```bash
# Verify stripe-webhook no longer has duplicate CORS logic
grep -c "getAllowedOrigin" maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
# Should be 0 (removed local copy)

# Verify resend-webhook uses shared handler with svix headers
grep "svix" maguey-pass-lounge/supabase/functions/resend-webhook/index.ts
grep "_shared/cors" maguey-pass-lounge/supabase/functions/resend-webhook/index.ts

# Verify vip/create-payment-intent uses shared handler
grep "_shared/cors" maguey-pass-lounge/supabase/functions/vip/create-payment-intent/index.ts
grep -c '"Access-Control-Allow-Origin": "\*"' maguey-pass-lounge/supabase/functions/vip/create-payment-intent/index.ts
# Should be 0

# Overall check: no hardcoded wildcards remaining in any index.ts
grep -rl '"Access-Control-Allow-Origin": "\*"' maguey-pass-lounge/supabase/functions/*/index.ts maguey-pass-lounge/supabase/functions/vip/*/index.ts 2>/dev/null
# Should return nothing
```
  </verify>
  <done>
stripe-webhook duplicate CORS logic removed and replaced with shared handler + stripe-signature extra header. resend-webhook migrated with svix extra headers. vip/create-payment-intent migrated with standard pattern. No Edge Function index.ts files contain hardcoded CORS wildcards.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **No hardcoded CORS wildcards in any Edge Function index.ts:**
   ```bash
   grep -rl '"Access-Control-Allow-Origin": "\*"' maguey-pass-lounge/supabase/functions/*/index.ts maguey-pass-lounge/supabase/functions/vip/*/index.ts 2>/dev/null
   ```
   Should return zero results.

2. **All functions import from shared handler:**
   ```bash
   for f in send-error-digest health-check verify-revenue cancel-event-with-refunds process-email-queue notify-payment-failure check-availability stripe-webhook resend-webhook; do
     grep -l "_shared/cors" "maguey-pass-lounge/supabase/functions/$f/index.ts" || echo "MISSING: $f"
   done
   grep -l "_shared/cors" "maguey-pass-lounge/supabase/functions/vip/confirmation/index.ts" || echo "MISSING: vip/confirmation"
   grep -l "_shared/cors" "maguey-pass-lounge/supabase/functions/vip/create-payment-intent/index.ts" || echo "MISSING: vip/create-payment-intent"
   ```

3. **Shared handler has extra headers support:**
   ```bash
   grep "extraAllowedHeaders" maguey-pass-lounge/supabase/functions/_shared/cors.ts
   ```

4. **Special headers preserved:**
   - `stripe-signature` in stripe-webhook
   - `svix-id, svix-timestamp, svix-signature` in resend-webhook
</verification>

<success_criteria>
- All 11 Edge Functions with hardcoded CORS migrated to _shared/cors.ts
- Shared CORS handler supports optional extra allowed headers
- stripe-webhook no longer has duplicate getAllowedOrigin/getCorsHeaders logic
- resend-webhook preserves svix headers via extra headers parameter
- Setting ALLOWED_ORIGINS env var in Supabase restricts all functions to production domains
</success_criteria>

<output>
After completion, create `.planning/phases/17-security-lockdown/17-02-SUMMARY.md`
</output>
