---
phase: 02-email-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/migrations/20260130100000_email_queue.sql
autonomous: true

must_haves:
  truths:
    - "Email queue table exists with correct schema and indexes"
    - "Email delivery status table exists for webhook tracking"
    - "RLS policies allow service role full access"
  artifacts:
    - path: "maguey-pass-lounge/supabase/migrations/20260130100000_email_queue.sql"
      provides: "email_queue and email_delivery_status tables"
      contains: "CREATE TABLE email_queue"
  key_links:
    - from: "email_queue"
      to: "email_delivery_status"
      via: "resend_email_id foreign key pattern"
      pattern: "resend_email_id"
---

<objective>
Create database schema for email queue and delivery tracking.

Purpose: Foundation for reliable email delivery - stores pending emails for retry and tracks delivery status via Resend webhooks.
Output: Migration file with email_queue and email_delivery_status tables, indexes, and RLS policies.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-reliability/02-CONTEXT.md
@.planning/phases/02-email-reliability/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email queue migration</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130100000_email_queue.sql</files>
  <action>
Create SQL migration with:

1. **email_queue table:**
```sql
CREATE TABLE email_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email_type TEXT NOT NULL CHECK (email_type IN ('ga_ticket', 'vip_confirmation')),
  recipient_email TEXT NOT NULL,
  subject TEXT NOT NULL,
  html_body TEXT NOT NULL,
  related_id UUID,  -- ticket_id or reservation_id
  resend_email_id TEXT,  -- Populated after successful send
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'sent', 'delivered', 'failed')),
  attempt_count INTEGER DEFAULT 0,
  max_attempts INTEGER DEFAULT 5,
  next_retry_at TIMESTAMPTZ DEFAULT NOW(),
  last_error TEXT,
  error_context JSONB DEFAULT '{}'::JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

2. **Indexes for queue processing:**
```sql
CREATE INDEX idx_email_queue_pending ON email_queue(next_retry_at)
  WHERE status = 'pending';
CREATE INDEX idx_email_queue_resend_id ON email_queue(resend_email_id)
  WHERE resend_email_id IS NOT NULL;
CREATE INDEX idx_email_queue_related ON email_queue(related_id, email_type);
```

3. **email_delivery_status table for webhook tracking:**
```sql
CREATE TABLE email_delivery_status (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  resend_email_id TEXT NOT NULL,
  event_type TEXT NOT NULL,  -- email.sent, email.delivered, email.bounced
  event_data JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_email_delivery_resend_id ON email_delivery_status(resend_email_id);
```

4. **RLS Policies:**
- Enable RLS on both tables
- Service role full access (for edge functions)
- Authenticated users can view their own email status (via related_id join to their tickets/reservations)

5. **Trigger for updated_at:**
```sql
CREATE TRIGGER update_email_queue_updated_at
  BEFORE UPDATE ON email_queue
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

Note: Assume update_updated_at_column() function exists from prior migrations. If not, create it.
  </action>
  <verify>
Run `supabase db diff` or check migration syntax. The migration file should be valid SQL that can be applied with `supabase db push`.
  </verify>
  <done>
Migration file exists at specified path with email_queue table, email_delivery_status table, indexes, RLS policies, and updated_at trigger.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply migration to local database</name>
  <files>maguey-pass-lounge/supabase/migrations/20260130100000_email_queue.sql</files>
  <action>
Apply the migration to the local Supabase database:
```bash
cd maguey-pass-lounge
supabase db push
```

If there are errors, fix the migration SQL and retry.

Verify tables exist:
```bash
supabase db execute --sql "SELECT table_name FROM information_schema.tables WHERE table_name IN ('email_queue', 'email_delivery_status');"
```
  </action>
  <verify>
`supabase db push` succeeds without errors. Query confirms both tables exist.
  </verify>
  <done>
Tables email_queue and email_delivery_status exist in local database with correct schema.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at specified path
- [ ] `supabase db push` succeeds
- [ ] email_queue table has correct columns and constraints
- [ ] email_delivery_status table has correct columns
- [ ] Indexes exist for efficient queue processing
- [ ] RLS policies are in place
</verification>

<success_criteria>
- Migration file created and applied successfully
- email_queue table ready for email queueing
- email_delivery_status table ready for webhook tracking
- Indexes optimize query performance for queue processing
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-reliability/02-01-SUMMARY.md`
</output>
