---
phase: 02-email-reliability
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - maguey-pass-lounge/supabase/functions/resend-webhook/index.ts
autonomous: true
user_setup:
  - service: resend
    why: "Receive email delivery status webhooks"
    env_vars:
      - name: RESEND_WEBHOOK_SECRET
        source: "Resend Dashboard -> Webhooks -> Create Webhook -> Copy Signing Secret"
    dashboard_config:
      - task: "Create webhook endpoint pointing to your-project-url/functions/v1/resend-webhook"
        location: "Resend Dashboard -> Webhooks -> Add Webhook"

must_haves:
  truths:
    - "Resend webhook signature is verified using svix"
    - "email.delivered events update email_queue status to delivered"
    - "email.bounced events update email_queue status to failed"
    - "All events are logged in email_delivery_status for audit"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/resend-webhook/index.ts"
      provides: "Resend webhook handler edge function"
      exports: ["serve"]
      min_lines: 70
  key_links:
    - from: "resend-webhook"
      to: "email_queue table"
      via: "update by resend_email_id"
      pattern: "eq\\('resend_email_id'"
    - from: "resend-webhook"
      to: "email_delivery_status table"
      via: "insert event record"
      pattern: "from\\('email_delivery_status'\\)"
---

<objective>
Create edge function to handle Resend webhooks for delivery tracking.

Purpose: Receive real-time delivery status updates from Resend to know when emails are actually delivered or bounced, updating email_queue status accordingly.
Output: Edge function that verifies webhook signatures and updates email status based on delivery events.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-reliability/02-CONTEXT.md
@.planning/phases/02-email-reliability/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resend-webhook edge function</name>
  <files>maguey-pass-lounge/supabase/functions/resend-webhook/index.ts</files>
  <action>
Create the edge function following the pattern from 02-RESEARCH.md:

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { Webhook } from "https://esm.sh/svix@1.34.0";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, svix-id, svix-timestamp, svix-signature",
};

interface ResendWebhookEvent {
  type: string;
  data: {
    email_id: string;
    from: string;
    to: string[];
    subject: string;
    created_at: string;
    // Bounce-specific fields
    bounce?: {
      message: string;
      type: string;
    };
    // Additional event-specific data
    [key: string]: unknown;
  };
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const webhookSecret = Deno.env.get("RESEND_WEBHOOK_SECRET");

    if (!webhookSecret) {
      console.error("RESEND_WEBHOOK_SECRET not configured");
      return new Response("Server misconfigured", {
        status: 500,
        headers: corsHeaders,
      });
    }

    // Get raw body for signature verification (must be done BEFORE parsing)
    const rawBody = await req.text();

    // Verify webhook signature using svix
    const wh = new Webhook(webhookSecret);
    const svixHeaders = {
      "svix-id": req.headers.get("svix-id") || "",
      "svix-timestamp": req.headers.get("svix-timestamp") || "",
      "svix-signature": req.headers.get("svix-signature") || "",
    };

    let event: ResendWebhookEvent;
    try {
      event = wh.verify(rawBody, svixHeaders) as ResendWebhookEvent;
    } catch (err) {
      console.error("Webhook signature verification failed:", err);
      return new Response("Invalid signature", {
        status: 401,
        headers: corsHeaders,
      });
    }

    const supabase = createClient(
      Deno.env.get("SUPABASE_URL")!,
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
    );

    const { type, data } = event;
    const resendEmailId = data.email_id;
    const now = new Date().toISOString();

    console.log(`Resend webhook: ${type} for email ${resendEmailId}`);

    // Update email_queue status based on event type
    switch (type) {
      case "email.sent":
        // Email accepted by Resend - we already mark as 'sent' when we get the response
        // This is a confirmation, no action needed
        console.log(`Email ${resendEmailId} confirmed sent`);
        break;

      case "email.delivered":
        // Email successfully delivered to recipient
        await supabase
          .from('email_queue')
          .update({
            status: 'delivered',
            updated_at: now
          })
          .eq('resend_email_id', resendEmailId);
        console.log(`Email ${resendEmailId} delivered successfully`);
        break;

      case "email.delivery_delayed":
        // Delivery delayed - log but don't change status, may still succeed
        console.warn(`Email ${resendEmailId} delivery delayed`);
        break;

      case "email.bounced":
        // Email bounced - permanent failure
        await supabase
          .from('email_queue')
          .update({
            status: 'failed',
            last_error: `Bounced: ${data.bounce?.message || 'Unknown bounce reason'}`,
            error_context: {
              bounce_type: data.bounce?.type,
              bounce_message: data.bounce?.message,
              webhook_received: now,
            },
            updated_at: now,
          })
          .eq('resend_email_id', resendEmailId);
        console.error(`Email ${resendEmailId} bounced: ${data.bounce?.message}`);
        break;

      case "email.complained":
        // Recipient marked as spam - treat as failure to avoid future issues
        await supabase
          .from('email_queue')
          .update({
            status: 'failed',
            last_error: 'Recipient marked email as spam',
            error_context: { complaint: true, webhook_received: now },
            updated_at: now,
          })
          .eq('resend_email_id', resendEmailId);
        console.warn(`Email ${resendEmailId} marked as spam by recipient`);
        break;

      default:
        console.log(`Unhandled Resend event type: ${type}`);
    }

    // Store in email_delivery_status for audit trail (all events)
    const { error: insertError } = await supabase
      .from('email_delivery_status')
      .insert({
        resend_email_id: resendEmailId,
        event_type: type,
        event_data: data,
      });

    if (insertError) {
      console.error("Error inserting delivery status:", insertError);
      // Don't fail the webhook - status update is more important
    }

    return new Response(JSON.stringify({ received: true }), {
      status: 200,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error) {
    console.error("Resend webhook error:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
```

Key implementation details:
- Uses svix library for webhook signature verification (Resend uses Svix infrastructure)
- MUST read raw body before parsing for signature verification
- Handles email.sent, email.delivered, email.bounced, email.delivery_delayed, email.complained
- Stores all events in email_delivery_status for audit trail
- Updates email_queue status for delivery/bounce events
  </action>
  <verify>
Check the function exists:
```bash
cat maguey-pass-lounge/supabase/functions/resend-webhook/index.ts
```
Verify svix import and signature verification logic are present.
  </verify>
  <done>
Edge function exists at specified path with svix signature verification, event handling for all relevant Resend events, and proper database updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CORS for Resend webhook headers</name>
  <files>maguey-pass-lounge/supabase/functions/resend-webhook/index.ts</files>
  <action>
Verify the CORS headers include svix headers:
```typescript
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, svix-id, svix-timestamp, svix-signature",
};
```

This is already in the Task 1 implementation. Verify it's correct.

Also ensure the function handles the case where RESEND_WEBHOOK_SECRET is not set (returns 500 with helpful error).
  </action>
  <verify>
CORS headers include svix headers. Function returns helpful error if webhook secret not configured.
  </verify>
  <done>
CORS headers properly configured for Resend webhook requests.
  </done>
</task>

</tasks>

<verification>
- [ ] resend-webhook/index.ts exists with correct logic
- [ ] Webhook signature verified using svix library
- [ ] email.delivered updates status to 'delivered'
- [ ] email.bounced updates status to 'failed' with bounce reason
- [ ] All events logged to email_delivery_status
- [ ] CORS headers include svix headers
</verification>

<success_criteria>
- Edge function correctly verifies Resend webhook signatures
- Delivery events update email_queue status
- Bounce events mark emails as failed
- Audit trail maintained in email_delivery_status
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-reliability/02-03-SUMMARY.md`
</output>
