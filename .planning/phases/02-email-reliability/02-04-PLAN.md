---
phase: 02-email-reliability
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
autonomous: true

must_haves:
  truths:
    - "Stripe webhook queues emails instead of sending directly"
    - "GA ticket emails are queued with correct email_type"
    - "VIP confirmation emails are queued with correct email_type"
    - "Email HTML is generated before queueing"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts"
      provides: "Modified webhook with email queueing"
      contains: "email_queue"
  key_links:
    - from: "stripe-webhook"
      to: "email_queue table"
      via: "supabase.from('email_queue').insert"
      pattern: "from\\('email_queue'\\)\\.insert"
---

<objective>
Modify stripe-webhook to queue emails instead of sending directly.

Purpose: Decouple email sending from webhook processing so emails are handled by the queue processor with retry capability, ensuring webhook responds to Stripe within 5 seconds.
Output: Updated stripe-webhook that inserts emails into email_queue table instead of calling Resend directly.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-reliability/02-CONTEXT.md
@.planning/phases/02-email-reliability/02-RESEARCH.md
@.planning/phases/01-payment-flow-hardening/01-02-SUMMARY.md
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create queueEmail helper function</name>
  <files>maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts</files>
  <action>
Add a helper function at the top of stripe-webhook/index.ts (after the imports) to queue emails:

```typescript
// ============================================
// Email Queue Helper
// ============================================

interface QueueEmailParams {
  emailType: 'ga_ticket' | 'vip_confirmation';
  recipientEmail: string;
  subject: string;
  htmlBody: string;
  relatedId?: string;
}

async function queueEmail(
  supabase: ReturnType<typeof createClient>,
  params: QueueEmailParams
): Promise<void> {
  const { error } = await supabase
    .from('email_queue')
    .insert({
      email_type: params.emailType,
      recipient_email: params.recipientEmail,
      subject: params.subject,
      html_body: params.htmlBody,
      related_id: params.relatedId,
      status: 'pending',
      attempt_count: 0,
      max_attempts: 5,
      next_retry_at: new Date().toISOString(),
    });

  if (error) {
    console.error('Failed to queue email:', {
      error: error.message,
      emailType: params.emailType,
      recipient: params.recipientEmail,
      relatedId: params.relatedId,
    });
    // Don't throw - webhook must return 200 to Stripe
    // Email will need manual intervention if queue insert fails
  } else {
    console.log('Email queued successfully:', {
      emailType: params.emailType,
      recipient: params.recipientEmail,
      relatedId: params.relatedId,
    });
  }
}
```

This helper:
- Takes email parameters and inserts into email_queue
- Logs success/failure without throwing (webhook must respond 200 to Stripe)
- Uses structured logging for debugging
  </action>
  <verify>
queueEmail function exists in stripe-webhook/index.ts with correct interface and implementation.
  </verify>
  <done>
queueEmail helper function added to stripe-webhook with proper error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor sendTicketEmail to generate HTML and queue</name>
  <files>maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts</files>
  <action>
Modify the sendTicketEmail function to:
1. Keep the HTML generation logic
2. Instead of calling Resend API directly, call queueEmail

Replace the sendTicketEmail function with:

```typescript
async function sendTicketEmail(
  supabase: ReturnType<typeof createClient>,
  to: string,
  customerName: string,
  orderId: string,
  tickets: TicketEmailData[]
): Promise<void> {
  // Skip if no tickets
  if (!tickets.length) {
    console.warn("sendTicketEmail called with no tickets");
    return;
  }

  const eventName = tickets[0]?.eventName || "Event";

  // Generate email HTML (same as before)
  const ticketHtml = tickets.map((ticket, index) => `
    <div style="border: 2px solid #6366f1; border-radius: 8px; padding: 20px; margin: 15px 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <h3 style="color: white; margin: 0 0 15px 0;">Ticket ${index + 1}: ${ticket.ticketType}</h3>
      <div style="background: white; padding: 15px; border-radius: 6px;">
        <p style="margin: 5px 0;"><strong>Event:</strong> ${ticket.eventName}</p>
        <p style="margin: 5px 0;"><strong>Date:</strong> ${ticket.eventDate}</p>
        <p style="margin: 5px 0;"><strong>Time:</strong> ${ticket.eventTime}</p>
        <p style="margin: 5px 0;"><strong>Venue:</strong> ${ticket.venueName}</p>
        <p style="margin: 5px 0;"><strong>Ticket ID:</strong> <code>${ticket.ticketId}</code></p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; color: #666;">
          Present this ticket at the venue. A QR code will be available in your account.
        </p>
      </div>
    </div>
  `).join("");

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Your Maguey Tickets</title>
    </head>
    <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5;">
      <div style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; padding-bottom: 20px;">
          <h1 style="color: #6366f1; margin: 0;">MAGUEY</h1>
        </div>

        <div style="background: #10b981; color: white; padding: 15px; border-radius: 6px; text-align: center; margin-bottom: 30px;">
          Payment Successful! Your tickets are confirmed.
        </div>

        <p>Hi ${customerName},</p>
        <p>Thank you for your purchase! Your digital tickets for <strong>${eventName}</strong> are ready.</p>

        ${ticketHtml}

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px;">
          <h3 style="margin-top: 0; color: #856404;">Important Information</h3>
          <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
            <li>Valid government-issued ID required at entrance</li>
            <li>Arrive 30 minutes before event time</li>
            <li>Your QR code will be in your account dashboard</li>
            <li>Tickets are non-transferable and non-refundable</li>
          </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
          <a href="https://tickets.magueynightclub.com/account" style="display: inline-block; padding: 12px 24px; background: #6366f1; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
            View My Tickets
          </a>
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; color: #666; font-size: 14px;">
          <p><strong>Order ID:</strong> ${orderId}</p>
          <p>Questions? Contact us at support@magueynightclub.com</p>
        </div>
      </div>
    </body>
    </html>
  `;

  // Queue email instead of sending directly
  await queueEmail(supabase, {
    emailType: 'ga_ticket',
    recipientEmail: to,
    subject: `Your Maguey Tickets - Order Confirmed`,
    htmlBody: html,
    relatedId: orderId,
  });
}
```

Update the function signature to accept supabase client as first parameter. Update all call sites to pass supabase.
  </action>
  <verify>
sendTicketEmail now calls queueEmail instead of fetch to Resend API directly.
  </verify>
  <done>
sendTicketEmail refactored to queue emails. All call sites updated to pass supabase client.
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor sendVipConfirmationEmail to generate HTML and queue</name>
  <files>maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts</files>
  <action>
Modify sendVipConfirmationEmail similarly:
1. Keep all the HTML generation logic (it's complex with QR codes, guest passes, etc.)
2. Instead of calling Resend API directly, call queueEmail
3. Update function signature to accept supabase client as first parameter

At the end of the function, replace the try/catch block that calls Resend with:

```typescript
// Queue email instead of sending directly
await queueEmail(supabase, {
  emailType: 'vip_confirmation',
  recipientEmail: data.customerEmail,
  subject: `VIP Table Confirmed - ${data.eventName}`,
  htmlBody: html,
  relatedId: data.reservationId,
});
```

Remove the try/catch around fetch("https://api.resend.com/emails") and replace with the queueEmail call.

Update all call sites to pass supabase client:
- Find all calls to sendVipConfirmationEmail() in the webhook
- Add supabase as first parameter

The function signature becomes:
```typescript
async function sendVipConfirmationEmail(
  supabase: ReturnType<typeof createClient>,
  data: VipEmailData
): Promise<void>
```
  </action>
  <verify>
sendVipConfirmationEmail now calls queueEmail. All call sites updated.
  </verify>
  <done>
sendVipConfirmationEmail refactored to queue emails. VIP confirmation emails go through the queue with retry.
  </done>
</task>

</tasks>

<verification>
- [ ] queueEmail helper function exists
- [ ] sendTicketEmail calls queueEmail instead of Resend API
- [ ] sendVipConfirmationEmail calls queueEmail instead of Resend API
- [ ] All call sites updated to pass supabase client
- [ ] Webhook still returns 200 to Stripe (no blocking on email)
- [ ] Email HTML generation preserved (QR codes, styling, etc.)
</verification>

<success_criteria>
- Stripe webhook queues all emails to email_queue table
- GA ticket and VIP confirmation emails both use the queue
- Webhook responds quickly to Stripe (no email API calls blocking)
- Email content identical to before (just delivery mechanism changed)
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-reliability/02-04-SUMMARY.md`
</output>
