---
phase: 02-email-reliability
plan: 05
type: execute
wave: 4
depends_on: ["02-01", "02-04"]
files_modified:
  - maguey-gate-scanner/src/pages/OwnerDashboard.tsx
  - maguey-gate-scanner/src/lib/email-status-service.ts
autonomous: true

must_haves:
  truths:
    - "Owner can see email status for each ticket"
    - "Owner can see email status for each VIP reservation"
    - "Failed emails show retry button"
    - "Email status updates when webhook delivers"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/email-status-service.ts"
      provides: "Email status query functions"
      exports: ["getTicketEmailStatus", "getReservationEmailStatus", "retryFailedEmail"]
    - path: "maguey-gate-scanner/src/pages/OwnerDashboard.tsx"
      provides: "Dashboard with email status indicators"
      contains: "emailStatus"
  key_links:
    - from: "OwnerDashboard"
      to: "email_queue table"
      via: "email-status-service"
      pattern: "getTicketEmailStatus|getReservationEmailStatus"
---

<objective>
Add email status indicators and retry buttons to owner dashboard.

Purpose: Give owners visibility into email delivery status and ability to retry failed emails without developer intervention.
Output: Dashboard shows email status per ticket/reservation with retry capability for failed emails.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-reliability/02-CONTEXT.md
@maguey-gate-scanner/src/pages/OwnerDashboard.tsx
@maguey-gate-scanner/src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email status service</name>
  <files>maguey-gate-scanner/src/lib/email-status-service.ts</files>
  <action>
Create a service to query and manage email status:

```typescript
import { supabase } from './supabase';

export interface EmailQueueStatus {
  id: string;
  email_type: 'ga_ticket' | 'vip_confirmation';
  status: 'pending' | 'processing' | 'sent' | 'delivered' | 'failed';
  attempt_count: number;
  last_error: string | null;
  created_at: string;
  updated_at: string;
}

/**
 * Get email status for a ticket by order_id
 */
export async function getTicketEmailStatus(orderId: string): Promise<EmailQueueStatus | null> {
  const { data, error } = await supabase
    .from('email_queue')
    .select('id, email_type, status, attempt_count, last_error, created_at, updated_at')
    .eq('email_type', 'ga_ticket')
    .eq('related_id', orderId)
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  if (error) {
    console.error('Error fetching ticket email status:', error);
    return null;
  }

  return data as EmailQueueStatus;
}

/**
 * Get email status for a VIP reservation
 */
export async function getReservationEmailStatus(reservationId: string): Promise<EmailQueueStatus | null> {
  const { data, error } = await supabase
    .from('email_queue')
    .select('id, email_type, status, attempt_count, last_error, created_at, updated_at')
    .eq('email_type', 'vip_confirmation')
    .eq('related_id', reservationId)
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  if (error) {
    console.error('Error fetching reservation email status:', error);
    return null;
  }

  return data as EmailQueueStatus;
}

/**
 * Get all email statuses for display (recent emails with their status)
 */
export async function getRecentEmailStatuses(limit: number = 50): Promise<EmailQueueStatus[]> {
  const { data, error } = await supabase
    .from('email_queue')
    .select('id, email_type, status, attempt_count, last_error, created_at, updated_at, recipient_email, subject, related_id')
    .order('created_at', { ascending: false })
    .limit(limit);

  if (error) {
    console.error('Error fetching recent email statuses:', error);
    return [];
  }

  return data as EmailQueueStatus[];
}

/**
 * Retry a failed email by resetting it to pending
 */
export async function retryFailedEmail(emailId: string): Promise<{ success: boolean; error?: string }> {
  const { error } = await supabase
    .from('email_queue')
    .update({
      status: 'pending',
      attempt_count: 0,
      next_retry_at: new Date().toISOString(),
      last_error: null,
      updated_at: new Date().toISOString(),
    })
    .eq('id', emailId)
    .eq('status', 'failed');  // Only retry if currently failed

  if (error) {
    console.error('Error retrying email:', error);
    return { success: false, error: error.message };
  }

  return { success: true };
}

/**
 * Get email status badge color
 */
export function getEmailStatusColor(status: string): string {
  switch (status) {
    case 'delivered':
      return 'bg-green-100 text-green-800';
    case 'sent':
      return 'bg-blue-100 text-blue-800';
    case 'pending':
    case 'processing':
      return 'bg-yellow-100 text-yellow-800';
    case 'failed':
      return 'bg-red-100 text-red-800';
    default:
      return 'bg-gray-100 text-gray-800';
  }
}

/**
 * Get human-readable status label
 */
export function getEmailStatusLabel(status: string): string {
  switch (status) {
    case 'delivered':
      return 'Delivered';
    case 'sent':
      return 'Sent';
    case 'pending':
      return 'Pending';
    case 'processing':
      return 'Sending...';
    case 'failed':
      return 'Failed';
    default:
      return status;
  }
}
```

This service provides:
- Query email status by order ID or reservation ID
- Get recent emails for dashboard display
- Retry failed emails by resetting to pending
- Helper functions for status badge colors and labels
  </action>
  <verify>
File exists at maguey-gate-scanner/src/lib/email-status-service.ts with all exported functions.
  </verify>
  <done>
Email status service created with query, retry, and display helper functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add email status to OwnerDashboard</name>
  <files>maguey-gate-scanner/src/pages/OwnerDashboard.tsx</files>
  <action>
Update OwnerDashboard to show email status. This is a minimal integration - add to the existing ticket/reservation tables:

1. Import the email status service:
```typescript
import {
  getRecentEmailStatuses,
  retryFailedEmail,
  getEmailStatusColor,
  getEmailStatusLabel,
  EmailQueueStatus
} from '@/lib/email-status-service';
```

2. Add state for email statuses:
```typescript
const [emailStatuses, setEmailStatuses] = useState<Map<string, EmailQueueStatus>>(new Map());
```

3. Fetch email statuses when dashboard loads:
```typescript
useEffect(() => {
  async function fetchEmailStatuses() {
    const statuses = await getRecentEmailStatuses(100);
    const statusMap = new Map<string, EmailQueueStatus>();
    for (const status of statuses) {
      if (status.related_id) {
        statusMap.set(status.related_id, status);
      }
    }
    setEmailStatuses(statusMap);
  }
  fetchEmailStatuses();
}, []);
```

4. Add an email status badge component:
```typescript
function EmailStatusBadge({ relatedId, emailStatuses, onRetry }: {
  relatedId: string;
  emailStatuses: Map<string, EmailQueueStatus>;
  onRetry: (id: string) => void;
}) {
  const status = emailStatuses.get(relatedId);
  if (!status) return <span className="text-gray-400 text-sm">No email</span>;

  return (
    <div className="flex items-center gap-2">
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${getEmailStatusColor(status.status)}`}>
        {getEmailStatusLabel(status.status)}
      </span>
      {status.status === 'failed' && (
        <button
          onClick={() => onRetry(status.id)}
          className="text-xs text-blue-600 hover:text-blue-800 underline"
        >
          Retry
        </button>
      )}
    </div>
  );
}
```

5. Add retry handler:
```typescript
const handleRetryEmail = async (emailId: string) => {
  const result = await retryFailedEmail(emailId);
  if (result.success) {
    // Refresh email statuses
    const statuses = await getRecentEmailStatuses(100);
    const statusMap = new Map<string, EmailQueueStatus>();
    for (const status of statuses) {
      if (status.related_id) {
        statusMap.set(status.related_id, status);
      }
    }
    setEmailStatuses(statusMap);
  } else {
    // Show error toast if available
    console.error('Failed to retry email:', result.error);
  }
};
```

6. Add email status column to ticket/order tables in the dashboard where orders are displayed. The exact location depends on the current dashboard structure - look for where orders or tickets are rendered in a table.

This is a minimal integration. The dashboard may have various sections - add email status to whichever section displays recent orders or tickets.
  </action>
  <verify>
OwnerDashboard imports email-status-service and renders email status badges with retry buttons.
  </verify>
  <done>
OwnerDashboard shows email status per ticket/reservation with retry capability for failed emails.
  </done>
</task>

</tasks>

<verification>
- [ ] email-status-service.ts exists with all functions
- [ ] OwnerDashboard imports and uses the service
- [ ] Email status badges display correctly
- [ ] Retry button appears for failed emails
- [ ] Retry resets email to pending status
</verification>

<success_criteria>
- Owners can see email delivery status in dashboard
- Failed emails have visible retry button
- Retry successfully requeues email for processing
- Status updates reflect actual queue state
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-reliability/02-05-SUMMARY.md`
</output>
