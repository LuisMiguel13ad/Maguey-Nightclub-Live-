---
phase: 11-error-handling-recovery
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/playwright/tests/scanner-offline.spec.ts
  - e2e/specs/offline/offline-recovery.cy.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Scanner shows clear offline indicator when network is unavailable"
    - "Offline scans are queued in IndexedDB and sync when reconnected"
    - "Invalid QR codes are rejected with user-friendly error"
    - "Already-scanned tickets show 'already used' rejection"
    - "Online indicator shows when reconnected"
  artifacts:
    - path: "maguey-pass-lounge/playwright/tests/scanner-offline.spec.ts"
      provides: "Scanner offline mode Playwright tests"
      min_lines: 120
    - path: "e2e/specs/offline/offline-recovery.cy.ts"
      provides: "Offline recovery and sync tests"
      min_lines: 80
  key_links:
    - from: "scanner-offline.spec.ts"
      to: "offline-queue-service.ts"
      via: "queueScan function"
      pattern: "queueScan|syncPendingScans"
    - from: "offline-recovery.cy.ts"
      to: "offline-ticket-cache.ts"
      via: "IndexedDB cache"
      pattern: "OfflineCacheDatabase|dexie"
---

<objective>
Scanner Offline Test Suite

Purpose: Validate that the gate scanner handles network failures gracefully - shows clear offline indicator, queues scans for later sync, rejects invalid QR codes with helpful messages, and properly syncs queued scans when connectivity returns.

Output: Two test files covering offline mode, queue persistence, auto-sync, and error rejection scenarios.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing scanner offline infrastructure
@maguey-gate-scanner/src/lib/offline-queue-service.ts
@maguey-gate-scanner/src/lib/offline-ticket-cache.ts
@maguey-gate-scanner/src/lib/vip-offline-queue-service.ts

# Existing offline tests
@e2e/specs/offline/offline-scan.cy.ts

# Scanner page
@maguey-gate-scanner/src/pages/Scanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive Playwright scanner offline tests</name>
  <files>maguey-pass-lounge/playwright/tests/scanner-offline.spec.ts</files>
  <action>
Create Playwright tests for scanner offline scenarios using context.setOffline():

1. **Test: Offline indicator appears when network lost**
   - Login to scanner app
   - Navigate to scanner page
   - Use `await context.setOffline(true)` to simulate network loss
   - Trigger a network request (manual entry scan)
   - Verify offline indicator visible (banner, icon, or modal)
   - Selector patterns: `[data-cy="offline-indicator"]`, `.offline-banner`, `text=Offline`

2. **Test: Offline scans are queued to IndexedDB**
   - Go offline with `context.setOffline(true)`
   - Enter manual QR token and submit
   - Verify scan result shows "queued" or "offline mode" indicator
   - Use page.evaluate to check IndexedDB:
   ```typescript
   const queuedScans = await page.evaluate(async () => {
     const db = await window.indexedDB.open('OfflineQueueDatabase');
     // Query queuedScans store
   });
   expect(queuedScans).toHaveLength(1);
   ```

3. **Test: Auto-sync when network restored**
   - Queue a scan while offline
   - Use `await context.setOffline(false)` to restore network
   - Wait for sync to complete (poll syncStatus)
   - Verify queued scan processed (status='synced' in IndexedDB)
   - Verify online indicator shown

4. **Test: Invalid QR code rejection with clear message**
   - Create invalid QR token (random string, not in database)
   - Submit via manual entry
   - Verify rejection overlay appears with user-friendly message
   - Message should NOT contain technical details
   - Verify dismiss button works

5. **Test: Already-scanned ticket rejection**
   - Create test ticket and scan it once (mark as used)
   - Attempt to scan same ticket again
   - Verify "already used" rejection overlay
   - Verify ticket info shown (ticket ID, scan time)

Scanner app URL: Use SCANNER_URL from environment
Login: Use SCANNER_EMAIL/SCANNER_PASSWORD

Note: Use Playwright's built-in offline simulation rather than route interception where possible.
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-pass-lounge && npx playwright test scanner-offline.spec.ts` passes
  </verify>
  <done>
Tests verify: offline indicator shown, scans queued to IndexedDB, auto-sync works, invalid QR rejected, already-scanned rejected
  </done>
</task>

<task type="auto">
  <name>Task 2: Create offline recovery and sync verification tests</name>
  <files>e2e/specs/offline/offline-recovery.cy.ts</files>
  <action>
Create Cypress tests for offline recovery scenarios:

1. **Test: Offline queue persists across page reload**
   - Go offline (cy.intercept forceNetworkError)
   - Queue a scan via manual entry
   - Reload page
   - Verify offline queue still contains scan
   - Use cy.window to access IndexedDB

2. **Test: Sync reports success/failure counts**
   - Queue multiple scans offline (3 valid, 1 invalid)
   - Restore network
   - Trigger sync
   - Verify sync result: success=3, failed=1
   - Check sync history logged

3. **Test: Conflict resolution (first-scan-wins)**
   - Create test ticket
   - Scan offline on "device A" (this test)
   - Simulate scan on "device B" (direct DB update)
   - Restore network and sync "device A"
   - Verify conflict resolved - ticket marked as used, scan logged with conflict note

4. **Test: Exponential backoff on sync failures**
   - Queue a scan
   - Intercept sync endpoint to fail
   - Trigger sync attempt
   - Verify retryCount incremented
   - Verify nextRetryAt follows exponential backoff

5. **Test: Old synced scans cleaned up after 7 days**
   - Insert old synced scan (8 days ago) via cy.task
   - Call clearOldSyncedScans
   - Verify old scan deleted
   - Recent synced scans remain

Use existing patterns from e2e/specs/offline/offline-scan.cy.ts

IndexedDB access via cy.window:
```typescript
cy.window().then(async (win) => {
  // Access Dexie database directly
  const db = new win.Dexie('OfflineQueueDatabase');
  await db.open();
  const scans = await db.table('queuedScans').toArray();
  return scans;
});
```
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live && npx cypress run --spec "e2e/specs/offline/offline-recovery.cy.ts" --config video=false` passes
  </verify>
  <done>
Tests verify: queue persists across reload, sync reports accurate counts, conflicts resolved, exponential backoff works, old scans cleaned up
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify user-friendly error messages in scanner</name>
  <files>maguey-pass-lounge/playwright/tests/scanner-offline.spec.ts</files>
  <action>
Add tests to scanner-offline.spec.ts for user-friendly error messages:

1. **Test: Network error shows friendly message**
   - Go offline during scan
   - Verify message like "You're offline. Scan queued for sync." or similar
   - NO technical jargon: no "NetworkError", "fetch failed", stack traces

2. **Test: Server error shows friendly message**
   - Intercept scan endpoint with 500 error
   - Verify user-friendly message: "Something went wrong. Please try again."
   - Verify retry suggestion shown

3. **Test: Invalid signature shows clear rejection**
   - Submit QR with invalid signature
   - Verify "Invalid ticket" message (not "Signature verification failed")

4. **Test: Expired ticket shows clear rejection**
   - Create test ticket for past event
   - Attempt scan
   - Verify "This ticket has expired" or similar

5. **Test: All rejection overlays have recovery instructions**
   - For each rejection type, verify overlay includes:
     - Clear reason (what went wrong)
     - What to do next
     - Dismiss button

Reference Phase 7 UX decisions:
- Professional/formal tone (no technical jargon)
- Manual dismiss required for rejections
- Full red screen for all rejection types
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-pass-lounge && npx playwright test scanner-offline.spec.ts` passes
  </verify>
  <done>
Tests verify: all scanner error messages are user-friendly, no technical jargon exposed, recovery instructions provided
  </done>
</task>

</tasks>

<verification>
All scanner offline tests pass:
```bash
cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-pass-lounge
npx playwright test scanner-offline.spec.ts
cd .. && npx cypress run --spec "e2e/specs/offline/offline-recovery.cy.ts" --config video=false
```
</verification>

<success_criteria>
1. Offline indicator test passes - clear UI when network lost
2. Queue persistence test passes - IndexedDB stores scans
3. Auto-sync test passes - queued scans sync on reconnect within 5 minutes
4. Invalid QR test passes - clear rejection message
5. Already-scanned test passes - "already used" shown
6. All error messages are user-friendly (no technical jargon)
</success_criteria>

<output>
After completion, create `.planning/phases/11-error-handling-recovery/11-03-SUMMARY.md`
</output>
