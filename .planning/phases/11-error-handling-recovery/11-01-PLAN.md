---
phase: 11-error-handling-recovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/specs/edge-cases/webhook-failures.cy.ts
  - e2e/specs/edge-cases/orphan-prevention.cy.ts
  - maguey-pass-lounge/playwright/tests/payment-recovery.spec.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Stripe webhook failures retry automatically via exponential backoff"
    - "Duplicate webhook events are idempotently handled (no duplicate tickets/reservations)"
    - "Payment failures do not leave orphaned records in database"
    - "Partial failures (payment success, ticket creation failure) notify owner"
  artifacts:
    - path: "e2e/specs/edge-cases/webhook-failures.cy.ts"
      provides: "Webhook timeout and retry verification tests"
      min_lines: 80
    - path: "e2e/specs/edge-cases/orphan-prevention.cy.ts"
      provides: "Orphan record prevention tests"
      min_lines: 60
    - path: "maguey-pass-lounge/playwright/tests/payment-recovery.spec.ts"
      provides: "Payment recovery E2E tests"
      min_lines: 100
  key_links:
    - from: "webhook-failures.cy.ts"
      to: "stripe-webhook/index.ts"
      via: "retryWithBackoff function"
      pattern: "retryWithBackoff"
    - from: "orphan-prevention.cy.ts"
      to: "stripe-webhook/index.ts"
      via: "idempotency check"
      pattern: "check_webhook_idempotency"
---

<objective>
Payment Failure Test Suite

Purpose: Validate that all payment failure scenarios are handled gracefully - declined cards show user-friendly errors, webhook failures retry automatically, duplicate webhooks don't create duplicate records, and partial failures (payment success but ticket creation failure) don't leave orphaned database records.

Output: Three test files covering Stripe decline cards, webhook retry verification, duplicate webhook idempotency, and orphan record prevention.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-error-handling-recovery/11-CONTEXT.md

# Existing test infrastructure
@e2e/specs/edge-cases/payment-failures.cy.ts
@maguey-pass-lounge/playwright/tests/checkout-failures.spec.ts
@maguey-pass-lounge/playwright/tests/webhook-idempotency.spec.ts

# Existing webhook implementation with retry logic
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook failure and retry verification tests</name>
  <files>e2e/specs/edge-cases/webhook-failures.cy.ts</files>
  <action>
Create Cypress tests that verify webhook retry behavior:

1. **Test: Webhook timeout triggers retry**
   - Intercept webhook endpoint with delayed response (simulate timeout)
   - Verify Stripe would retry (document expected behavior)
   - This is a behavioral documentation test since we can't control Stripe's retry

2. **Test: Duplicate webhook idempotency**
   - Use cy.task to directly insert a webhook_idempotency record
   - Call webhook endpoint with same event ID
   - Verify response indicates duplicate (200 with cached response)
   - Verify no duplicate ticket/reservation created

3. **Test: Partial failure notification**
   - Use existing test ticket creation
   - Intercept payment_failures table
   - Verify failed ticket creation logs to payment_failures
   - Verify owner notification endpoint called

Test data setup:
- Use existing cy.task('getTestEvent') and cy.task('createTestTicket')
- Use cy.task('queryEmailQueue') pattern for DB verification

Reference existing patterns from:
- e2e/specs/edge-cases/payment-failures.cy.ts for Cypress patterns
- maguey-pass-lounge/playwright/tests/webhook-idempotency.spec.ts for idempotency patterns
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live && npx cypress run --spec "e2e/specs/edge-cases/webhook-failures.cy.ts" --config video=false` passes
  </verify>
  <done>
Tests verify: duplicate webhooks return cached response without creating duplicate records, partial failures are logged for manual resolution
  </done>
</task>

<task type="auto">
  <name>Task 2: Create orphan record prevention tests</name>
  <files>e2e/specs/edge-cases/orphan-prevention.cy.ts</files>
  <action>
Create Cypress tests verifying no orphaned database records after failures:

1. **Test: Declined payment leaves no ticket record**
   - Complete checkout with Stripe decline card (4000000000000002)
   - Query tickets table for test email
   - Verify count is 0

2. **Test: Declined payment leaves no order record in 'paid' status**
   - Complete checkout with decline card
   - Query orders table for test email
   - Verify no order with status='paid' exists

3. **Test: Network error during checkout leaves no orphaned records**
   - Intercept create-checkout-session with forceNetworkError
   - Verify no ticket or order created

4. **Test: Verify database constraints prevent orphans**
   - Document the foreign key constraints that prevent orphans:
     - tickets.order_id -> orders.id
     - vip_reservations.event_vip_table_id -> event_vip_tables.id
   - Use cy.task to attempt invalid inserts (expect failure)

Use cy.task('supabaseQuery') pattern:
```typescript
// Add to cypress.config.ts tasks if not exists
supabaseQuery: async ({ table, query }) => {
  const { data, error } = await supabase.from(table).select(query.select).match(query.match);
  return { data, error };
}
```

Test email format: `orphan-test+${Date.now()}@test.maguey.com`
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live && npx cypress run --spec "e2e/specs/edge-cases/orphan-prevention.cy.ts" --config video=false` passes
  </verify>
  <done>
Tests verify: declined payments, network errors, and checkout failures leave no orphaned tickets, orders, or reservations in database
  </done>
</task>

<task type="auto">
  <name>Task 3: Create payment recovery Playwright tests</name>
  <files>maguey-pass-lounge/playwright/tests/payment-recovery.spec.ts</files>
  <action>
Create Playwright tests for VIP payment recovery scenarios:

1. **Test: VIP checkout recovery after network error**
   - Navigate through VIP checkout flow
   - Intercept create-vip-payment-intent with abort
   - Verify error toast appears
   - Verify retry button works (mock success on second attempt)

2. **Test: VIP reservation status after Stripe decline**
   - Start VIP checkout
   - Use Stripe test decline card via URL parameter simulation
   - Verify reservation stays in 'pending' status (not 'confirmed')
   - Verify table remains available

3. **Test: GA+VIP unified checkout failure rollback**
   - Start unified checkout (GA ticket + VIP table)
   - Simulate payment failure
   - Verify no ticket created
   - Verify no reservation confirmed
   - Verify table availability unchanged

4. **Test: Stripe test card decline scenarios**
   Document all decline card behaviors:
   - 4000000000000002: Generic decline
   - 4000000000009995: Insufficient funds
   - 4000000000000069: Expired card
   - 4000000000000119: Processing error

Use existing patterns from:
- maguey-pass-lounge/playwright/tests/checkout-failures.spec.ts
- maguey-pass-lounge/playwright/tests/vip-checkout.spec.ts

Note: These tests verify UI behavior and error handling. Actual Stripe decline happens on Stripe's hosted checkout page.
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-pass-lounge && npx playwright test payment-recovery.spec.ts` passes
  </verify>
  <done>
Tests verify: VIP checkout errors show retry button, failed payments don't leave confirmed reservations, unified checkout failures roll back cleanly
  </done>
</task>

</tasks>

<verification>
All payment failure tests pass:
```bash
cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live
npx cypress run --spec "e2e/specs/edge-cases/webhook-failures.cy.ts,e2e/specs/edge-cases/orphan-prevention.cy.ts" --config video=false
cd maguey-pass-lounge && npx playwright test payment-recovery.spec.ts
```
</verification>

<success_criteria>
1. Webhook idempotency test passes - duplicate events return cached response
2. Orphan prevention tests pass - no orphaned records after any failure scenario
3. Payment recovery tests pass - retry flows work, failed payments don't pollute database
4. All Stripe test card decline scenarios documented and tested
</success_criteria>

<output>
After completion, create `.planning/phases/11-error-handling-recovery/11-01-SUMMARY.md`
</output>
