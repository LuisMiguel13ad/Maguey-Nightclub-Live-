---
phase: 11-error-handling-recovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/specs/edge-cases/email-failures.cy.ts
  - maguey-pass-lounge/playwright/tests/email-retry.spec.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Failed email deliveries are logged in email_queue with status='failed'"
    - "Failed emails can be manually retried from owner dashboard"
    - "Permanent bounces are marked appropriately and don't retry indefinitely"
    - "Successful retry changes email_queue status to 'delivered'"
  artifacts:
    - path: "e2e/specs/edge-cases/email-failures.cy.ts"
      provides: "Email failure handling E2E tests"
      min_lines: 100
    - path: "maguey-pass-lounge/playwright/tests/email-retry.spec.ts"
      provides: "Dashboard email retry UI tests"
      min_lines: 80
  key_links:
    - from: "email-failures.cy.ts"
      to: "process-email-queue/index.ts"
      via: "exponential backoff retry"
      pattern: "calculateNextRetryTime"
    - from: "email-retry.spec.ts"
      to: "OwnerDashboard.tsx"
      via: "retry button click"
      pattern: "retry.*email|resend"
---

<objective>
Email Failure Test Suite

Purpose: Validate that email delivery failures are properly logged, can be retried from the dashboard, and permanent bounces are handled correctly. This validates the existing email queue infrastructure built in Phase 2.

Output: Two test files - one for email failure scenarios (Cypress) and one for dashboard retry UI (Playwright).
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing email infrastructure
@maguey-pass-lounge/supabase/functions/process-email-queue/index.ts
@maguey-pass-lounge/supabase/functions/resend-webhook/index.ts

# Existing email tests
@e2e/specs/happy-path/email-verification.cy.ts
@maguey-pass-lounge/playwright/tests/vip-email-delivery.spec.ts

# Dashboard with email status
@maguey-gate-scanner/src/pages/OwnerDashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email failure handling tests</name>
  <files>e2e/specs/edge-cases/email-failures.cy.ts</files>
  <action>
Create Cypress tests for email failure scenarios:

1. **Test: Initial delivery failure is logged**
   - Insert a test email into email_queue with invalid recipient
   - Use cy.task to call process-email-queue Edge Function
   - Verify email_queue entry has:
     - status: 'pending' (scheduled for retry) or 'failed' (max attempts)
     - last_error: contains error message
     - attempt_count: incremented

2. **Test: Exponential backoff schedule is correct**
   - Insert test email with attempt_count=0
   - Process queue (simulated failure)
   - Verify next_retry_at is ~1 minute from now
   - Update attempt_count=1, process again
   - Verify next_retry_at is ~2 minutes from now
   - Document the schedule: 1min -> 2min -> 4min -> 8min -> 16min -> capped at 30min

3. **Test: Max attempts exhausted marks as permanently failed**
   - Insert test email with attempt_count=4 (one below max)
   - Process queue (simulated failure)
   - Verify status changes to 'failed' (not 'pending')
   - Verify error_context contains final_failure: true

4. **Test: Permanent bounce handling via webhook**
   - Insert test email marked as 'sent' with resend_email_id
   - Simulate Resend webhook with event type 'email.bounced'
   - Verify email_queue status changes to 'bounced' or 'failed'
   - Verify email is not retried

Database manipulation via cy.task:
```typescript
// Add to cypress.config.ts tasks
insertEmailQueue: async (emailData) => {
  const { data, error } = await supabase
    .from('email_queue')
    .insert(emailData)
    .select()
    .single();
  return { data, error };
},
updateEmailQueue: async ({ id, updates }) => {
  const { data, error } = await supabase
    .from('email_queue')
    .update(updates)
    .eq('id', id)
    .select()
    .single();
  return { data, error };
},
getEmailQueueEntry: async (id) => {
  const { data, error } = await supabase
    .from('email_queue')
    .select('*')
    .eq('id', id)
    .single();
  return { data, error };
}
```

Test email format: `email-test+invalid@test.maguey.com`
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live && npx cypress run --spec "e2e/specs/edge-cases/email-failures.cy.ts" --config video=false` passes
  </verify>
  <done>
Tests verify: failed emails logged with error, exponential backoff schedule correct, max attempts marks as permanently failed, bounces handled correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard email retry UI tests</name>
  <files>maguey-pass-lounge/playwright/tests/email-retry.spec.ts</files>
  <action>
Create Playwright tests for owner dashboard email retry functionality:

1. **Test: Dashboard shows failed email entries**
   - Login to owner dashboard (scanner app)
   - Navigate to email status section
   - Verify failed emails are visible with:
     - Recipient email
     - Error message
     - Attempt count
     - Retry button

2. **Test: Retry button triggers email requeue**
   - Setup: Insert a failed email via API
   - Login to dashboard
   - Find the failed email entry
   - Click retry button
   - Verify email_queue entry status changes to 'pending'
   - Verify next_retry_at is set to now (immediate retry)

3. **Test: Successful retry updates status to delivered**
   - Insert failed email with valid recipient (use Resend test mode)
   - Click retry
   - Poll email_queue until status='sent' or 'delivered'
   - Verify UI updates to show success

4. **Test: Dashboard shows recent email activity**
   - Verify last 5 emails are shown (per STATE.md decision)
   - Verify real-time updates when email status changes
   - Use page.evaluate to trigger Supabase subscription

Scanner app URL: Use SCANNER_URL from environment
Login credentials: Use SCANNER_EMAIL/SCANNER_PASSWORD from environment

Dashboard email section selectors (inspect OwnerDashboard.tsx):
- Look for email status table/list
- Find retry buttons
- Real-time subscription indicator
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live/maguey-pass-lounge && npx playwright test email-retry.spec.ts` passes
  </verify>
  <done>
Tests verify: dashboard shows failed emails, retry button requeues email, successful retry shows in UI, real-time updates work
  </done>
</task>

<task type="auto">
  <name>Task 3: Update cypress.config.ts with email queue tasks</name>
  <files>e2e/cypress.config.ts</files>
  <action>
Add email queue manipulation tasks to cypress.config.ts:

```typescript
// Add to setupNodeEvents tasks object:
insertEmailQueue: async (emailData: {
  email_type: 'ga_ticket' | 'vip_confirmation';
  recipient_email: string;
  subject: string;
  html_body: string;
  related_id?: string;
  status?: string;
  attempt_count?: number;
  max_attempts?: number;
  next_retry_at?: string;
  last_error?: string;
}) => {
  const { data, error } = await supabase
    .from('email_queue')
    .insert({
      ...emailData,
      status: emailData.status || 'pending',
      attempt_count: emailData.attempt_count || 0,
      max_attempts: emailData.max_attempts || 5,
      next_retry_at: emailData.next_retry_at || new Date().toISOString(),
    })
    .select()
    .single();
  if (error) throw new Error(`insertEmailQueue failed: ${error.message}`);
  return data;
},

updateEmailQueue: async ({ id, updates }: { id: string; updates: Record<string, unknown> }) => {
  const { data, error } = await supabase
    .from('email_queue')
    .update({ ...updates, updated_at: new Date().toISOString() })
    .eq('id', id)
    .select()
    .single();
  if (error) throw new Error(`updateEmailQueue failed: ${error.message}`);
  return data;
},

getEmailQueueEntry: async (id: string) => {
  const { data, error } = await supabase
    .from('email_queue')
    .select('*')
    .eq('id', id)
    .single();
  if (error) throw new Error(`getEmailQueueEntry failed: ${error.message}`);
  return data;
},

deleteEmailQueueEntry: async (id: string) => {
  const { error } = await supabase
    .from('email_queue')
    .delete()
    .eq('id', id);
  if (error) throw new Error(`deleteEmailQueueEntry failed: ${error.message}`);
  return true;
},
```

Also add type declarations to e2e/support/index.d.ts:
```typescript
insertEmailQueue(emailData: EmailQueueInput): Chainable<EmailQueueEntry>;
updateEmailQueue(params: { id: string; updates: Record<string, unknown> }): Chainable<EmailQueueEntry>;
getEmailQueueEntry(id: string): Chainable<EmailQueueEntry>;
deleteEmailQueueEntry(id: string): Chainable<boolean>;
```
  </action>
  <verify>
`cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live && npx cypress run --spec "e2e/specs/edge-cases/email-failures.cy.ts" --config video=false` passes (tasks are available)
  </verify>
  <done>
Cypress tasks for email_queue manipulation are available and properly typed
  </done>
</task>

</tasks>

<verification>
All email failure tests pass:
```bash
cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live
npx cypress run --spec "e2e/specs/edge-cases/email-failures.cy.ts" --config video=false
cd maguey-pass-lounge && npx playwright test email-retry.spec.ts
```
</verification>

<success_criteria>
1. Email failure tests pass - failures logged, backoff correct, max attempts handled
2. Dashboard retry tests pass - retry button works, status updates in UI
3. Bounce handling test passes - permanent bounces don't retry
4. Real-time updates verified in dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/11-error-handling-recovery/11-02-SUMMARY.md`
</output>
