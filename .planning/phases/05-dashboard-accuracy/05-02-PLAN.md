---
phase: 05-dashboard-accuracy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/components/ui/LiveIndicator.tsx
  - maguey-gate-scanner/src/hooks/useDashboardRealtime.ts
  - maguey-gate-scanner/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows pulsing green Live indicator when connected"
    - "Dashboard reconnects automatically when tab regains focus"
    - "Data refreshes on visibility change without user action"
  artifacts:
    - path: "maguey-gate-scanner/src/components/ui/LiveIndicator.tsx"
      provides: "Live connection status indicator"
      min_lines: 20
    - path: "maguey-gate-scanner/src/hooks/useDashboardRealtime.ts"
      provides: "Real-time subscription hook with reconnection"
      exports: ["useDashboardRealtime"]
  key_links:
    - from: "useDashboardRealtime.ts"
      to: "supabase.channel"
      via: "postgres_changes subscription"
      pattern: "postgres_changes.*tickets|orders|vip_reservations"
    - from: "Dashboard.tsx"
      to: "LiveIndicator.tsx"
      via: "component render"
      pattern: "<LiveIndicator"
---

<objective>
Create reusable real-time infrastructure for dashboard with visibility-aware reconnection and live status indicator.

Purpose: Provide real-time feel per user decision - data updates as transactions happen with visual confirmation of connection status.

Output: LiveIndicator component + useDashboardRealtime hook with automatic reconnection on tab focus.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-dashboard-accuracy/05-CONTEXT.md
@.planning/phases/05-dashboard-accuracy/05-RESEARCH.md
@maguey-gate-scanner/src/lib/realtime-sync-service.ts
@maguey-gate-scanner/src/pages/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LiveIndicator component</name>
  <files>maguey-gate-scanner/src/components/ui/LiveIndicator.tsx</files>
  <action>
Create component following the pattern from RESEARCH.md:

```typescript
interface LiveIndicatorProps {
  isLive: boolean;
  lastUpdate?: Date;
  showLastUpdate?: boolean;
}

export function LiveIndicator({ isLive, lastUpdate, showLastUpdate = false }: LiveIndicatorProps)
```

Implementation:
1. Pulsing green dot when isLive=true:
   - Use Tailwind animate-ping for pulse effect
   - Inner solid dot (bg-green-500) with outer pulsing ring (bg-green-400 opacity-75)
   - Size: h-2 w-2 for compact display

2. Gray dot when isLive=false:
   - Static gray dot (bg-gray-400)
   - No animation
   - Optional "Reconnecting..." text

3. Status text:
   - "Live" when connected (text-xs text-muted-foreground)
   - "Reconnecting..." when disconnected

4. Optional lastUpdate display:
   - If showLastUpdate=true and lastUpdate provided
   - Show relative time: "Updated 5s ago"
   - Use date-fns formatDistanceToNow

5. Layout:
   - Flex row with items-center gap-2
   - Fits in dashboard header alongside title

Export as named export for use in Dashboard.tsx.
  </action>
  <verify>
Component renders without errors. Run: `cd maguey-gate-scanner && npm run build` to verify TypeScript compiles.
  </verify>
  <done>
LiveIndicator component exists with pulsing animation when live, gray when disconnected, optional last update time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useDashboardRealtime hook</name>
  <files>maguey-gate-scanner/src/hooks/useDashboardRealtime.ts</files>
  <action>
Create hook following pattern from RESEARCH.md with visibility-aware reconnection:

```typescript
interface UseDashboardRealtimeOptions {
  eventId?: string;
  tables?: Array<'tickets' | 'orders' | 'vip_reservations' | 'scan_logs'>;
  onUpdate?: () => void;
}

interface UseDashboardRealtimeReturn {
  isLive: boolean;
  lastUpdate: Date;
  reconnect: () => void;
}

export function useDashboardRealtime(options: UseDashboardRealtimeOptions): UseDashboardRealtimeReturn
```

Implementation:

1. State management:
   - isLive (boolean) - subscription status
   - lastUpdate (Date) - last update timestamp
   - channelRef (useRef) - track channel for cleanup

2. Setup subscription:
   - Create supabase.channel('dashboard-{eventId}')
   - Subscribe to postgres_changes for each table in options.tables
   - Default tables: ['tickets', 'orders', 'vip_reservations']
   - On any change: update lastUpdate, call options.onUpdate if provided

3. Subscription status handling:
   - 'SUBSCRIBED' -> setIsLive(true)
   - 'CLOSED' | 'CHANNEL_ERROR' -> setIsLive(false)

4. Visibility change handling (critical for tab backgrounding):
   - Add document.addEventListener('visibilitychange', handler)
   - On 'visible':
     - Remove old channel if exists
     - Re-setup subscription
     - Call onUpdate to refresh data (catch up on missed updates)
   - Track lastUpdateTime to know how stale data might be

5. Reconnect function:
   - Manual reconnect trigger
   - Remove existing channel, setup fresh

6. Cleanup:
   - Return cleanup function from useEffect
   - Remove event listener
   - Remove channel

Use supabase from '@/integrations/supabase/client'.
  </action>
  <verify>
Run: `cd maguey-gate-scanner && npm run build` to verify TypeScript compiles.
  </verify>
  <done>
Hook exports useDashboardRealtime with isLive, lastUpdate, reconnect. Handles visibility changes and subscription lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate LiveIndicator into Dashboard</name>
  <files>maguey-gate-scanner/src/pages/Dashboard.tsx</files>
  <action>
Update Dashboard.tsx to use new real-time infrastructure:

1. Import new components:
   - import { LiveIndicator } from '@/components/ui/LiveIndicator'
   - import { useDashboardRealtime } from '@/hooks/useDashboardRealtime'

2. Add hook in Dashboard component:
   ```typescript
   const { isLive, lastUpdate, reconnect } = useDashboardRealtime({
     tables: ['tickets', 'orders', 'vip_reservations', 'scan_logs'],
     onUpdate: () => {
       loadData();
       loadScanSpeedMetrics();
       loadAnalytics();
     },
   });
   ```

3. Add LiveIndicator to header (near "Analytics Dashboard" title):
   - Position in flex container with title
   - Show: `<LiveIndicator isLive={isLive} lastUpdate={lastUpdate} showLastUpdate />`

4. Remove existing manual polling (if any setInterval for data refresh):
   - The real-time hook handles updates automatically
   - Keep the loadScanSpeedMetrics 30-second interval (scan metrics are computed, not direct DB)

5. Style the header to accommodate LiveIndicator:
   - Existing: `<h1>Analytics Dashboard</h1>`
   - Update to flex container with indicator on right
  </action>
  <verify>
Run: `cd maguey-gate-scanner && npm run dev` and verify:
1. Dashboard shows "Live" indicator with pulsing green dot
2. Switch to another tab, wait 5 seconds, switch back - data should refresh
3. No console errors
  </verify>
  <done>
Dashboard shows LiveIndicator, automatically reconnects on tab focus, updates data in real-time.
  </done>
</task>

</tasks>

<verification>
1. LiveIndicator shows pulsing green when connected
2. Dashboard header displays live status
3. Tab backgrounding and returning triggers reconnection
4. Data updates without page refresh when changes occur
</verification>

<success_criteria>
- Live indicator visible in dashboard header
- Real-time updates work (test by adding ticket in another tab)
- Tab switch reconnection works without user intervention
- No subscription memory leaks (check React DevTools)
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-accuracy/05-02-SUMMARY.md`
</output>
