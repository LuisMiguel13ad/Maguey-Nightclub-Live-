---
phase: 05-dashboard-accuracy
plan: 04
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - maguey-pass-lounge/src/hooks/useEventsRealtime.ts
  - maguey-pass-lounge/src/pages/Checkout.tsx
  - maguey-gate-scanner/src/pages/Dashboard.tsx
  - maguey-gate-scanner/src/components/dashboard/CheckInProgress.tsx
autonomous: true

must_haves:
  truths:
    - "Events created in dashboard appear on purchase site within 30 seconds"
    - "Check-in progress displays 'X / Y checked in' with progress bar"
    - "VIP reservations show in dashboard immediately after confirmation"
  artifacts:
    - path: "maguey-pass-lounge/src/hooks/useEventsRealtime.ts"
      provides: "Real-time events subscription for purchase site"
      exports: ["useEventsRealtime"]
    - path: "maguey-gate-scanner/src/components/dashboard/CheckInProgress.tsx"
      provides: "Check-in progress display component"
      min_lines: 30
  key_links:
    - from: "useEventsRealtime.ts"
      to: "supabase.channel"
      via: "postgres_changes on events table"
      pattern: "postgres_changes.*events"
    - from: "Checkout.tsx"
      to: "useEventsRealtime"
      via: "hook usage for event list"
      pattern: "useEventsRealtime"
---

<objective>
Ensure event sync between dashboard and purchase site meets 30-second requirement, and add check-in progress visualization.

Purpose: Per success criteria - events created in owner dashboard appear on purchase site within 30 seconds, and analytics charts show check-in rate as live progress.

Output: Real-time events hook for purchase site + check-in progress component + validation of VIP real-time sync.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-dashboard-accuracy/05-CONTEXT.md
@.planning/phases/05-dashboard-accuracy/05-RESEARCH.md
@maguey-pass-lounge/src/pages/Checkout.tsx
@maguey-gate-scanner/src/pages/Dashboard.tsx
@maguey-gate-scanner/src/lib/analytics-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useEventsRealtime hook for purchase site</name>
  <files>maguey-pass-lounge/src/hooks/useEventsRealtime.ts</files>
  <action>
Create hook to provide real-time event updates in maguey-pass-lounge:

```typescript
interface UseEventsRealtimeOptions {
  onEventChange?: (event: Event) => void;
  filter?: {
    upcomingOnly?: boolean;
    minDate?: Date;
  };
}

interface UseEventsRealtimeReturn {
  events: Event[];
  isLoading: boolean;
  isLive: boolean;
  error: Error | null;
  refetch: () => Promise<void>;
}

export function useEventsRealtime(options?: UseEventsRealtimeOptions): UseEventsRealtimeReturn
```

Implementation:

1. Initial fetch:
   - Query events table with filters (upcoming, not cancelled)
   - Order by event_date ASC
   - Set isLoading during fetch

2. Real-time subscription:
   - Subscribe to postgres_changes on events table
   - Events: INSERT, UPDATE, DELETE
   - On INSERT: Add to events list if matches filter
   - On UPDATE: Update in list (handles status changes, cancellations)
   - On DELETE: Remove from list

3. Sync guarantee:
   - The postgres_changes subscription provides near-instant updates
   - Supabase real-time typically delivers within 100ms
   - This exceeds the 30-second requirement

4. Connection status:
   - Track isLive for UI indicator (optional usage)
   - Handle subscription errors gracefully

5. Cleanup:
   - Remove channel on unmount
   - Prevent memory leaks

Use supabase from '@/lib/supabase' (pass-lounge path).
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npm run build` to verify TypeScript compiles.
  </verify>
  <done>
Hook provides real-time event list with INSERT/UPDATE/DELETE handling for sub-30-second sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate real-time events in Checkout page</name>
  <files>maguey-pass-lounge/src/pages/Checkout.tsx</files>
  <action>
Update Checkout.tsx to use real-time events:

1. Import hook:
   - import { useEventsRealtime } from '@/hooks/useEventsRealtime'

2. Replace or augment existing event fetching:
   - Current: likely uses useQuery or direct fetch
   - New: Use useEventsRealtime({ upcomingOnly: true })
   - Keep existing useQuery as fallback if needed for initial server render

3. Handle real-time updates:
   - New events appear automatically in dropdown/list
   - Cancelled events removed from selection
   - No page refresh required

4. Optional: Add subtle indicator that event list is live:
   - Small "Live" text or dot near event selector
   - Not required but nice UX touch

5. Test consideration:
   - If an event is created while user is on checkout page
   - It should appear in the event list within seconds
   - This is the 30-second requirement validation

Preserve existing checkout functionality - this is additive real-time enhancement.
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npm run dev` and:
1. Open Checkout page
2. Create event in another browser tab (or directly in Supabase)
3. Verify new event appears within 30 seconds without refresh
  </verify>
  <done>
Checkout page shows events in real-time, new events appear within 30 seconds of creation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CheckInProgress component</name>
  <files>maguey-gate-scanner/src/components/dashboard/CheckInProgress.tsx</files>
  <action>
Create check-in progress visualization per CONTEXT.md:

Props:
```typescript
interface CheckInProgressProps {
  eventId?: string;
  eventName?: string;
  showDetails?: boolean;
}
```

Implementation:

1. Fetch check-in data:
   - Use existing getCheckInRates from analytics-service.ts
   - Or direct query: count tickets where scanned_at IS NOT NULL vs total
   - Subscribe to real-time updates on tickets table for live progress

2. Display format (per CONTEXT.md):
   - Main: "125 / 200 checked in"
   - Progress bar showing percentage
   - Percentage label: "62.5%"

3. Progress bar styling:
   - Use existing Tailwind patterns from Dashboard
   - Green fill (bg-green-500 or success color)
   - Gray background track
   - Rounded corners, smooth animation on updates

4. Real-time updates:
   - Subscribe to tickets table for event
   - Update counts when tickets scanned
   - Smooth animation for progress bar changes

5. Multiple events support:
   - If no eventId, show aggregate or list top events
   - Each event as separate progress item

6. Empty state:
   - "No check-ins yet" when 0 scanned
   - Still show progress bar at 0%

Use existing check-in rate data from Dashboard (checkInRates state).
  </action>
  <verify>
Component renders progress bars correctly. Run: `cd maguey-gate-scanner && npm run build` to verify.
  </verify>
  <done>
CheckInProgress shows "X / Y checked in" with animated progress bar, updates in real-time.
  </done>
</task>

</tasks>

<verification>
1. Create event in dashboard, appears on Checkout within 30s
2. Check-in progress shows accurate counts
3. Progress bar animates when check-ins occur
4. VIP reservations appear in dashboard immediately (verify existing 04-03 work)
</verification>

<success_criteria>
- Event sync verified: <30 seconds from creation to purchase site visibility
- Check-in progress displays "X / Y checked in" format with progress bar
- Real-time updates work for both events and check-ins
- No regressions to existing checkout functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-accuracy/05-04-SUMMARY.md`
</output>
