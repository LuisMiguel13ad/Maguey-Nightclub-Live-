---
phase: 05-dashboard-accuracy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/migrations/20260131000000_revenue_discrepancies.sql
  - maguey-pass-lounge/supabase/functions/verify-revenue/index.ts
autonomous: true

must_haves:
  truths:
    - "Revenue verification endpoint returns DB and Stripe totals"
    - "Discrepancies logged to audit table with timestamps"
    - "Stripe balance transactions queried by date range"
  artifacts:
    - path: "maguey-pass-lounge/supabase/migrations/20260131000000_revenue_discrepancies.sql"
      provides: "revenue_discrepancies audit table"
      contains: "CREATE TABLE revenue_discrepancies"
    - path: "maguey-pass-lounge/supabase/functions/verify-revenue/index.ts"
      provides: "Stripe reconciliation endpoint"
      exports: ["serve"]
  key_links:
    - from: "verify-revenue/index.ts"
      to: "stripe.balanceTransactions"
      via: "Stripe SDK list call"
      pattern: "balanceTransactions\\.list"
    - from: "verify-revenue/index.ts"
      to: "revenue_discrepancies"
      via: "Supabase insert on mismatch"
      pattern: "from.*revenue_discrepancies.*insert"
---

<objective>
Create revenue reconciliation infrastructure to verify database revenue against Stripe's authoritative records.

Purpose: Enable transparency by detecting and logging discrepancies between local ticket revenue and actual Stripe payments, per user decision to show both data sources when mismatch detected.

Output: Database migration for audit table + Edge Function that compares DB vs Stripe totals and logs discrepancies.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-dashboard-accuracy/05-CONTEXT.md
@.planning/phases/05-dashboard-accuracy/05-RESEARCH.md
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revenue_discrepancies audit table</name>
  <files>maguey-pass-lounge/supabase/migrations/20260131000000_revenue_discrepancies.sql</files>
  <action>
Create migration with:

1. revenue_discrepancies table:
   - id (uuid, primary key, gen_random_uuid())
   - event_id (uuid, nullable, references events)
   - db_revenue (numeric(10,2), not null) - database calculated total
   - stripe_revenue (numeric(10,2), not null) - Stripe verified total
   - discrepancy_amount (numeric(10,2), not null) - absolute difference
   - discrepancy_percent (numeric(5,2)) - percentage difference
   - period_start (timestamptz) - start of verified period
   - period_end (timestamptz) - end of verified period
   - checked_at (timestamptz, not null, default now())
   - resolved_at (timestamptz, nullable)
   - resolution_notes (text, nullable)
   - metadata (jsonb, default '{}') - for additional context

2. Indexes:
   - idx_revenue_discrepancies_event_id on event_id
   - idx_revenue_discrepancies_checked_at on checked_at DESC
   - idx_revenue_discrepancies_unresolved on (event_id) WHERE resolved_at IS NULL

3. RLS policies:
   - Enable RLS
   - SELECT for authenticated users (owners need to see discrepancies)
   - INSERT for service role only (Edge Functions)
   - UPDATE for authenticated users (to mark resolved)
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx supabase db push --dry-run` to validate migration syntax
  </verify>
  <done>
Migration file exists with revenue_discrepancies table, indexes, and RLS policies. Dry run succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create verify-revenue Edge Function</name>
  <files>maguey-pass-lounge/supabase/functions/verify-revenue/index.ts</files>
  <action>
Create Edge Function that:

1. Accepts POST with JSON body: { eventId?: string, startDate: string, endDate: string }

2. Fetches database revenue:
   - Query tickets table: SUM(price) for event_id in date range
   - Query vip_reservations: SUM(amount_paid_cents / 100) for event_id with status in ('confirmed', 'checked_in', 'completed')
   - Calculate dbTotalRevenue = ticket revenue + VIP revenue

3. Fetches Stripe revenue:
   - Use stripe.balanceTransactions.list with:
     - created: { gte: startTimestamp, lte: endTimestamp }
     - type: 'charge' (only successful charges)
     - limit: 100, paginate with starting_after
   - Sum all transaction amounts (convert cents to dollars)
   - Filter by metadata.event_id if eventId provided

4. Compare and log discrepancy:
   - If |dbTotal - stripeTotal| > 1.00 (threshold per RESEARCH.md):
     - Insert into revenue_discrepancies table
     - Include discrepancy_percent calculation

5. Return JSON response:
   ```json
   {
     "dbRevenue": 5000.00,
     "stripeRevenue": 5100.00,
     "hasDiscrepancy": true,
     "discrepancyAmount": 100.00,
     "discrepancyPercent": 1.96,
     "checkedAt": "2026-01-31T12:00:00Z"
   }
   ```

6. Error handling:
   - Return 400 for missing dates
   - Return 500 with error message for Stripe API failures
   - Log errors but don't expose internal details

Use Stripe SDK pattern from existing stripe-webhook/index.ts. Use Deno imports consistent with other Edge Functions.
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx supabase functions serve verify-revenue --no-verify-jwt` and test with curl:
```bash
curl -X POST http://localhost:54321/functions/v1/verify-revenue \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
  -d '{"startDate": "2026-01-01", "endDate": "2026-01-31"}'
```
  </verify>
  <done>
Edge Function responds with dbRevenue, stripeRevenue, hasDiscrepancy fields. Discrepancies logged to database.
  </done>
</task>

</tasks>

<verification>
1. Migration creates revenue_discrepancies table with all columns
2. Edge Function compiles and responds to requests
3. Discrepancy detection works (test with known mismatch if possible)
</verification>

<success_criteria>
- revenue_discrepancies table exists in database
- verify-revenue Edge Function deployed and callable
- Function returns both DB and Stripe revenue figures
- Discrepancies > $1 logged to audit table
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-accuracy/05-01-SUMMARY.md`
</output>
