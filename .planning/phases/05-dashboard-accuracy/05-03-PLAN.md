---
phase: 05-dashboard-accuracy
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - maguey-gate-scanner/src/components/dashboard/RevenueVerification.tsx
  - maguey-gate-scanner/src/lib/revenue-verification-service.ts
  - maguey-gate-scanner/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Revenue card shows DB vs Stripe comparison when discrepancy exists"
    - "Discrepancy displays both figures: 'DB: $5,000 vs Stripe: $5,100'"
    - "Revenue verification runs on dashboard load"
  artifacts:
    - path: "maguey-gate-scanner/src/components/dashboard/RevenueVerification.tsx"
      provides: "Discrepancy display component"
      min_lines: 40
    - path: "maguey-gate-scanner/src/lib/revenue-verification-service.ts"
      provides: "Client service for verify-revenue Edge Function"
      exports: ["verifyRevenue", "getRecentDiscrepancies"]
  key_links:
    - from: "revenue-verification-service.ts"
      to: "verify-revenue Edge Function"
      via: "supabase.functions.invoke"
      pattern: "functions\\.invoke.*verify-revenue"
    - from: "Dashboard.tsx"
      to: "RevenueVerification.tsx"
      via: "component render in revenue section"
      pattern: "<RevenueVerification"
---

<objective>
Integrate revenue verification into dashboard with transparent discrepancy display.

Purpose: Per user decision - show both data sources when mismatch detected ("DB: $5,000 vs Stripe: $5,100") for transparency over hiding discrepancies.

Output: Service to call verify-revenue + component to display discrepancies + integration in Dashboard revenue section.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-dashboard-accuracy/05-CONTEXT.md
@.planning/phases/05-dashboard-accuracy/05-RESEARCH.md
@.planning/phases/05-dashboard-accuracy/05-01-SUMMARY.md
@maguey-gate-scanner/src/pages/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revenue verification service</name>
  <files>maguey-gate-scanner/src/lib/revenue-verification-service.ts</files>
  <action>
Create client service to interact with verify-revenue Edge Function:

```typescript
interface RevenueVerificationResult {
  dbRevenue: number;
  stripeRevenue: number;
  hasDiscrepancy: boolean;
  discrepancyAmount: number;
  discrepancyPercent: number;
  checkedAt: string;
}

interface RevenueDiscrepancy {
  id: string;
  event_id: string | null;
  db_revenue: number;
  stripe_revenue: number;
  discrepancy_amount: number;
  discrepancy_percent: number;
  checked_at: string;
  resolved_at: string | null;
}
```

Exports:

1. `verifyRevenue(options: { eventId?: string; startDate: Date; endDate: Date }): Promise<RevenueVerificationResult>`
   - Call supabase.functions.invoke('verify-revenue', { body: {...} })
   - Handle errors gracefully, return null on failure
   - Cache result for 5 minutes (per RESEARCH.md pitfall on Stripe rate limits)
   - Use in-memory cache with TTL

2. `getRecentDiscrepancies(limit?: number): Promise<RevenueDiscrepancy[]>`
   - Query revenue_discrepancies table
   - Order by checked_at DESC
   - Default limit 10
   - Return empty array on error

3. `markDiscrepancyResolved(id: string, notes: string): Promise<boolean>`
   - Update revenue_discrepancies set resolved_at = now(), resolution_notes = notes
   - Return true on success

Use isSupabaseConfigured() check. Import supabase from '@/integrations/supabase/client'.
  </action>
  <verify>
Run: `cd maguey-gate-scanner && npm run build` to verify TypeScript compiles.
  </verify>
  <done>
Service exports verifyRevenue, getRecentDiscrepancies, markDiscrepancyResolved with proper typing and caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RevenueVerification component</name>
  <files>maguey-gate-scanner/src/components/dashboard/RevenueVerification.tsx</files>
  <action>
Create component to display revenue verification status:

Props:
```typescript
interface RevenueVerificationProps {
  eventId?: string;
  startDate: Date;
  endDate: Date;
}
```

Implementation:

1. Fetch verification on mount and when props change:
   - Call verifyRevenue from service
   - Store result in state
   - Show loading skeleton during fetch

2. Normal display (no discrepancy):
   - Small green checkmark icon
   - Text: "Revenue verified" with Stripe icon
   - Subtle, non-intrusive design

3. Discrepancy display (per user decision for transparency):
   - Warning badge/border (amber or yellow)
   - Show BOTH figures clearly:
     - "Database: $5,000.00"
     - "Stripe: $5,100.00"
     - "Difference: $100.00 (1.96%)"
   - Icon: AlertTriangle from lucide-react
   - Link to view discrepancy history

4. Error state:
   - Show "Unable to verify" with retry button
   - Don't block dashboard functionality

5. Styling:
   - Compact design that fits within revenue card
   - Use existing Tailwind classes matching Dashboard theme
   - Border color indicates status: green (verified), amber (discrepancy), red (error)

Use Intl.NumberFormat for currency formatting (already used in Dashboard.tsx).
  </action>
  <verify>
Component renders in all states. Run: `cd maguey-gate-scanner && npm run build` to verify.
  </verify>
  <done>
RevenueVerification component shows verification status with transparent dual-source display when discrepancy exists.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate verification into Dashboard revenue section</name>
  <files>maguey-gate-scanner/src/pages/Dashboard.tsx</files>
  <action>
Add revenue verification to the Revenue Overview card:

1. Import component:
   - import { RevenueVerification } from '@/components/dashboard/RevenueVerification'

2. Add state for date range (or use existing stats dates):
   - Use monthStart and now for verification period
   - Or add date range picker if not already present

3. Position RevenueVerification in Revenue Overview card:
   - Add below the "All Time Revenue" section
   - Or as a small indicator near the revenue total
   - Should be visible but not dominate the UI

4. Add to loadData flow:
   - Verification can be triggered alongside other data loads
   - Consider adding to the real-time update callback (but cache prevents excessive calls)

5. Optional: Add discrepancy count badge if recent unresolved discrepancies:
   - Small red badge showing count of unresolved discrepancies
   - Links to discrepancy history view

Ensure the integration matches the existing dark theme of the Revenue Overview card (from-slate-900 styling).
  </action>
  <verify>
Run: `cd maguey-gate-scanner && npm run dev` and verify:
1. Revenue card shows verification status
2. If discrepancy, both DB and Stripe figures shown
3. No layout issues or style conflicts
  </verify>
  <done>
Dashboard Revenue Overview includes RevenueVerification with transparent discrepancy display when mismatch exists.
  </done>
</task>

</tasks>

<verification>
1. Revenue verification service calls Edge Function successfully
2. Component displays "Revenue verified" when matching
3. Component displays both figures when discrepancy exists
4. Dashboard loads without blocking on verification failures
</verification>

<success_criteria>
- Revenue card shows verification status indicator
- Discrepancies display both DB and Stripe figures (transparency requirement)
- Verification cached to prevent Stripe rate limit issues
- Dashboard remains functional if verification fails
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-accuracy/05-03-SUMMARY.md`
</output>
