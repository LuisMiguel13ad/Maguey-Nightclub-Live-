---
phase: 23-cicd-deployment
plan: 02
type: execute
wave: 2
depends_on: [23-01]
files_modified: []
autonomous: false
user_setup:
  - service: stripe
    why: "Switch from test mode to production payment processing"
    env_vars:
      - name: STRIPE_PUBLISHABLE_KEY_LIVE
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key (live)"
        value_hint: "pk_live_..."
      - name: STRIPE_SECRET_KEY_LIVE
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (live)"
        value_hint: "sk_live_..."
      - name: STRIPE_WEBHOOK_SECRET_LIVE
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret (production endpoint)"
        value_hint: "whsec_..."
    dashboard_config:
      - task: "Create production webhook endpoint"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"
      - task: "Verify Stripe account is fully activated for live payments"
        location: "Stripe Dashboard -> Settings -> Account details"

must_haves:
  truths:
    - "Stripe production keys are configured in Supabase Edge Function secrets"
    - "A production webhook endpoint exists in Stripe Dashboard pointing to Supabase"
    - "Webhook events checkout.session.completed, payment_intent.succeeded, and payment_intent.payment_failed are subscribed"
    - "A small real payment can be processed end-to-end"
  artifacts: []
  key_links:
    - from: "Stripe Dashboard webhook endpoint"
      to: "Supabase Edge Function stripe-webhook"
      via: "HTTPS POST to Edge Function URL"
      pattern: "supabase.co/functions/v1/stripe-webhook"
    - from: "Supabase Edge Function secrets"
      to: "Stripe API"
      via: "STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET"
      pattern: "STRIPE_SECRET_KEY"
---

<objective>
Switch Stripe from test mode to production keys and verify real payment processing.

Purpose: Stripe is currently in test mode (`pk_test_` / `sk_test_`). Before launch, production keys must be configured in Supabase Edge Functions (server-side) and Vercel (client-side publishable key only). Local `.env` files keep test keys for development. This plan handles the Stripe-specific configuration; Vercel env vars are in plan 23-03.

Output: Stripe production keys configured in Supabase Edge Function secrets, production webhook endpoint created and verified.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/23-cicd-deployment/23-CONTEXT.md
@.planning/ENVIRONMENT-AUDIT.md
</context>

<tasks>

<task type="manual">
  <name>Task 1: Verify Stripe account activation and obtain production keys</name>
  <files>N/A (Stripe Dashboard)</files>
  <action>
1. Log into Stripe Dashboard (https://dashboard.stripe.com)
2. Ensure the account is fully activated for live payments:
   - Go to Settings -> Account details
   - Verify business information is complete
   - Verify bank account/payout method is connected
   - If not activated: complete the activation steps (business info, bank account, identity verification)
3. Toggle OFF "Test mode" in the top-right corner to view live keys
4. Go to Developers -> API keys
5. Copy the **Publishable key** (starts with `pk_live_`)
6. Copy or reveal the **Secret key** (starts with `sk_live_`)
7. Store both keys securely for Tasks 2 and 3

IMPORTANT: Do NOT replace test keys in local `.env` files. Local development continues using test keys. Production keys go only to Supabase Edge Functions and Vercel (plan 23-03).
  </action>
  <verify>
- Stripe Dashboard shows "Live" mode (not "Test")
- Publishable key starts with `pk_live_`
- Secret key starts with `sk_live_`
- Account status shows "Active" or "Payouts enabled"
  </verify>
  <done>Stripe production API keys (publishable + secret) are obtained and stored securely. Account is activated for live payments.</done>
</task>

<task type="manual">
  <name>Task 2: Create production webhook endpoint in Stripe</name>
  <files>N/A (Stripe Dashboard)</files>
  <action>
1. In Stripe Dashboard (live mode, NOT test mode), go to Developers -> Webhooks
2. Click "Add endpoint"
3. Set the endpoint URL to:
   `https://djbzjasdrwvbsoifxqzd.supabase.co/functions/v1/stripe-webhook`
4. Select these 3 events:
   - `checkout.session.completed`
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
5. Click "Add endpoint"
6. After creation, click on the endpoint to view details
7. Click "Reveal" on the **Signing secret** (starts with `whsec_`)
8. Copy and store the webhook signing secret for Task 3

NOTE: The test-mode webhook endpoint can remain active for development. The production endpoint is separate.
  </action>
  <verify>
- Production webhook endpoint appears in Stripe Dashboard -> Developers -> Webhooks (live mode)
- Endpoint URL is `https://djbzjasdrwvbsoifxqzd.supabase.co/functions/v1/stripe-webhook`
- All 3 events are subscribed
- Signing secret starts with `whsec_`
  </verify>
  <done>Production Stripe webhook endpoint is created, subscribed to the 3 required events, and the signing secret is obtained.</done>
</task>

<task type="manual">
  <name>Task 3: Set Stripe production secrets in Supabase Edge Functions</name>
  <files>N/A (Supabase Dashboard)</files>
  <action>
1. Go to Supabase Dashboard (https://supabase.com/dashboard)
2. Select the project (djbzjasdrwvbsoifxqzd)
3. Go to Project Settings -> Edge Functions -> Secrets (or Settings -> Vault -> Secrets)
4. Add or update these 2 secrets:

   - `STRIPE_SECRET_KEY` = the `sk_live_` key from Task 1
   - `STRIPE_WEBHOOK_SECRET` = the `whsec_` signing secret from Task 2

5. Verify both secrets are saved (they should appear in the secrets list)

IMPORTANT: These secrets are read by Edge Functions via `Deno.env.get()`. The functions `create-checkout-session`, `stripe-webhook`, and `create-vip-payment-intent` all use `STRIPE_SECRET_KEY`. The `stripe-webhook` function uses `STRIPE_WEBHOOK_SECRET` for signature verification. No code changes are needed -- the functions already read from these env var names.
  </action>
  <verify>
- `STRIPE_SECRET_KEY` appears in Supabase Edge Function secrets list
- `STRIPE_WEBHOOK_SECRET` appears in Supabase Edge Function secrets list
- Both values are the LIVE (production) keys, not test keys
  </verify>
  <done>Supabase Edge Functions have production Stripe keys configured. The `create-checkout-session`, `stripe-webhook`, and `create-vip-payment-intent` functions will use live Stripe when invoked.</done>
</task>

</tasks>

<verification>
1. Stripe Dashboard (live mode) shows an active webhook endpoint pointing to Supabase
2. Supabase Edge Function secrets include `STRIPE_SECRET_KEY` (sk_live_) and `STRIPE_WEBHOOK_SECRET` (whsec_)
3. Optional: Make a small test purchase on the production site after plan 23-03 deploys it (full E2E verification)
</verification>

<success_criteria>
- Stripe account is activated for live payments
- Production publishable key (pk_live_) and secret key (sk_live_) are obtained
- Production webhook endpoint exists in Stripe with 3 subscribed events
- STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET are set in Supabase Edge Function secrets with production values
- Local .env files are UNCHANGED (still using test keys)
</success_criteria>

<output>
After completion, create `.planning/phases/23-cicd-deployment/23-02-SUMMARY.md`
</output>
