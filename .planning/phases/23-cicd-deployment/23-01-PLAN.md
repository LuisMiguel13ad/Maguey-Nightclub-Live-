---
phase: 23-cicd-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/e2e.yml
autonomous: true
user_setup:
  - service: github
    why: "CI/CD pipeline needs secrets to access Supabase, Stripe, and scanner test account"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "CLAUDE.md or Supabase Dashboard -> Project Settings -> API -> URL"
        value_hint: "https://djbzjasdrwvbsoifxqzd.supabase.co"
      - name: VITE_SUPABASE_ANON_KEY
        source: "CLAUDE.md or Supabase Dashboard -> Project Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "CLAUDE.md or Supabase Dashboard -> Project Settings -> API -> service_role key"
      - name: STRIPE_TEST_PK
        source: "CLAUDE.md or Stripe Dashboard -> Developers -> API keys -> Publishable key (test)"
        value_hint: "pk_test_..."
      - name: STRIPE_TEST_SK
        source: "CLAUDE.md or Stripe Dashboard -> Developers -> API keys -> Secret key (test)"
        value_hint: "sk_test_..."
      - name: SCANNER_TEST_EMAIL
        source: "CLAUDE.md -> Application Logins -> Scanner/Employee email"
        value_hint: "Luismbadillo13@gmail.com"
      - name: SCANNER_TEST_PASSWORD
        source: "CLAUDE.md -> Application Logins -> Scanner/Employee password"
        value_hint: "MagueyScanner123"
    dashboard_config:
      - task: "Add 7 repository secrets"
        location: "GitHub -> Repository Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "CI/CD pipeline triggers on push to main and on pull requests"
    - "Pipeline lints all 3 workspaces before building"
    - "Pipeline runs unit tests for pass-lounge and gate-scanner"
    - "Pipeline builds all 3 sites (pass-lounge, gate-scanner, maguey-nights)"
    - "E2E specs are distributed across 4 containers without duplication"
  artifacts:
    - path: ".github/workflows/e2e.yml"
      provides: "Complete CI/CD workflow with lint, test, build, and E2E jobs"
      contains: "push:"
  key_links:
    - from: ".github/workflows/e2e.yml"
      to: "GitHub Secrets"
      via: "secrets.VITE_SUPABASE_URL, secrets.STRIPE_TEST_PK, etc."
      pattern: "secrets\\."
---

<objective>
Fix and enable the GitHub Actions CI/CD pipeline.

Purpose: The CI/CD pipeline (`e2e.yml`) exists but has push/PR triggers commented out, is missing lint and unit test jobs, does not build `maguey-nights`, and has a spec duplication bug (containers 1 and 2 both run `happy-path/**/*.cy.ts`). This plan fixes all issues and enables automatic CI on push/PR.

Output: A fully functional `.github/workflows/e2e.yml` that lints, tests, builds all 3 sites, and runs E2E tests across 4 parallel containers.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/23-cicd-deployment/23-CONTEXT.md
@.github/workflows/e2e.yml
@package.json
</context>

<tasks>

<task type="manual">
  <name>Task 1: Set 7 GitHub repository secrets</name>
  <files>N/A (GitHub Dashboard)</files>
  <action>
Go to GitHub repository (https://github.com/LuisMiguel13ad/Maguey-Nightclub-Live-) -> Settings -> Secrets and variables -> Actions -> New repository secret.

Add these 7 secrets (values from CLAUDE.md):

1. `VITE_SUPABASE_URL` = `https://djbzjasdrwvbsoifxqzd.supabase.co`
2. `VITE_SUPABASE_ANON_KEY` = the anon key from CLAUDE.md
3. `SUPABASE_SERVICE_ROLE_KEY` = the service role key from CLAUDE.md
4. `STRIPE_TEST_PK` = `pk_test_51SdKwiK9xNUVZKDuAzJsTllAGm5ZshO9WsNjD9EvNqYL6KX65FpnIpG23FSXbOHmMvXyNavlPpCOKvUchgFyhraB00TkmKNBqx`
5. `STRIPE_TEST_SK` = `sk_test_51SdKwiK9xNUVZKDukmYheWf07z1vgS2dc5pqB35BhHxd90QRwJqblqxPtMprzyyUOfvcc162KrDV1o8ce6gsx3nZ009X7wd543`
6. `SCANNER_TEST_EMAIL` = `Luismbadillo13@gmail.com`
7. `SCANNER_TEST_PASSWORD` = `MagueyScanner123`
  </action>
  <verify>Go to Settings -> Secrets and variables -> Actions. All 7 secrets should appear in the list (values hidden but names visible).</verify>
  <done>All 7 GitHub secrets are configured and visible in the repository settings.</done>
</task>

<task type="code">
  <name>Task 2: Fix and enable the CI/CD workflow</name>
  <files>.github/workflows/e2e.yml</files>
  <action>
Rewrite `.github/workflows/e2e.yml` with these changes:

**A. Uncomment push/PR triggers** (lines 7-10):
```yaml
on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
```

**B. Add a `lint` job** that runs before build:
```yaml
lint:
  runs-on: ubuntu-24.04
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    - run: npm ci
    - name: Lint pass-lounge
      run: npm run lint --workspace=maguey-pass-lounge
    - name: Lint gate-scanner
      run: npm run lint --workspace=maguey-gate-scanner
    - name: Lint maguey-nights
      run: npm run lint --workspace=maguey-nights
```

**C. Add a `unit-test` job** that runs after lint:
```yaml
unit-test:
  runs-on: ubuntu-24.04
  needs: lint
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    - run: npm ci
    - name: Test pass-lounge
      run: npm run test --workspace=maguey-pass-lounge
    - name: Test gate-scanner
      run: npm run test --workspace=maguey-gate-scanner
```
Note: maguey-nights has no test script, so do NOT include it.

**D. Update `build` job** to depend on `unit-test` and include `maguey-nights`:
```yaml
build:
  runs-on: ubuntu-24.04
  needs: unit-test
  steps:
    # ... existing checkout + setup + install ...
    - name: Build pass-lounge
      run: npm run build --workspace=maguey-pass-lounge
    - name: Build gate-scanner
      run: npm run build --workspace=maguey-gate-scanner
    - name: Build maguey-nights
      run: npm run build --workspace=maguey-nights
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          maguey-pass-lounge/dist
          maguey-gate-scanner/dist
          maguey-nights/dist
        retention-days: 1
```

**E. Fix E2E spec duplication** in the e2e job matrix:
Container 1 and 2 both run `happy-path/**/*.cy.ts`. Fix the spec assignment:

- Container 1: `e2e/specs/health-check.cy.ts,e2e/specs/smoke.cy.ts` (health + smoke)
- Container 2: `e2e/specs/happy-path/**/*.cy.ts` (happy path — 3 specs)
- Container 3: `e2e/specs/edge-cases/**/*.cy.ts` (edge cases — 4 specs)
- Container 4: `e2e/specs/offline/**/*.cy.ts` (offline — 2 specs)

The actual spec files are:
- `e2e/specs/health-check.cy.ts`
- `e2e/specs/smoke.cy.ts`
- `e2e/specs/happy-path/purchase-flow.cy.ts`
- `e2e/specs/happy-path/email-verification.cy.ts`
- `e2e/specs/happy-path/scan-flow.cy.ts`
- `e2e/specs/edge-cases/payment-failures.cy.ts`
- `e2e/specs/edge-cases/invalid-qr.cy.ts`
- `e2e/specs/edge-cases/webhook-failures.cy.ts`
- `e2e/specs/edge-cases/email-failures.cy.ts`
- `e2e/specs/edge-cases/orphan-prevention.cy.ts`
- `e2e/specs/offline/offline-scan.cy.ts`
- `e2e/specs/offline/offline-recovery.cy.ts`

**F. Keep the e2e job depending on `build`** (unchanged).

IMPORTANT: Do NOT add `continue-on-error: true` to the lint or test jobs. They should fail the pipeline if they fail.
  </action>
  <verify>
Validate the YAML syntax:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/e2e.yml'))" && echo "Valid YAML"
```
Verify the triggers are uncommented:
```bash
grep -n "^  push:" .github/workflows/e2e.yml
grep -n "^  pull_request:" .github/workflows/e2e.yml
```
Verify all 4 jobs exist:
```bash
grep "^  lint:" .github/workflows/e2e.yml
grep "^  unit-test:" .github/workflows/e2e.yml
grep "^  build:" .github/workflows/e2e.yml
grep "^  e2e:" .github/workflows/e2e.yml
```
Verify maguey-nights in lint and build:
```bash
grep "Lint maguey-nights" .github/workflows/e2e.yml
grep "Build maguey-nights" .github/workflows/e2e.yml
```
Verify container 1 runs health+smoke (not happy-path):
```bash
grep -A2 "containers == 1" .github/workflows/e2e.yml | grep -v "happy-path" && echo "No happy-path in container 1"
grep -A2 "containers == 1" .github/workflows/e2e.yml | grep "smoke" && echo "smoke.cy.ts present"
```
  </verify>
  <done>
The e2e.yml workflow has: push/PR triggers enabled, lint job (all 3 workspaces), unit-test job (pass-lounge + gate-scanner), build job (all 3 sites), E2E job with correct spec distribution across 4 containers (no duplication). Pipeline execution order: lint -> unit-test -> build -> e2e.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/e2e.yml'))"` succeeds
2. `grep -c "push:" .github/workflows/e2e.yml` returns at least 1
3. `grep -c "pull_request:" .github/workflows/e2e.yml` returns at least 1
4. 4 jobs defined: lint, unit-test, build, e2e
5. `maguey-nights` appears in both lint and build jobs
6. Container spec assignments have no overlap
</verification>

<success_criteria>
- CI/CD workflow YAML is valid and has push/PR triggers enabled
- Pipeline runs lint -> unit-test -> build -> e2e in correct dependency order
- All 3 sites are linted and built
- Unit tests run for pass-lounge and gate-scanner
- E2E specs are distributed across 4 containers without duplication
- After GitHub secrets are set (Task 1), a push to main triggers the full pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/23-cicd-deployment/23-01-SUMMARY.md`
</output>
