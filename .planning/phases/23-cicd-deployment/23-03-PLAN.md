---
phase: 23-cicd-deployment
plan: 03
type: execute
wave: 2
depends_on: [23-01]
files_modified:
  - maguey-pass-lounge/vercel.json
autonomous: false
user_setup:
  - service: supabase
    why: "Edge Functions need all server-side secrets for production"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
        value_hint: "re_jH2HNEMf_KDN2W97nHbt3qgziwxntBhex"
      - name: RESEND_WEBHOOK_SECRET
        source: "Resend Dashboard -> Webhooks -> Signing secret"
      - name: EMAIL_FROM_ADDRESS
        source: "Static value"
        value_hint: "tickets@magueynightclub.com"
      - name: QR_SIGNING_SECRET
        source: "Generate new secret or use rotated value (NOT the one in CLAUDE.md)"
      - name: ALLOWED_ORIGINS
        source: "Static value"
        value_hint: "https://magueynightclub.com,https://tickets.magueynightclub.com,https://staff.magueynightclub.com"
      - name: OWNER_EMAIL
        source: "Static value"
        value_hint: "info@magueynightclub.com"
      - name: FRONTEND_URL
        source: "Static value"
        value_hint: "https://tickets.magueynightclub.com"
      - name: ENVIRONMENT
        source: "Static value"
        value_hint: "production"
    dashboard_config:
      - task: "Set 8 Edge Function secrets (non-Stripe ones)"
        location: "Supabase Dashboard -> Project Settings -> Edge Functions -> Secrets"
  - service: vercel
    why: "Frontend sites need environment variables for Supabase and Stripe"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "CLAUDE.md"
        value_hint: "https://djbzjasdrwvbsoifxqzd.supabase.co"
      - name: VITE_SUPABASE_ANON_KEY
        source: "CLAUDE.md"
      - name: VITE_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key (live)"
        value_hint: "pk_live_..."
      - name: VITE_PURCHASE_SITE_URL
        source: "Static value"
        value_hint: "https://tickets.magueynightclub.com"
    dashboard_config:
      - task: "Set env vars for maguey-pass-lounge project"
        location: "Vercel Dashboard -> maguey-pass-lounge -> Settings -> Environment Variables"
      - task: "Set env vars for maguey-gate-scanner project"
        location: "Vercel Dashboard -> maguey-gate-scanner -> Settings -> Environment Variables"
      - task: "Set env vars for maguey-nights project"
        location: "Vercel Dashboard -> maguey-nights -> Settings -> Environment Variables"

must_haves:
  truths:
    - "All required Supabase Edge Function secrets are configured for production"
    - "All 3 Vercel projects have correct environment variables"
    - "VITE_QR_SIGNING_SECRET is NOT set on any Vercel project"
    - "ALLOWED_ORIGINS is set to specific production domains, not wildcard"
    - "All 3 sites deploy and load without errors"
    - "End-to-end purchase flow works in production"
  artifacts:
    - path: "maguey-pass-lounge/vercel.json"
      provides: "Clean Vercel config without stale rewrites or unnecessary env references"
  key_links:
    - from: "Vercel maguey-pass-lounge"
      to: "Supabase"
      via: "VITE_SUPABASE_URL + VITE_SUPABASE_ANON_KEY env vars"
      pattern: "VITE_SUPABASE"
    - from: "Vercel maguey-pass-lounge"
      to: "Stripe"
      via: "VITE_STRIPE_PUBLISHABLE_KEY (pk_live_) env var"
      pattern: "VITE_STRIPE_PUBLISHABLE_KEY"
    - from: "Supabase Edge Functions"
      to: "Resend API"
      via: "RESEND_API_KEY secret"
      pattern: "RESEND_API_KEY"
---

<objective>
Set all Supabase Edge Function secrets, configure Vercel environment variables for all 3 sites, clean up stale vercel.json configuration, deploy, and verify end-to-end.

Purpose: All 3 frontend sites need correct environment variables in Vercel for production. The Supabase Edge Functions need ~13 server-side secrets for email, QR signing, CORS, and monitoring. The `maguey-pass-lounge/vercel.json` has a stale `rewrites` section pointing to `your-backend.example.com` and an `env` block with `@` references that may not match actual Vercel secret names. Clean these up and verify all 3 sites work end-to-end.

Output: All 3 sites deployed on Vercel with correct env vars, Supabase Edge Functions fully configured, stale vercel.json cleaned up.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/23-cicd-deployment/23-CONTEXT.md
@.planning/ENVIRONMENT-AUDIT.md
@maguey-pass-lounge/vercel.json
@maguey-gate-scanner/vercel.json
@maguey-nights/vercel.json
</context>

<tasks>

<task type="manual">
  <name>Task 1: Set remaining Supabase Edge Function secrets</name>
  <files>N/A (Supabase Dashboard)</files>
  <action>
Go to Supabase Dashboard -> Project Settings -> Edge Functions -> Secrets.

Plan 23-02 already set STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET. Now set the remaining required secrets:

**Required (8 secrets):**
1. `RESEND_API_KEY` = `re_jH2HNEMf_KDN2W97nHbt3qgziwxntBhex`
2. `RESEND_WEBHOOK_SECRET` = (obtain from Resend Dashboard -> Webhooks, or set up webhook first)
3. `EMAIL_FROM_ADDRESS` = `tickets@magueynightclub.com`
4. `QR_SIGNING_SECRET` = Generate a NEW random secret (NOT the one in CLAUDE.md which was exposed). Use: `openssl rand -base64 32` to generate. This MUST match the value set via `ALTER DATABASE postgres SET app.qr_signing_secret = '...'`
5. `ALLOWED_ORIGINS` = `https://magueynightclub.com,https://tickets.magueynightclub.com,https://staff.magueynightclub.com`
6. `OWNER_EMAIL` = `info@magueynightclub.com`
7. `FRONTEND_URL` = `https://tickets.magueynightclub.com`
8. `ENVIRONMENT` = `production`

**Recommended (3 secrets, skip if not using):**
9. `UPSTASH_REDIS_REST_URL` = (from Upstash console, if using rate limiting)
10. `UPSTASH_REDIS_REST_TOKEN` = (from Upstash console, if using rate limiting)
11. `SENTRY_DSN` = (from Sentry project settings, if using error tracking)

**Also run this SQL in Supabase SQL Editor** to set the QR signing secret for PostgreSQL functions:
```sql
ALTER DATABASE postgres SET app.qr_signing_secret = '<same-value-as-QR_SIGNING_SECRET-above>';
```

CRITICAL SECURITY NOTES:
- Do NOT set VITE_QR_SIGNING_SECRET anywhere. Phase 17 moved QR verification server-side.
- The QR_SIGNING_SECRET MUST be a newly generated value, not the one from CLAUDE.md.
- ALLOWED_ORIGINS must NOT be `*`. Use the exact comma-separated production domains.
  </action>
  <verify>
Check Supabase Dashboard -> Edge Functions -> Secrets. These secrets should all be listed:
- STRIPE_SECRET_KEY (from plan 23-02)
- STRIPE_WEBHOOK_SECRET (from plan 23-02)
- RESEND_API_KEY
- EMAIL_FROM_ADDRESS
- QR_SIGNING_SECRET
- ALLOWED_ORIGINS
- OWNER_EMAIL
- FRONTEND_URL
- ENVIRONMENT

Verify the ALTER DATABASE command ran:
```sql
SELECT current_setting('app.qr_signing_secret', true);
```
Should return the QR signing secret value (not empty).
  </verify>
  <done>All required Supabase Edge Function secrets are configured. QR_SIGNING_SECRET is a fresh rotated value. ALLOWED_ORIGINS is set to specific production domains. The ALTER DATABASE command has set app.qr_signing_secret.</done>
</task>

<task type="code">
  <name>Task 2: Clean up stale vercel.json in maguey-pass-lounge</name>
  <files>maguey-pass-lounge/vercel.json</files>
  <action>
Edit `maguey-pass-lounge/vercel.json`:

1. **Remove the `rewrites` section** entirely. It currently points to `https://your-backend.example.com/api/$1` which is a placeholder that will cause 404s. The app uses Supabase Edge Functions directly (not API rewrites).

2. **Remove the `env` block** entirely. The `env` block with `@` references (e.g., `"VITE_SUPABASE_URL": "@vite_supabase_url"`) is a Vercel legacy pattern. Vercel environment variables set in the dashboard are automatically injected at build time for Vite apps. The `@` references require matching "Vercel Secrets" (deprecated feature), and these likely don't match actual secret names. Removing this block means Vercel will use the environment variables set directly in the dashboard (which is the standard approach).

Keep: `$schema`, `framework`, `buildCommand`, `installCommand`, `outputDirectory`, `headers`.

The resulting vercel.json should only have:
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "framework": "vite",
  "buildCommand": "npm run build",
  "installCommand": "npm install",
  "outputDirectory": "dist",
  "headers": [ ... existing security headers unchanged ... ]
}
```

Do NOT modify the `headers` array. The security headers (CSP, HSTS, etc.) are correct.
  </action>
  <verify>
```bash
# Verify valid JSON
python3 -c "import json; json.load(open('maguey-pass-lounge/vercel.json'))" && echo "Valid JSON"

# Verify rewrites removed
python3 -c "import json; d=json.load(open('maguey-pass-lounge/vercel.json')); assert 'rewrites' not in d, 'rewrites still present'; print('No rewrites')"

# Verify env block removed
python3 -c "import json; d=json.load(open('maguey-pass-lounge/vercel.json')); assert 'env' not in d, 'env still present'; print('No env block')"

# Verify headers still present
python3 -c "import json; d=json.load(open('maguey-pass-lounge/vercel.json')); assert 'headers' in d; print(f'Headers: {len(d[\"headers\"][0][\"headers\"])} entries')"
```
  </verify>
  <done>maguey-pass-lounge/vercel.json is cleaned up: stale `rewrites` to `your-backend.example.com` removed, deprecated `env` block with `@` references removed, security headers preserved.</done>
</task>

<task type="manual">
  <name>Task 3: Set Vercel environment variables and deploy all 3 sites</name>
  <files>N/A (Vercel Dashboard)</files>
  <action>
Go to Vercel Dashboard (https://vercel.com/dashboard). For each of the 3 projects, go to Settings -> Environment Variables and set the following for the **Production** environment:

**Project: maguey-pass-lounge (tickets.magueynightclub.com)**
1. `VITE_SUPABASE_URL` = `https://djbzjasdrwvbsoifxqzd.supabase.co`
2. `VITE_SUPABASE_ANON_KEY` = (the anon key from CLAUDE.md)
3. `VITE_STRIPE_PUBLISHABLE_KEY` = `pk_live_...` (the LIVE publishable key from plan 23-02 Task 1)
4. `VITE_PURCHASE_SITE_URL` = `https://tickets.magueynightclub.com`

**Project: maguey-gate-scanner (staff.magueynightclub.com)**
1. `VITE_SUPABASE_URL` = `https://djbzjasdrwvbsoifxqzd.supabase.co`
2. `VITE_SUPABASE_ANON_KEY` = (the anon key from CLAUDE.md)
3. `VITE_PURCHASE_SITE_URL` = `https://tickets.magueynightclub.com`

**Project: maguey-nights (magueynightclub.com)**
1. `VITE_SUPABASE_URL` = `https://djbzjasdrwvbsoifxqzd.supabase.co`
2. `VITE_SUPABASE_ANON_KEY` = (the anon key from CLAUDE.md)
3. `VITE_PURCHASE_SITE_URL` = `https://tickets.magueynightclub.com`

CRITICAL: Do NOT set `VITE_QR_SIGNING_SECRET` on any project. Phase 17 moved QR verification server-side. QR validation happens in Supabase Edge Functions, not client-side.

After setting env vars, trigger a redeploy for each project:
- Go to Deployments tab -> click the most recent deployment -> "..." menu -> Redeploy

Alternatively, pushing the commit from plan 23-01 (with the vercel.json cleanup from Task 2) will trigger automatic deploys if Vercel is connected to GitHub.
  </action>
  <verify>
After deployment completes for all 3 sites:

1. Visit https://magueynightclub.com — marketing site loads, events display from Supabase
2. Visit https://tickets.magueynightclub.com — purchase site loads, events display, Stripe checkout initializes
3. Visit https://staff.magueynightclub.com — scanner site loads, login page appears
4. Check browser console on each site — no errors about missing env vars (SUPABASE_URL, etc.)
5. On tickets site: verify Stripe Elements load (card input renders) — confirms pk_live_ key is working
6. On staff site: log in with owner credentials — dashboard loads with real data

CRITICAL verification: Open browser DevTools -> Network tab on tickets site. Confirm NO requests to `your-backend.example.com` (the stale rewrite endpoint should be gone).
  </verify>
  <done>All 3 Vercel projects have production environment variables. All 3 sites are deployed and loading correctly. No VITE_QR_SIGNING_SECRET is present on any frontend.</done>
</task>

</tasks>

<verification>
1. Supabase Edge Function secrets include all 10+ required secrets (Stripe, Resend, QR, CORS, etc.)
2. `VITE_QR_SIGNING_SECRET` is NOT set on any Vercel project
3. `ALLOWED_ORIGINS` is set to specific domains (not `*`)
4. `maguey-pass-lounge/vercel.json` has no `rewrites` or `env` blocks
5. All 3 sites load correctly at their production domains
6. Browser console shows no env var errors
7. Stripe Elements render on the purchase site (confirms pk_live_ key works)
</verification>

<success_criteria>
- All required Supabase Edge Function secrets are configured (10+ secrets)
- QR_SIGNING_SECRET is rotated (new value, not the one in CLAUDE.md)
- ALTER DATABASE app.qr_signing_secret matches the Edge Function secret
- ALLOWED_ORIGINS = specific production domains
- All 3 Vercel projects have correct env vars (4 for pass-lounge, 3 for gate-scanner, 3 for maguey-nights)
- VITE_QR_SIGNING_SECRET is NOT present on any Vercel project
- maguey-pass-lounge/vercel.json is cleaned up (no stale rewrites or env block)
- All 3 production sites load without errors
- Stripe checkout works with live publishable key
- Optional: A small real purchase completes end-to-end (ticket created, email sent, QR scannable)
</success_criteria>

<output>
After completion, create `.planning/phases/23-cicd-deployment/23-03-SUMMARY.md`
</output>
