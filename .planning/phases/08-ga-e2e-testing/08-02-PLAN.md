---
phase: 08-ga-e2e-testing
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - e2e/specs/health-check.cy.ts
  - .github/workflows/e2e.yml
autonomous: true

must_haves:
  truths:
    - "Health checks verify DB, Stripe, and edge functions before tests run"
    - "CI workflow runs E2E tests on every commit"
    - "Tests run in parallel with 4 workers"
  artifacts:
    - path: "e2e/specs/health-check.cy.ts"
      provides: "Service health verification tests"
      contains: "healthCheck"
    - path: ".github/workflows/e2e.yml"
      provides: "GitHub Actions E2E workflow"
      contains: "cypress-io/github-action"
  key_links:
    - from: ".github/workflows/e2e.yml"
      to: "e2e/cypress.config.ts"
      via: "config-file flag"
      pattern: "config-file.*e2e/cypress.config.ts"
---

<objective>
Create health check tests and CI/CD pipeline for automated E2E test execution.

Purpose: Health checks ensure all services are available before running the test suite, preventing false failures. The CI pipeline enables automatic testing on every commit with parallel execution for speed.

Output: Health check test spec and GitHub Actions workflow that runs E2E tests on push/PR.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-ga-e2e-testing/08-CONTEXT.md
@.planning/phases/08-ga-e2e-testing/08-RESEARCH.md
@.planning/phases/08-ga-e2e-testing/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check test spec</name>
  <files>
    e2e/specs/health-check.cy.ts
  </files>
  <action>
Create e2e/specs/health-check.cy.ts that verifies all services before main test suite:

```typescript
/// <reference types="cypress" />

describe('Health Checks', () => {
  it('verifies database connectivity', () => {
    cy.task('healthCheck').then((checks: { db: boolean; stripe: boolean; edgeFunctions: boolean }) => {
      expect(checks.db, 'Database should be accessible').to.be.true;
    });
  });

  it('verifies Stripe API is available', () => {
    // Stripe test mode should always be available
    cy.task('healthCheck').then((checks: { db: boolean; stripe: boolean; edgeFunctions: boolean }) => {
      expect(checks.stripe, 'Stripe should be available').to.be.true;
    });
  });

  it('verifies edge functions are deployed', () => {
    cy.task('healthCheck').then((checks: { db: boolean; stripe: boolean; edgeFunctions: boolean }) => {
      expect(checks.edgeFunctions, 'Edge functions should be deployed').to.be.true;
    });
  });

  it('can access pass-lounge homepage', () => {
    cy.visit('/');
    cy.get('body').should('be.visible');
    cy.url().should('include', 'localhost:3016');
  });

  it('can access gate-scanner login page', () => {
    cy.visit(Cypress.env('SCANNER_URL') + '/auth');
    cy.get('body').should('be.visible');
    cy.url().should('include', 'localhost:3015');
  });

  it('has at least one upcoming published event', () => {
    cy.task('getTestEvent').then((event: any) => {
      expect(event, 'Should have an upcoming event for testing').to.not.be.null;
      expect(event.status).to.eq('published');
      cy.log(`Found test event: ${event.name} on ${event.event_datetime}`);
    });
  });
});
```

This test suite:
1. Checks database connectivity via Supabase client
2. Verifies Stripe (always true in test mode)
3. Checks edge functions availability
4. Loads both app homepages to verify they're running
5. Ensures there's a published event to test with
  </action>
  <verify>
With both apps running locally:
```bash
cd maguey-pass-lounge && npm run dev &
cd maguey-gate-scanner && npm run dev &
```
Run: `npx cypress run --config-file e2e/cypress.config.ts --spec "e2e/specs/health-check.cy.ts"`
All 6 tests should pass.
  </verify>
  <done>Health check tests verify DB, Stripe, edge functions, both app homepages, and test event availability</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>
    .github/workflows/e2e.yml
  </files>
  <action>
Create .github/workflows/e2e.yml for automated E2E testing:

```yaml
name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PK }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SK }}
  SCANNER_TEST_EMAIL: ${{ secrets.SCANNER_TEST_EMAIL }}
  SCANNER_TEST_PASSWORD: ${{ secrets.SCANNER_TEST_PASSWORD }}

jobs:
  # Build job - builds both apps once
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build pass-lounge
        run: npm run build --workspace=maguey-pass-lounge

      - name: Build gate-scanner
        run: npm run build --workspace=maguey-gate-scanner

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            maguey-pass-lounge/dist
            maguey-gate-scanner/dist
          retention-days: 1

  # E2E test job - runs in parallel containers
  e2e:
    runs-on: ubuntu-24.04
    needs: build
    strategy:
      fail-fast: false
      matrix:
        # 4 parallel workers per CONTEXT.md
        containers: [1, 2, 3, 4]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          config-file: e2e/cypress.config.ts
          # Start both preview servers
          start: |
            npx serve maguey-pass-lounge/dist -l 3016 &
            npx serve maguey-gate-scanner/dist -l 3015
          wait-on: 'http://localhost:3016, http://localhost:3015'
          wait-on-timeout: 120
          browser: chrome
          # Split tests across containers (basic split without Cypress Cloud)
          # Container 1: health + happy path
          # Container 2: happy path
          # Container 3: edge cases
          # Container 4: offline
          spec: |
            ${{ matrix.containers == 1 && 'e2e/specs/health-check.cy.ts,e2e/specs/happy-path/**/*.cy.ts' || '' }}
            ${{ matrix.containers == 2 && 'e2e/specs/happy-path/**/*.cy.ts' || '' }}
            ${{ matrix.containers == 3 && 'e2e/specs/edge-cases/**/*.cy.ts' || '' }}
            ${{ matrix.containers == 4 && 'e2e/specs/offline/**/*.cy.ts' || '' }}
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PK }}

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.containers }}
          path: e2e/screenshots
          retention-days: 7

      - name: Upload videos on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos-${{ matrix.containers }}
          path: e2e/videos
          retention-days: 7
```

This workflow:
1. Builds both apps once in a separate job
2. Runs 4 parallel test containers
3. Each container runs a subset of specs
4. Uploads screenshots and videos only on failure
5. Uses `serve` package to serve built apps (add as dev dependency)

Also add serve as a dev dependency:
```bash
npm install --save-dev serve
```
  </action>
  <verify>
1. Verify the workflow file is valid YAML: `cat .github/workflows/e2e.yml | python3 -c "import sys, yaml; yaml.safe_load(sys.stdin)"`
2. Check that .github/workflows directory exists
3. Verify serve is installed: `npm ls serve`
  </verify>
  <done>GitHub Actions workflow created with 4 parallel workers, artifact upload on failure, and proper secret handling</done>
</task>

</tasks>

<verification>
1. Health check tests pass locally with apps running
2. GitHub Actions workflow file is valid YAML
3. Workflow triggers on push to main/develop and PRs
4. 4 parallel containers configured in matrix
5. Screenshots/videos uploaded only on failure
</verification>

<success_criteria>
- Health check spec verifies DB, Stripe, edge functions, and both app availability
- CI workflow runs on every push and PR
- Tests execute in 4 parallel containers
- Build artifacts shared between jobs for efficiency
- Failure artifacts (screenshots, videos) preserved for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/08-ga-e2e-testing/08-02-SUMMARY.md`
</output>
