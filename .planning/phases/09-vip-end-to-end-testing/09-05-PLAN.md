---
phase: 09-vip-end-to-end-testing
plan: 05
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - maguey-gate-scanner/src/pages/Scanner.tsx
  - .planning/phases/09-vip-end-to-end-testing/09-GA-VIP-LINK-UAT.md
autonomous: false

must_haves:
  truths:
    - "Linked GA ticket scans successfully with VIP re-entry privilege"
    - "Regular GA ticket is rejected on second scan"
    - "Scanner shows VIP table information for linked tickets"
  artifacts:
    - path: ".planning/phases/09-vip-end-to-end-testing/09-GA-VIP-LINK-UAT.md"
      provides: "Manual UAT script for GA+VIP link testing"
      contains: "GA-VIP-LINKED"
  key_links:
    - from: "Scanner.tsx"
      to: "check_vip_linked_ticket_reentry RPC"
      via: "supabase.rpc call"
      pattern: "check_vip_linked_ticket_reentry"
---

<objective>
Add URL parameter support to GA Scanner and conduct manual UAT for GA tickets with VIP link.

Purpose: Validates success criteria #4 from ROADMAP: "Guest passes link correctly and scan independently at gate"

Output:
- Scanner.tsx with URL parameter support for testing (dev mode only)
- Manual UAT script documenting GA+VIP link test cases and results
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
@maguey-gate-scanner/src/pages/Scanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add URL parameter QR input to Scanner.tsx</name>
  <files>maguey-gate-scanner/src/pages/Scanner.tsx</files>
  <action>
Add URL parameter detection for testing, similar to VIPScanner implementation.

Implementation:
1. Add useEffect that runs on component mount
2. Gate behind DEV mode check: `import.meta.env.DEV || import.meta.env.MODE === 'test'`
3. Read `qr` parameter from URL
4. If qr parameter exists, call existing handleScan or equivalent function
5. Clear parameter from URL after processing
6. Add console.log for debugging

Find the appropriate scan handler function in Scanner.tsx - likely named handleScan, handleQRCode, or similar. The function that's called when QR scanner captures a code.

Security: This MUST be gated behind DEV mode. Production builds should NOT accept URL parameters.

```typescript
useEffect(() => {
  // Test-only: Accept QR token via URL parameter
  if (import.meta.env.DEV || import.meta.env.MODE === 'test') {
    const params = new URLSearchParams(window.location.search);
    const qrParam = params.get('qr');

    if (qrParam) {
      console.log('[TEST MODE] Processing QR from URL parameter:', qrParam);
      // Call the appropriate scan handler - adjust function name as needed
      handleScan(qrParam);

      // Clear parameter from URL
      const url = new URL(window.location.href);
      url.searchParams.delete('qr');
      window.history.replaceState({}, '', url.toString());
    }
  }
}, []); // Empty deps - run once on mount
```
  </action>
  <verify>
1. Start scanner app: `cd maguey-gate-scanner && npm run dev`
2. Navigate to GA scanner with URL param: `http://localhost:5174/scanner?qr=GA-VIP-LINKED-01`
3. Verify scan is processed
4. Verify URL parameter is cleared after processing
  </verify>
  <done>Scanner.tsx accepts ?qr=TOKEN parameter in dev mode for testing.</done>
</task>

<task type="auto">
  <name>Task 2: Create GA+VIP Link UAT script</name>
  <files>.planning/phases/09-vip-end-to-end-testing/09-GA-VIP-LINK-UAT.md</files>
  <action>
Create manual UAT documentation for GA tickets with VIP link.

UAT Script structure:
1. Prerequisites: Seed data applied (GA-VIP-LINKED-XX and GA-REGULAR-TEST-01 tokens)
2. Test cases for linked vs regular GA behavior
3. Result columns for PASS/FAIL and notes

Test cases to include:

**Linked GA Ticket Tests (VIP Privilege):**
- TC-GAL-01: First scan of GA-VIP-LINKED-01 - Expected: Success, show VIP table info
- TC-GAL-02: Re-scan of GA-VIP-LINKED-01 - Expected: Re-entry granted with gold banner, VIP table info
- TC-GAL-03: First scan of GA-VIP-LINKED-02 - Expected: Success, VIP guest count incremented
- TC-GAL-04: Re-scan of GA-VIP-LINKED-02 - Expected: Re-entry granted

**Regular GA Ticket Tests (No VIP Privilege):**
- TC-GAR-01: First scan of GA-REGULAR-TEST-01 - Expected: Success, standard GA check-in
- TC-GAR-02: Re-scan of GA-REGULAR-TEST-01 - Expected: REJECTION, "Already used" error
- TC-GAR-03: Third scan of GA-REGULAR-TEST-01 - Expected: REJECTION, "Already used" error

**Comparison Tests:**
- TC-CMP-01: Verify linked ticket shows "Guest of Table X" on success
- TC-CMP-02: Verify regular ticket does NOT show VIP info
- TC-CMP-03: Verify VIP checked_in_guests count includes linked GA scans

**Edge Cases:**
- TC-EDG-01: Scan linked ticket before VIP host checks in - Expected: Success (linked tickets independent)
- TC-EDG-02: Verify vip_scan_logs records linked ticket scans with correct entry_type

Format as markdown table with columns: ID, Test Case, Steps, Expected, Actual, Status, Notes
  </action>
  <verify>
File exists and contains all test cases listed.
  </verify>
  <done>UAT script created with comprehensive GA+VIP link test cases.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GA Scanner with URL parameter testing and UAT script for VIP-linked tickets</what-built>
  <how-to-verify>
Execute the UAT script manually:

**Prerequisites:**
1. Ensure seed data is applied (09-01 must be complete)
2. Start scanner app: `cd maguey-gate-scanner && npm run dev`
3. Open browser to http://localhost:5174
4. Select the test event (VIP Test Event)
5. Navigate to GA scanner (main scanner page)

**Execute test cases:**
1. Open 09-GA-VIP-LINK-UAT.md
2. For each test case, use the URL parameter method: `?qr=TOKEN`
3. Example: http://localhost:5174/scanner?qr=GA-VIP-LINKED-01
4. Record results in the UAT document

**Key verifications:**
- Linked GA tickets get VIP re-entry privilege (multiple scans allowed)
- Regular GA tickets are rejected on second scan ("already used")
- Linked tickets show VIP table info on scan result
- VIP checked_in_guests count is updated when linked tickets scan

**Critical difference to verify:**
- GA-VIP-LINKED-XX: Re-entry should be GRANTED (gold banner)
- GA-REGULAR-TEST-01: Re-entry should be REJECTED (red screen)

Report any failures with detailed observations.
  </how-to-verify>
  <resume-signal>Provide UAT results: "all passed" or describe failures for each test case</resume-signal>
</task>

</tasks>

<verification>
1. Scanner.tsx accepts ?qr=TOKEN in dev mode
2. URL parameter is gated behind DEV check
3. UAT script covers linked and regular GA behavior comparison
4. Human verification confirms VIP privilege extended to linked tickets only
</verification>

<success_criteria>
- Linked GA tickets scan successfully with VIP re-entry privilege
- Regular GA tickets are rejected on second scan
- VIP table info shown for linked tickets
- All UAT test cases pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-05-SUMMARY.md`
</output>
