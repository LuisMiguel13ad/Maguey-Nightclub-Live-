---
phase: 09-vip-end-to-end-testing
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - maguey-gate-scanner/src/components/vip/VIPScanner.tsx
  - .planning/phases/09-vip-end-to-end-testing/09-VIP-SCANNER-UAT.md
autonomous: false

must_haves:
  truths:
    - "VIP guest pass scans successfully on first entry"
    - "VIP guest pass grants re-entry on subsequent scans"
    - "Scanner shows correct guest count after each scan"
  artifacts:
    - path: ".planning/phases/09-vip-end-to-end-testing/09-VIP-SCANNER-UAT.md"
      provides: "Manual UAT script with test results"
      contains: "VIP-TEST-GUEST"
  key_links:
    - from: "VIPScanner.tsx"
      to: "process_vip_scan_with_reentry RPC"
      via: "supabase.rpc call"
      pattern: "process_vip_scan_with_reentry"
---

<objective>
Add URL parameter support to VIP Scanner for testing and conduct manual UAT for VIP scanner flows.

Purpose: Validates success criteria #3 from ROADMAP: "VIP QR code scans successfully and marks reservation as checked-in"

Output:
- VIPScanner.tsx with URL parameter support for testing (dev mode only)
- Manual UAT script documenting test cases and results
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
@maguey-gate-scanner/src/components/vip/VIPScanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add URL parameter QR input to VIPScanner</name>
  <files>maguey-gate-scanner/src/components/vip/VIPScanner.tsx</files>
  <action>
Add URL parameter detection for testing following RESEARCH.md Pattern 2.

Implementation:
1. Add useEffect that runs on component mount
2. Gate behind DEV mode check: `import.meta.env.DEV || import.meta.env.MODE === 'test'`
3. Read `qr` parameter from URL: `new URLSearchParams(window.location.search).get('qr')`
4. If qr parameter exists, call existing handleQRCode function with the token
5. Clear parameter from URL after processing to avoid re-processing on re-render
6. Add console.log for debugging: `[TEST MODE] Processing QR from URL parameter: ${qrParam}`

Security: This MUST be gated behind DEV mode. Production builds should NOT accept URL parameters for QR codes.

```typescript
useEffect(() => {
  // Test-only: Accept QR token via URL parameter
  if (import.meta.env.DEV || import.meta.env.MODE === 'test') {
    const params = new URLSearchParams(window.location.search);
    const qrParam = params.get('qr');

    if (qrParam) {
      console.log('[TEST MODE] Processing QR from URL parameter:', qrParam);
      handleQRCode(qrParam);

      // Clear parameter from URL to avoid re-processing
      const url = new URL(window.location.href);
      url.searchParams.delete('qr');
      window.history.replaceState({}, '', url.toString());
    }
  }
}, []); // Empty deps - run once on mount
```

Place this after the existing useEffect hooks but before the return statement.
  </action>
  <verify>
1. Start scanner app: `cd maguey-gate-scanner && npm run dev`
2. Navigate to VIP scanner with URL param: `http://localhost:5174/vip-scanner?qr=VIP-TEST-GUEST-01`
3. Verify scan is processed (success or appropriate error if token not in DB)
4. Verify URL parameter is cleared after processing
  </verify>
  <done>VIPScanner accepts ?qr=TOKEN parameter in dev mode for testing.</done>
</task>

<task type="auto">
  <name>Task 2: Create VIP Scanner UAT script</name>
  <files>.planning/phases/09-vip-end-to-end-testing/09-VIP-SCANNER-UAT.md</files>
  <action>
Create manual UAT documentation with test cases and result tracking.

UAT Script structure:
1. Prerequisites: Seed data applied, scanner app running, event selected
2. Test cases with expected outcomes
3. Result columns for PASS/FAIL and notes

Test cases to include:

**First Entry Tests:**
- TC-VIP-01: First guest scans VIP-TEST-GUEST-01 - Expected: Success, "Guest 1 of 8 checked in"
- TC-VIP-02: Second guest scans VIP-TEST-GUEST-02 - Expected: Success, "Guest 2 of 8 checked in"
- TC-VIP-03: Verify checked_in_guests incremented correctly after each scan

**Re-entry Tests:**
- TC-VIP-04: Re-scan VIP-TEST-GUEST-01 - Expected: Re-entry granted with gold banner
- TC-VIP-05: Re-scan VIP-TEST-GUEST-02 - Expected: Re-entry granted with gold banner
- TC-VIP-06: Verify vip_scan_logs has entry_type='reentry' for re-scans

**Error Tests:**
- TC-VIP-07: Scan invalid token "INVALID-TOKEN" - Expected: Rejection, invalid QR
- TC-VIP-08: Scan empty string - Expected: Rejection or no action

**Offline Tests:**
- TC-VIP-09: Enable network offline in DevTools, scan VIP-TEST-GUEST-03 - Expected: Queued locally
- TC-VIP-10: Re-enable network - Expected: Scan syncs, success shown

Format as markdown table with columns: ID, Test Case, Steps, Expected, Actual, Status, Notes
  </action>
  <verify>
File exists and contains all test cases listed.
  </verify>
  <done>UAT script created with comprehensive VIP scanner test cases.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>VIP Scanner with URL parameter testing and UAT script</what-built>
  <how-to-verify>
Execute the UAT script manually:

**Prerequisites:**
1. Ensure seed data is applied (09-01 must be complete)
2. Start scanner app: `cd maguey-gate-scanner && npm run dev`
3. Open browser to http://localhost:5174
4. Select the test event (VIP Test Event)
5. Navigate to VIP scanner

**Execute test cases:**
1. Open 09-VIP-SCANNER-UAT.md
2. For each test case, use the URL parameter method: `?qr=TOKEN`
3. Example: http://localhost:5174/vip-scanner?qr=VIP-TEST-GUEST-01
4. Record results in the UAT document

**Key verifications:**
- First scan shows success with guest count
- Re-scan shows re-entry granted with gold banner
- Invalid tokens are rejected
- Offline mode queues scans correctly

Report any failures with detailed observations.
  </how-to-verify>
  <resume-signal>Provide UAT results: "all passed" or describe failures for each test case</resume-signal>
</task>

</tasks>

<verification>
1. VIPScanner accepts ?qr=TOKEN in dev mode
2. URL parameter is gated behind DEV check (not in production)
3. UAT script covers first entry, re-entry, errors, and offline scenarios
4. Human verification confirms scanner behavior matches expectations
</verification>

<success_criteria>
- VIP guest passes scan successfully with correct feedback
- Re-entry scans show gold "RE-ENTRY GRANTED" banner
- Invalid tokens are properly rejected
- All UAT test cases pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-04-SUMMARY.md`
</output>
