---
phase: 09-vip-end-to-end-testing
plan: 07
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - maguey-pass-lounge/playwright/tests/vip-email-delivery.spec.ts
autonomous: true

must_haves:
  truths:
    - "VIP confirmation email queued after checkout"
    - "Email delivery webhook received and status updated"
    - "email_delivery_status shows 'delivered' event"
  artifacts:
    - path: "maguey-pass-lounge/playwright/tests/vip-email-delivery.spec.ts"
      provides: "Email delivery verification E2E test"
      contains: "email_delivery_status"
  key_links:
    - from: "vip-email-delivery.spec.ts"
      to: "email_queue table"
      via: "supabase.from polling"
      pattern: "from\\('email_queue'\\)"
    - from: "Resend webhook"
      to: "email_delivery_status table"
      via: "resend-webhook edge function"
      pattern: "email.delivered"
---

<objective>
Create Playwright E2E test to verify VIP confirmation email delivery.

Purpose: Validates that VIP reservations trigger email delivery with correct QR codes and table details (part of success criteria #1 from ROADMAP).

Output:
- Playwright test that completes VIP checkout and verifies email delivery via Resend webhook
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
@maguey-pass-lounge/playwright/tests/vip-checkout.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email delivery verification test</name>
  <files>maguey-pass-lounge/playwright/tests/vip-email-delivery.spec.ts</files>
  <action>
Create Playwright E2E test following RESEARCH.md Pattern 4.

Test flow:
1. Use VIP seed fixture to create test event and table
2. Complete VIP checkout (reuse pattern from vip-checkout.spec.ts)
3. After confirmation page visible, poll email_queue for entry
4. Wait for Resend webhook to deliver email.delivered event
5. Verify email_delivery_status shows successful delivery

Implementation:
```typescript
import { test, expect } from '@playwright/test';
import { createClient } from '@supabase/supabase-js';

test.describe('VIP Email Delivery', () => {
  test('VIP confirmation email delivered after checkout', async ({ page }) => {
    const supabase = createClient(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );

    // Complete VIP checkout flow
    // ... (same as vip-checkout.spec.ts up to confirmation page)

    // Wait for confirmation
    await expect(
      page.getByRole('heading', { name: /reservation confirmed/i })
    ).toBeVisible({ timeout: 30000 });

    // Get the reservation ID from session storage or URL
    const confirmationUrl = page.url();
    const reservationId = /* extract from URL or page content */;

    // Poll email_queue for VIP confirmation email
    let emailEntry = null;
    for (let i = 0; i < 30; i++) {
      const { data } = await supabase
        .from('email_queue')
        .select('id, resend_email_id, status, email_type')
        .eq('email_type', 'vip_confirmation')
        .order('created_at', { ascending: false })
        .limit(1);

      if (data?.[0]?.resend_email_id) {
        emailEntry = data[0];
        break;
      }
      await page.waitForTimeout(1000);
    }

    expect(emailEntry).toBeTruthy();
    expect(emailEntry.status).toMatch(/sent|delivered/);

    // Wait for delivery webhook (up to 60 seconds per RESEARCH.md)
    let delivered = false;
    for (let i = 0; i < 60; i++) {
      const { data } = await supabase
        .from('email_delivery_status')
        .select('event_type')
        .eq('resend_email_id', emailEntry.resend_email_id)
        .eq('event_type', 'email.delivered')
        .maybeSingle();

      if (data) {
        delivered = true;
        break;
      }
      await page.waitForTimeout(1000);
    }

    expect(delivered).toBe(true);
  });
});
```

Key considerations:
- Use generous timeout (60s) for webhook delivery per RESEARCH.md Pitfall 3
- Poll every 1 second to avoid overwhelming database
- Test should pass even if delivery takes up to 60 seconds
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-email-delivery.spec.ts --headed`
Test should complete with email delivery confirmed.
  </verify>
  <done>Email delivery test verifies complete flow from checkout to delivered webhook.</done>
</task>

<task type="auto">
  <name>Task 2: Add email content verification</name>
  <files>maguey-pass-lounge/playwright/tests/vip-email-delivery.spec.ts</files>
  <action>
Extend email delivery test to verify email content fields.

Add verification of email_queue entry:
1. recipient_email matches checkout email
2. email_type is 'vip_confirmation'
3. subject contains event name or "VIP Reservation"
4. html_content (if stored) contains QR code image or token reference

```typescript
// Verify email content fields
expect(emailEntry.recipient_email).toBe('[email protected]');
expect(emailEntry.email_type).toBe('vip_confirmation');

// Verify subject line (if available in queue)
if (emailEntry.subject) {
  expect(emailEntry.subject).toMatch(/vip|reservation|table/i);
}

// Optional: Check html_content for key elements
if (emailEntry.html_content) {
  expect(emailEntry.html_content).toContain('qr'); // QR code reference
  expect(emailEntry.html_content).toContain(vipTestData.tableName || 'table');
}
```

Also add test for email failure handling:
- Query for any emails with status='failed'
- Verify retry_count incremented on failure
- Verify error_message captured
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-email-delivery.spec.ts`
Tests should verify email content and delivery status.
  </verify>
  <done>Email test verifies both delivery and content correctness.</done>
</task>

<task type="auto">
  <name>Task 3: Add email queue monitoring test</name>
  <files>maguey-pass-lounge/playwright/tests/vip-email-delivery.spec.ts</files>
  <action>
Add test to verify email queue processing behavior.

Additional test case:
1. Query email_queue for test emails from VIP checkout tests
2. Verify processing timestamps:
   - created_at is set
   - sent_at is set after processing
   - Time between created_at and sent_at is reasonable (<2 minutes per ROADMAP)

3. Verify queue status progression:
   - Initial: 'pending'
   - After processing: 'sent'
   - After delivery webhook: status still 'sent' (delivery tracked separately)

```typescript
test('email queue processes VIP confirmation within 2 minutes', async ({ page }) => {
  // ... complete checkout ...

  // Find email entry
  const { data: emailEntry } = await supabase
    .from('email_queue')
    .select('created_at, sent_at, status')
    .eq('email_type', 'vip_confirmation')
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  expect(emailEntry.status).toBe('sent');
  expect(emailEntry.sent_at).toBeTruthy();

  // Verify processing time
  const created = new Date(emailEntry.created_at);
  const sent = new Date(emailEntry.sent_at);
  const processingTime = (sent.getTime() - created.getTime()) / 1000;

  expect(processingTime).toBeLessThan(120); // 2 minutes max
  console.log(`Email processed in ${processingTime.toFixed(1)}s`);
});
```

This verifies the email queue is processing efficiently.
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-email-delivery.spec.ts`
All email tests pass with processing time logged.
  </verify>
  <done>Email delivery tests verify queue processing, delivery, and timing.</done>
</task>

</tasks>

<verification>
1. Email delivery test runs after VIP checkout
2. email_queue entry created with correct type and recipient
3. Resend processes email and returns resend_email_id
4. email.delivered webhook received within 60 seconds
5. email_delivery_status updated with delivery confirmation
6. Processing time is under 2 minutes
</verification>

<success_criteria>
- VIP confirmation email queued immediately after checkout
- Email delivered via Resend within reasonable time
- Webhook updates email_delivery_status to 'delivered'
- Complete audit trail from checkout to delivery
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-07-SUMMARY.md`
</output>
