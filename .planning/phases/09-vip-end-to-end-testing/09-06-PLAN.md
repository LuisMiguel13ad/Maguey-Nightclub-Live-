---
phase: 09-vip-end-to-end-testing
plan: 06
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - scripts/test-vip-concurrency.ts
autonomous: true

must_haves:
  truths:
    - "Concurrent VIP check-ins complete without duplicate entries"
    - "checked_in_guests count is accurate after concurrent scans"
    - "vip_scan_logs has exactly one entry per guest pass"
  artifacts:
    - path: "scripts/test-vip-concurrency.ts"
      provides: "Concurrent VIP check-in test script"
      contains: "Promise.allSettled"
  key_links:
    - from: "scripts/test-vip-concurrency.ts"
      to: "process_vip_scan_with_reentry RPC"
      via: "parallel supabase.rpc calls"
      pattern: "rpc\\('process_vip_scan_with_reentry'"
---

<objective>
Create and run concurrent VIP check-in test to verify race condition handling.

Purpose: Validates success criteria #5 from ROADMAP: "Multiple concurrent checkins for same reservation handled correctly"

Output:
- TypeScript script that tests concurrent VIP check-ins using multiple Supabase connections
- Test results showing no duplicates and accurate counts
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create concurrent VIP check-in test script</name>
  <files>scripts/test-vip-concurrency.ts</files>
  <action>
Create TypeScript script following RESEARCH.md Pattern 3.

Implementation:

1. Setup:
   - Read SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from environment
   - Create 5 separate Supabase clients (simulating 5 simultaneous scanners)
   - Use the test reservation from seed data (ID: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa)

2. Reset test state:
   - Reset checked_in_guests to 0 on test reservation
   - Delete any existing scan logs for test guest passes
   - Reset guest pass statuses to 'active'

3. Concurrent scan execution:
   - Get 5 guest pass IDs from seed data (VIP-TEST-GUEST-01 through 05)
   - Use Promise.allSettled to call process_vip_scan_with_reentry concurrently
   - Pass different scanner device IDs for each "scanner"

4. Verification:
   - All 5 calls should succeed (no race condition errors)
   - checked_in_guests should equal exactly 5
   - vip_scan_logs should have exactly 5 entries (one per guest)
   - No duplicate scan log entries

5. Output results:
   - Print success/failure for each concurrent scan
   - Print final checked_in_guests count
   - Print scan log count
   - Exit 0 if all verifications pass, 1 if any fail

```typescript
// Core test logic
const GUEST_PASS_TOKENS = [
  'VIP-TEST-GUEST-01', 'VIP-TEST-GUEST-02', 'VIP-TEST-GUEST-03',
  'VIP-TEST-GUEST-04', 'VIP-TEST-GUEST-05'
];

const clients = GUEST_PASS_TOKENS.map(() =>
  createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!)
);

// Execute concurrently
const results = await Promise.allSettled(
  clients.map((client, idx) =>
    client.rpc('process_vip_scan_with_reentry', {
      p_qr_token: GUEST_PASS_TOKENS[idx],
      p_scanned_by: `test-scanner-${idx}`
    })
  )
);
```

Handle the specific RPC parameter names - check existing code for exact parameter names.
  </action>
  <verify>
Run: `npx tsx scripts/test-vip-concurrency.ts`
Should output success for all 5 concurrent scans and verification results.
  </verify>
  <done>Concurrency test script created with proper parallel execution.</done>
</task>

<task type="auto">
  <name>Task 2: Run concurrency test and verify results</name>
  <files>N/A - execution only</files>
  <action>
Execute the concurrency test script and verify results.

Steps:
1. Ensure seed data is applied from 09-01
2. Run the test: `npx tsx scripts/test-vip-concurrency.ts`
3. Verify output shows:
   - All 5 concurrent scans succeeded
   - No duplicate key or race condition errors
   - checked_in_guests = 5
   - vip_scan_logs count = 5

4. If any verification fails:
   - Check process_vip_scan_with_reentry RPC for proper locking
   - Verify row-level locking is using FOR UPDATE NOWAIT or similar
   - Check for proper transaction isolation

5. Run test multiple times (3x) to ensure consistency

6. Document results in script comments or output
  </action>
  <verify>
1. Script runs without errors 3 times consecutively
2. checked_in_guests = 5 after each run
3. No duplicate scan logs created
4. All concurrent scans completed successfully
  </verify>
  <done>Concurrency test passes consistently, confirming no race conditions in VIP check-in.</done>
</task>

<task type="auto">
  <name>Task 3: Add re-entry concurrency test</name>
  <files>scripts/test-vip-concurrency.ts</files>
  <action>
Extend the concurrency test to also test concurrent re-entry scenarios.

Add second test case:
1. After first concurrent check-in test passes
2. Reset scan logs but keep checked_in_guests at 5
3. Run concurrent re-entry scans for the same 5 guest passes
4. Verify:
   - All 5 re-entry scans succeed
   - Scan logs have entry_type='reentry' for second batch
   - No errors about "already checked in" (re-entry is allowed for VIP)
   - Total scan logs = 10 (5 first entry + 5 re-entry)

This tests that concurrent re-entry scans also handle race conditions correctly.

```typescript
// Re-entry test
console.log('\n--- Running Re-entry Concurrency Test ---');

const reentryResults = await Promise.allSettled(
  clients.map((client, idx) =>
    client.rpc('process_vip_scan_with_reentry', {
      p_qr_token: GUEST_PASS_TOKENS[idx],
      p_scanned_by: `test-scanner-${idx}`
    })
  )
);

// Verify re-entry worked
const reentrySuccesses = reentryResults.filter(r => r.status === 'fulfilled');
console.log(`Re-entry scans: ${reentrySuccesses.length}/5 succeeded`);
```
  </action>
  <verify>
Run: `npx tsx scripts/test-vip-concurrency.ts`
Should show both first-entry and re-entry concurrent tests passing.
  </verify>
  <done>Concurrency test covers both first-entry and re-entry scenarios.</done>
</task>

</tasks>

<verification>
1. Concurrency test script runs successfully
2. 5 concurrent check-ins complete without errors
3. checked_in_guests count is exactly 5
4. No duplicate scan log entries
5. Re-entry concurrency also works correctly
6. Test passes consistently on multiple runs
</verification>

<success_criteria>
- Concurrent VIP check-ins handled without race conditions
- checked_in_guests count accurate after concurrent operations
- vip_scan_logs maintains data integrity under concurrent load
- Both first-entry and re-entry concurrent scenarios pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-06-SUMMARY.md`
</output>
