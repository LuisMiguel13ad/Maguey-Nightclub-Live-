---
phase: 09-vip-end-to-end-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/supabase/seed/vip-e2e-test-data.sql
  - scripts/verify-vip-migrations.ts
autonomous: true

must_haves:
  truths:
    - "All 8 required VIP RPCs exist on remote Supabase database"
    - "Test event, tables, and reservations exist in database"
    - "QR tokens for manual testing are output and documented"
  artifacts:
    - path: "scripts/verify-vip-migrations.ts"
      provides: "RPC existence verification script"
      exports: ["verifyMigrations"]
    - path: "maguey-pass-lounge/supabase/seed/vip-e2e-test-data.sql"
      provides: "Idempotent VIP test data seed script"
      contains: "ON CONFLICT"
  key_links:
    - from: "scripts/verify-vip-migrations.ts"
      to: "Supabase remote database"
      via: "supabase.rpc() calls"
      pattern: "supabase\\.rpc\\("
---

<objective>
Verify all VIP migrations are applied to remote Supabase and create idempotent seed data for E2E testing.

Purpose: Phase 4 UAT showed 5/8 tests blocked by unapplied migrations. This plan ensures all VIP RPCs exist before any testing begins, and creates complete test data including QR tokens for manual UAT.

Output:
- Verification script that fails fast if migrations missing
- SQL seed script with test event, VIP tables, reservations, and guest passes
- QR tokens output for use in manual UAT plans
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VIP migration verification script</name>
  <files>scripts/verify-vip-migrations.ts</files>
  <action>
Create TypeScript script that verifies all 8 required VIP RPCs exist on remote Supabase:

Required RPCs to verify:
- check_vip_linked_ticket_reentry
- process_vip_scan_with_reentry
- scan_ticket_atomic
- increment_vip_checked_in
- create_unified_vip_checkout
- verify_vip_pass_signature
- link_ticket_to_vip
- check_vip_capacity

Implementation:
1. Read SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from environment
2. For each RPC, call `supabase.rpc(rpcName, {})` - empty params will error but confirms existence
3. Parse error message: "function does not exist" = missing, other errors = exists
4. Output results with checkmarks for each RPC
5. Exit with code 1 if any missing, 0 if all present

Use createClient from @supabase/supabase-js. Script should be runnable with `npx tsx scripts/verify-vip-migrations.ts`.

If any RPCs missing, output: "Run: supabase db push" with clear instructions.
  </action>
  <verify>
Run: `npx tsx scripts/verify-vip-migrations.ts`
Should output checkmarks for all 8 RPCs or fail with clear missing list.
  </verify>
  <done>Script exits 0 with all 8 RPCs verified, or exits 1 with clear instructions to push migrations.</done>
</task>

<task type="auto">
  <name>Task 2: Create idempotent VIP test data seed script</name>
  <files>maguey-pass-lounge/supabase/seed/vip-e2e-test-data.sql</files>
  <action>
Create SQL seed script following patterns from RESEARCH.md Pattern 5.

Script must:
1. Use fixed UUIDs for predictable test data (format: 99999999-..., aaaaaaaa-..., etc.)
2. Use ON CONFLICT DO NOTHING or DO UPDATE for idempotency
3. Create:
   - Test event (future date, 30 days from now)
   - 3 VIP tables (premium $750, front_row $700, standard $600)
   - VIP reservation in 'confirmed' status
   - 8 guest passes with predictable QR tokens (VIP-TEST-GUEST-01 through 08)
   - 3 linked GA tickets for testing VIP privilege
   - 1 regular GA ticket (for comparison testing)
4. Use generate_series for guest pass creation
5. Generate QR signatures using hmac() with 'test-secret' key
6. Output all QR tokens at end for manual testing use

Token format:
- VIP guest passes: VIP-TEST-GUEST-01 through VIP-TEST-GUEST-08
- Linked GA tickets: GA-VIP-LINKED-01 through GA-VIP-LINKED-03
- Regular GA ticket: GA-REGULAR-TEST-01

Include SELECT statement at end to output tokens in table format.
  </action>
  <verify>
Run in Supabase SQL editor or via: `psql -f maguey-pass-lounge/supabase/seed/vip-e2e-test-data.sql`
Should complete without errors, output QR tokens table.
Re-run should complete without errors (idempotent).
  </verify>
  <done>Seed script creates complete VIP test scenario with 8 guest passes, 3 linked GA tickets, 1 regular GA ticket, and outputs tokens for UAT.</done>
</task>

<task type="auto">
  <name>Task 3: Run verification and seed on remote database</name>
  <files>N/A - execution only</files>
  <action>
Execute the verification and seeding against remote Supabase:

1. Run migration verification:
   ```bash
   cd /Users/luismiguel/Desktop/Maguey-Nightclub-Live
   npx tsx scripts/verify-vip-migrations.ts
   ```

2. If migrations missing, run:
   ```bash
   cd maguey-pass-lounge
   supabase db push
   ```

3. Re-run verification to confirm

4. Apply seed data via Supabase CLI:
   ```bash
   cd maguey-pass-lounge
   supabase db reset --linked --db-url $SUPABASE_DB_URL < supabase/seed/vip-e2e-test-data.sql
   ```

   Or apply directly via SQL editor in Supabase Dashboard.

5. Document the QR tokens output for use in subsequent UAT plans.

Save the token output to a comment in the seed file for reference.
  </action>
  <verify>
1. `npx tsx scripts/verify-vip-migrations.ts` exits with code 0
2. Query remote DB: SELECT COUNT(*) FROM vip_guest_passes WHERE qr_token LIKE 'VIP-TEST-GUEST-%' returns 8
3. Query remote DB: SELECT COUNT(*) FROM tickets WHERE qr_code_token LIKE 'GA-VIP-LINKED-%' returns 3
  </verify>
  <done>All VIP RPCs verified, seed data applied to remote database, QR tokens documented for UAT.</done>
</task>

</tasks>

<verification>
1. Migration verification script runs and exits 0
2. Seed script is idempotent (can run multiple times without error)
3. Remote database contains:
   - Test event with future date
   - 3 VIP tables
   - 1 confirmed VIP reservation
   - 8 guest passes with VIP-TEST-GUEST-XX tokens
   - 3 linked GA tickets with VIP re-entry privilege
   - 1 regular GA ticket for comparison
4. QR tokens documented for use in 09-04 and 09-05 UAT
</verification>

<success_criteria>
- All 8 VIP RPCs exist on remote Supabase
- Seed data applied and queryable
- Subsequent plans can reference test tokens
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-01-SUMMARY.md`
</output>
