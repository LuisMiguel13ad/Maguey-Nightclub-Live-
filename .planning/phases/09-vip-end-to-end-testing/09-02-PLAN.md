---
phase: 09-vip-end-to-end-testing
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - maguey-pass-lounge/playwright/tests/vip-checkout.spec.ts
  - maguey-pass-lounge/playwright/fixtures/vip-seed.ts
autonomous: true

must_haves:
  truths:
    - "VIP table checkout completes with Stripe test card"
    - "Reservation is created in confirmed status after payment"
    - "Guest pass QR codes are displayed after checkout"
  artifacts:
    - path: "maguey-pass-lounge/playwright/tests/vip-checkout.spec.ts"
      provides: "VIP checkout E2E test"
      contains: "4242 4242 4242 4242"
    - path: "maguey-pass-lounge/playwright/fixtures/vip-seed.ts"
      provides: "Worker-scoped database fixture for VIP test data"
      exports: ["test"]
  key_links:
    - from: "vip-checkout.spec.ts"
      to: "VIP checkout page"
      via: "page.goto"
      pattern: "goto.*vip"
    - from: "vip-seed.ts"
      to: "Supabase database"
      via: "createClient insert"
      pattern: "supabase\\.from\\("
---

<objective>
Create Playwright E2E test for complete VIP table checkout flow.

Purpose: Validates success criteria #1 from ROADMAP: "Test VIP booking completes: payment -> webhook -> reservation confirmed -> email with table details"

Output:
- Playwright test covering full VIP checkout with Stripe test payment
- Worker-scoped fixture for database seeding
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
@maguey-pass-lounge/playwright/tests/checkout.spec.ts
@maguey-pass-lounge/playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VIP seed fixture</name>
  <files>maguey-pass-lounge/playwright/fixtures/vip-seed.ts</files>
  <action>
Create worker-scoped Playwright fixture for VIP test data following RESEARCH.md Pattern 1.

Implementation:
1. Extend base test with VipFixtures type containing eventId, tableId, reservationId
2. Use createClient with SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from process.env
3. In fixture setup:
   - Insert test event (unique name with timestamp to avoid conflicts)
   - Insert VIP table for that event (premium tier, $750, 8 guests)
4. Return fixture data to tests
5. In fixture teardown: Delete test event (cascades to tables)
6. Use `{ scope: 'worker' }` for efficiency (one setup per test worker)

Export extended test for use in spec files.

Note: For the E2E test, we create fresh data per worker to avoid conflicts with seed data from 09-01. The 09-01 seed data is for manual UAT; this fixture is for automated Playwright tests.
  </action>
  <verify>
Create a simple test that uses the fixture and logs the returned IDs.
Run: `cd maguey-pass-lounge && npx playwright test vip-checkout.spec.ts --headed`
  </verify>
  <done>Fixture creates isolated test event and VIP table, cleans up after tests complete.</done>
</task>

<task type="auto">
  <name>Task 2: Create VIP checkout E2E test</name>
  <files>maguey-pass-lounge/playwright/tests/vip-checkout.spec.ts</files>
  <action>
Create Playwright E2E test following existing checkout.spec.ts pattern.

Test flow:
1. Navigate to VIP tables page for test event
2. Wait for tables to load
3. Select an available VIP table
4. Click "Book Table" or equivalent CTA
5. Fill host information (name, email, guest count)
6. Proceed to payment
7. Fill Stripe test card (4242 4242 4242 4242, 12/30, 123)
8. Complete purchase
9. Verify confirmation page shows reservation confirmed
10. Verify guest passes are displayed (check for QR code elements)

Key assertions:
- page.waitForURL('**/vip-checkout**') after table selection
- page.waitForURL('**/payment**') after proceeding to payment
- Confirmation heading visible with 30s timeout (Stripe processing)
- Guest pass QR codes visible (locator('[data-qr-code]') or similar)

Use vipTest from fixtures/vip-seed.ts for database fixture.

Handle dynamic UI - the VIP checkout flow may have different steps than GA checkout. Adapt selectors as needed.
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-checkout.spec.ts --headed`
Test should complete with payment confirmation visible.
  </verify>
  <done>VIP checkout E2E test passes, confirming payment -> reservation -> confirmation flow.</done>
</task>

<task type="auto">
  <name>Task 3: Verify reservation created in database</name>
  <files>maguey-pass-lounge/playwright/tests/vip-checkout.spec.ts</files>
  <action>
Extend the VIP checkout test to verify database state after checkout.

Add to existing test:
1. After confirmation page visible, query database for the reservation
2. Use Supabase client to verify:
   - VIP reservation exists with status 'confirmed'
   - Reservation is linked to the correct table
   - Guest passes were created
   - checked_in_guests is 0 (not yet checked in)

Add verification:
```typescript
// After confirmation visible
const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// Query for reservation by email (since we used [email protected])
const { data: reservations } = await supabase
  .from('vip_reservations')
  .select('id, status, checked_in_guests, event_id')
  .eq('host_email', '[email protected]')
  .order('created_at', { ascending: false })
  .limit(1);

expect(reservations?.[0]?.status).toBe('confirmed');
expect(reservations?.[0]?.checked_in_guests).toBe(0);
```

This confirms the webhook processed correctly and created the reservation.
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-checkout.spec.ts`
Test should pass with database assertions confirming reservation state.
  </verify>
  <done>Test verifies complete flow: UI checkout -> Stripe payment -> webhook -> database reservation in confirmed status.</done>
</task>

</tasks>

<verification>
1. VIP checkout test runs and completes without errors
2. Payment processes with Stripe test card
3. Confirmation page displays reservation confirmed
4. Database query confirms reservation status is 'confirmed'
5. Guest passes exist in database linked to reservation
</verification>

<success_criteria>
- Playwright test passes for VIP checkout flow
- Reservation created with correct status after payment
- Test cleanup removes test data (no pollution)
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-02-SUMMARY.md`
</output>
