---
phase: 09-vip-end-to-end-testing
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - maguey-pass-lounge/playwright/tests/vip-floor-plan.spec.ts
autonomous: true

must_haves:
  truths:
    - "Floor plan shows table as available before booking"
    - "Floor plan updates to show table as booked after reservation"
    - "Realtime subscription delivers update within 5 seconds"
  artifacts:
    - path: "maguey-pass-lounge/playwright/tests/vip-floor-plan.spec.ts"
      provides: "VIP floor plan realtime E2E test"
      contains: "toHaveClass"
  key_links:
    - from: "vip-floor-plan.spec.ts"
      to: "Supabase Realtime"
      via: "database insert triggers subscription"
      pattern: "insert.*vip_reservations"
---

<objective>
Create Playwright E2E test for VIP floor plan realtime updates.

Purpose: Validates success criteria #2 from ROADMAP: "VIP floor plan shows table as booked immediately after confirmation"

Output:
- Playwright test that verifies floor plan updates in realtime when VIP reservation is created
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vip-end-to-end-testing/09-CONTEXT.md
@.planning/phases/09-vip-end-to-end-testing/09-RESEARCH.md
@maguey-pass-lounge/playwright/fixtures/vip-seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create floor plan realtime test</name>
  <files>maguey-pass-lounge/playwright/tests/vip-floor-plan.spec.ts</files>
  <action>
Create Playwright E2E test following RESEARCH.md Pattern 6.

Test flow:
1. Use VIP seed fixture to create test event with available table
2. Navigate to VIP tables/floor plan page for test event
3. Verify table shows as available (no reserved class/indicator)
4. Use Supabase client to directly insert a confirmed reservation for that table
5. Wait for floor plan to update via Supabase Realtime (up to 5 seconds)
6. Verify table now shows as reserved/booked

Key implementation:
```typescript
test('floor plan updates when VIP table booked', async ({ page, vipTestData }) => {
  // Navigate to VIP tables page
  await page.goto(`/vip-tables?eventId=${vipTestData.eventId}`);

  // Wait for tables to render
  await page.waitForSelector('[data-table-id]');

  // Verify table is available initially
  const tableCard = page.locator(`[data-table-id="${vipTestData.tableId}"]`);
  await expect(tableCard).not.toHaveClass(/reserved|booked/);

  // Insert reservation directly via database (triggers realtime)
  const supabase = createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );

  await supabase.from('vip_reservations').insert({
    event_id: vipTestData.eventId,
    table_id: vipTestData.tableId,
    status: 'confirmed',
    host_name: 'Realtime Test',
    host_email: '[email protected]',
    total_guests: 4
  });

  // Wait for realtime update (Supabase realtime is typically <1s)
  await expect(tableCard).toHaveClass(/reserved|booked/, { timeout: 5000 });
});
```

Adapt selectors based on actual floor plan component implementation.
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-floor-plan.spec.ts --headed`
Should see table change from available to reserved after database insert.
  </verify>
  <done>Test confirms floor plan updates in realtime when reservation created.</done>
</task>

<task type="auto">
  <name>Task 2: Add test for table availability state changes</name>
  <files>maguey-pass-lounge/playwright/tests/vip-floor-plan.spec.ts</files>
  <action>
Extend floor plan test to verify multiple state changes.

Add second test:
1. Create reservation in 'pending' state
2. Verify floor plan shows table as pending/held (if UI differentiates)
3. Update reservation to 'confirmed' via database
4. Verify floor plan updates to show confirmed/booked
5. Update reservation to 'cancelled' via database
6. Verify floor plan updates to show table as available again

This tests the full lifecycle of table availability via realtime:
- pending: Table held but not confirmed
- confirmed: Table booked
- cancelled: Table available again

Handle case where UI doesn't differentiate pending/confirmed - just verify booked vs available transitions.

Also add test for subscription reconnection:
1. Navigate to floor plan page
2. Wait for subscription active (live indicator visible if present)
3. Create reservation via database
4. Verify update received
  </action>
  <verify>
Run: `cd maguey-pass-lounge && npx playwright test vip-floor-plan.spec.ts`
All floor plan realtime tests should pass.
  </verify>
  <done>Floor plan realtime tests cover booking, state transitions, and availability updates.</done>
</task>

</tasks>

<verification>
1. Floor plan test navigates to VIP tables page
2. Initial state shows table as available
3. Database insert triggers realtime update
4. UI updates within 5 seconds to show table as booked
5. Test cleanup removes test reservation
</verification>

<success_criteria>
- Playwright test passes for floor plan realtime updates
- Table availability changes reflected in UI within 5 seconds
- Supabase Realtime subscription working correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-vip-end-to-end-testing/09-03-SUMMARY.md`
</output>
