---
phase: 19-dashboard-accuracy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/pages/OwnerDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Recent orders table shows actual ticket count per order (not 0)"
    - "Recent orders table shows primary ticket type per order (not 'General')"
    - "Revenue trend percentage displays real week-over-week delta from database data"
    - "Multi-ticket orders show the most expensive ticket type as primary"
  artifacts:
    - path: "maguey-gate-scanner/src/pages/OwnerDashboard.tsx"
      provides: "Orders query with tickets join and aggregation transform"
      contains: "tickets(ticket_type_name, price)"
  key_links:
    - from: "maguey-gate-scanner/src/pages/OwnerDashboard.tsx"
      to: "supabase orders table"
      via: "select with tickets relationship join"
      pattern: 'from.*orders.*select.*tickets'
---

<objective>
Verify revenue trends are correctly calculated from real data, and fix the hardcoded ticket_count (always 0) and ticket_type (always 'General') in the Recent Purchases table by joining the tickets table in the orders query.

Purpose: The owner dashboard shows recent orders with placeholder data — "0" tickets and "General" type — regardless of what was actually purchased. This makes the dashboard unreliable for business decisions. Revenue trends were previously flagged as hardcoded but research shows they are already dynamically calculated.

Output: OwnerDashboard.tsx with working ticket count/type from real database relationships.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/19-dashboard-accuracy/19-CONTEXT.md
@.planning/phases/19-dashboard-accuracy/19-RESEARCH.md

Key source files:
@maguey-gate-scanner/src/pages/OwnerDashboard.tsx — lines 314-317 (orders query), lines 506-517 (transform with hardcoded values)
@maguey-gate-scanner/src/components/dashboard/RecentPurchases.tsx — Order interface expects ticket_type: string, ticket_count: number
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify revenue trends and fix orders query with tickets join</name>
  <files>maguey-gate-scanner/src/pages/OwnerDashboard.tsx</files>
  <action>
**Part A — Revenue Trend Verification (GSD-10 / R13):**
Verify that the revenue trend calculation at lines 440-502 is working correctly:
- Lines 440-445: Week-over-week date ranges are computed from real `fourteenDayPoints`
- Line 447-449: `revenueTrendDelta` uses real revenue data
- Line 502: Stored in `weekOverWeek` state
- Line 803: Displayed in hero section as `{weekOverWeek.toFixed(1)}% vs last week`
- Confirm no hardcoded percentages (12.5%, 8.2%, -3.1%) remain anywhere in the file
If correct (expected), no code changes needed for revenue trends.

**Part B — Fix Orders Query (GSD-11, GSD-12 / R14, R15):**

1. Update the orders query at lines 314-317 to include a JOIN to the tickets table:

```typescript
const { data: ordersData, error: ordersError } = await supabase
  .from<any>("orders")
  .select("id, total, created_at, status, purchaser_email, purchaser_name, event_id, events(name), tickets(ticket_type_name, price)")
  .order('created_at', { ascending: false })
  .limit(10);
```

IMPORTANT: The select adds `tickets(ticket_type_name, price)` which uses the foreign key relationship `tickets.order_id -> orders.id`. Also add `.order()` and `.limit(10)` to the query itself instead of doing `.slice(0, 10)` client-side later (line 506).

NOTE on column names: The code currently uses `purchaser_email` and `purchaser_name` (lines 508-509). If these columns don't exist in the schema (the migration shows `customer_email`, `customer_first_name`, `customer_last_name`), the query may be returning nulls already. Check if there was a migration that aliased these. If the query works as-is with `purchaser_email`/`purchaser_name`, keep them. If they return null, switch to `customer_email, customer_first_name, customer_last_name` and update the transform accordingly.

2. Update the transform block at lines 506-517 to aggregate real ticket data:

```typescript
const transformedOrders = (ordersData || []).map((order: any) => {
  const tickets = order.tickets || [];
  const ticketCount = tickets.length;

  // Find primary ticket type: most expensive ticket in the order
  const primaryTicket = tickets.length > 0
    ? tickets.reduce((highest: any, ticket: any) =>
        (Number(ticket.price) || 0) > (Number(highest.price) || 0) ? ticket : highest,
        tickets[0]
      )
    : null;

  return {
    id: order.id,
    customer_email: order.purchaser_email || order.customer_email || '',
    customer_name: order.purchaser_name || (order.customer_first_name ? `${order.customer_first_name} ${order.customer_last_name || ''}`.trim() : null),
    event_name: (order.events as any)?.name || 'Unknown Event',
    ticket_type: primaryTicket?.ticket_type_name || 'Unknown',
    ticket_count: ticketCount,
    total: Number(order.total || 0) / 100,
    status: order.status || 'pending',
    created_at: order.created_at,
    completed_at: order.created_at,
  };
});
```

Key logic:
- `ticket_count`: `tickets.length` (actual count from joined data)
- `ticket_type`: Pick `ticket_type_name` from the ticket with the highest `price` in the order (VIP dominates over GA)
- Handle edge case: order with 0 tickets shows "Unknown" type and 0 count
- Handle column name ambiguity: Try `purchaser_email` first, fall back to `customer_email`

3. Remove the `.slice(0, 10)` from line 506 since the query now has `.limit(10)`.
  </action>
  <verify>
Run `npm run build --workspace=maguey-gate-scanner` to verify no TypeScript/build errors.
Grep for "ticket_type: 'General'" in OwnerDashboard.tsx — should find zero matches.
Grep for "ticket_count: 0" as a hardcoded assignment in OwnerDashboard.tsx — should find zero matches.
Grep for hardcoded percentages "12.5" or "8.2" or "-3.1" in OwnerDashboard.tsx — should find zero matches.
  </verify>
  <done>
Orders query joins tickets table. Recent Purchases table displays real ticket_count (from tickets.length) and real ticket_type (from most expensive ticket's ticket_type_name). Revenue trends confirmed using real week-over-week calculations with no hardcoded values. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=maguey-gate-scanner` succeeds
2. No hardcoded 'General' or 0 for ticket_type/ticket_count in transform block
3. Orders query includes `tickets(ticket_type_name, price)` in select
4. Revenue trend calculation at lines 440-502 uses real data (no hardcoded percentages)
</verification>

<success_criteria>
- The RecentPurchases component receives orders with real ticket_count and ticket_type values from database
- Revenue trend percentage is dynamically calculated from actual ticket sales data
- Build passes without errors
- GSD items 10, 11, 12 addressed (R13, R14, R15)
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-accuracy/19-01-SUMMARY.md`
</output>
