---
phase: 19-dashboard-accuracy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/pages/AdvancedAnalytics.tsx
  - maguey-gate-scanner/src/pages/Dashboard.tsx
  - maguey-gate-scanner/src/lib/staff-name-service.ts
autonomous: true

must_haves:
  truths:
    - "Staff efficiency chart in AdvancedAnalytics shows human-readable names instead of UUIDs"
    - "Scan logs table in Dashboard shows staff names instead of raw scanned_by UUIDs"
    - "Unknown or missing staff IDs display a sensible fallback (email or 'Unknown Staff')"
    - "Staff name resolution is reusable across components via a shared service"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/staff-name-service.ts"
      provides: "Staff name resolution service with caching"
      exports: ["resolveStaffNames", "getStaffDisplayName"]
    - path: "maguey-gate-scanner/src/pages/AdvancedAnalytics.tsx"
      provides: "Staff efficiency with resolved names"
      contains: "resolveStaffNames"
    - path: "maguey-gate-scanner/src/pages/Dashboard.tsx"
      provides: "Scan logs with staff display names"
      contains: "resolveStaffNames"
  key_links:
    - from: "maguey-gate-scanner/src/lib/staff-name-service.ts"
      to: "supabase profiles table"
      via: "select on profiles with fallback to auth user_metadata"
      pattern: 'from.*profiles.*select.*first_name'
    - from: "maguey-gate-scanner/src/pages/AdvancedAnalytics.tsx"
      to: "maguey-gate-scanner/src/lib/staff-name-service.ts"
      via: "import and call resolveStaffNames"
      pattern: "import.*staff-name-service"
---

<objective>
Replace raw UUID display with human-readable staff names in the AdvancedAnalytics staff efficiency chart and Dashboard scan logs table by creating a reusable staff name resolution service.

Purpose: The owner sees cryptic UUIDs (e.g., "a1b2c3d4-...") when viewing staff performance metrics and scan logs. Staff names should show "Luis Badillo" or "info@magueynightclub.com" as fallback for recognizability. Phase 14 created real auth accounts with user_metadata.full_name and a profiles table.

Output: A staff-name-service.ts that caches name lookups, plus updated AdvancedAnalytics.tsx and Dashboard.tsx using resolved names.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/19-dashboard-accuracy/19-CONTEXT.md
@.planning/phases/19-dashboard-accuracy/19-RESEARCH.md

Key source files:
@maguey-gate-scanner/src/pages/AdvancedAnalytics.tsx — lines 395-438 (loadStaffEfficiency, staff_name: staffId at line 411)
@maguey-gate-scanner/src/pages/Dashboard.tsx — line 1557 ({log.scanned_by || "System"})

Database context:
- profiles table: id (UUID PK refs auth.users), first_name, last_name (from 20250320000000_auth_enhancements.sql)
- auth.users: raw_user_metadata->>'full_name' (set by Phase 14 account creation)
- scan_logs: scanned_by (UUID referencing auth.users)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create staff name resolution service with caching</name>
  <files>maguey-gate-scanner/src/lib/staff-name-service.ts</files>
  <action>
Create a new file `maguey-gate-scanner/src/lib/staff-name-service.ts` that provides reusable staff name resolution:

```typescript
/**
 * Staff Name Resolution Service
 *
 * Resolves user UUIDs to human-readable display names using the profiles table,
 * with fallback to a truncated UUID. Caches results to avoid repeated queries.
 */
import { supabase } from '@/integrations/supabase/client';

// In-memory cache: UUID -> display name
const nameCache = new Map<string, string>();

/**
 * Resolve a batch of staff UUIDs to display names.
 * Queries the profiles table for first_name + last_name.
 * Falls back to truncated UUID if no profile found.
 * Results are cached for subsequent lookups.
 *
 * @param userIds - Array of user UUIDs to resolve
 * @returns Map of UUID -> display name
 */
export async function resolveStaffNames(userIds: string[]): Promise<Map<string, string>> {
  const result = new Map<string, string>();
  const uncachedIds: string[] = [];

  // Check cache first
  for (const id of userIds) {
    if (!id || id === 'unknown') {
      result.set(id || 'unknown', 'Unknown Staff');
      continue;
    }
    const cached = nameCache.get(id);
    if (cached) {
      result.set(id, cached);
    } else {
      uncachedIds.push(id);
    }
  }

  if (uncachedIds.length === 0) return result;

  // Query profiles table for uncached IDs
  try {
    const { data: profiles, error } = await supabase
      .from('profiles')
      .select('id, first_name, last_name')
      .in('id', uncachedIds);

    if (!error && profiles) {
      for (const profile of profiles) {
        const fullName = [profile.first_name, profile.last_name]
          .filter(Boolean)
          .join(' ')
          .trim();
        if (fullName) {
          nameCache.set(profile.id, fullName);
          result.set(profile.id, fullName);
        }
      }
    }
  } catch (err) {
    console.warn('[staff-name-service] Error querying profiles:', err);
  }

  // For any still-unresolved IDs, use truncated UUID as fallback
  for (const id of uncachedIds) {
    if (!result.has(id)) {
      const fallback = id.length > 8 ? `Staff-${id.slice(0, 8)}` : id;
      nameCache.set(id, fallback);
      result.set(id, fallback);
    }
  }

  return result;
}

/**
 * Get display name for a single staff ID (sync, cache-only).
 * Call resolveStaffNames first to populate cache.
 */
export function getStaffDisplayName(userId: string): string {
  if (!userId || userId === 'unknown') return 'Unknown Staff';
  return nameCache.get(userId) || (userId.length > 8 ? `Staff-${userId.slice(0, 8)}` : userId);
}

/**
 * Clear the staff name cache (useful on logout or role change).
 */
export function clearStaffNameCache(): void {
  nameCache.clear();
}
```

Design decisions:
- Uses profiles table (created in Phase 14 auth_enhancements migration) which is queryable by any authenticated user (not SECURITY DEFINER needed since profiles has RLS allowing select for authenticated users)
- Batch resolution to minimize queries (one query per batch of unknown IDs)
- In-memory cache avoids repeated queries within a session
- Truncated UUID fallback (`Staff-a1b2c3d4`) is better than raw 36-char UUID for display
- No dependency on auth.admin (which requires service role key)
  </action>
  <verify>
Verify file exists: `ls maguey-gate-scanner/src/lib/staff-name-service.ts`
Verify exports: grep for `export async function resolveStaffNames` and `export function getStaffDisplayName`
Run `npm run build --workspace=maguey-gate-scanner` to check for import/type errors
  </verify>
  <done>
staff-name-service.ts exists with resolveStaffNames (async batch), getStaffDisplayName (sync cache), and clearStaffNameCache exports. Queries profiles table with in-memory caching and truncated UUID fallback. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire staff names into AdvancedAnalytics and Dashboard</name>
  <files>maguey-gate-scanner/src/pages/AdvancedAnalytics.tsx, maguey-gate-scanner/src/pages/Dashboard.tsx</files>
  <action>
**AdvancedAnalytics.tsx — Staff Efficiency Chart:**

1. Add import at top of file:
```typescript
import { resolveStaffNames } from '@/lib/staff-name-service';
```

2. Update `loadStaffEfficiency` function (around line 395) to resolve names after aggregation:

After the existing `staffMap` aggregation loop (line 431 area), before setting state, add name resolution:

```typescript
// After the efficiency_score calculation loop...

// Resolve staff names from profiles table
const staffIds = Array.from(staffMap.keys()).filter(id => id !== 'unknown');
const nameMap = await resolveStaffNames(staffIds);

// Apply resolved names
Array.from(staffMap.values()).forEach(staff => {
  staff.staff_name = nameMap.get(staff.staff_id) || staff.staff_id;
});

setStaffEfficiency(Array.from(staffMap.values()).sort((a, b) => b.efficiency_score - a.efficiency_score));
```

This replaces the current line 411 pattern `staff_name: staffId` where the UUID is used directly as the display name. The chart at line 1292 uses `dataKey="staff_name"` so the resolved name will appear automatically.

**Dashboard.tsx — Scan Logs Table:**

1. Add import at top of file:
```typescript
import { resolveStaffNames, getStaffDisplayName } from '@/lib/staff-name-service';
```

2. Find where scan logs are fetched/loaded. After the scan log data is loaded and before it's set to state, resolve the staff names in batch:

```typescript
// After fetching scan logs data, resolve names for all scanned_by UUIDs
const scannerIds = [...new Set((logsData || []).map((l: any) => l.scanned_by).filter(Boolean))];
if (scannerIds.length > 0) {
  await resolveStaffNames(scannerIds);
}
```

3. At line 1557, replace the raw UUID display:
Change: `{log.scanned_by || "System"}`
To: `{getStaffDisplayName(log.scanned_by) || "System"}`

This works because `resolveStaffNames` populates the cache, and `getStaffDisplayName` reads from cache synchronously.
  </action>
  <verify>
Run `npm run build --workspace=maguey-gate-scanner` — no build errors.
Grep for `staffId` being assigned directly to `staff_name` in AdvancedAnalytics.tsx — should NOT find `staff_name: staffId` pattern (replaced with resolved name).
Grep for `log.scanned_by || "System"` in Dashboard.tsx — should NOT find this pattern (replaced with getStaffDisplayName).
Grep for `resolveStaffNames` in AdvancedAnalytics.tsx and Dashboard.tsx — should find matches (imported and used).
  </verify>
  <done>
AdvancedAnalytics staff efficiency chart displays resolved staff names from profiles table. Dashboard scan logs table shows staff display names instead of raw UUIDs. Both pages use the shared staff-name-service with caching. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=maguey-gate-scanner` succeeds
2. staff-name-service.ts exists with batch resolution and caching
3. AdvancedAnalytics.tsx uses resolveStaffNames in loadStaffEfficiency
4. Dashboard.tsx uses getStaffDisplayName in scan logs display
5. No raw UUIDs visible where staff names should appear
</verification>

<success_criteria>
- Staff efficiency chart shows human-readable names (from profiles table) not UUIDs
- Scan logs table shows staff display names not UUIDs
- Fallback works for unknown IDs (shows "Staff-{first8chars}")
- Build passes without errors
- GSD item 13 addressed (R16)
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-accuracy/19-02-SUMMARY.md`
</output>
