---
phase: 01-payment-flow-hardening
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
  - maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts
autonomous: true

must_haves:
  truths:
    - "Owner receives email when ticket creation fails after successful payment"
    - "Owner sees pending payment in dashboard"
    - "Failed payments create 'pending' record in payment_failures table"
  artifacts:
    - path: "maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts"
      provides: "Owner notification Edge Function"
      contains: "Resend"
    - path: "maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts"
      provides: "Webhook with failure notification"
      contains: "notify-payment-failure"
  key_links:
    - from: "stripe-webhook/index.ts"
      to: "payment_failures table"
      via: "insert on ticket creation failure"
      pattern: "insert.*payment_failures"
    - from: "notify-payment-failure/index.ts"
      to: "Resend API"
      via: "email to owner"
      pattern: "resend\\.emails\\.send"
---

<objective>
Create owner notification system for payment failures where payment succeeded but ticket/reservation creation failed.

Purpose: Per user decision, after all retries fail, notify owner via BOTH email AND dashboard notification. Create "pending" record visible in dashboard. This ensures no customer is charged without receiving their ticket.

Output: New Edge Function for notifications and updated webhook to call it on failure.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-payment-flow-hardening/01-CONTEXT.md
@.planning/phases/01-payment-flow-hardening/01-RESEARCH.md
@maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notify-payment-failure Edge Function</name>
  <files>maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts</files>
  <action>
Create a new Supabase Edge Function for notifying owners of payment failures:

1. Create function directory and index.ts:
   ```
   maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts
   ```

2. Implementation:
   ```typescript
   import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
   import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
   import { Resend } from "https://esm.sh/resend@4.0.0";

   const corsHeaders = {
     "Access-Control-Allow-Origin": "*",
     "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
   };

   interface PaymentFailureNotification {
     stripeEventId: string;
     stripePaymentIntentId: string;
     customerEmail: string;
     amountCents: number;
     errorMessage: string;
     paymentType: 'ga_ticket' | 'vip_reservation';
     eventId?: string;
     eventName?: string;
     metadata?: Record<string, unknown>;
   }

   serve(async (req) => {
     if (req.method === "OPTIONS") {
       return new Response("ok", { headers: corsHeaders });
     }

     try {
       const supabase = createClient(
         Deno.env.get("SUPABASE_URL") || "",
         Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") || ""
       );

       const resend = new Resend(Deno.env.get("RESEND_API_KEY"));
       const ownerEmail = Deno.env.get("OWNER_EMAIL") || "owner@maguey.com";

       const body: PaymentFailureNotification = await req.json();

       // 1. Insert into payment_failures table (creates "pending" record)
       const { data: failureRecord, error: insertError } = await supabase
         .from('payment_failures')
         .insert({
           stripe_event_id: body.stripeEventId,
           stripe_payment_intent_id: body.stripePaymentIntentId,
           customer_email: body.customerEmail,
           amount_cents: body.amountCents,
           error_message: body.errorMessage,
           payment_type: body.paymentType,
           event_id: body.eventId,
           resolved: false,
           metadata: {
             event_name: body.eventName,
             ...body.metadata,
             notified_at: new Date().toISOString(),
           }
         })
         .select()
         .single();

       if (insertError) {
         console.error('Failed to insert payment failure record:', insertError);
         // Continue to send email even if DB insert fails
       }

       // 2. Send email to owner
       const formattedAmount = (body.amountCents / 100).toFixed(2);
       const { data: emailData, error: emailError } = await resend.emails.send({
         from: 'Maguey Alerts <alerts@maguey.com>',
         to: [ownerEmail],
         subject: `[ACTION REQUIRED] Payment succeeded but ticket creation failed`,
         html: `
           <h2>Payment Failure Alert</h2>
           <p>A customer's payment was successful, but ticket/reservation creation failed.</p>

           <h3>Details:</h3>
           <ul>
             <li><strong>Customer Email:</strong> ${body.customerEmail}</li>
             <li><strong>Amount:</strong> $${formattedAmount}</li>
             <li><strong>Type:</strong> ${body.paymentType === 'ga_ticket' ? 'GA Ticket' : 'VIP Reservation'}</li>
             <li><strong>Event:</strong> ${body.eventName || body.eventId || 'Unknown'}</li>
             <li><strong>Payment Intent:</strong> ${body.stripePaymentIntentId}</li>
             <li><strong>Error:</strong> ${body.errorMessage}</li>
           </ul>

           <h3>Action Required:</h3>
           <p>Please manually create the ticket/reservation for this customer or issue a refund.</p>

           <p>View in dashboard: <a href="https://magueypass.com/admin/payment-failures">Payment Failures</a></p>

           <p><small>Failure ID: ${failureRecord?.id || 'unknown'}</small></p>
         `,
       });

       if (emailError) {
         console.error('Failed to send owner notification email:', emailError);
         // Don't throw - we've already recorded in DB
       }

       return new Response(
         JSON.stringify({
           success: true,
           failureRecordId: failureRecord?.id,
           emailSent: !emailError,
         }),
         {
           headers: { ...corsHeaders, "Content-Type": "application/json" },
           status: 200,
         }
       );

     } catch (error) {
       console.error('notify-payment-failure error:', error);
       return new Response(
         JSON.stringify({ error: error.message }),
         {
           headers: { ...corsHeaders, "Content-Type": "application/json" },
           status: 500,
         }
       );
     }
   });
   ```

3. Note: OWNER_EMAIL env var needs to be set in Supabase dashboard or .env
  </action>
  <verify>
```bash
# Verify function file exists
cat maguey-pass-lounge/supabase/functions/notify-payment-failure/index.ts | head -30
```
  </verify>
  <done>
- notify-payment-failure Edge Function created
- Function inserts into payment_failures table
- Function sends email to owner via Resend
- Function handles errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry with backoff and failure notification to webhook</name>
  <files>maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts</files>
  <action>
Update webhook to retry ticket creation and notify owner on final failure:

1. Add retry utility function at top of file (after imports):
   ```typescript
   async function retryWithBackoff<T>(
     fn: () => Promise<T>,
     maxRetries: number = 5,
     baseDelayMs: number = 1000
   ): Promise<T> {
     let lastError: Error | null = null;

     for (let attempt = 0; attempt < maxRetries; attempt++) {
       try {
         return await fn();
       } catch (error) {
         lastError = error as Error;

         if (attempt === maxRetries - 1) {
           throw lastError;
         }

         // Exponential backoff with jitter
         const delay = (baseDelayMs * Math.pow(2, attempt)) + (Math.random() * 1000);
         console.log(`Attempt ${attempt + 1}/${maxRetries} failed, retrying in ${Math.round(delay)}ms`);
         await new Promise(resolve => setTimeout(resolve, delay));
       }
     }

     throw lastError;
   }
   ```

2. Wrap ticket creation in retry logic. Find where tickets are inserted and wrap:
   ```typescript
   try {
     await retryWithBackoff(async () => {
       const { error } = await supabase.from('tickets').insert(ticketData);
       if (error) throw error;
     }, 5, 1000);
   } catch (error) {
     // All retries failed - notify owner
     console.error('All ticket creation retries failed:', error);

     await notifyPaymentFailure({
       stripeEventId: event.id,
       stripePaymentIntentId: paymentIntent.id,
       customerEmail: session.customer_details?.email || '',
       amountCents: session.amount_total,
       errorMessage: error.message,
       paymentType: 'ga_ticket',
       eventId: ticketData.event_id,
       metadata: { session_id: session.id }
     });

     // Still return 200 to Stripe - payment succeeded, we've logged the failure
     // Don't want Stripe to retry the webhook
   }
   ```

3. Add helper function for calling notify-payment-failure:
   ```typescript
   async function notifyPaymentFailure(data: {
     stripeEventId: string;
     stripePaymentIntentId: string;
     customerEmail: string;
     amountCents: number;
     errorMessage: string;
     paymentType: 'ga_ticket' | 'vip_reservation';
     eventId?: string;
     eventName?: string;
     metadata?: Record<string, unknown>;
   }) {
     try {
       // Call the notification Edge Function
       const response = await fetch(
         `${Deno.env.get("SUPABASE_URL")}/functions/v1/notify-payment-failure`,
         {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'Authorization': `Bearer ${Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")}`,
           },
           body: JSON.stringify(data),
         }
       );

       if (!response.ok) {
         console.error('Failed to notify payment failure:', await response.text());
       }
     } catch (error) {
       console.error('Error calling notify-payment-failure:', error);
     }
   }
   ```

4. Apply same pattern to VIP reservation creation

IMPORTANT:
- Return 200 to Stripe even if ticket creation fails (payment succeeded)
- Log comprehensively for debugging
- Never block webhook response on notification
  </action>
  <verify>
```bash
# Verify retry function exists
grep -n "retryWithBackoff" maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
# Verify notify function exists
grep -n "notifyPaymentFailure" maguey-pass-lounge/supabase/functions/stripe-webhook/index.ts
```
  </verify>
  <done>
- Ticket creation wrapped in retry with backoff (5 attempts)
- VIP reservation creation wrapped in retry with backoff
- Owner notified via notify-payment-failure on final failure
- Webhook returns 200 even if ticket creation fails (after logging failure)
  </done>
</task>

</tasks>

<verification>
1. Deploy functions: `cd maguey-pass-lounge && npx supabase functions deploy`
2. Test failure scenario by temporarily making ticket insert fail
3. Verify payment_failures table has record
4. Verify owner email received (check OWNER_EMAIL env var)
5. Verify webhook returns 200 even on failure
</verification>

<success_criteria>
- notify-payment-failure Edge Function deployed and working
- Ticket/reservation creation retries 5 times with exponential backoff
- Owner receives email when all retries fail
- payment_failures table contains record of failure
- Webhook returns 200 to Stripe (doesn't trigger Stripe retries for handled failures)
</success_criteria>

<output>
After completion, create `.planning/phases/01-payment-flow-hardening/01-04-SUMMARY.md`
</output>
