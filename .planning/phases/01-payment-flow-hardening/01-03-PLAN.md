---
phase: 01-payment-flow-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/src/pages/Payment.tsx
  - maguey-pass-lounge/src/pages/VipPayment.tsx
  - maguey-pass-lounge/src/lib/payment-errors.ts
autonomous: true

must_haves:
  truths:
    - "Failed payments show toast notification with retry button"
    - "Toast auto-dismisses after 5 seconds"
    - "Error messages are friendly (not technical stack traces)"
    - "Loading overlay appears during retry"
  artifacts:
    - path: "maguey-pass-lounge/src/lib/payment-errors.ts"
      provides: "Payment error handling utilities"
      exports: ["handlePaymentError", "PaymentErrorType"]
    - path: "maguey-pass-lounge/src/pages/Payment.tsx"
      provides: "GA ticket payment with error handling"
      contains: "toast.error"
    - path: "maguey-pass-lounge/src/pages/VipPayment.tsx"
      provides: "VIP payment with error handling"
      contains: "toast.error"
  key_links:
    - from: "Payment.tsx"
      to: "payment-errors.ts"
      via: "import handlePaymentError"
      pattern: "import.*handlePaymentError.*from.*payment-errors"
    - from: "VipPayment.tsx"
      to: "payment-errors.ts"
      via: "import handlePaymentError"
      pattern: "import.*handlePaymentError.*from.*payment-errors"
---

<objective>
Update frontend payment pages to show user-friendly error toasts with retry capability.

Purpose: Per user decisions, payment failures should show toast notifications (not modals), auto-dismiss after 5 seconds, display simple friendly messages ("Payment failed. Please try again."), and include a retry button. Same treatment for GA and VIP.

Output: Updated Payment.tsx and VipPayment.tsx with standardized error handling via shared utility.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-payment-flow-hardening/01-CONTEXT.md
@.planning/phases/01-payment-flow-hardening/01-RESEARCH.md
@maguey-pass-lounge/src/pages/Payment.tsx
@maguey-pass-lounge/src/pages/VipPayment.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared payment error handling utility</name>
  <files>maguey-pass-lounge/src/lib/payment-errors.ts</files>
  <action>
Create a new utility file for consistent payment error handling:

```typescript
import { toast } from "sonner";

// Error types for logging/analytics
export type PaymentErrorType =
  | 'card_declined'
  | 'insufficient_funds'
  | 'expired_card'
  | 'processing_error'
  | 'network_error'
  | 'unknown';

// Map Stripe error codes to types
function categorizeError(error: Error | unknown): PaymentErrorType {
  const message = error instanceof Error ? error.message.toLowerCase() : '';

  if (message.includes('card_declined') || message.includes('declined')) {
    return 'card_declined';
  }
  if (message.includes('insufficient_funds') || message.includes('insufficient')) {
    return 'insufficient_funds';
  }
  if (message.includes('expired')) {
    return 'expired_card';
  }
  if (message.includes('processing') || message.includes('try again')) {
    return 'processing_error';
  }
  if (message.includes('network') || message.includes('fetch') || message.includes('timeout')) {
    return 'network_error';
  }
  return 'unknown';
}

// User-friendly messages (per user decision: simple, no technical details)
const USER_MESSAGES: Record<PaymentErrorType, string> = {
  card_declined: 'Payment failed. Please try again.',
  insufficient_funds: 'Payment failed. Please try again.',
  expired_card: 'Payment failed. Please try again.',
  processing_error: 'Payment failed. Please try again.',
  network_error: 'Connection issue. Please try again.',
  unknown: 'Payment failed. Please try again.',
};

interface HandlePaymentErrorOptions {
  onRetry: () => void;
  setIsLoading: (loading: boolean) => void;
  customerEmail?: string;
  paymentType: 'ga_ticket' | 'vip_reservation';
  eventId?: string;
}

/**
 * Handle payment errors with toast notification and retry button.
 * Per user decisions:
 * - Toast notification (not modal)
 * - Auto-dismiss after 5 seconds
 * - Simple friendly message
 * - Retry button on toast
 * - Full loading overlay during retry
 * - No retry limit
 * - Log all failed payment attempts
 */
export function handlePaymentError(
  error: Error | unknown,
  options: HandlePaymentErrorOptions
) {
  const { onRetry, setIsLoading, customerEmail, paymentType, eventId } = options;
  const errorType = categorizeError(error);
  const userMessage = USER_MESSAGES[errorType];

  // Log error for debugging (per user decision: log all failed payment attempts)
  console.error('[Payment Error]', {
    type: errorType,
    paymentType,
    eventId,
    customerEmail: customerEmail ? `${customerEmail.slice(0, 3)}...` : undefined,
    timestamp: new Date().toISOString(),
    rawError: error instanceof Error ? error.message : String(error),
  });

  // Show toast with retry button (per user decisions)
  toast.error(userMessage, {
    duration: 5000, // 5 second auto-dismiss
    action: {
      label: 'Retry',
      onClick: () => {
        // Show loading overlay during retry (per user decision)
        setIsLoading(true);
        onRetry();
      },
    },
  });
}

/**
 * Wrap an async payment function with retry capability.
 * Does NOT implement automatic retries - that's for backend.
 * This just provides the UI pattern for manual retry.
 */
export async function executePayment<T>(
  paymentFn: () => Promise<T>,
  options: Omit<HandlePaymentErrorOptions, 'onRetry'>
): Promise<T | null> {
  try {
    return await paymentFn();
  } catch (error) {
    handlePaymentError(error, {
      ...options,
      onRetry: () => {
        executePayment(paymentFn, options);
      },
    });
    return null;
  }
}
```
  </action>
  <verify>
```bash
# Verify file exists and exports correctly
cat maguey-pass-lounge/src/lib/payment-errors.ts | head -50
```
  </verify>
  <done>
- payment-errors.ts exports handlePaymentError and PaymentErrorType
- Error messages are user-friendly (no technical details)
- Toast configured for 5-second auto-dismiss with retry button
- Error logging captures type, payment type, timestamp
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GA Payment.tsx error handling</name>
  <files>maguey-pass-lounge/src/pages/Payment.tsx</files>
  <action>
Update Payment.tsx to use the new error handling:

1. Add import at top of file:
   ```typescript
   import { handlePaymentError } from '@/lib/payment-errors';
   ```

2. Find existing error handling (likely in try/catch around checkout session creation)

3. Replace error handling with:
   ```typescript
   catch (error) {
     handlePaymentError(error, {
       onRetry: () => handleCheckout(), // or whatever the checkout function is named
       setIsLoading,
       customerEmail: formData.email, // or wherever email is stored
       paymentType: 'ga_ticket',
       eventId: eventId, // pass event ID if available
     });
     setIsLoading(false);
   }
   ```

4. Remove any existing Alert component for error display (replace with toast)

5. Ensure loading state is properly managed:
   - setIsLoading(true) at start of checkout
   - setIsLoading(false) after error OR after redirect to Stripe

6. If there's a full-page loading overlay, keep it. If not, ensure button shows loading state.

IMPORTANT: Keep all existing functionality. Only change error display mechanism.
  </action>
  <verify>
```bash
# Verify import and usage
grep -n "handlePaymentError" maguey-pass-lounge/src/pages/Payment.tsx
# Verify no old Alert error display
grep -n "error.*Alert" maguey-pass-lounge/src/pages/Payment.tsx
```
  </verify>
  <done>
- Payment.tsx imports and uses handlePaymentError
- Errors show as toast with retry button
- No Alert component for error display
- Loading state properly managed
  </done>
</task>

<task type="auto">
  <name>Task 3: Update VIP VipPayment.tsx error handling</name>
  <files>maguey-pass-lounge/src/pages/VipPayment.tsx</files>
  <action>
Update VipPayment.tsx to use the same error handling pattern:

1. Add import at top of file:
   ```typescript
   import { handlePaymentError } from '@/lib/payment-errors';
   ```

2. Find existing error handling (likely in Stripe Elements onSubmit or payment confirmation)

3. Replace error handling with:
   ```typescript
   catch (error) {
     handlePaymentError(error, {
       onRetry: () => handlePaymentSubmit(), // or whatever the submit function is named
       setIsLoading: setProcessing, // VIP might use "processing" instead of "isLoading"
       customerEmail: bookingDetails.email, // wherever email is stored
       paymentType: 'vip_reservation',
       eventId: bookingDetails.eventId, // if available
     });
     setProcessing(false);
   }
   ```

4. VIP uses embedded Stripe Elements, so also handle Stripe.js errors:
   ```typescript
   // If using stripe.confirmPayment
   const { error, paymentIntent } = await stripe.confirmPayment({...});
   if (error) {
     handlePaymentError(error, {
       onRetry: () => handlePaymentSubmit(),
       setIsLoading: setProcessing,
       customerEmail: bookingDetails.email,
       paymentType: 'vip_reservation',
       eventId: bookingDetails.eventId,
     });
     setProcessing(false);
     return;
   }
   ```

5. Remove any existing error state display (replace with toast)

IMPORTANT: Same UX as GA - user decision says "Same error treatment for VIP and GA"
  </action>
  <verify>
```bash
# Verify import and usage
grep -n "handlePaymentError" maguey-pass-lounge/src/pages/VipPayment.tsx
# Check for consistent pattern
grep -n "paymentType.*vip_reservation" maguey-pass-lounge/src/pages/VipPayment.tsx
```
  </verify>
  <done>
- VipPayment.tsx imports and uses handlePaymentError
- Same toast pattern as GA (consistent experience per user decision)
- Stripe.js errors handled correctly
- Loading/processing state properly managed
  </done>
</task>

</tasks>

<verification>
1. Build project: `cd maguey-pass-lounge && npm run build` - no TypeScript errors
2. Manual test: Navigate to checkout, enter invalid card (4000 0000 0000 0002), submit
3. Verify toast appears with "Payment failed. Please try again." message
4. Verify toast has Retry button
5. Verify toast auto-dismisses after ~5 seconds
6. Click Retry - verify loading overlay appears
</verification>

<success_criteria>
- GA and VIP payment errors show toast (not Alert/modal)
- Toast auto-dismisses after 5 seconds
- Toast has working Retry button
- Error messages are user-friendly (no stack traces)
- Loading overlay appears during retry
- All payment errors are logged to console
</success_criteria>

<output>
After completion, create `.planning/phases/01-payment-flow-hardening/01-03-SUMMARY.md`
</output>
