---
phase: 12-launch-readiness-review
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/ENVIRONMENT-AUDIT.md
  - .planning/BACKUP-RECOVERY.md
autonomous: true

must_haves:
  truths:
    - "All required environment variables are documented with their purpose"
    - "Production configuration audit checklist is complete"
    - "Backup verification steps are documented"
    - "Recovery procedures exist for database restoration"
  artifacts:
    - path: ".planning/ENVIRONMENT-AUDIT.md"
      provides: "Environment variable validation checklist"
      min_lines: 100
      contains: "STRIPE_SECRET_KEY"
    - path: ".planning/BACKUP-RECOVERY.md"
      provides: "Backup and recovery procedures"
      min_lines: 80
      contains: "Point-in-Time Recovery"
  key_links:
    - from: ".planning/ENVIRONMENT-AUDIT.md"
      to: "supabase/functions/**/*.ts"
      via: "Deno.env.get references"
      pattern: "Deno\\.env\\.get"
---

<objective>
Create environment variable audit checklist and backup/recovery procedures documentation for production readiness validation.

Purpose: Ensure all required secrets and configuration are documented and verified, and that recovery procedures exist for disaster scenarios.

Output: .planning/ENVIRONMENT-AUDIT.md with complete env var checklist, .planning/BACKUP-RECOVERY.md with recovery procedures.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-launch-readiness-review/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment variable audit checklist</name>
  <files>.planning/ENVIRONMENT-AUDIT.md</files>
  <action>
First, scan the codebase to identify all environment variables used:

```bash
grep -rh "Deno.env.get" supabase/functions/ | sed 's/.*Deno.env.get("\([^"]*\)").*/\1/' | sort -u
grep -rh "import.meta.env" maguey-*/src/ | grep -o 'VITE_[A-Z_]*' | sort -u
```

Create .planning/ENVIRONMENT-AUDIT.md with:

1. **Header:**
   - Title: "Production Environment Audit"
   - Purpose: Validate all secrets and configuration before launch
   - Audit date placeholder

2. **Supabase Edge Functions (Backend Secrets):**

| Variable | Purpose | Required | Configured | Validated |
|----------|---------|----------|------------|-----------|
| SUPABASE_URL | Database connection | Yes | [ ] | [ ] |
| SUPABASE_SERVICE_ROLE_KEY | Service role access | Yes | [ ] | [ ] |
| STRIPE_SECRET_KEY | Payment processing | Yes | [ ] | [ ] |
| STRIPE_WEBHOOK_SECRET | Webhook signature verification | Yes | [ ] | [ ] |
| RESEND_API_KEY | Email sending | Yes | [ ] | [ ] |
| RESEND_WEBHOOK_SECRET | Email webhook verification | Yes | [ ] | [ ] |
| QR_SIGNING_SECRET | QR code HMAC signing | Yes | [ ] | [ ] |
| OWNER_EMAIL | Payment failure notifications | Yes | [ ] | [ ] |
| SENTRY_DSN | Error tracking | Recommended | [ ] | [ ] |
| UPSTASH_REDIS_REST_URL | Rate limiting | Recommended | [ ] | [ ] |
| UPSTASH_REDIS_REST_TOKEN | Rate limiting auth | Recommended | [ ] | [ ] |
| EMAIL_FROM_ADDRESS | Email sender address | Yes | [ ] | [ ] |
| FRONTEND_URL | Frontend base URL | Yes | [ ] | [ ] |
| ALLOWED_ORIGINS | CORS origins | Yes | [ ] | [ ] |

3. **Frontend Environment (maguey-pass-lounge):**

| Variable | Purpose | Required | Configured | Validated |
|----------|---------|----------|------------|-----------|
| VITE_SUPABASE_URL | Supabase connection | Yes | [ ] | [ ] |
| VITE_SUPABASE_ANON_KEY | Supabase anon key | Yes | [ ] | [ ] |
| VITE_STRIPE_PUBLISHABLE_KEY | Stripe public key | Yes | [ ] | [ ] |
| VITE_SENTRY_DSN | Frontend error tracking | Recommended | [ ] | [ ] |

4. **Frontend Environment (maguey-gate-scanner):**

| Variable | Purpose | Required | Configured | Validated |
|----------|---------|----------|------------|-----------|
| VITE_SUPABASE_URL | Supabase connection | Yes | [ ] | [ ] |
| VITE_SUPABASE_ANON_KEY | Supabase anon key | Yes | [ ] | [ ] |
| VITE_QR_SIGNING_SECRET | QR verification | Yes | [ ] | [ ] |
| VITE_SENTRY_DSN | Frontend error tracking | Recommended | [ ] | [ ] |

5. **Validation Procedure:**
   - Step 1: Log into Supabase Dashboard > Project Settings > Edge Functions > Secrets
   - Step 2: Verify each secret exists and has non-empty value
   - Step 3: Run health check to validate dependencies: `curl -X POST https://[project-ref].supabase.co/functions/v1/health-check -H "Authorization: Bearer [anon-key]"`
   - Step 4: Verify health check returns all "healthy" statuses
   - Step 5: Mark "Validated" column for each verified secret

6. **External Service Configuration:**

| Service | Configuration Item | Location | Verified |
|---------|-------------------|----------|----------|
| Stripe | Webhook endpoint URL | Stripe Dashboard > Developers > Webhooks | [ ] |
| Stripe | Webhook events subscribed | Stripe Dashboard > Developers > Webhooks | [ ] |
| Resend | Webhook endpoint URL | Resend Dashboard > Webhooks | [ ] |
| Supabase | pg_cron job for email queue | Supabase Dashboard > Database > cron | [ ] |
| Upstash | Redis database created | Upstash Console | [ ] |
| Sentry | Project DSN configured | Sentry Dashboard | [ ] |

7. **Security Notes:**
   - Never commit secrets to git
   - Rotate STRIPE_WEBHOOK_SECRET if exposed
   - QR_SIGNING_SECRET should match between backend and scanner frontend
   - OWNER_EMAIL must be valid email address for notifications
  </action>
  <verify>
    - File exists at .planning/ENVIRONMENT-AUDIT.md
    - Contains at least 14 backend secrets documented
    - Contains at least 4 frontend variables per app
    - Validation procedure section exists
    - External service configuration table exists
  </verify>
  <done>ENVIRONMENT-AUDIT.md exists with complete environment variable checklist, validation procedures, and external service configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create backup and recovery procedures</name>
  <files>.planning/BACKUP-RECOVERY.md</files>
  <action>
Create .planning/BACKUP-RECOVERY.md with:

1. **Header:**
   - Title: "Backup and Recovery Procedures"
   - Purpose: Document recovery procedures for disaster scenarios
   - Last updated timestamp

2. **Backup Overview:**
   - Supabase Plan: [Pro/Team - verify in dashboard]
   - Backup Type: Daily automated backups
   - Point-in-Time Recovery (PITR): Available for Pro/Team plans
   - Recovery Point Objective (RPO): 24 hours (daily backups) or continuous (PITR)
   - Recovery Time Objective (RTO): Proportional to database size

3. **Current Backup Status:**

| Item | Status | Last Verified |
|------|--------|---------------|
| Automated backups enabled | [ ] | |
| Last successful backup | [ ] | |
| PITR enabled | [ ] | |
| Backup retention period | [ ] days | |

4. **Verification Procedure:**
   - Step 1: Log into Supabase Dashboard > Project Settings > Database
   - Step 2: Navigate to "Backups" section
   - Step 3: Verify "Automated backups" is enabled
   - Step 4: Note last successful backup timestamp
   - Step 5: Check PITR status if available

5. **Recovery Scenarios:**

**Scenario A: Database Corruption / Accidental Data Loss**
1. Assess scope of data loss
2. Determine recovery point (which backup to restore from)
3. Contact Supabase support if immediate restoration needed
4. For Pro plans: Use PITR to restore to specific point in time
5. For daily backups: Restore from last daily backup
6. Verify restored data integrity
7. Resume operations

**Scenario B: Stripe Webhook Data Mismatch**
1. Query Stripe Dashboard for transaction history
2. Compare with tickets/vip_reservations tables
3. Use verify-revenue Edge Function to identify discrepancies
4. Manually reconcile any missing records
5. Document discrepancies in revenue_discrepancies table

**Scenario C: Email Queue Failure**
1. Check email_queue table for stuck emails
2. Verify Resend API status
3. Reset failed emails to 'pending' status for retry
4. Monitor process-email-queue function execution
5. Manual retry via Dashboard if needed

**Scenario D: Complete Environment Recovery**
1. Create new Supabase project
2. Request backup restoration to new project
3. Reconfigure all edge function secrets
4. Update frontend environment variables
5. Update Stripe/Resend webhook URLs
6. Verify health check passes
7. Redirect DNS/traffic to new environment

6. **Rollback Procedure (Deployment Failure):**
   - Frontend: Revert to previous Vercel deployment
   - Edge Functions: Redeploy previous version via supabase functions deploy
   - Database Migrations: Document any schema changes; manual rollback SQL if needed

7. **Emergency Contacts:**
   - Supabase Support: support@supabase.com (Pro/Team plans have priority support)
   - Stripe Support: https://support.stripe.com
   - Resend Support: https://resend.com/support
   - Developer: [Owner contact info]

8. **Recovery Testing:**
   - Last full recovery test: [ ] Not yet tested
   - Test frequency: Recommended quarterly
   - Test environment: Create test project, request backup restore

Note: Actual backup restoration testing creates downtime and may incur costs. Document procedure but defer actual test unless time permits before launch.
  </action>
  <verify>
    - File exists at .planning/BACKUP-RECOVERY.md
    - Contains backup status verification procedure
    - Contains at least 4 recovery scenarios (A through D)
    - Contains rollback procedure section
    - Contains emergency contacts section
  </verify>
  <done>BACKUP-RECOVERY.md exists with complete backup verification procedures, recovery scenarios, rollback procedures, and emergency contacts</done>
</task>

</tasks>

<verification>
1. .planning/ENVIRONMENT-AUDIT.md exists with all environment variables
2. .planning/BACKUP-RECOVERY.md exists with recovery procedures
3. Both documents have clear verification checklists
4. Recovery scenarios cover common failure modes
5. Emergency contacts and escalation paths documented
</verification>

<success_criteria>
- Environment audit checklist documents all required secrets
- Backup status verification procedure is actionable
- Recovery procedures cover database, payment, email, and complete environment scenarios
- Rollback procedure documented for deployment failures
</success_criteria>

<output>
After completion, create `.planning/phases/12-launch-readiness-review/12-02-SUMMARY.md`
</output>
