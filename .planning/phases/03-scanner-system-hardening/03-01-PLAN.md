---
phase: 03-scanner-system-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/src/components/scanner/SuccessOverlay.tsx
  - maguey-gate-scanner/src/components/scanner/RejectionOverlay.tsx
  - maguey-gate-scanner/src/pages/Scanner.tsx
autonomous: true

must_haves:
  truths:
    - "Valid scan shows full green screen with checkmark"
    - "Invalid/already-scanned shows full red screen"
    - "GA tickets show minimal display (checkmark only)"
    - "VIP reservations show full details (table, tier, holder)"
    - "VIP guest passes show minimal (VIP Guest + table number)"
    - "Success auto-dismisses after 1.5 seconds"
  artifacts:
    - path: "maguey-gate-scanner/src/components/scanner/SuccessOverlay.tsx"
      provides: "Full-screen green success overlay"
      exports: ["SuccessOverlay"]
    - path: "maguey-gate-scanner/src/components/scanner/RejectionOverlay.tsx"
      provides: "Full-screen red rejection overlay"
      exports: ["RejectionOverlay"]
  key_links:
    - from: "Scanner.tsx"
      to: "SuccessOverlay.tsx"
      via: "conditional render on scanState.status === 'success'"
      pattern: "SuccessOverlay.*ticketType"
    - from: "Scanner.tsx"
      to: "RejectionOverlay.tsx"
      via: "conditional render on scanState.status !== 'success'"
      pattern: "RejectionOverlay.*reason"
---

<objective>
Create full-screen scan feedback overlays with distinct success/failure experiences

Purpose: Gate staff need unmistakable visual feedback when scanning tickets. Full-screen color changes are visible from distance, critical for fast-paced venue entry.

Output: Two overlay components (success/rejection) that take over the entire screen with color, icon, sound, and haptic feedback
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scanner-system-hardening/03-CONTEXT.md
@.planning/phases/03-scanner-system-hardening/03-RESEARCH.md

@maguey-gate-scanner/src/pages/Scanner.tsx
@maguey-gate-scanner/src/lib/audio-feedback-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SuccessOverlay component</name>
  <files>maguey-gate-scanner/src/components/scanner/SuccessOverlay.tsx</files>
  <action>
Create SuccessOverlay.tsx with these requirements:

**Props interface:**
```typescript
interface SuccessOverlayProps {
  ticketType: 'ga' | 'vip_reservation' | 'vip_guest';
  guestName?: string;
  vipDetails?: {
    tableName: string;
    tier: string;
    guestCount: number;
    holderName: string;
  };
  groupCheckIn?: { current: number; total: number };
  onDismiss: () => void;
}
```

**Display behavior per context decision (03-CONTEXT.md):**
- GA tickets: Minimal display - just large checkmark, no text
- VIP reservations: Full details - table name, tier, holder name, guest count
- VIP guest passes: Minimal - 'VIP Guest' + table number only

**Visual design:**
- Full viewport: `fixed inset-0 z-[100]`
- Background: `bg-green-500` (full green)
- Large centered CheckCircle2 icon (h-32 w-32) with bounce animation
- Text white, center-aligned

**Behavior:**
- On mount: Call `playSuccess()` or `playTierSuccess(tier)` from audio-feedback-service
- Auto-dismiss: `setTimeout(onDismiss, 1500)` (1.5 seconds per context)
- Clear timeout on unmount to prevent memory leaks
- Optional: Show group check-in count ('3 of 5 guests checked in') below main content

**Animation:** Use Tailwind `animate-in fade-in duration-200` for entry
  </action>
  <verify>Component exports correctly: `grep -l "export.*SuccessOverlay" maguey-gate-scanner/src/components/scanner/SuccessOverlay.tsx`</verify>
  <done>SuccessOverlay renders full-green screen, auto-dismisses after 1.5s, shows correct content per ticket type</done>
</task>

<task type="auto">
  <name>Task 2: Create RejectionOverlay component</name>
  <files>maguey-gate-scanner/src/components/scanner/RejectionOverlay.tsx</files>
  <action>
Create RejectionOverlay.tsx with these requirements:

**Props interface:**
```typescript
interface RejectionOverlayProps {
  reason: 'already_used' | 'wrong_event' | 'invalid' | 'expired' | 'tampered' | 'not_found';
  details: {
    previousScan?: { staff: string; gate: string; time: string };
    wrongEventDate?: string;
    message?: string;
  };
  onDismiss: () => void;
}
```

**Error messages per context decision (03-CONTEXT.md):**
- `already_used`: "ALREADY SCANNED" + "Scanned by [staff] at [gate], [time]"
- `wrong_event`: "WRONG EVENT" + "This ticket is for [date]"
- `invalid`/`tampered`: "INVALID" + generic message
- `not_found`: "NOT FOUND" + "Ticket does not exist"

**Visual design:**
- Full viewport: `fixed inset-0 z-[100]`
- Background: `bg-red-600` (full red for ALL rejection types per context)
- Large centered XCircle icon (h-32 w-32)
- Text white, center-aligned
- "Scan Next" button at bottom to dismiss manually

**Behavior:**
- On mount: Call `playError()` from audio-feedback-service
- Trigger longer haptic: `navigator.vibrate?.([200, 100, 200])`
- NO auto-dismiss (staff needs to acknowledge rejection)

**Animation:** Use Tailwind `animate-in fade-in duration-200` for entry
  </action>
  <verify>Component exports correctly: `grep -l "export.*RejectionOverlay" maguey-gate-scanner/src/components/scanner/RejectionOverlay.tsx`</verify>
  <done>RejectionOverlay renders full-red screen with specific error message based on reason, requires manual dismissal</done>
</task>

<task type="auto">
  <name>Task 3: Integrate overlays into Scanner.tsx</name>
  <files>maguey-gate-scanner/src/pages/Scanner.tsx</files>
  <action>
Replace the current result overlay in Scanner.tsx with the new full-screen overlays:

1. **Import the new components:**
```typescript
import { SuccessOverlay } from "@/components/scanner/SuccessOverlay";
import { RejectionOverlay } from "@/components/scanner/RejectionOverlay";
```

2. **Update ScanState interface** to include rejection reason:
```typescript
interface ScanState {
  status: "idle" | "scanning" | "success" | "error" | "already_scanned";
  ticket: TicketType | null;
  message: string;
  rejectionReason?: 'already_used' | 'wrong_event' | 'invalid' | 'expired' | 'tampered' | 'not_found';
  rejectionDetails?: {
    previousScan?: { staff: string; gate: string; time: string };
    wrongEventDate?: string;
  };
}
```

3. **Determine ticket type** from scan result:
- Check if vipLinkInfo.isVipGuest -> 'vip_guest'
- Check if ticket has vip-related ticket_type -> 'vip_reservation'
- Otherwise -> 'ga'

4. **Replace the existing result overlay block** (lines ~627-713) with conditional rendering:

For success state:
```tsx
{scanState.status === "success" && (
  <SuccessOverlay
    ticketType={determineTicketType(scanState.ticket, vipLinkInfo)}
    guestName={scanState.ticket?.guest_name}
    vipDetails={vipLinkInfo.isVipGuest ? {
      tableName: `Table ${vipLinkInfo.tableNumber}`,
      tier: 'VIP',
      guestCount: 1,
      holderName: vipLinkInfo.purchaserName || 'VIP Host'
    } : undefined}
    onDismiss={handleScanAnother}
  />
)}
```

For rejection states:
```tsx
{(scanState.status === "error" || scanState.status === "already_scanned") && (
  <RejectionOverlay
    reason={scanState.rejectionReason || (scanState.status === "already_scanned" ? 'already_used' : 'invalid')}
    details={{
      previousScan: scanState.rejectionDetails?.previousScan,
      wrongEventDate: scanState.rejectionDetails?.wrongEventDate,
      message: scanState.message
    }}
    onDismiss={handleScanAnother}
  />
)}
```

5. **Update processScan** to populate rejectionReason and rejectionDetails when scan fails (for now, use placeholders for staff/gate since we'll enhance this in plan 04).

6. **Add helper function** to determine ticket type:
```typescript
const determineTicketType = (ticket: TicketType | null, vipInfo: VipLinkInfo): 'ga' | 'vip_reservation' | 'vip_guest' => {
  if (vipInfo.isVipGuest) return 'vip_guest';
  if (ticket?.ticket_type?.toLowerCase().includes('vip')) return 'vip_reservation';
  return 'ga';
};
```
  </action>
  <verify>Build passes: `cd maguey-gate-scanner && npm run build`</verify>
  <done>Scanner.tsx uses new full-screen overlays, success auto-dismisses, rejection requires acknowledgment</done>
</task>

</tasks>

<verification>
1. Build completes without errors
2. SuccessOverlay and RejectionOverlay components exist in components/scanner/
3. Scanner.tsx imports and uses both overlay components
4. Audio feedback functions are called on overlay mount
</verification>

<success_criteria>
1. Valid QR scan shows full green screen with large checkmark
2. GA scans show minimal display (just checkmark)
3. VIP scans show table details
4. Invalid/already-scanned shows full red screen
5. Success overlays auto-dismiss after 1.5 seconds
6. Rejection overlays require manual "Scan Next" button
7. Audio tones play on success/failure
8. Haptic feedback triggers on success/failure
</success_criteria>

<output>
After completion, create `.planning/phases/03-scanner-system-hardening/03-01-SUMMARY.md`
</output>
