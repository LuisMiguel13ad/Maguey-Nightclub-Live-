---
phase: 03-scanner-system-hardening
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - maguey-gate-scanner/src/components/scanner/ScanHistory.tsx
  - maguey-gate-scanner/src/components/scanner/CheckInCounter.tsx
  - maguey-gate-scanner/src/components/scanner/OfflineBanner.tsx
  - maguey-gate-scanner/src/pages/Scanner.tsx
autonomous: true

must_haves:
  truths:
    - "Scan history shows last 5-10 scans with color-coded status"
    - "Scan history rows expand on tap to show full details"
    - "Check-in counter always visible at top showing 'Checked in: X / Y'"
    - "OFFLINE MODE banner prominently displayed when disconnected"
    - "Pending sync count shown in offline banner"
  artifacts:
    - path: "maguey-gate-scanner/src/components/scanner/ScanHistory.tsx"
      provides: "Expandable scan history list"
      exports: ["ScanHistory", "ScanHistoryEntry"]
    - path: "maguey-gate-scanner/src/components/scanner/CheckInCounter.tsx"
      provides: "Event check-in counter badge"
      exports: ["CheckInCounter"]
    - path: "maguey-gate-scanner/src/components/scanner/OfflineBanner.tsx"
      provides: "Prominent offline mode banner"
      exports: ["OfflineBanner"]
  key_links:
    - from: "Scanner.tsx"
      to: "ScanHistory.tsx"
      via: "render with scanHistory state"
      pattern: "ScanHistory.*entries"
    - from: "Scanner.tsx"
      to: "CheckInCounter.tsx"
      via: "render with eventId prop"
      pattern: "CheckInCounter.*eventId"
    - from: "Scanner.tsx"
      to: "OfflineBanner.tsx"
      via: "conditional render based on isOnline"
      pattern: "OfflineBanner"
---

<objective>
Create scanner UI components: scan history, check-in counter, and prominent offline banner

Purpose: Gate staff need visibility into recent scans, current check-in progress, and clear indication when operating offline. These components enhance situational awareness during high-volume scanning.

Output: Three reusable components that integrate into Scanner.tsx for enhanced operational visibility
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scanner-system-hardening/03-CONTEXT.md
@.planning/phases/03-scanner-system-hardening/03-RESEARCH.md

@maguey-gate-scanner/src/pages/Scanner.tsx
@maguey-gate-scanner/src/lib/offline-queue-service.ts
@maguey-gate-scanner/src/lib/offline-ticket-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScanHistory component with expandable rows</name>
  <files>maguey-gate-scanner/src/components/scanner/ScanHistory.tsx</files>
  <action>
Create ScanHistory.tsx per context decisions:

**1. Type definitions:**
```typescript
export interface ScanHistoryEntry {
  id: string;
  timestamp: Date;
  status: 'success' | 'failure';
  ticketType: 'GA' | 'VIP' | 'VIP Guest';
  guestName?: string;
  eventName?: string;
  errorReason?: string;
  expanded?: boolean;
}

interface ScanHistoryProps {
  entries: ScanHistoryEntry[];
  maxVisible?: number; // Default 5
  onToggleExpand: (id: string) => void;
}
```

**2. Component structure:**
- Container with semi-transparent background at bottom of screen
- List of last 5-10 scans (configurable via maxVisible prop)
- Each row shows: status icon (CheckCircle2/XCircle), timestamp, ticket type
- Color-coded backgrounds: green-500/20 for success, red-500/20 for failure
- Rows are tappable to expand

**3. Collapsed row (minimal):**
```tsx
<div className={cn(
  "flex items-center gap-3 px-4 py-3 rounded-xl transition-all",
  entry.status === 'success' ? "bg-green-500/20" : "bg-red-500/20"
)}>
  {entry.status === 'success'
    ? <CheckCircle2 className="h-5 w-5 text-green-400" />
    : <XCircle className="h-5 w-5 text-red-400" />
  }
  <span className="text-sm text-white/70">{formatTime(entry.timestamp)}</span>
  <span className="text-sm font-medium text-white">{entry.ticketType}</span>
  <ChevronDown className={cn("ml-auto h-4 w-4 text-white/50 transition-transform", entry.expanded && "rotate-180")} />
</div>
```

**4. Expanded row (full details):**
```tsx
{entry.expanded && (
  <div className="px-4 py-2 space-y-1 text-sm">
    {entry.guestName && <p className="text-white/80">Guest: {entry.guestName}</p>}
    {entry.eventName && <p className="text-white/60">Event: {entry.eventName}</p>}
    {entry.errorReason && <p className="text-red-400">Reason: {entry.errorReason}</p>}
  </div>
)}
```

**5. Formatting helper:**
```typescript
const formatTime = (date: Date) => {
  return date.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
};
```

**6. Animation:** Use `animate-in slide-in-from-bottom-2` for new entries
  </action>
  <verify>Component exports: `grep -l "export.*ScanHistory" maguey-gate-scanner/src/components/scanner/ScanHistory.tsx`</verify>
  <done>ScanHistory shows color-coded rows with tap-to-expand functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create CheckInCounter and OfflineBanner components</name>
  <files>
    maguey-gate-scanner/src/components/scanner/CheckInCounter.tsx
    maguey-gate-scanner/src/components/scanner/OfflineBanner.tsx
  </files>
  <action>
**Part A: Create CheckInCounter.tsx**

Per context decision: "Event check-in counter always visible at top ('Checked in: 234 / 500')"

```typescript
import { useState, useEffect } from 'react';
import { Users } from 'lucide-react';
import { supabase } from '@/integrations/supabase/client';
import { getCheckedInCount } from '@/lib/offline-ticket-cache';

interface CheckInCounterProps {
  eventId: string | null;
}

export function CheckInCounter({ eventId }: CheckInCounterProps) {
  const [count, setCount] = useState({ checkedIn: 0, total: 0 });

  useEffect(() => {
    if (!eventId) return;

    const fetchCount = async () => {
      // Try online first if available
      if (navigator.onLine) {
        try {
          // Get scanned count
          const { count: checkedIn } = await supabase
            .from('tickets')
            .select('id', { count: 'exact', head: true })
            .eq('event_id', eventId)
            .eq('status', 'scanned');

          // Get total count
          const { count: total } = await supabase
            .from('tickets')
            .select('id', { count: 'exact', head: true })
            .eq('event_id', eventId);

          setCount({ checkedIn: checkedIn ?? 0, total: total ?? 0 });
        } catch (error) {
          // Fall back to cache
          const cached = await getCheckedInCount(eventId);
          setCount(cached);
        }
      } else {
        // Offline - use cache
        const cached = await getCheckedInCount(eventId);
        setCount(cached);
      }
    };

    fetchCount();

    // Subscribe to realtime updates when online
    if (navigator.onLine) {
      const channel = supabase
        .channel(`tickets:${eventId}`)
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'tickets',
          filter: `event_id=eq.${eventId}`
        }, fetchCount)
        .subscribe();

      return () => { channel.unsubscribe(); };
    }
  }, [eventId]);

  if (!eventId) return null;

  return (
    <div className="bg-black/60 backdrop-blur-sm px-4 py-2 flex items-center justify-center gap-2">
      <Users className="w-4 h-4 text-white/70" />
      <span className="text-white font-semibold">
        Checked in: {count.checkedIn.toLocaleString()} / {count.total.toLocaleString()}
      </span>
    </div>
  );
}
```

**Part B: Create OfflineBanner.tsx**

Per context decision: "Prominent 'OFFLINE MODE' banner always visible when disconnected"

```typescript
import { useState, useEffect } from 'react';
import { WifiOff, CloudOff, Upload } from 'lucide-react';
import { getSyncStatus } from '@/lib/offline-queue-service';
import { cn } from '@/lib/utils';

interface OfflineBannerProps {
  className?: string;
}

export function OfflineBanner({ className }: OfflineBannerProps) {
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [pendingCount, setPendingCount] = useState(0);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  useEffect(() => {
    // Update pending count periodically
    const updatePending = async () => {
      const status = await getSyncStatus();
      setPendingCount(status.pending + status.failed);
    };

    updatePending();
    const interval = setInterval(updatePending, 3000);
    return () => clearInterval(interval);
  }, []);

  // Only show when offline
  if (isOnline) return null;

  return (
    <div className={cn(
      "bg-orange-500 text-white px-4 py-3 flex items-center justify-center gap-3",
      "animate-pulse", // Subtle attention-grabbing animation
      className
    )}>
      <WifiOff className="w-5 h-5" />
      <span className="font-bold text-lg tracking-wide">OFFLINE MODE</span>
      {pendingCount > 0 && (
        <div className="flex items-center gap-1 bg-white/20 px-2 py-0.5 rounded-full text-sm">
          <Upload className="w-3 h-3" />
          <span>{pendingCount} pending</span>
        </div>
      )}
    </div>
  );
}
```

Key design decisions per context:
- Orange background (not subtle) to be unmistakably obvious
- Always visible (not dismissible) when offline
- Shows pending sync count so staff knows scans are queued
- Animate-pulse for attention without being annoying
  </action>
  <verify>Both components export: `grep -l "export.*function" maguey-gate-scanner/src/components/scanner/CheckInCounter.tsx maguey-gate-scanner/src/components/scanner/OfflineBanner.tsx`</verify>
  <done>CheckInCounter shows real-time counts, OfflineBanner prominently indicates offline status</done>
</task>

<task type="auto">
  <name>Task 3: Integrate all components into Scanner.tsx</name>
  <files>maguey-gate-scanner/src/pages/Scanner.tsx</files>
  <action>
Update Scanner.tsx to integrate the new UI components:

**1. Add imports:**
```typescript
import { ScanHistory, ScanHistoryEntry } from "@/components/scanner/ScanHistory";
import { CheckInCounter } from "@/components/scanner/CheckInCounter";
import { OfflineBanner } from "@/components/scanner/OfflineBanner";
```

**2. Add scan history state:**
```typescript
const [scanHistory, setScanHistory] = useState<ScanHistoryEntry[]>([]);
const MAX_HISTORY_ENTRIES = 10;

const addToHistory = (entry: Omit<ScanHistoryEntry, 'id'>) => {
  setScanHistory(prev => {
    const newEntry = { ...entry, id: crypto.randomUUID() };
    const updated = [newEntry, ...prev].slice(0, MAX_HISTORY_ENTRIES);
    // Persist to localStorage for reload recovery
    localStorage.setItem('scan_history', JSON.stringify(updated));
    return updated;
  });
};

const toggleHistoryExpand = (id: string) => {
  setScanHistory(prev => prev.map(entry =>
    entry.id === id ? { ...entry, expanded: !entry.expanded } : entry
  ));
};
```

**3. Load history from localStorage on mount:**
```typescript
useEffect(() => {
  const saved = localStorage.getItem('scan_history');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      // Convert timestamp strings back to Date objects
      setScanHistory(parsed.map((e: any) => ({
        ...e,
        timestamp: new Date(e.timestamp)
      })));
    } catch (e) {
      console.error('Failed to load scan history:', e);
    }
  }
}, []);
```

**4. Update processScan to add to history:**
After setting scan state (both success and failure), add:
```typescript
addToHistory({
  timestamp: new Date(),
  status: result.success ? 'success' : 'failure',
  ticketType: determineTicketTypeLabel(result.ticket, vipLinkInfo),
  guestName: result.ticket?.guest_name,
  eventName: result.ticket?.event_name,
  errorReason: !result.success ? result.message : undefined,
});
```

**5. Get selected event ID for counter:**
Add state to track selected event ID (not just name):
```typescript
const [selectedEventId, setSelectedEventId] = useState<string | null>(null);
```

Update the event dropdown to also set the ID when selecting an event.

**6. Update layout to include new components:**

Position OfflineBanner at very top (above everything):
```tsx
{/* Offline Banner - very top, above nav */}
<OfflineBanner className="fixed top-0 left-0 right-0 z-[70]" />

{/* Check-in Counter - below offline banner, above nav */}
<div className={cn(
  "fixed left-0 right-0 z-[65]",
  isOnline ? "top-0" : "top-[52px]" // Adjust for offline banner height
)}>
  <CheckInCounter eventId={selectedEventId} />
</div>
```

Position ScanHistory at bottom, above the navigation bar:
```tsx
{/* Scan History - above bottom nav, below scanner */}
{scanHistory.length > 0 && (
  <div className="fixed bottom-24 left-0 right-0 z-[40] px-4 pb-2">
    <ScanHistory
      entries={scanHistory}
      maxVisible={5}
      onToggleExpand={toggleHistoryExpand}
    />
  </div>
)}
```

**7. Adjust existing layout padding** to account for new components:
- Add padding-top to main content for counter (and offline banner when shown)
- Ensure scan history doesn't overlap with result overlays (z-index ordering)
  </action>
  <verify>Build passes: `cd maguey-gate-scanner && npm run build`</verify>
  <done>Scanner.tsx integrates CheckInCounter, OfflineBanner, and ScanHistory components</done>
</task>

</tasks>

<verification>
1. Build completes without errors
2. All three new components exist in components/scanner/
3. Scanner.tsx imports and renders all new components
4. Scan history persists in localStorage across page reloads
5. Check-in counter updates when tickets are scanned
6. Offline banner appears immediately when network is lost
</verification>

<success_criteria>
1. Scan history shows last 5-10 scans with green/red color coding
2. Tapping a scan history row expands to show full details
3. Check-in counter always visible at top: "Checked in: X / Y"
4. Counter updates in real-time via Supabase subscription
5. OFFLINE MODE banner prominently displayed when disconnected
6. Banner shows pending sync count
7. All components properly positioned without overlapping
</success_criteria>

<output>
After completion, create `.planning/phases/03-scanner-system-hardening/03-03-SUMMARY.md`
</output>
