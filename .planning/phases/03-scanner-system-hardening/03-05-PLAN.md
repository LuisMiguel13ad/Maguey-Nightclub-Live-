---
phase: 03-scanner-system-hardening
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - maguey-gate-scanner/src/lib/scanner-status-service.ts
  - maguey-gate-scanner/src/pages/OwnerDashboard.tsx
autonomous: false

must_haves:
  truths:
    - "Owner dashboard shows scanner online/offline status"
    - "Dashboard updates in real-time as scanner status changes"
    - "Scanner heartbeat is sent periodically to track status"
    - "All scanner hardening features verified by human testing"
  artifacts:
    - path: "maguey-gate-scanner/src/lib/scanner-status-service.ts"
      provides: "Scanner heartbeat and status reporting"
      exports: ["sendHeartbeat", "getScannerStatuses"]
    - path: "maguey-gate-scanner/src/pages/OwnerDashboard.tsx"
      provides: "Scanner status display section"
      contains: "Scanner Status"
  key_links:
    - from: "OwnerDashboard.tsx"
      to: "scanner-status-service.ts"
      via: "getScannerStatuses call"
      pattern: "getScannerStatuses"
    - from: "Scanner.tsx"
      to: "scanner-status-service.ts"
      via: "sendHeartbeat on interval"
      pattern: "sendHeartbeat"
---

<objective>
Add scanner status monitoring to dashboard and verify all scanner hardening features

Purpose: Venue owners need to see which gate scanners are online/offline from the dashboard. This provides operational visibility and helps identify connectivity issues before they impact guest entry.

Output: Scanner status service with heartbeat reporting, dashboard integration, and human verification of complete scanner system
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scanner-system-hardening/03-CONTEXT.md
@.planning/phases/03-scanner-system-hardening/03-RESEARCH.md

@maguey-gate-scanner/src/pages/OwnerDashboard.tsx
@maguey-gate-scanner/src/pages/Scanner.tsx
@maguey-gate-scanner/src/lib/offline-queue-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scanner status service with heartbeat</name>
  <files>maguey-gate-scanner/src/lib/scanner-status-service.ts</files>
  <action>
Create scanner-status-service.ts to track scanner device status:

**1. Type definitions:**
```typescript
import { supabase } from './supabase';

export interface ScannerStatus {
  deviceId: string;
  deviceName?: string;
  lastHeartbeat: string;
  isOnline: boolean;
  pendingScans: number;
  currentEventId?: string;
  currentEventName?: string;
  scansToday: number;
  batteryLevel?: number; // If available from device API
}

// Heartbeat considered stale after 60 seconds
const HEARTBEAT_STALE_MS = 60 * 1000;
```

**2. Get or create device ID (reuse from offline-queue-service):**
```typescript
export function getDeviceId(): string {
  const stored = localStorage.getItem('scanner_device_id');
  if (stored) return stored;

  const deviceId = `scanner_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  localStorage.setItem('scanner_device_id', deviceId);
  return deviceId;
}

export function getDeviceName(): string {
  return localStorage.getItem('scanner_device_name') || 'Unnamed Scanner';
}

export function setDeviceName(name: string): void {
  localStorage.setItem('scanner_device_name', name);
}
```

**3. Send heartbeat function:**
```typescript
export async function sendHeartbeat(options: {
  eventId?: string;
  eventName?: string;
  pendingScans: number;
  scansToday: number;
}): Promise<boolean> {
  const deviceId = getDeviceId();
  const deviceName = getDeviceName();

  try {
    const { error } = await supabase
      .from('scanner_heartbeats')
      .upsert({
        device_id: deviceId,
        device_name: deviceName,
        last_heartbeat: new Date().toISOString(),
        is_online: navigator.onLine,
        pending_scans: options.pendingScans,
        current_event_id: options.eventId || null,
        current_event_name: options.eventName || null,
        scans_today: options.scansToday,
      }, {
        onConflict: 'device_id',
      });

    if (error) {
      console.error('[scanner-status] Heartbeat failed:', error);
      return false;
    }

    return true;
  } catch (error) {
    console.error('[scanner-status] Heartbeat error:', error);
    return false;
  }
}
```

**4. Get all scanner statuses (for dashboard):**
```typescript
export async function getScannerStatuses(): Promise<ScannerStatus[]> {
  try {
    const { data, error } = await supabase
      .from('scanner_heartbeats')
      .select('*')
      .order('last_heartbeat', { ascending: false });

    if (error) throw error;

    const now = Date.now();

    return (data || []).map(row => ({
      deviceId: row.device_id,
      deviceName: row.device_name,
      lastHeartbeat: row.last_heartbeat,
      // Consider online if heartbeat is recent AND device reported online
      isOnline: row.is_online && (now - new Date(row.last_heartbeat).getTime() < HEARTBEAT_STALE_MS),
      pendingScans: row.pending_scans || 0,
      currentEventId: row.current_event_id,
      currentEventName: row.current_event_name,
      scansToday: row.scans_today || 0,
    }));
  } catch (error) {
    console.error('[scanner-status] Failed to get statuses:', error);
    return [];
  }
}
```

**5. Create database table migration:**
Create migration file: `maguey-pass-lounge/supabase/migrations/[timestamp]_create_scanner_heartbeats.sql`

```sql
-- Scanner heartbeat tracking for dashboard status display
CREATE TABLE IF NOT EXISTS scanner_heartbeats (
  device_id TEXT PRIMARY KEY,
  device_name TEXT,
  last_heartbeat TIMESTAMPTZ NOT NULL DEFAULT now(),
  is_online BOOLEAN NOT NULL DEFAULT true,
  pending_scans INTEGER NOT NULL DEFAULT 0,
  current_event_id UUID REFERENCES events(id),
  current_event_name TEXT,
  scans_today INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Index for dashboard queries
CREATE INDEX idx_scanner_heartbeats_last_heartbeat ON scanner_heartbeats(last_heartbeat DESC);

-- RLS: Allow authenticated users to read, scanners to write their own
ALTER TABLE scanner_heartbeats ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read scanner status"
  ON scanner_heartbeats FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Scanners can upsert their own heartbeat"
  ON scanner_heartbeats FOR ALL
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Trigger to update updated_at
CREATE TRIGGER update_scanner_heartbeats_updated_at
  BEFORE UPDATE ON scanner_heartbeats
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```
  </action>
  <verify>Service file created: `test -f maguey-gate-scanner/src/lib/scanner-status-service.ts && echo "exists"`</verify>
  <done>Scanner status service created with heartbeat sending and status retrieval functions</done>
</task>

<task type="auto">
  <name>Task 2: Add scanner status to Owner Dashboard</name>
  <files>maguey-gate-scanner/src/pages/OwnerDashboard.tsx</files>
  <action>
Add scanner status section to OwnerDashboard.tsx:

**1. Add imports:**
```typescript
import { getScannerStatuses, ScannerStatus } from '@/lib/scanner-status-service';
import { Wifi, WifiOff, Smartphone } from 'lucide-react';
```

**2. Add state for scanner statuses:**
```typescript
const [scannerStatuses, setScannerStatuses] = useState<ScannerStatus[]>([]);
```

**3. Add fetch function:**
```typescript
const fetchScannerStatuses = async () => {
  try {
    const statuses = await getScannerStatuses();
    setScannerStatuses(statuses);
  } catch (error) {
    console.error('Error fetching scanner statuses:', error);
  }
};
```

**4. Call in loadData and add to realtime subscription:**
Add `fetchScannerStatuses()` to the loadData function.

Add subscription for scanner_heartbeats table:
```typescript
.on(
  'postgres_changes',
  {
    event: '*',
    schema: 'public',
    table: 'scanner_heartbeats',
  },
  () => {
    fetchScannerStatuses();
  }
)
```

**5. Add Scanner Status card to the Operational Insights section:**
After the email status section (around line 916), add:

```tsx
{/* Scanner Status Section */}
<div className="rounded-2xl border border-white/5 bg-white/5 p-4 transition-all hover:bg-white/10">
  <div className="flex items-center gap-4 mb-3">
    <div className="rounded-full bg-gradient-to-br from-green-500/20 to-emerald-500/20 p-3 text-green-300 shadow-[0_0_15px_rgba(34,197,94,0.2)]">
      <Smartphone className="h-4 w-4" />
    </div>
    <div className="flex-1 space-y-1">
      <p className="text-sm font-medium leading-none text-white">Scanner Status</p>
      <div className="flex items-center gap-2 text-xs text-slate-400">
        <span className="text-emerald-400 font-semibold">
          {scannerStatuses.filter(s => s.isOnline).length} online
        </span>
        <span className="text-slate-600">|</span>
        <span className="text-red-400">
          {scannerStatuses.filter(s => !s.isOnline).length} offline
        </span>
      </div>
    </div>
  </div>

  {/* Scanner list */}
  {scannerStatuses.length > 0 ? (
    <div className="mt-3 space-y-2 max-h-40 overflow-y-auto">
      {scannerStatuses.map((scanner) => (
        <div
          key={scanner.deviceId}
          className="flex items-center justify-between text-xs bg-white/5 rounded-lg px-3 py-2"
        >
          <div className="flex items-center gap-2">
            {scanner.isOnline ? (
              <Wifi className="h-3 w-3 text-emerald-400" />
            ) : (
              <WifiOff className="h-3 w-3 text-red-400" />
            )}
            <span className="text-slate-300">
              {scanner.deviceName || scanner.deviceId.slice(0, 12)}
            </span>
          </div>
          <div className="flex items-center gap-2">
            {scanner.currentEventName && (
              <span className="text-slate-500 truncate max-w-[100px]">
                {scanner.currentEventName}
              </span>
            )}
            <span className="text-slate-400">
              {scanner.scansToday} scans
            </span>
            {scanner.pendingScans > 0 && (
              <span className="px-1.5 py-0.5 rounded-full text-[10px] font-medium bg-yellow-500/20 text-yellow-400">
                {scanner.pendingScans} pending
              </span>
            )}
          </div>
        </div>
      ))}
    </div>
  ) : (
    <p className="text-xs text-slate-500 mt-2">No active scanners</p>
  )}
</div>
```

**6. Update Scanner.tsx to send heartbeats:**
Add to Scanner.tsx:
```typescript
import { sendHeartbeat } from '@/lib/scanner-status-service';
import { getSyncStatus } from '@/lib/offline-queue-service';

// Track scans today in state or localStorage
const [scansToday, setScansToday] = useState(() => {
  const saved = localStorage.getItem('scans_today');
  const savedDate = localStorage.getItem('scans_today_date');
  const today = new Date().toDateString();
  if (savedDate === today && saved) return parseInt(saved, 10);
  return 0;
});

// Send heartbeat every 30 seconds
useEffect(() => {
  const sendStatus = async () => {
    const syncStatus = await getSyncStatus();
    await sendHeartbeat({
      eventId: selectedEventId || undefined,
      eventName: selectedEvent !== 'all' ? selectedEvent : undefined,
      pendingScans: syncStatus.pending + syncStatus.failed,
      scansToday,
    });
  };

  // Send immediately
  sendStatus();

  // Then every 30 seconds
  const interval = setInterval(sendStatus, 30000);
  return () => clearInterval(interval);
}, [selectedEventId, selectedEvent, scansToday]);

// Increment scans today on successful scan
// Add to processScan success path:
setScansToday(prev => {
  const newCount = prev + 1;
  localStorage.setItem('scans_today', String(newCount));
  localStorage.setItem('scans_today_date', new Date().toDateString());
  return newCount;
});
```
  </action>
  <verify>Build passes: `cd maguey-gate-scanner && npm run build`</verify>
  <done>Dashboard displays scanner online/offline status with real-time updates</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete scanner system hardening including:
- Full-screen green/red feedback overlays
- Audio tones and haptic feedback
- Offline ticket cache with local validation
- Scan history with expandable details
- Check-in counter at top
- Prominent OFFLINE MODE banner
- Enhanced rejection messages with staff/gate/time
- Dashboard scanner status display
  </what-built>
  <how-to-verify>
**Test 1: Success Feedback**
1. Navigate to scanner (http://localhost:5173/scanner)
2. Scan a valid QR code (or use manual entry with a valid ticket ID)
3. Verify: Full green screen appears with large checkmark
4. Verify: Success audio tone plays
5. Verify: Auto-dismisses after ~1.5 seconds
6. For VIP tickets: Verify table details shown

**Test 2: Rejection Feedback**
1. Scan the same ticket again
2. Verify: Full red screen appears with "ALREADY SCANNED"
3. Verify: Shows time of previous scan
4. Verify: Error audio tone plays
5. Verify: Must tap "Scan Next" to dismiss (no auto-dismiss)

**Test 3: Offline Mode**
1. Open DevTools > Network > Set to Offline
2. Verify: Orange "OFFLINE MODE" banner appears prominently
3. Try scanning a ticket
4. Verify: Validates against local cache OR accepts with warning
5. Verify: Scan queued for sync (shown in banner)
6. Restore network
7. Verify: Scans sync and toast shows "Synced X check-ins"

**Test 4: UI Components**
1. Verify: Check-in counter visible at top ("Checked in: X / Y")
2. Verify: Scan history shows recent scans (color-coded)
3. Tap a history entry
4. Verify: Expands to show full details

**Test 5: Dashboard Status**
1. Navigate to owner dashboard
2. Verify: Scanner status section shows the scanner device
3. Verify: Shows online/offline status
4. Verify: Shows scan count and pending syncs
  </how-to-verify>
  <resume-signal>Type "scanner verified" to confirm all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build completes without errors
2. scanner-status-service.ts exists with sendHeartbeat and getScannerStatuses
3. OwnerDashboard.tsx has scanner status section
4. Scanner.tsx sends heartbeats every 30 seconds
5. Human verification confirms all scanner features work correctly
</verification>

<success_criteria>
1. Dashboard shows scanner devices with online/offline status
2. Status updates in real-time via Supabase subscription
3. Scanner sends heartbeat every 30 seconds
4. Human tester confirms:
   - Full-screen success/failure overlays work
   - Audio/haptic feedback plays
   - Offline mode banner is prominent
   - Ticket cache validation works offline
   - Scan history is visible and expandable
   - Check-in counter updates
</success_criteria>

<output>
After completion, create `.planning/phases/03-scanner-system-hardening/03-05-SUMMARY.md`
</output>
