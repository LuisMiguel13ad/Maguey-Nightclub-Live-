---
phase: 21-vip-events-polish
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - maguey-gate-scanner/src/pages/VipTablesManagement.tsx
  - maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
  - maguey-gate-scanner/src/lib/cross-site-sync.ts
autonomous: true

must_haves:
  truths:
    - "Owner can share VIP invite link via native share sheet on mobile or clipboard on desktop"
    - "Invite code is auto-generated for new reservations that lack one"
    - "VIP table CRUD operations log a sync entry to cross_site_sync_log"
  artifacts:
    - path: "maguey-gate-scanner/src/pages/VipTablesManagement.tsx"
      provides: "Share button with Web Share API and clipboard fallback"
      contains: "navigator.share"
    - path: "maguey-gate-scanner/src/lib/vip-tables-admin-service.ts"
      provides: "generateInviteCode function"
      contains: "generate_vip_invite_code"
    - path: "maguey-gate-scanner/src/lib/cross-site-sync.ts"
      provides: "syncVipTables function"
      exports: ["syncVipTables"]
  key_links:
    - from: "maguey-gate-scanner/src/pages/VipTablesManagement.tsx"
      to: "maguey-gate-scanner/src/lib/vip-tables-admin-service.ts"
      via: "calls generateInviteCode before sharing"
      pattern: "generateInviteCode"
    - from: "maguey-gate-scanner/src/pages/VipTablesManagement.tsx"
      to: "maguey-gate-scanner/src/lib/cross-site-sync.ts"
      via: "calls syncVipTables after table CRUD"
      pattern: "syncVipTables"
---

<objective>
Add one-tap invite link sharing for VIP reservations and explicit VIP table sync logging.

Purpose: Currently the "Copy Invite Link" button only appears if invite_code exists (which is always null). The owner needs a working share flow. Additionally, VIP table changes need explicit sync logging to the cross_site_sync_log table so the owner can see sync status.

Output: Working share button with Web Share API + clipboard fallback, invite code generation, and syncVipTables function called on VIP table CRUD.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.0-ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-vip-events-polish/21-RESEARCH.md
@maguey-gate-scanner/src/pages/VipTablesManagement.tsx
@maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
@maguey-gate-scanner/src/lib/cross-site-sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invite code generation and Web Share API sharing</name>
  <files>
    maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
    maguey-gate-scanner/src/pages/VipTablesManagement.tsx
  </files>
  <action>
    1. Add `generateInviteCode` function to `vip-tables-admin-service.ts` (after the existing exports, around line 1090):
       ```typescript
       /**
        * Generate an invite code for a VIP reservation.
        * Uses the database RPC generate_vip_invite_code() which creates
        * a unique 8-char alphanumeric code.
        */
       export async function generateInviteCode(reservationId: string): Promise<{ code: string | null; error?: string }> {
         // First check if reservation already has a code
         const { data: reservation, error: fetchError } = await supabase
           .from('vip_reservations')
           .select('invite_code')
           .eq('id', reservationId)
           .single();

         if (fetchError) {
           return { code: null, error: fetchError.message };
         }

         if (reservation.invite_code) {
           return { code: reservation.invite_code };
         }

         // Generate new code via RPC
         const { data: code, error: rpcError } = await supabase
           .rpc('generate_vip_invite_code');

         if (rpcError || !code) {
           // Fallback: generate client-side if RPC fails
           const fallbackCode = crypto.randomUUID().replace(/-/g, '').substring(0, 8).toUpperCase();
           const { error: updateError } = await supabase
             .from('vip_reservations')
             .update({ invite_code: fallbackCode })
             .eq('id', reservationId);

           if (updateError) {
             return { code: null, error: updateError.message };
           }
           return { code: fallbackCode };
         }

         // Save the generated code to the reservation
         const { error: updateError } = await supabase
           .from('vip_reservations')
           .update({ invite_code: code })
           .eq('id', reservationId);

         if (updateError) {
           return { code: null, error: updateError.message };
         }

         return { code };
       }
       ```

    2. Replace the existing "Copy Invite Link" button in `VipTablesManagement.tsx` (lines ~1191-1209) with a full share implementation:

       - Add `Share2` to the lucide-react imports (already has `Copy` imported)
       - Add `generateInviteCode` to the vip-tables-admin-service imports
       - Add state for share loading: `const [isGeneratingCode, setIsGeneratingCode] = useState(false);`

       Replace the existing invite link button block (inside the "Linked GA Tickets" section header, ~line 1191) with:
       ```tsx
       <Button
         variant="outline"
         size="sm"
         className="h-7 text-xs gap-1"
         disabled={isGeneratingCode}
         onClick={async () => {
           setIsGeneratingCode(true);
           try {
             // Ensure invite code exists
             let inviteCode = selectedReservation.invite_code;
             if (!inviteCode) {
               const result = await generateInviteCode(selectedReservation.id);
               if (result.error || !result.code) {
                 toast({ variant: 'destructive', title: 'Error', description: result.error || 'Failed to generate invite code' });
                 return;
               }
               inviteCode = result.code;
               // Update local state so the code persists in UI
               setSelectedReservation(prev => prev ? { ...prev, invite_code: inviteCode } : prev);
             }

             const purchaseBaseUrl = import.meta.env.VITE_PURCHASE_SITE_URL || (import.meta.env.DEV ? 'http://localhost:3016' : 'https://tickets.maguey.club');
             const url = `${purchaseBaseUrl}/checkout?event=${selectedReservation.event_id}&vip=${inviteCode}`;
             const eventName = events.find(e => e.id === selectedReservation.event_id)?.name || 'Maguey VIP';

             const shareData = {
               title: `Join VIP Table - ${eventName}`,
               text: `You're invited to join Table ${selectedReservation.vip_table?.table_number || ''} at ${eventName}!`,
               url,
             };

             // Try Web Share API first (mobile native share sheet)
             if (navigator.canShare && navigator.canShare(shareData)) {
               try {
                 await navigator.share(shareData);
                 toast({ title: 'Shared successfully' });
               } catch (err: any) {
                 if (err.name !== 'AbortError') {
                   // Share failed, fall back to clipboard
                   await copyToClipboard(url);
                 }
                 // AbortError = user cancelled, no action needed
               }
             } else {
               // Desktop fallback: copy to clipboard
               await copyToClipboard(url);
             }
           } finally {
             setIsGeneratingCode(false);
           }
         }}
       >
         {isGeneratingCode ? (
           <Loader2 className="h-3 w-3 animate-spin" />
         ) : navigator.canShare ? (
           <Share2 className="h-3 w-3" />
         ) : (
           <Copy className="h-3 w-3" />
         )}
         {isGeneratingCode ? 'Generating...' : 'Share Invite'}
       </Button>
       ```

       - Remove the `{selectedReservation.invite_code && (` conditional wrapper -- the button should ALWAYS show, regardless of whether invite_code exists (it will generate one on click)
       - Add a helper function inside the component:
       ```typescript
       const copyToClipboard = async (url: string) => {
         try {
           await navigator.clipboard.writeText(url);
           toast({ title: 'Invite link copied', description: 'Share this link with guests to join the VIP table' });
         } catch {
           toast({ title: 'Copy failed', description: url, variant: 'destructive' });
         }
       };
       ```

       - Also update the empty state text (line ~1255-1257): remove the conditional `{selectedReservation.invite_code && (` -- always show the "Share the invite link" hint since we can now always generate a code.
  </action>
  <verify>
    - `grep -n "navigator.share" maguey-gate-scanner/src/pages/VipTablesManagement.tsx` returns a match
    - `grep -n "generateInviteCode" maguey-gate-scanner/src/lib/vip-tables-admin-service.ts` returns the function
    - `grep -n "Share Invite" maguey-gate-scanner/src/pages/VipTablesManagement.tsx` shows the button text
    - `cd maguey-gate-scanner && npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    - Share button always visible in reservation detail dialog (no conditional on invite_code)
    - Clicking Share generates invite_code if missing, then uses Web Share API on mobile or clipboard on desktop
    - generateInviteCode uses DB RPC with client-side fallback
    - AbortError (user cancelled share sheet) handled gracefully without toast
  </done>
</task>

<task type="auto">
  <name>Task 2: Add syncVipTables to cross-site-sync and call on CRUD</name>
  <files>
    maguey-gate-scanner/src/lib/cross-site-sync.ts
    maguey-gate-scanner/src/pages/VipTablesManagement.tsx
  </files>
  <action>
    1. Add `syncVipTables` function to `cross-site-sync.ts` (after the syncEvent function, ~line 79):
       ```typescript
       /**
        * Log a VIP table sync operation.
        * VIP tables are already synced via Supabase real-time (shared DB),
        * so this function logs the operation for audit and provides owner visibility.
        */
       export async function syncVipTables(
         eventId: string,
         action: 'create' | 'update' | 'delete'
       ): Promise<SyncResult> {
         if (!isSupabaseConfigured()) {
           return {
             success: false,
             syncedSites: [],
             failedSites: ["purchase"],
             errors: ["Supabase not configured"],
           };
         }

         try {
           const { data: user } = await supabase.auth.getUser();

           const { data: syncLog, error: logError } = await supabase
             .from("cross_site_sync_log")
             .insert({
               sync_type: "vip_tables",
               source_site: "scanner",
               target_sites: ["purchase"],
               status: "pending",
               synced_by: user?.user?.id || null,
             })
             .select()
             .single();

           if (logError) throw logError;

           // VIP tables sync automatically via Supabase real-time subscriptions
           // (both sites share the same Supabase database)
           const syncedSites = ["purchase"];

           await supabase
             .from("cross_site_sync_log")
             .update({
               status: "success",
               completed_at: new Date().toISOString(),
               details: {
                 event_id: eventId,
                 action,
                 synced_sites: syncedSites,
               },
             })
             .eq("id", syncLog.id);

           return {
             success: true,
             syncedSites,
             failedSites: [],
           };
         } catch (error: any) {
           return {
             success: false,
             syncedSites: [],
             failedSites: ["purchase"],
             errors: [error.message],
           };
         }
       }
       ```

       Update the SyncType at the top (~line 9):
       ```typescript
       export type SyncType = "event" | "branding" | "content" | "settings" | "vip_tables";
       ```

    2. Call `syncVipTables` after VIP table modifications in `VipTablesManagement.tsx`:

       - Import `syncVipTables` from `@/lib/cross-site-sync`
       - In the `handleTableEdit` function (~line 474-509), after the successful `supabase.from('event_vip_tables').update(...)` call and before the toast, add:
         ```typescript
         // Log sync for purchase site visibility
         if (selectedEventId) {
           syncVipTables(selectedEventId, 'update').catch(err =>
             console.warn('VIP sync log failed:', err)
           );
         }
         ```
         Note: fire-and-forget (no await) to avoid blocking the UI. The sync is for logging only since both sites share the same database.

       - In the `handleStatusChange` function (~line 455-471), after the successful `updateReservationStatus` call, add the same fire-and-forget sync:
         ```typescript
         if (selectedEventId) {
           syncVipTables(selectedEventId, 'update').catch(err =>
             console.warn('VIP sync log failed:', err)
           );
         }
         ```
  </action>
  <verify>
    - `grep -n "syncVipTables" maguey-gate-scanner/src/lib/cross-site-sync.ts` shows the function
    - `grep -n "syncVipTables" maguey-gate-scanner/src/pages/VipTablesManagement.tsx` shows import and usage
    - `grep -n "vip_tables" maguey-gate-scanner/src/lib/cross-site-sync.ts` shows the sync_type
    - `cd maguey-gate-scanner && npm run build` succeeds
  </verify>
  <done>
    - syncVipTables function exported from cross-site-sync.ts
    - VIP table edits (pricing, availability, tier) trigger sync log entry
    - Reservation status changes trigger sync log entry
    - Sync calls are fire-and-forget to avoid blocking UI
    - cross_site_sync_log table receives vip_tables entries with event_id and action
  </done>
</task>

</tasks>

<verification>
- Share button works: always visible, generates invite code if needed, uses Web Share API on mobile
- Clipboard fallback works on desktop browsers
- syncVipTables logs to cross_site_sync_log on table edits
- Build succeeds: `cd maguey-gate-scanner && npm run build`
</verification>

<success_criteria>
- VIP invite links shareable via one-tap (Web Share API on mobile, clipboard copy on desktop)
- Invite codes auto-generated on first share attempt (no manual step)
- VIP table changes logged to cross_site_sync_log with sync_type "vip_tables"
</success_criteria>

<output>
After completion, create `.planning/phases/21-vip-events-polish/21-02-SUMMARY.md`
</output>
