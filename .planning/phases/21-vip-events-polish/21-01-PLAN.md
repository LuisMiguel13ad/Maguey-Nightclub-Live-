---
phase: 21-vip-events-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/package.json
  - maguey-pass-lounge/supabase/migrations/20260215000000_add_table_positions.sql
  - maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx
  - maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
  - maguey-gate-scanner/src/pages/VipTablesManagement.tsx
autonomous: true

must_haves:
  truths:
    - "Owner can drag VIP tables to new positions on the floor plan"
    - "Table positions persist across page reloads (saved to database)"
    - "Existing tables without positions render in a sensible default layout"
    - "Floor plan still shows table numbers, prices, tiers, and reservation status"
  artifacts:
    - path: "maguey-pass-lounge/supabase/migrations/20260215000000_add_table_positions.sql"
      provides: "position_x and position_y columns on event_vip_tables with default backfill"
      contains: "position_x"
    - path: "maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx"
      provides: "Drag-and-drop floor plan using @dnd-kit/core"
      min_lines: 100
    - path: "maguey-gate-scanner/src/lib/vip-tables-admin-service.ts"
      provides: "updateTablePosition function"
      exports: ["updateTablePosition"]
  key_links:
    - from: "maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx"
      to: "maguey-gate-scanner/src/lib/vip-tables-admin-service.ts"
      via: "onUpdatePosition callback calling updateTablePosition"
      pattern: "updateTablePosition"
    - from: "maguey-gate-scanner/src/pages/VipTablesManagement.tsx"
      to: "maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx"
      via: "renders VIPFloorPlanAdmin with position data"
      pattern: "VIPFloorPlanAdmin"
---

<objective>
Add drag-and-drop positioning to the VIP floor plan so the owner can arrange tables freely.

Purpose: The current floor plan uses static Flexbox layout -- tables are locked in rows (1-3 left, 4-7 center, 8 right, 9-20 bottom). The owner needs to position tables to match the real venue layout for event night.

Output: Draggable floor plan with database-persisted positions, migration for position columns.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.0-ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-vip-events-polish/21-RESEARCH.md
@maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx
@maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
@maguey-gate-scanner/src/pages/VipTablesManagement.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add position columns and install @dnd-kit</name>
  <files>
    maguey-pass-lounge/supabase/migrations/20260215000000_add_table_positions.sql
    maguey-gate-scanner/package.json
    maguey-gate-scanner/src/lib/vip-tables-admin-service.ts
  </files>
  <action>
    1. Create migration `maguey-pass-lounge/supabase/migrations/20260215000000_add_table_positions.sql`:
       - ALTER TABLE event_vip_tables ADD COLUMN IF NOT EXISTS position_x INTEGER, ADD COLUMN IF NOT EXISTS position_y INTEGER
       - Backfill existing rows with default grid positions based on table_number. Use a fixed coordinate system within a 1000x700 canvas (not pixels, logical units):
         - Tables 1,2,3 (left wing): x=50, y=100/250/400
         - Tables 4,5,6,7 (front row): x=250/400/550/700, y=100
         - Table 8 (right wing): x=900, y=100
         - Tables 9-14 (standard top): x=200/350/500/650/800/950, y=350 (spaced evenly)
         - Tables 15-20 (standard bottom): x=200/350/500/650/800/950, y=500
       - Use WHERE position_x IS NULL OR position_y IS NULL to avoid overwriting existing positions

    2. Install @dnd-kit/core in maguey-gate-scanner:
       ```
       cd maguey-gate-scanner && npm install @dnd-kit/core@^6.1.0
       ```
       Do NOT install @dnd-kit/sortable (not needed for free-form positioning).

    3. Add `updateTablePosition` function to `maguey-gate-scanner/src/lib/vip-tables-admin-service.ts`:
       ```typescript
       export async function updateTablePosition(
         tableId: string,
         position: { x: number; y: number }
       ): Promise<{ success: boolean; error?: string }> {
         const { error } = await supabase
           .from('event_vip_tables')
           .update({ position_x: Math.round(position.x), position_y: Math.round(position.y) })
           .eq('id', tableId);

         if (error) {
           console.error('Failed to update table position:', error);
           return { success: false, error: error.message };
         }
         return { success: true };
       }
       ```
       Add it near the other table update functions (around line 358).
  </action>
  <verify>
    - Migration file exists and is valid SQL (check for syntax errors)
    - `npm ls @dnd-kit/core` shows the package installed in maguey-gate-scanner
    - `grep -n "updateTablePosition" maguey-gate-scanner/src/lib/vip-tables-admin-service.ts` shows the function
  </verify>
  <done>
    - position_x and position_y columns defined in migration with backfill
    - @dnd-kit/core installed
    - updateTablePosition exported from vip-tables-admin-service.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite VIPFloorPlanAdmin with drag-and-drop</name>
  <files>
    maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx
    maguey-gate-scanner/src/pages/VipTablesManagement.tsx
  </files>
  <action>
    1. Rewrite `VIPFloorPlanAdmin.tsx` to use @dnd-kit/core for free-form positioning:

       **Keep unchanged:** The EventVIPTable and VIPReservation interfaces, TIER_COLORS, TIER_LABELS, AdminTableButton component (visual), SelectedTableInfo component, DEFAULT_TABLES array.

       **Add to EventVIPTable interface:** `position_x?: number | null; position_y?: number | null;`

       **Add new props to VIPFloorPlanAdminProps:**
       ```typescript
       onUpdatePosition?: (tableId: string, x: number, y: number) => Promise<void>;
       ```

       **Create DraggableTable wrapper component:**
       ```typescript
       import { DndContext, DragEndEvent, useDraggable } from '@dnd-kit/core';
       import { CSS } from '@dnd-kit/utilities';

       function DraggableTable({ table, position, isSelected, hasReservation, onSelect, readOnly, compact }: {
         table: EventVIPTable;
         position: { x: number; y: number };
         isSelected: boolean;
         hasReservation: boolean;
         onSelect: () => void;
         readOnly?: boolean;
         compact?: boolean;
       }) {
         const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
           id: table.id,
           data: { table, position },
           disabled: readOnly,
         });

         const style: React.CSSProperties = {
           position: 'absolute',
           left: `${(position.x / 1000) * 100}%`,
           top: `${(position.y / 700) * 100}%`,
           transform: CSS.Translate.toString(transform),
           touchAction: 'none',
           zIndex: isDragging ? 50 : undefined,
           opacity: isDragging ? 0.8 : 1,
           cursor: readOnly ? 'pointer' : 'grab',
         };

         return (
           <div ref={setNodeRef} style={style} {...listeners} {...attributes}>
             <AdminTableButton
               table={table}
               isSelected={isSelected}
               hasReservation={hasReservation}
               onClick={onSelect}
               isAbsolute={false}
               readOnly={false}
               compact={compact}
             />
           </div>
         );
       }
       ```

       **Replace the floor plan layout section** (the JSX that currently uses flex columns for left wing, center, right wing) with a DndContext wrapping a single relative container:
       ```tsx
       <DndContext onDragEnd={handleDragEnd}>
         <div className={cn(
           "relative bg-zinc-950 rounded-xl border border-emerald-900/50 overflow-hidden",
           compact ? "h-[400px]" : "h-[600px] sm:h-[700px]"
         )}>
           {/* Stage indicator at top center */}
           <div className="absolute top-2 left-1/2 -translate-x-1/2 z-10">
             <div className={cn(
               "bg-gradient-to-b from-emerald-950 to-zinc-950 border border-emerald-800/50 rounded-t-xl px-4 py-1.5",
               compact ? "w-24" : "w-36"
             )}>
               <h3 className={cn("text-white text-center font-bold tracking-[0.2em] uppercase", compact ? "text-[8px]" : "text-xs")}>Stage</h3>
             </div>
           </div>

           {/* All tables as draggable items */}
           {effectiveTables.map(table => {
             const pos = positions.get(table.id) || { x: 0, y: 0 };
             return (
               <DraggableTable
                 key={table.id}
                 table={table}
                 position={pos}
                 isSelected={selectedTableId === table.id}
                 hasReservation={hasActiveReservation(table.table_number)}
                 onSelect={() => onSelectTable(table)}
                 readOnly={readOnly}
                 compact={compact}
               />
             );
           })}
         </div>
       </DndContext>
       ```

       **Add position state and drag handler inside VIPFloorPlanAdmin:**
       ```typescript
       const [positions, setPositions] = useState<Map<string, { x: number; y: number }>>(
         new Map(effectiveTables.map(t => [
           t.id,
           { x: t.position_x ?? 0, y: t.position_y ?? 0 }
         ]))
       );

       // Sync positions when tables prop changes
       useEffect(() => {
         setPositions(new Map(effectiveTables.map(t => [
           t.id,
           { x: t.position_x ?? 0, y: t.position_y ?? 0 }
         ])));
       }, [effectiveTables]);

       const handleDragEnd = async (event: DragEndEvent) => {
         if (!onUpdatePosition) return;
         const { active, delta } = event;
         const tableId = active.id as string;
         const currentPos = positions.get(tableId);
         if (!currentPos) return;

         // Convert pixel delta to logical units (container is 100% wide, mapped to 1000 units)
         const container = document.querySelector('[data-floor-plan]') as HTMLElement;
         if (!container) return;
         const rect = container.getBoundingClientRect();
         const deltaX = (delta.x / rect.width) * 1000;
         const deltaY = (delta.y / rect.height) * 700;

         const newX = Math.max(0, Math.min(950, currentPos.x + deltaX));
         const newY = Math.max(0, Math.min(650, currentPos.y + deltaY));

         // Optimistic update
         setPositions(prev => new Map(prev).set(tableId, { x: newX, y: newY }));

         try {
           await onUpdatePosition(tableId, newX, newY);
         } catch {
           // Rollback
           setPositions(prev => new Map(prev).set(tableId, currentPos));
         }
       };
       ```
       Add `data-floor-plan` attribute to the relative container div.

       **Keep the legend/stats section** at the top (unchanged).
       **Keep the SelectedTableInfo section** at the bottom (unchanged).
       **Update the click hint** text: "Drag tables to reposition. Click to edit." (when not readOnly)

    2. Update `VipTablesManagement.tsx` to pass position data and handler:

       - Import `updateTablePosition` from vip-tables-admin-service
       - In the `loadReservations` function where eventVipTables are mapped (around line 729-742), add `position_x` and `position_y` to the mapped table objects:
         ```
         position_x: t.position_x ?? null,
         position_y: t.position_y ?? null,
         ```
       - Add a `handleUpdatePosition` callback:
         ```typescript
         const handleUpdatePosition = async (tableId: string, x: number, y: number) => {
           const result = await updateTablePosition(tableId, { x, y });
           if (!result.success) {
             toast({ variant: 'destructive', title: 'Error', description: 'Failed to save table position' });
             throw new Error(result.error);
           }
         };
         ```
       - Pass `onUpdatePosition={handleUpdatePosition}` to both VIPFloorPlanAdmin instances (the one inside the floor plan tab and any other usage)
  </action>
  <verify>
    - `cd maguey-gate-scanner && npx tsc --noEmit` compiles without errors
    - `cd maguey-gate-scanner && npm run build` builds successfully
    - Grep confirms DndContext usage: `grep -n "DndContext" maguey-gate-scanner/src/components/vip/VIPFloorPlanAdmin.tsx`
    - Grep confirms updateTablePosition import: `grep -n "updateTablePosition" maguey-gate-scanner/src/pages/VipTablesManagement.tsx`
  </verify>
  <done>
    - VIPFloorPlanAdmin renders tables at absolute positions from DB using percentage-based layout
    - Tables are draggable using @dnd-kit/core with transform during drag
    - On drag end, position is saved to DB via updateTablePosition
    - Optimistic updates with rollback on error
    - Floor plan maintains existing visual design (tier colors, reservation rings, stage indicator)
    - VipTablesManagement passes position data and update handler
  </done>
</task>

</tasks>

<verification>
- Migration file creates position_x and position_y columns with backfill
- @dnd-kit/core installed and imported
- VIPFloorPlanAdmin uses DndContext with draggable tables
- updateTablePosition saves coordinates to event_vip_tables
- VipTablesManagement passes onUpdatePosition callback
- Build succeeds: `cd maguey-gate-scanner && npm run build`
</verification>

<success_criteria>
- Owner can drag tables to any position on the floor plan canvas
- Positions persist to database and survive page reload
- Tables without saved positions render at default grid locations
- Existing table functionality (click to select, tier colors, reservation status) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/21-vip-events-polish/21-01-SUMMARY.md`
</output>
