---
phase: 07-ux-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-gate-scanner/package.json
  - maguey-gate-scanner/src/hooks/use-wake-lock.ts
  - maguey-gate-scanner/src/lib/audio-feedback-service.ts
  - maguey-gate-scanner/src/components/scanner/OfflineAcknowledgeModal.tsx
  - maguey-gate-scanner/src/components/scanner/BatteryIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "Scanner screen stays awake during active scanning"
    - "Haptic feedback provides distinct patterns for success vs rejection"
    - "Offline mode requires staff acknowledgment before continuing"
    - "Battery level is visible in scanner UI"
  artifacts:
    - path: "maguey-gate-scanner/src/hooks/use-wake-lock.ts"
      provides: "Screen wake lock management"
      exports: ["useWakeLock"]
    - path: "maguey-gate-scanner/src/components/scanner/OfflineAcknowledgeModal.tsx"
      provides: "Full-screen offline acknowledgment modal"
      exports: ["OfflineAcknowledgeModal"]
    - path: "maguey-gate-scanner/src/components/scanner/BatteryIndicator.tsx"
      provides: "Battery level display for scanner UI"
      exports: ["BatteryIndicator"]
  key_links:
    - from: "audio-feedback-service.ts"
      to: "navigator.vibrate"
      via: "haptic feedback patterns"
      pattern: "navigator\\.vibrate"
    - from: "use-wake-lock.ts"
      to: "react-screen-wake-lock"
      via: "wake lock API wrapper"
      pattern: "useWakeLock.*react-screen-wake-lock"
---

<objective>
Enhance the mobile scanner experience with screen wake lock, distinct haptic patterns, offline acknowledgment modal, and battery indicator.

Purpose: Gate staff scanning in a nightclub environment need the screen to stay awake, clear haptic/audio feedback, and awareness of offline state and battery level. This ensures reliable operation during busy door periods.

Output: useWakeLock hook, enhanced haptic patterns in audio-feedback-service, OfflineAcknowledgeModal component, and BatteryIndicator component.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ux-polish/07-CONTEXT.md
@.planning/phases/07-ux-polish/07-RESEARCH.md
@maguey-gate-scanner/src/lib/audio-feedback-service.ts
@maguey-gate-scanner/src/components/scanner/OfflineBanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-screen-wake-lock and create useWakeLock hook</name>
  <files>
    maguey-gate-scanner/package.json
    maguey-gate-scanner/src/hooks/use-wake-lock.ts
  </files>
  <action>
First, install the react-screen-wake-lock package:
```bash
cd maguey-gate-scanner && npm install react-screen-wake-lock
```

Then create the useWakeLock hook that manages screen wake state:

```typescript
import { useWakeLock as useWakeLockLib } from 'react-screen-wake-lock';
import { useEffect, useCallback } from 'react';

/**
 * Custom wake lock hook that:
 * 1. Requests wake lock on mount when active
 * 2. Releases on unmount
 * 3. Re-acquires when tab becomes visible (per RESEARCH pitfall #3)
 */
export function useWakeLock(isActive: boolean = true) {
  const { isSupported, released, request, release } = useWakeLockLib({
    onRelease: () => console.log('[WakeLock] Released'),
    onError: (err) => console.warn('[WakeLock] Error:', err),
  });

  // Request wake lock when active
  useEffect(() => {
    if (isActive && isSupported) {
      request();
    }
    return () => {
      if (!released) {
        release();
      }
    };
  }, [isActive, isSupported, request, release, released]);

  // Re-acquire on visibility change (tab switch back)
  useEffect(() => {
    const handleVisibility = () => {
      if (document.visibilityState === 'visible' && isActive && isSupported) {
        request();
      }
    };

    document.addEventListener('visibilitychange', handleVisibility);
    return () => document.removeEventListener('visibilitychange', handleVisibility);
  }, [isActive, isSupported, request]);

  return {
    isSupported,
    isLocked: !released,
  };
}
```

This hook will be used in Scanner.tsx to keep the screen awake during scanning.
  </action>
  <verify>
Package installed and hook created:
- `grep "react-screen-wake-lock" maguey-gate-scanner/package.json`
- `ls maguey-gate-scanner/src/hooks/use-wake-lock.ts`
- `grep "useWakeLock" maguey-gate-scanner/src/hooks/use-wake-lock.ts`
  </verify>
  <done>react-screen-wake-lock installed and useWakeLock hook created with visibility change re-acquisition.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance haptic feedback with distinct patterns</name>
  <files>
    maguey-gate-scanner/src/lib/audio-feedback-service.ts
  </files>
  <action>
Update the audio-feedback-service.ts to add distinct haptic patterns per CONTEXT decisions:
- Quick buzz (50ms) for success
- Longer pattern (200ms, 100ms pause, 200ms) for rejection

Add new exported functions:

```typescript
/**
 * Distinct haptic patterns per context decision:
 * - Success: quick buzz (50ms)
 * - Rejection: longer pattern (200, 100, 200)
 * - VIP: triple pulse (50, 30, 50, 30, 50)
 * - Re-entry: double pulse (100, 50, 100)
 */

// Success: Quick buzz (per context: quick buzz for success)
export const hapticSuccess = (): void => {
  const settings = getAudioSettings();
  if (settings.hapticEnabled && navigator.vibrate) {
    navigator.vibrate(50);
  }
};

// Rejection: Longer pattern (per context: longer for rejection)
export const hapticRejection = (): void => {
  const settings = getAudioSettings();
  if (settings.hapticEnabled && navigator.vibrate) {
    navigator.vibrate([200, 100, 200]);
  }
};

// VIP success: Triple pulse pattern
export const hapticVIP = (): void => {
  const settings = getAudioSettings();
  if (settings.hapticEnabled && navigator.vibrate) {
    navigator.vibrate([50, 30, 50, 30, 50]);
  }
};

// Re-entry: Double pulse pattern
export const hapticReentry = (): void => {
  const settings = getAudioSettings();
  if (settings.hapticEnabled && navigator.vibrate) {
    navigator.vibrate([100, 50, 100]);
  }
};
```

Also update the existing playSuccess, playError functions to use these new pattern functions.

Modify playSuccess to call hapticSuccess instead of inline vibration:
```typescript
export const playSuccess = (): void => {
  const settings = getAudioSettings();
  if (settings.soundEnabled) {
    playTone(400, 0.1, settings.volume);
  }
  hapticSuccess(); // Use new function
};

export const playError = (): void => {
  const settings = getAudioSettings();
  if (settings.soundEnabled) {
    playTone(200, 0.2, settings.volume);
  }
  hapticRejection(); // Use new function for consistent rejection pattern
};
```
  </action>
  <verify>
Updated audio-feedback-service.ts:
- `grep -l "hapticSuccess" maguey-gate-scanner/src/lib/audio-feedback-service.ts`
- `grep -l "hapticRejection" maguey-gate-scanner/src/lib/audio-feedback-service.ts`
- `grep -l "hapticVIP" maguey-gate-scanner/src/lib/audio-feedback-service.ts`
- `grep "\[200, 100, 200\]" maguey-gate-scanner/src/lib/audio-feedback-service.ts` (rejection pattern)
  </verify>
  <done>audio-feedback-service.ts exports hapticSuccess, hapticRejection, hapticVIP, hapticReentry with distinct vibration patterns.</done>
</task>

<task type="auto">
  <name>Task 3: Create OfflineAcknowledgeModal and BatteryIndicator</name>
  <files>
    maguey-gate-scanner/src/components/scanner/OfflineAcknowledgeModal.tsx
    maguey-gate-scanner/src/components/scanner/BatteryIndicator.tsx
  </files>
  <action>
Create two scanner-specific components:

**OfflineAcknowledgeModal.tsx** - Full-screen modal when going offline (per context: staff must acknowledge)

```typescript
import { WifiOff } from "lucide-react";
import { Button } from "@/components/ui/button";

interface OfflineAcknowledgeModalProps {
  onAcknowledge: () => void;
}

/**
 * Full-screen offline acknowledgment modal.
 * Per context decision: Staff must acknowledge before continuing to scan.
 * Uses orange background for visibility in dark environment.
 */
export function OfflineAcknowledgeModal({ onAcknowledge }: OfflineAcknowledgeModalProps) {
  return (
    <div className="fixed inset-0 z-[200] bg-orange-500 flex flex-col items-center justify-center p-6">
      <WifiOff className="h-24 w-24 text-white mb-8" />
      <h2 className="text-3xl font-black text-white mb-4 text-center">
        OFFLINE MODE
      </h2>
      <p className="text-white/90 text-lg text-center mb-8 max-w-md">
        Network connection lost. Scans will be queued and synced when connection is restored.
      </p>
      <Button
        onClick={onAcknowledge}
        className="bg-white text-orange-600 hover:bg-white/90 text-lg font-bold px-8 py-6 h-auto min-h-[56px]"
      >
        I Understand - Continue Scanning
      </Button>
    </div>
  );
}
```

**BatteryIndicator.tsx** - Shows battery level in scanner UI (per context: visible battery indicator)

```typescript
import { useState, useEffect } from "react";
import { Battery, BatteryLow, BatteryMedium, BatteryFull, BatteryCharging } from "lucide-react";
import { cn } from "@/lib/utils";

interface BatteryStatus {
  level: number; // 0-1
  charging: boolean;
}

/**
 * Battery indicator for scanner UI.
 * Uses Navigator Battery API (where available).
 * Falls back to hidden state if API not supported.
 */
export function BatteryIndicator() {
  const [battery, setBattery] = useState<BatteryStatus | null>(null);

  useEffect(() => {
    const getBattery = async () => {
      try {
        // Battery API is available on some browsers
        if ('getBattery' in navigator) {
          const batteryManager = await (navigator as any).getBattery();

          const updateBattery = () => {
            setBattery({
              level: batteryManager.level,
              charging: batteryManager.charging,
            });
          };

          updateBattery();
          batteryManager.addEventListener('levelchange', updateBattery);
          batteryManager.addEventListener('chargingchange', updateBattery);

          return () => {
            batteryManager.removeEventListener('levelchange', updateBattery);
            batteryManager.removeEventListener('chargingchange', updateBattery);
          };
        }
      } catch (err) {
        console.warn('[Battery] API not available:', err);
      }
    };

    getBattery();
  }, []);

  if (!battery) return null;

  const percentage = Math.round(battery.level * 100);
  const isLow = percentage <= 20;
  const isMedium = percentage > 20 && percentage <= 50;

  const Icon = battery.charging
    ? BatteryCharging
    : isLow
    ? BatteryLow
    : isMedium
    ? BatteryMedium
    : BatteryFull;

  return (
    <div
      className={cn(
        "flex items-center gap-1 text-xs font-medium",
        isLow && "text-red-500",
        !isLow && !battery.charging && "text-white/70",
        battery.charging && "text-green-500"
      )}
    >
      <Icon className="h-4 w-4" />
      <span>{percentage}%</span>
    </div>
  );
}
```

Both components use 56px+ touch targets and high contrast per context decisions.
  </action>
  <verify>
Components created:
- `ls maguey-gate-scanner/src/components/scanner/OfflineAcknowledgeModal.tsx`
- `ls maguey-gate-scanner/src/components/scanner/BatteryIndicator.tsx`
- `grep "min-h-\[56px\]" maguey-gate-scanner/src/components/scanner/OfflineAcknowledgeModal.tsx` (large touch target)
- `grep "getBattery" maguey-gate-scanner/src/components/scanner/BatteryIndicator.tsx`
  </verify>
  <done>OfflineAcknowledgeModal with full-screen orange overlay and BatteryIndicator with Battery API integration created.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. react-screen-wake-lock is in package.json
2. All 4 files exist and export correctly
3. No TypeScript errors: `cd maguey-gate-scanner && npx tsc --noEmit`
4. Haptic patterns match context decisions (50ms success, 200-100-200 rejection)
</verification>

<success_criteria>
- useWakeLock hook prevents screen sleep during scanning and re-acquires on visibility change
- Haptic feedback has distinct patterns: quick buzz for success, longer pattern for rejection
- OfflineAcknowledgeModal requires staff acknowledgment before continuing
- BatteryIndicator shows battery level when Battery API is available
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-polish/07-03-SUMMARY.md`
</output>
