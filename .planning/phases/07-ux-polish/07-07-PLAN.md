---
phase: 07-ux-polish
plan: 07
type: execute
wave: 2
depends_on: ["07-02", "07-04"]
files_modified:
  - maguey-pass-lounge/src/pages/Checkout.tsx
autonomous: false

must_haves:
  truths:
    - "Checkout shows breadcrumb progress (Tickets > Details > Payment)"
    - "Form data persists for returning visitors"
    - "Step transitions use fade animations"
    - "Error messages use persistent toasts with action buttons"
  artifacts:
    - path: "maguey-pass-lounge/src/pages/Checkout.tsx"
      provides: "Enhanced checkout with stepper, persistence, transitions, and improved errors"
      contains: "CheckoutStepper"
  key_links:
    - from: "Checkout.tsx"
      to: "@/components/checkout/CheckoutStepper"
      via: "progress indicator"
      pattern: "import.*CheckoutStepper"
    - from: "Checkout.tsx"
      to: "@/hooks/use-persisted-form"
      via: "form persistence"
      pattern: "import.*usePersistedForm"
    - from: "Checkout.tsx"
      to: "@/lib/error-messages"
      via: "error handling"
      pattern: "import.*showError"
---

<objective>
Integrate checkout UX enhancements: breadcrumb stepper, form persistence, fade transitions, and improved error handling.

Purpose: Enables customers to complete checkout in under 60 seconds through clear progress, faster form completion (prefilled returning visitor data), smooth transitions, and helpful error recovery.

Output: Checkout.tsx enhanced with CheckoutStepper, usePersistedForm, FadeTransition, and error-messages integration from 07-02 and 07-04.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ux-polish/07-CONTEXT.md
@.planning/phases/07-ux-polish/07-RESEARCH.md
@maguey-pass-lounge/src/pages/Checkout.tsx
@maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx
@maguey-pass-lounge/src/hooks/use-persisted-form.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CheckoutStepper and step management</name>
  <files>
    maguey-pass-lounge/src/pages/Checkout.tsx
  </files>
  <action>
Add the CheckoutStepper component and step state management to Checkout.tsx.

Changes to make:

1. Import CheckoutStepper:
```typescript
import { CheckoutStepper, CHECKOUT_STEPS } from "@/components/checkout/CheckoutStepper";
import { FadeTransition } from "@/components/checkout/FadeTransition";
```

2. Add step state (Checkout.tsx already has some step logic - integrate with it):
```typescript
// Step management: 1=Tickets, 2=Details, 3=Payment
const [checkoutStep, setCheckoutStep] = useState(1);
```

3. Add the stepper at the top of the checkout content:
```tsx
{/* Add after page header, before main content */}
<CheckoutStepper
  currentStep={checkoutStep}
  onStepClick={(step) => {
    // Only allow going back to completed steps
    if (step < checkoutStep) {
      setCheckoutStep(step);
    }
  }}
/>
```

4. Determine step automatically based on state:
- Step 1: Ticket selection (user is choosing tickets)
- Step 2: Customer details (tickets selected, filling form)
- Step 3: Payment (form filled, proceeding to pay)

```typescript
// Auto-advance logic
useEffect(() => {
  const hasSelectedTickets = Object.values(selectedTickets).some(t => t.quantity > 0);

  if (!hasSelectedTickets) {
    setCheckoutStep(1);
  } else if (checkoutStep === 1) {
    // Auto-advance to details when tickets selected
    setCheckoutStep(2);
  }
}, [selectedTickets, checkoutStep]);
```

5. Update payment submit to set step 3:
```typescript
// In form submit handler, before calling payment API:
setCheckoutStep(3);
```
  </action>
  <verify>
Checkout.tsx has stepper:
- `grep "CheckoutStepper" maguey-pass-lounge/src/pages/Checkout.tsx`
- `grep "checkoutStep" maguey-pass-lounge/src/pages/Checkout.tsx`
  </verify>
  <done>Checkout.tsx includes CheckoutStepper showing Tickets > Details > Payment progress with automatic step advancement.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate form persistence and error handling</name>
  <files>
    maguey-pass-lounge/src/pages/Checkout.tsx
  </files>
  <action>
Add form persistence for returning visitors and improved error handling.

Changes to make:

1. Import hooks and utilities:
```typescript
import { usePersistedForm } from "@/hooks/use-persisted-form";
import { showError, showNetworkError } from "@/lib/error-messages";
```

2. Use the persistence hook:
```typescript
const { formData: persistedData, setFormField, hasPersistedData } = usePersistedForm();
```

3. Pre-fill form with persisted data (in addition to user data):
```typescript
// Update the useEffect that pre-fills form
useEffect(() => {
  // Priority: logged-in user > persisted data > empty
  const firstName = userFirstName || persistedData.firstName || '';
  const lastName = userLastName || persistedData.lastName || '';
  const email = userEmail || persistedData.email || '';

  if (firstName) setValue('firstName', firstName);
  if (lastName) setValue('lastName', lastName);
  if (email) setValue('email', email);
}, [user, persistedData, hasPersistedData, setValue, userFirstName, userLastName, userEmail]);
```

4. Persist form changes on successful submission:
```typescript
// In form submit handler, before payment:
setFormField('firstName', data.firstName);
setFormField('lastName', data.lastName);
setFormField('email', data.email);
```

5. Update error handling to use showError:
```typescript
// Replace toast.error calls with showError:
// OLD: toast.error("Something went wrong");
// NEW: showError('generic', { onRetry: () => handleSubmit(onSubmit)() });

// For network errors:
// OLD: toast.error("Network error");
// NEW: showNetworkError(() => handleSubmit(onSubmit)());
```

6. Add a "Welcome back" indicator for returning visitors:
```typescript
{hasPersistedData && !user && (
  <div className="text-sm text-muted-foreground mb-4">
    Welcome back! Your details have been remembered.
  </div>
)}
```
  </action>
  <verify>
Checkout.tsx has persistence and errors:
- `grep "usePersistedForm" maguey-pass-lounge/src/pages/Checkout.tsx`
- `grep "showError" maguey-pass-lounge/src/pages/Checkout.tsx`
- `grep "hasPersistedData" maguey-pass-lounge/src/pages/Checkout.tsx`
  </verify>
  <done>Checkout.tsx persists form data for returning visitors and uses showError for consistent, persistent error toasts.</done>
</task>

<task type="auto">
  <name>Task 3: Add fade transitions between steps</name>
  <files>
    maguey-pass-lounge/src/pages/Checkout.tsx
  </files>
  <action>
Add smooth fade transitions between checkout steps.

Per context decision: "Fade in/out transitions between checkout steps"

Changes to make:

1. Import FadeTransition (if not already):
```typescript
import { FadeTransition } from "@/components/checkout/FadeTransition";
```

2. Wrap each step section with FadeTransition:
```tsx
<div className="relative min-h-[400px]">
  {/* Step 1: Ticket Selection */}
  <FadeTransition show={checkoutStep === 1}>
    <div className="space-y-4">
      {/* Existing ticket selection UI */}
    </div>
  </FadeTransition>

  {/* Step 2: Customer Details */}
  <FadeTransition show={checkoutStep === 2}>
    <div className="space-y-4">
      {/* Existing customer details form */}
    </div>
  </FadeTransition>

  {/* Step 3: Payment */}
  <FadeTransition show={checkoutStep === 3}>
    <div className="space-y-4">
      {/* Existing payment/summary section */}
    </div>
  </FadeTransition>
</div>
```

3. The current Checkout.tsx may not be strictly step-separated. If needed, reorganize into clearer step sections:
   - Step 1 visible: Event info, ticket types, quantity selectors
   - Step 2 visible: Customer form (name, email)
   - Step 3 visible: Order summary, payment button

4. Alternative if full step separation is complex: Use AnimatedStep for simpler enter animations:
```tsx
import { AnimatedStep } from "@/components/checkout/FadeTransition";

{/* Wrap main content area */}
<AnimatedStep key={checkoutStep}>
  {/* Content changes with step, animates in */}
</AnimatedStep>
```

The key is smooth visual transitions when moving between steps, creating a perception of speed.
  </action>
  <verify>
Checkout.tsx has transitions:
- `grep "FadeTransition\|AnimatedStep" maguey-pass-lounge/src/pages/Checkout.tsx`
- `grep "transition\|animate" maguey-pass-lounge/src/pages/Checkout.tsx`
  </verify>
  <done>Checkout.tsx uses fade transitions between checkout steps for smooth UX.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. No TypeScript errors: `cd maguey-pass-lounge && npx tsc --noEmit`
2. Checkout flow has 3 clear steps with progress indicator
3. Form data persists in localStorage (check DevTools > Application > Local Storage)
4. Transitions are smooth between steps
</verification>

<success_criteria>
- CheckoutStepper shows Tickets > Details > Payment with current step highlighted
- Form pre-fills with persisted data for returning visitors
- Step transitions fade smoothly (300ms)
- Error messages persist until dismissed with action buttons
- Complete checkout flow can be completed under 60 seconds (UX-04)
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Checkout UX enhancements: stepper, persistence, transitions, error handling</what-built>
  <how-to-verify>
    1. Open checkout at http://localhost:3016/checkout?event=[valid-event-id]
    2. Verify breadcrumb stepper shows "Tickets > Details > Payment"
    3. Select tickets - verify step advances to "Details"
    4. Fill in name and email
    5. Refresh the page
    6. Verify form is pre-filled with previously entered data
    7. Complete a test purchase
    8. Time the flow - should be completable under 60 seconds
    9. Test error handling: disconnect network during payment
       - Verify error toast persists
       - Verify "Try Again" button works
    10. Verify step transitions are smooth (no jarring jumps)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/07-ux-polish/07-07-SUMMARY.md`
</output>
