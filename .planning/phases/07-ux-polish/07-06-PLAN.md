---
phase: 07-ux-polish
plan: 06
type: execute
wave: 2
depends_on: ["07-03"]
files_modified:
  - maguey-gate-scanner/src/pages/Scanner.tsx
autonomous: false

must_haves:
  truths:
    - "Scanner screen stays awake during active scanning"
    - "Offline mode shows full-screen acknowledgment modal"
    - "Battery indicator visible in scanner navigation"
    - "Haptic feedback distinguishes success from rejection"
  artifacts:
    - path: "maguey-gate-scanner/src/pages/Scanner.tsx"
      provides: "Enhanced scanner with wake lock, offline modal, battery indicator"
      contains: "useWakeLock"
  key_links:
    - from: "Scanner.tsx"
      to: "@/hooks/use-wake-lock"
      via: "screen wake lock hook"
      pattern: "import.*useWakeLock.*from.*use-wake-lock"
    - from: "Scanner.tsx"
      to: "@/components/scanner/OfflineAcknowledgeModal"
      via: "offline acknowledgment"
      pattern: "import.*OfflineAcknowledgeModal"
    - from: "Scanner.tsx"
      to: "@/components/scanner/BatteryIndicator"
      via: "battery status display"
      pattern: "import.*BatteryIndicator"
---

<objective>
Integrate mobile scanner UX enhancements into Scanner.tsx: wake lock, offline acknowledgment modal, battery indicator, and enhanced haptic feedback.

Purpose: Gate staff need the scanner to work reliably in nightclub conditions. Screen must stay awake, offline mode must be explicitly acknowledged, battery level must be visible, and haptic feedback must provide clear success/failure distinction.

Output: Scanner.tsx updated with useWakeLock, OfflineAcknowledgeModal, BatteryIndicator, and enhanced haptic patterns from 07-03.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ux-polish/07-CONTEXT.md
@.planning/phases/07-ux-polish/07-RESEARCH.md
@maguey-gate-scanner/src/pages/Scanner.tsx
@maguey-gate-scanner/src/lib/audio-feedback-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate useWakeLock and BatteryIndicator</name>
  <files>
    maguey-gate-scanner/src/pages/Scanner.tsx
  </files>
  <action>
Update Scanner.tsx to keep screen awake during scanning and show battery level.

Changes to make:

1. Import the new components and hooks:
```typescript
import { useWakeLock } from "@/hooks/use-wake-lock";
import { BatteryIndicator } from "@/components/scanner/BatteryIndicator";
```

2. Add useWakeLock hook at component level (after other hooks):
```typescript
// Keep screen awake while scanner is active
const { isSupported: wakeLockSupported, isLocked } = useWakeLock(
  scanMode === "qr" || scanMode === "nfc" // Active when in scanning mode
);
```

3. Add BatteryIndicator to the top navigation bar (next to sync status):
```tsx
{/* In the top navigation bar, before the sync button */}
<BatteryIndicator />

{/* Or add it to the Sheet header for better visibility */}
<div className="flex items-center gap-2">
  <BatteryIndicator />
  {/* existing sync button */}
</div>
```

4. Optional: Show wake lock status indicator (subtle, only for debugging):
```tsx
{/* In development only, or hidden */}
{process.env.NODE_ENV === 'development' && (
  <span className="text-xs text-white/30">
    {isLocked ? 'Screen locked' : wakeLockSupported ? 'Sleep enabled' : 'No wake lock'}
  </span>
)}
```

The wake lock automatically:
- Activates when scanning mode is QR or NFC
- Re-acquires when tab becomes visible
- Releases when component unmounts or mode changes to manual
  </action>
  <verify>
Scanner.tsx has wake lock and battery:
- `grep "useWakeLock" maguey-gate-scanner/src/pages/Scanner.tsx`
- `grep "BatteryIndicator" maguey-gate-scanner/src/pages/Scanner.tsx`
  </verify>
  <done>Scanner.tsx uses useWakeLock to prevent screen sleep and shows BatteryIndicator in navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Add OfflineAcknowledgeModal integration</name>
  <files>
    maguey-gate-scanner/src/pages/Scanner.tsx
  </files>
  <action>
Add the offline acknowledgment modal that requires staff to confirm before continuing to scan.

Per context decision: "Full overlay when going offline - staff must acknowledge before continuing"

Changes to make:

1. Import the modal:
```typescript
import { OfflineAcknowledgeModal } from "@/components/scanner/OfflineAcknowledgeModal";
```

2. Add state to track acknowledgment:
```typescript
// Track if offline mode has been acknowledged
const [offlineAcknowledged, setOfflineAcknowledged] = useState(false);
```

3. Reset acknowledgment when going back online:
```typescript
// In the online/offline effect, reset acknowledgment:
useEffect(() => {
  const handleOnline = () => {
    setIsOnline(true);
    setOfflineAcknowledged(false); // Reset for next offline event
  };
  const handleOffline = () => setIsOnline(false);
  // ... rest of effect
}, []);
```

4. Show modal when offline and not acknowledged:
```tsx
{/* Add after the existing OfflineBanner, before success/rejection overlays */}
{!isOnline && !offlineAcknowledged && (
  <OfflineAcknowledgeModal
    onAcknowledge={() => setOfflineAcknowledged(true)}
  />
)}
```

5. The modal should appear ABOVE the scanner but BELOW success/rejection overlays (z-index between 100-150).

The flow:
1. User is scanning normally
2. Network drops -> OfflineAcknowledgeModal appears (full screen orange)
3. User taps "I Understand - Continue Scanning"
4. Modal dismisses, OfflineBanner remains visible, scanning continues
5. Network returns -> offlineAcknowledged resets for next time
  </action>
  <verify>
Scanner.tsx has offline modal:
- `grep "OfflineAcknowledgeModal" maguey-gate-scanner/src/pages/Scanner.tsx`
- `grep "offlineAcknowledged" maguey-gate-scanner/src/pages/Scanner.tsx`
  </verify>
  <done>Scanner.tsx shows OfflineAcknowledgeModal when offline, requires acknowledgment before continuing.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate enhanced haptic feedback</name>
  <files>
    maguey-gate-scanner/src/pages/Scanner.tsx
  </files>
  <action>
Update Scanner.tsx to use the distinct haptic patterns for success vs rejection.

Changes to make:

1. Import the new haptic functions:
```typescript
import {
  playSuccess,
  playError,
  playTierSuccess,
  hapticSuccess,
  hapticRejection,
  hapticVIP,
  hapticReentry,
} from "@/lib/audio-feedback-service";
```

2. In the processScan function, add haptic feedback after setting scan state:

For success scans:
```typescript
if (result.success) {
  // Existing code...
  setScanState({ status: isReentry ? "reentry" : "success", ... });

  // Add haptic feedback based on type
  if (isReentry) {
    hapticReentry(); // Double pulse for re-entry
  } else if (vipLinkInfo.isVipGuest || result.vipInfo) {
    hapticVIP(); // Triple pulse for VIP
  } else {
    hapticSuccess(); // Quick buzz for regular success
  }
  // ...existing code
}
```

For failure scans:
```typescript
} else if (result.alreadyScanned) {
  // Existing code...
  setScanState({ status: "already_scanned", ... });
  hapticRejection(); // Longer pattern for rejection
} else {
  // Existing code...
  setScanState({ status: "error", ... });
  hapticRejection(); // Longer pattern for rejection
}
```

3. Also add haptic for offline scan results:
```typescript
// In offline scan section
if (result.success) {
  // ...
  hapticSuccess();
} else {
  // ...
  hapticRejection();
}
```

The haptic patterns distinguish:
- Success: Quick 50ms buzz
- VIP: Triple pulse (50-30-50-30-50)
- Re-entry: Double pulse (100-50-100)
- Rejection: Long pattern (200-100-200)
  </action>
  <verify>
Scanner.tsx has haptic integration:
- `grep "hapticSuccess" maguey-gate-scanner/src/pages/Scanner.tsx`
- `grep "hapticRejection" maguey-gate-scanner/src/pages/Scanner.tsx`
- `grep "hapticVIP" maguey-gate-scanner/src/pages/Scanner.tsx`
- `grep "hapticReentry" maguey-gate-scanner/src/pages/Scanner.tsx`
  </verify>
  <done>Scanner.tsx calls distinct haptic patterns for success, VIP, re-entry, and rejection scan results.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. No TypeScript errors: `cd maguey-gate-scanner && npx tsc --noEmit`
2. All imports resolve correctly
3. Haptic patterns match context decisions (quick buzz for success, longer for rejection)
</verification>

<success_criteria>
- Scanner screen stays awake during QR/NFC scanning mode
- Battery indicator visible in scanner navigation
- Offline mode shows full-screen acknowledgment modal before allowing continued scanning
- Haptic feedback clearly distinguishes success (quick buzz) from rejection (longer pattern)
- VIP and re-entry have distinct haptic patterns
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Mobile scanner UX enhancements: wake lock, offline modal, battery indicator, haptic feedback</what-built>
  <how-to-verify>
    1. Open scanner at http://localhost:3015/scanner on mobile device (or Chrome DevTools mobile emulation)
    2. Verify screen stays awake during QR scanning (wait 30+ seconds)
    3. Check battery indicator appears in navigation
    4. Turn on airplane mode:
       - Verify full-screen orange "OFFLINE MODE" modal appears
       - Tap "I Understand - Continue Scanning"
       - Verify modal dismisses, scanning continues with offline banner
    5. Turn off airplane mode, verify acknowledgment resets
    6. On Android device, scan tickets and verify:
       - Success: Quick buzz
       - VIP: Triple pulse
       - Rejection: Longer vibration pattern
    7. Note: Haptic may not work on iOS Safari
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/07-ux-polish/07-06-SUMMARY.md`
</output>
