---
phase: 07-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/src/lib/payment-errors.ts
  - maguey-pass-lounge/src/lib/error-messages.ts
  - maguey-gate-scanner/src/lib/error-messages.ts
  - maguey-nights/src/lib/error-messages.ts
autonomous: true

must_haves:
  truths:
    - "Error messages use professional/formal tone without technical jargon"
    - "All error toasts include at least one action button"
    - "Error toasts persist until user dismisses them"
  artifacts:
    - path: "maguey-pass-lounge/src/lib/error-messages.ts"
      provides: "Centralized user-friendly error messages and showError utility"
      exports: ["ERROR_MESSAGES", "showError", "showNetworkError", "showValidationError"]
    - path: "maguey-pass-lounge/src/lib/payment-errors.ts"
      provides: "Updated payment error handling with persistent toasts"
      exports: ["handlePaymentError"]
  key_links:
    - from: "error-messages.ts"
      to: "sonner"
      via: "toast function for notifications"
      pattern: "import.*toast.*from.*sonner"
    - from: "payment-errors.ts"
      to: "error-messages.ts"
      via: "uses showError for consistency"
      pattern: "import.*showError.*from.*error-messages"
---

<objective>
Create centralized error message utilities that display user-friendly, persistent toasts with recovery actions.

Purpose: Ensures all error messages follow the professional/formal tone decision, always include action buttons, and persist until dismissed. Eliminates technical jargon from user-facing errors.

Output: error-messages.ts utility in all three apps, updated payment-errors.ts with persistent toast behavior.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ux-polish/07-CONTEXT.md
@.planning/phases/07-ux-polish/07-RESEARCH.md
@maguey-pass-lounge/src/lib/payment-errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error-messages.ts utility</name>
  <files>
    maguey-pass-lounge/src/lib/error-messages.ts
    maguey-gate-scanner/src/lib/error-messages.ts
    maguey-nights/src/lib/error-messages.ts
  </files>
  <action>
Create a centralized error message utility that handles all user-facing errors.

Per CONTEXT.md decisions:
- Professional/formal tone
- Always include action buttons (every error has at least one recovery action)
- Display as toast notifications
- Errors persist until dismissed (duration: Infinity)

Implementation:
```typescript
import { toast } from "sonner";

// Error message catalog - professional/formal tone (per context decision)
export const ERROR_MESSAGES = {
  // Network errors
  network_offline: "Unable to connect. Please check your internet connection.",
  network_timeout: "The request timed out. Please try again.",
  network_error: "A connection error occurred. Please try again.",

  // Payment errors
  payment_failed: "Payment could not be processed. Please check your card details and try again.",
  payment_declined: "Your card was declined. Please try a different payment method.",
  payment_expired: "Your session has expired. Please start again.",

  // Validation errors
  validation_error: "Please review the form for errors.",
  invalid_input: "The information provided is invalid. Please check and try again.",

  // Auth errors
  auth_failed: "Sign in failed. Please check your credentials.",
  session_expired: "Your session has expired. Please sign in again.",

  // Scanner errors
  scan_failed: "Unable to process scan. Please try again.",
  ticket_not_found: "Ticket not found. Please verify the code.",

  // Generic fallback
  generic: "An error occurred. Please contact support if this persists.",
} as const;

type ErrorType = keyof typeof ERROR_MESSAGES;

interface ShowErrorOptions {
  onRetry?: () => void;
  onDismiss?: () => void;
  supportEmail?: string;
}

/**
 * Show user-friendly error toast with action button.
 * Per context decisions:
 * - duration: Infinity (persist until dismissed)
 * - Always include action button
 * - closeButton: true
 */
export function showError(
  type: ErrorType | string,
  options: ShowErrorOptions = {}
) {
  const message = ERROR_MESSAGES[type as ErrorType] || ERROR_MESSAGES.generic;
  const { onRetry, supportEmail = "support@maguey.com" } = options;

  toast.error(message, {
    duration: Infinity, // Persist until dismissed (per context decision)
    closeButton: true,
    action: onRetry
      ? {
          label: "Try Again",
          onClick: onRetry,
        }
      : {
          label: "Contact Support",
          onClick: () => window.location.href = `mailto:${supportEmail}`,
        },
  });
}

/**
 * Shorthand for network errors
 */
export function showNetworkError(onRetry?: () => void) {
  showError(navigator.onLine ? "network_error" : "network_offline", { onRetry });
}

/**
 * Shorthand for validation errors
 */
export function showValidationError() {
  showError("validation_error");
}
```

Create identical implementation in all three apps.
  </action>
  <verify>
Files exist with correct exports:
- `grep -l "ERROR_MESSAGES" maguey-pass-lounge/src/lib/error-messages.ts`
- `grep "duration: Infinity" maguey-pass-lounge/src/lib/error-messages.ts`
- `grep -l "showError" maguey-gate-scanner/src/lib/error-messages.ts`
- `grep -l "showError" maguey-nights/src/lib/error-messages.ts`
  </verify>
  <done>error-messages.ts exists in all three apps with ERROR_MESSAGES catalog, showError utility with persistent toasts, and action buttons.</done>
</task>

<task type="auto">
  <name>Task 2: Update payment-errors.ts for persistent toasts</name>
  <files>
    maguey-pass-lounge/src/lib/payment-errors.ts
  </files>
  <action>
Update the existing payment-errors.ts to use persistent toasts and integrate with the new error-messages utility.

Changes needed:
1. Change `duration: 5000` to `duration: Infinity` (per context decision: errors persist until dismissed)
2. Import and use showError from error-messages.ts for consistency
3. Keep the existing error categorization logic
4. Maintain backward compatibility with existing API

Updated handlePaymentError function:
```typescript
import { showError } from "./error-messages";

// ... keep existing PaymentErrorType and categorizeError ...

// Update USER_MESSAGES to use ERROR_MESSAGES keys
const ERROR_TYPE_MAP: Record<PaymentErrorType, string> = {
  card_declined: 'payment_declined',
  insufficient_funds: 'payment_declined',
  expired_card: 'payment_expired',
  processing_error: 'payment_failed',
  network_error: 'network_error',
  unknown: 'payment_failed',
};

export function handlePaymentError(
  error: Error | unknown,
  options: HandlePaymentErrorOptions
) {
  const { onRetry, setIsLoading, customerEmail, paymentType, eventId } = options;
  const errorType = categorizeError(error);
  const errorMessageKey = ERROR_TYPE_MAP[errorType];

  // Log error for debugging
  console.error('[Payment Error]', {
    type: errorType,
    paymentType,
    eventId,
    customerEmail: customerEmail ? `${customerEmail.slice(0, 3)}...` : undefined,
    timestamp: new Date().toISOString(),
    rawError: error instanceof Error ? error.message : String(error),
  });

  // Show persistent error toast with retry action
  showError(errorMessageKey, {
    onRetry: () => {
      setIsLoading(true);
      onRetry();
    },
  });
}
```

The key changes:
- Uses showError which has `duration: Infinity`
- Consistent with other error handling in the app
- Maintains retry callback behavior
  </action>
  <verify>
Updated payment-errors.ts:
- `grep "import.*showError" maguey-pass-lounge/src/lib/payment-errors.ts`
- `grep "ERROR_TYPE_MAP" maguey-pass-lounge/src/lib/payment-errors.ts`
- No remaining `duration: 5000` references: `grep -c "duration: 5000" maguey-pass-lounge/src/lib/payment-errors.ts` returns 0
  </verify>
  <done>payment-errors.ts updated to use showError utility with persistent toasts, integrated with ERROR_TYPE_MAP for consistent messaging.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. All 4 files exist and export correctly
2. No TypeScript errors: `cd maguey-pass-lounge && npx tsc --noEmit`
3. Error toasts use `duration: Infinity`
4. All error handling includes action buttons
</verification>

<success_criteria>
- All error messages use professional/formal tone from ERROR_MESSAGES catalog
- Error toasts persist until dismissed (duration: Infinity)
- Every error toast includes at least one action button (Try Again or Contact Support)
- payment-errors.ts integrates with new error-messages utility
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-polish/07-02-SUMMARY.md`
</output>
