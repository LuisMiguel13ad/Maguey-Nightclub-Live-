---
phase: 07-ux-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx
  - maguey-pass-lounge/src/hooks/use-persisted-form.ts
  - maguey-pass-lounge/src/components/checkout/FadeTransition.tsx
autonomous: true

must_haves:
  truths:
    - "Checkout shows breadcrumb progress indicator (Tickets > Details > Payment)"
    - "Form data persists in localStorage for returning visitors"
    - "Step transitions use fade in/out animations"
  artifacts:
    - path: "maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx"
      provides: "Breadcrumb progress indicator for checkout"
      exports: ["CheckoutStepper"]
    - path: "maguey-pass-lounge/src/hooks/use-persisted-form.ts"
      provides: "localStorage form persistence hook"
      exports: ["usePersistedForm"]
    - path: "maguey-pass-lounge/src/components/checkout/FadeTransition.tsx"
      provides: "Fade transition wrapper for step changes"
      exports: ["FadeTransition"]
  key_links:
    - from: "CheckoutStepper.tsx"
      to: "@/components/ui/breadcrumb"
      via: "shadcn breadcrumb component"
      pattern: "import.*Breadcrumb.*from.*@/components/ui/breadcrumb"
    - from: "use-persisted-form.ts"
      to: "localStorage"
      via: "persistent state storage"
      pattern: "localStorage\\.(getItem|setItem)"
---

<objective>
Create checkout flow UX enhancements: breadcrumb progress indicator, form persistence, and fade transitions between steps.

Purpose: Enables customers to complete checkout in under 60 seconds through clear progress indication, faster form completion (prefilled data for returning visitors), and smooth transitions that create perception of speed.

Output: CheckoutStepper component, usePersistedForm hook, and FadeTransition wrapper.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ux-polish/07-CONTEXT.md
@.planning/phases/07-ux-polish/07-RESEARCH.md
@maguey-pass-lounge/src/pages/Checkout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CheckoutStepper breadcrumb component</name>
  <files>
    maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx
  </files>
  <action>
Create a breadcrumb-based checkout progress indicator using shadcn/ui Breadcrumb.

First, ensure Breadcrumb component exists:
```bash
cd maguey-pass-lounge && npx shadcn@latest add breadcrumb --yes 2>/dev/null || echo "Already exists"
```

Then create CheckoutStepper.tsx:

```typescript
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { Check } from "lucide-react";
import { cn } from "@/lib/utils";

const CHECKOUT_STEPS = [
  { id: 1, label: "Tickets" },
  { id: 2, label: "Details" },
  { id: 3, label: "Payment" },
] as const;

interface CheckoutStepperProps {
  currentStep: number; // 1, 2, or 3
  onStepClick?: (step: number) => void; // Optional: allow clicking completed steps
}

/**
 * Breadcrumb progress indicator for checkout flow.
 * Per context decision: "Breadcrumb trail progress indicator (Tickets > Details > Payment)"
 */
export function CheckoutStepper({ currentStep, onStepClick }: CheckoutStepperProps) {
  return (
    <Breadcrumb className="mb-6">
      <BreadcrumbList>
        {CHECKOUT_STEPS.map((step, index) => {
          const isCompleted = step.id < currentStep;
          const isCurrent = step.id === currentStep;
          const isUpcoming = step.id > currentStep;

          return (
            <BreadcrumbItem key={step.id}>
              {isCompleted ? (
                <BreadcrumbLink
                  href="#"
                  onClick={(e) => {
                    e.preventDefault();
                    onStepClick?.(step.id);
                  }}
                  className="flex items-center gap-1 text-green-600 hover:text-green-500"
                >
                  <Check className="h-4 w-4" />
                  {step.label}
                </BreadcrumbLink>
              ) : isCurrent ? (
                <BreadcrumbPage className="font-semibold">
                  {step.label}
                </BreadcrumbPage>
              ) : (
                <span className="text-muted-foreground">{step.label}</span>
              )}
              {index < CHECKOUT_STEPS.length - 1 && <BreadcrumbSeparator />}
            </BreadcrumbItem>
          );
        })}
      </BreadcrumbList>
    </Breadcrumb>
  );
}

export { CHECKOUT_STEPS };
```

The stepper shows:
- Green checkmark for completed steps (clickable to go back)
- Bold text for current step
- Muted text for upcoming steps
  </action>
  <verify>
Component created:
- `ls maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx`
- `grep "CHECKOUT_STEPS" maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx`
- `grep "Breadcrumb" maguey-pass-lounge/src/components/checkout/CheckoutStepper.tsx`
  </verify>
  <done>CheckoutStepper component created with Tickets > Details > Payment breadcrumb trail, completed step indicators, and optional step navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Create usePersistedForm hook</name>
  <files>
    maguey-pass-lounge/src/hooks/use-persisted-form.ts
  </files>
  <action>
Create a hook that persists form state to localStorage for returning visitors.

Per context decisions:
- Remember returning visitor info (name, email) in localStorage for prefill
- Handle quota exceeded errors gracefully (per RESEARCH pitfall #4)

```typescript
import { useState, useCallback, useEffect } from "react";

const STORAGE_KEY = "maguey_checkout_form";

interface CheckoutFormData {
  firstName: string;
  lastName: string;
  email: string;
  phone?: string;
}

interface UsePersistedFormReturn {
  formData: Partial<CheckoutFormData>;
  setFormField: <K extends keyof CheckoutFormData>(
    field: K,
    value: CheckoutFormData[K]
  ) => void;
  clearForm: () => void;
  hasPersistedData: boolean;
}

/**
 * Persists checkout form data to localStorage for returning visitors.
 * Per context decision: Remember name/email for faster checkout.
 *
 * Handles quota exceeded errors gracefully per RESEARCH pitfall #4.
 */
export function usePersistedForm(): UsePersistedFormReturn {
  const [formData, setFormData] = useState<Partial<CheckoutFormData>>(() => {
    if (typeof window === "undefined") return {};

    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const parsed = JSON.parse(saved);
        // Only restore specific fields (not phone for privacy)
        return {
          firstName: parsed.firstName || "",
          lastName: parsed.lastName || "",
          email: parsed.email || "",
        };
      }
    } catch (err) {
      console.warn("[usePersistedForm] Failed to load:", err);
    }
    return {};
  });

  const [hasPersistedData] = useState(() => {
    if (typeof window === "undefined") return false;
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved !== null && saved !== "{}";
    } catch {
      return false;
    }
  });

  // Persist changes to localStorage
  const persistToStorage = useCallback((data: Partial<CheckoutFormData>) => {
    try {
      // Only persist essential fields (name, email) - not phone
      const toPersist = {
        firstName: data.firstName,
        lastName: data.lastName,
        email: data.email,
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toPersist));
    } catch (err) {
      // Quota exceeded - silently fail (per RESEARCH pitfall #4)
      console.warn("[usePersistedForm] Failed to persist:", err);
    }
  }, []);

  const setFormField = useCallback(
    <K extends keyof CheckoutFormData>(field: K, value: CheckoutFormData[K]) => {
      setFormData((prev) => {
        const next = { ...prev, [field]: value };
        persistToStorage(next);
        return next;
      });
    },
    [persistToStorage]
  );

  const clearForm = useCallback(() => {
    setFormData({});
    try {
      localStorage.removeItem(STORAGE_KEY);
    } catch {
      // Ignore errors
    }
  }, []);

  return {
    formData,
    setFormField,
    clearForm,
    hasPersistedData,
  };
}
```

Usage in Checkout.tsx:
```typescript
const { formData, setFormField, hasPersistedData } = usePersistedForm();

// Pre-fill form with persisted data
useEffect(() => {
  if (hasPersistedData) {
    setValue('firstName', formData.firstName || '');
    setValue('lastName', formData.lastName || '');
    setValue('email', formData.email || '');
  }
}, [hasPersistedData, formData, setValue]);
```
  </action>
  <verify>
Hook created:
- `ls maguey-pass-lounge/src/hooks/use-persisted-form.ts`
- `grep "usePersistedForm" maguey-pass-lounge/src/hooks/use-persisted-form.ts`
- `grep "localStorage" maguey-pass-lounge/src/hooks/use-persisted-form.ts`
- `grep "maguey_checkout_form" maguey-pass-lounge/src/hooks/use-persisted-form.ts`
  </verify>
  <done>usePersistedForm hook created with localStorage persistence, quota error handling, and field-level updates.</done>
</task>

<task type="auto">
  <name>Task 3: Create FadeTransition component</name>
  <files>
    maguey-pass-lounge/src/components/checkout/FadeTransition.tsx
  </files>
  <action>
Create a fade transition wrapper for smooth step changes.

Per context decision: "Fade in/out transitions between checkout steps"

```typescript
import { ReactNode } from "react";
import { cn } from "@/lib/utils";

interface FadeTransitionProps {
  show: boolean;
  children: ReactNode;
  className?: string;
  duration?: number; // in ms, default 300
}

/**
 * Fade transition wrapper for checkout step changes.
 * Per context decision: "Fade in/out transitions between checkout steps"
 *
 * Uses CSS transitions for smooth, GPU-accelerated animations.
 * The transition uses opacity + pointer-events for accessibility.
 */
export function FadeTransition({
  show,
  children,
  className,
  duration = 300,
}: FadeTransitionProps) {
  return (
    <div
      className={cn(
        "transition-opacity ease-in-out",
        show ? "opacity-100" : "opacity-0 pointer-events-none absolute inset-0",
        className
      )}
      style={{ transitionDuration: `${duration}ms` }}
      aria-hidden={!show}
    >
      {children}
    </div>
  );
}

/**
 * Alternative: Use tailwindcss-animate classes directly
 * This is a convenience wrapper that matches the project's existing animation patterns.
 */
export function AnimatedStep({
  children,
  className,
}: {
  children: ReactNode;
  className?: string;
}) {
  return (
    <div
      className={cn(
        "animate-in fade-in duration-300",
        className
      )}
    >
      {children}
    </div>
  );
}
```

Also create an index export for the checkout components folder:
```typescript
// src/components/checkout/index.ts
export { CheckoutStepper, CHECKOUT_STEPS } from "./CheckoutStepper";
export { FadeTransition, AnimatedStep } from "./FadeTransition";
```

Usage pattern:
```tsx
<div className="relative">
  <FadeTransition show={step === 1}>
    <TicketSelection />
  </FadeTransition>
  <FadeTransition show={step === 2}>
    <CustomerDetails />
  </FadeTransition>
  <FadeTransition show={step === 3}>
    <PaymentForm />
  </FadeTransition>
</div>
```
  </action>
  <verify>
Component created:
- `ls maguey-pass-lounge/src/components/checkout/FadeTransition.tsx`
- `grep "FadeTransition" maguey-pass-lounge/src/components/checkout/FadeTransition.tsx`
- `grep "transition-opacity" maguey-pass-lounge/src/components/checkout/FadeTransition.tsx`
  </verify>
  <done>FadeTransition and AnimatedStep components created with smooth opacity transitions and accessibility handling.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. All 3+ files exist in checkout components directory
2. Breadcrumb component is available (shadcn added if needed)
3. No TypeScript errors: `cd maguey-pass-lounge && npx tsc --noEmit`
4. localStorage key follows naming convention (maguey_checkout_form)
</verification>

<success_criteria>
- CheckoutStepper shows Tickets > Details > Payment with completion states
- usePersistedForm loads/saves form data from localStorage
- FadeTransition provides smooth 300ms opacity transitions
- All components follow existing project conventions
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-polish/07-04-SUMMARY.md`
</output>
