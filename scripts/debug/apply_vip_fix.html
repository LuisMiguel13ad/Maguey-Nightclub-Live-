<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply VIP Fix - Maguey Nightclub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #121212;
      color: #ffffff;
      padding: 40px;
      line-height: 1.6;
      background-image: radial-gradient(circle at 50% 0%, #1a3223 0%, #121212 70%);
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      color: #39B54A;
      margin-bottom: 8px;
      font-weight: 900;
      letter-spacing: -1px;
    }

    .subtitle {
      color: #888;
      margin-bottom: 40px;
      font-size: 1.1rem;
    }

    .step {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 30px;
      margin: 24px 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }

    .step h2 {
      color: #39B54A;
      margin-bottom: 16px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .step h2 span {
      background: #39B54A;
      color: #121212;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      rounded: 50%;
      font-size: 0.9rem;
      border-radius: 50%;
    }

    .sql-container {
      background: #000;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      position: relative;
      border: 1px solid #333;
    }

    .sql-container textarea {
      width: 100%;
      min-height: 450px;
      background: transparent;
      color: #ddd;
      border: none;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      padding: 10px;
      outline: none;
    }

    .copy-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #39B54A;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(57, 181, 74, 0.3);
    }

    .copy-btn:hover {
      background: #2d963d;
      transform: translateY(-2px);
    }

    .copy-btn.copied {
      background: #fff;
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }

    .link {
      color: #39B54A;
      text-decoration: none;
      border-bottom: 1px solid rgba(57, 181, 74, 0.3);
      padding-bottom: 2px;
      transition: all 0.2s;
    }

    .link:hover {
      border-bottom-color: #39B54A;
    }

    code {
      background: rgba(255, 255, 255, 0.1);
      padding: 3px 8px;
      border-radius: 6px;
      font-family: monospace;
      color: #39B54A;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .badge-green {
      background: rgba(57, 181, 74, 0.1);
      color: #39B54A;
      border: 1px solid rgba(57, 181, 74, 0.2);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="badge badge-green">Database Fix - Robust Version</div>
    <h1>Sync & Apply VIP Migration</h1>
    <p class="subtitle">This tool will help you sync your migration history and apply the VIP race condition fixes,
      including schema repairs for missing columns.</p>

    <div class="step">
      <h2><span>1</span> Open Supabase SQL Editor</h2>
      <p>Go to your project dashboard: <a href="https://supabase.com/dashboard/project/djbzjasdrwvbsoifxqzd/sql/new"
          target="_blank" class="link">Supabase SQL Editor - New Query</a></p>
      <p style="margin-top: 8px;">Make sure you are logged in to your Supabase account.</p>
    </div>

    <div class="step">
      <h2><span>2</span> Copy & Paste SQL</h2>
      <p>Click the button below to copy the combined fix SQL, then paste it into the editor.</p>
      <div class="sql-container">
        <button class="copy-btn" onclick="copySQL()">ðŸ“‹ Copy SQL</button>
        <textarea id="sql" readonly>-- ============================================================================
-- STEP 1: Sync migration history
-- This marks all previous migrations as already applied so Supabase CLI
-- won't try to re-apply them
-- ============================================================================

-- Create the schema_migrations table if it doesn't exist
CREATE TABLE IF NOT EXISTS supabase_migrations.schema_migrations (
  version TEXT PRIMARY KEY,
  statements TEXT[],
  name TEXT
);

-- Insert all previous migrations as already applied
INSERT INTO supabase_migrations.schema_migrations (version, name)
VALUES
  ('20250115000000', '20250115000000_create_ticket_system.sql'),
  ('20250115000001', '20250115000001_add_event_image_to_tickets.sql'),
  ('20250115000002', '20250115000002_seed_events.sql'),
  ('20250115000003', '20250115000003_fix_rls_for_public_purchases.sql'),
  ('20250115000004', '20250115000004_add_inventory_protection.sql'),
  ('20250201000000', '20250201000000_add_rls_policies.sql'),
  ('20250201001000', '20250201001000_create_promotions_table.sql'),
  ('20250202000000', '20250202000000_add_scanner_compatibility_fields.sql'),
  ('20250301090000', '20250301090000_update_tickets_add_security_columns.sql'),
  ('20250302000000', '20250302000000_add_ticket_categories.sql'),
  ('20250302000001', '20250302000001_update_scanner_view_categories.sql'),
  ('20250303000000', '20250303000000_add_event_status.sql'),
  ('20250303000001', '20250303000001_add_promo_code_tracking.sql'),
  ('20250303000002', '20250303000002_create_user_loyalty.sql'),
  ('20250320000000', '20250320000000_auth_enhancements.sql'),
  ('20250322000000', '20250322000000_organizer_reservations.sql'),
  ('20250323000000', '20250323000000_fix_inventory_race_condition.sql'),
  ('20250324000000', '20250324000000_create_order_transaction.sql'),
  ('20250325000000', '20250325000000_add_webhook_idempotency.sql'),
  ('20250326000000', '20250326000000_add_performance_indexes.sql'),
  ('20250610000000', '20250610000000_create_vip_tables_system.sql'),
  ('20250611000000', '20250611000000_saga_executions.sql'),
  ('20250612000000', '20250612000000_ticket_events.sql'),
  ('20250613000000', '20250613000000_query_optimization.sql'),
  ('20250619000000', '20250619000000_create_event_vip_tables.sql'),
  ('20250621000000', '20250621000000_distributed_traces.sql'),
  ('20250622000000', '20250622000000_error_tracking.sql'),
  ('20250623000000', '20250623000000_guest_lists.sql'),
  ('20251219000000', '20251219000000_backfill_vip_tables.sql'),
  ('20251219100000', '20251219100000_add_vip_config_to_events.sql')
ON CONFLICT (version) DO NOTHING;

-- ============================================================================
-- STEP 1.5: Schema Repair (Add missing columns if needed)
-- This ensures the tables have the columns expected by the functions below
-- ============================================================================

-- Fix vip_reservations columns
DO $$
BEGIN
  BEGIN
    ALTER TABLE vip_reservations ADD COLUMN IF NOT EXISTS qr_code_token TEXT;
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_reservations ADD COLUMN IF NOT EXISTS checked_in_guests INTEGER DEFAULT 0;
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_reservations ADD COLUMN IF NOT EXISTS checked_in_at TIMESTAMPTZ;
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_reservations ADD COLUMN IF NOT EXISTS package_snapshot JSONB;
  EXCEPTION WHEN OTHERS THEN NULL; END;
END $$;

-- Fix vip_guest_passes columns
DO $$
BEGIN
  BEGIN
    ALTER TABLE vip_guest_passes ADD COLUMN IF NOT EXISTS qr_code_token TEXT;
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_guest_passes ADD COLUMN IF NOT EXISTS qr_signature TEXT;
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_guest_passes ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'issued';
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_guest_passes ADD COLUMN IF NOT EXISTS checked_in_at TIMESTAMPTZ;
  EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN
    ALTER TABLE vip_guest_passes ADD COLUMN IF NOT EXISTS checked_in_by TEXT;
  EXCEPTION WHEN OTHERS THEN NULL; END;
END $$;

-- ============================================================================
-- STEP 2: Apply the VIP Race Condition and RLS Fix
-- ============================================================================

-- 1. ATOMIC RESERVATION FUNCTION
CREATE OR REPLACE FUNCTION create_vip_reservation_atomic(
  p_event_id VARCHAR,
  p_table_id UUID,
  p_purchaser_name VARCHAR,
  p_purchaser_email VARCHAR,
  p_purchaser_phone VARCHAR DEFAULT NULL,
  p_guest_count INTEGER DEFAULT 6,
  p_bottle_choice VARCHAR DEFAULT NULL,
  p_special_requests TEXT DEFAULT NULL,
  p_is_walk_in BOOLEAN DEFAULT FALSE
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_table RECORD;
  v_existing_reservation UUID;
  v_reservation_id UUID;
  v_qr_code_token VARCHAR;
  v_price_cents INTEGER;
  v_result JSON;
  v_pass_token VARCHAR;
  v_pass_signature VARCHAR;
  v_passes JSON[];
  i INTEGER;
BEGIN
  -- Lock the table row to prevent concurrent bookings
  SELECT * INTO v_table
  FROM event_vip_tables
  WHERE id = p_table_id
    AND event_id = p_event_id
    AND is_active = TRUE
  FOR UPDATE;

  IF NOT FOUND THEN
    RETURN json_build_object(
      'success', FALSE,
      'error', 'TABLE_NOT_FOUND',
      'message', 'Table not found or not active for this event'
    );
  END IF;

  IF NOT v_table.is_available THEN
    RETURN json_build_object(
      'success', FALSE,
      'error', 'TABLE_NOT_AVAILABLE',
      'message', 'This table is no longer available'
    );
  END IF;

  SELECT id INTO v_existing_reservation
  FROM vip_reservations
  WHERE event_id = p_event_id
    AND event_vip_table_id = p_table_id
    AND status IN ('pending', 'confirmed', 'checked_in')
  LIMIT 1;

  IF v_existing_reservation IS NOT NULL THEN
    RETURN json_build_object(
      'success', FALSE,
      'error', 'TABLE_ALREADY_RESERVED',
      'message', 'This table already has an active reservation'
    );
  END IF;

  IF p_guest_count > v_table.capacity THEN
    RETURN json_build_object(
      'success', FALSE,
      'error', 'EXCEEDS_CAPACITY',
      'message', format('This table has a maximum capacity of %s guests', v_table.capacity)
    );
  END IF;

  v_qr_code_token := 'VIP-' || upper(substring(gen_random_uuid()::text, 1, 12));
  v_price_cents := round(v_table.price * 100)::INTEGER;

  INSERT INTO vip_reservations (
    event_id, event_vip_table_id, table_number, purchaser_name, purchaser_email,
    purchaser_phone, amount_paid_cents, status, qr_code_token, package_snapshot,
    special_requests, disclaimer_accepted_at, refund_policy_accepted_at, checked_in_guests
  ) VALUES (
    p_event_id, p_table_id, v_table.table_number, p_purchaser_name, p_purchaser_email,
    p_purchaser_phone, v_price_cents,
    CASE WHEN p_is_walk_in THEN 'confirmed' ELSE 'pending' END,
    v_qr_code_token,
    jsonb_build_object(
      'tier', v_table.tier, 'tableNumber', v_table.table_number,
      'guestCount', p_guest_count, 'price', v_table.price,
      'displayName', v_table.table_name, 'bottleChoice', p_bottle_choice,
      'specialRequests', p_special_requests,
      'firstName', split_part(p_purchaser_name, ' ', 1),
      'lastName', substring(p_purchaser_name from position(' ' in p_purchaser_name) + 1),
      'isWalkIn', p_is_walk_in
    ),
    p_special_requests, NOW(), NOW(), 0
  )
  RETURNING id INTO v_reservation_id;

  v_passes := ARRAY[]::JSON[];
  FOR i IN 1..p_guest_count LOOP
    v_pass_token := 'VIP-PASS-' || upper(substring(gen_random_uuid()::text, 1, 8));
    v_pass_signature := encode(sha256((v_pass_token || v_reservation_id::text || i::text)::bytea), 'hex');

    INSERT INTO vip_guest_passes (reservation_id, guest_number, qr_code_token, qr_signature, status)
    VALUES (v_reservation_id, i, v_pass_token, v_pass_signature, 'issued');

    v_passes := v_passes || json_build_object(
      'guest_number', i, 'qr_code_token', v_pass_token, 'qr_signature', v_pass_signature
    )::JSON;
  END LOOP;

  IF p_is_walk_in THEN
    UPDATE event_vip_tables SET is_available = FALSE, updated_at = NOW() WHERE id = p_table_id;
  END IF;

  RETURN json_build_object(
    'success', TRUE, 'reservation_id', v_reservation_id, 'qr_code_token', v_qr_code_token,
    'table_number', v_table.table_number, 'table_name', v_table.table_name,
    'tier', v_table.tier, 'price', v_table.price, 'price_cents', v_price_cents,
    'guest_count', p_guest_count, 'guest_passes', to_json(v_passes),
    'status', CASE WHEN p_is_walk_in THEN 'confirmed' ELSE 'pending' END
  );

EXCEPTION
  WHEN unique_violation THEN
    RETURN json_build_object('success', FALSE, 'error', 'DUPLICATE_RESERVATION', 'message', 'A reservation already exists for this table');
  WHEN OTHERS THEN
    RETURN json_build_object('success', FALSE, 'error', 'UNEXPECTED_ERROR', 'message', SQLERRM);
END;
$$;

GRANT EXECUTE ON FUNCTION create_vip_reservation_atomic TO authenticated;
GRANT EXECUTE ON FUNCTION create_vip_reservation_atomic TO service_role;

-- 2. FIX RLS POLICIES
DROP POLICY IF EXISTS "vip_reservations_select_policy" ON vip_reservations;
DROP POLICY IF EXISTS "vip_reservations_insert_policy" ON vip_reservations;
DROP POLICY IF EXISTS "vip_reservations_update_policy" ON vip_reservations;
DROP POLICY IF EXISTS "Anyone can view reservations" ON vip_reservations;
DROP POLICY IF EXISTS "Authenticated users can create reservations" ON vip_reservations;
DROP POLICY IF EXISTS "Service role can do anything" ON vip_reservations;

DROP POLICY IF EXISTS "vip_guest_passes_select_policy" ON vip_guest_passes;
DROP POLICY IF EXISTS "vip_guest_passes_insert_policy" ON vip_guest_passes;
DROP POLICY IF EXISTS "vip_guest_passes_update_policy" ON vip_guest_passes;
DROP POLICY IF EXISTS "Anyone can view guest passes" ON vip_guest_passes;

ALTER TABLE vip_reservations ENABLE ROW LEVEL SECURITY;
ALTER TABLE vip_guest_passes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own reservations" ON vip_reservations FOR SELECT
  USING (purchaser_email = auth.jwt() ->> 'email' OR auth.role() = 'service_role');

CREATE POLICY "Authenticated users can create reservations" ON vip_reservations FOR INSERT
  WITH CHECK (auth.role() = 'authenticated' OR auth.role() = 'service_role');

CREATE POLICY "Service role can update reservations" ON vip_reservations FOR UPDATE
  USING (auth.role() = 'service_role') WITH CHECK (auth.role() = 'service_role');

CREATE POLICY "Users can view own guest passes" ON vip_guest_passes FOR SELECT
  USING (EXISTS (SELECT 1 FROM vip_reservations r WHERE r.id = vip_guest_passes.reservation_id AND r.purchaser_email = auth.jwt() ->> 'email') OR auth.role() = 'service_role');

CREATE POLICY "Service role can create guest passes" ON vip_guest_passes FOR INSERT
  WITH CHECK (auth.role() = 'service_role');

CREATE POLICY "Service role can update guest passes" ON vip_guest_passes FOR UPDATE
  USING (auth.role() = 'service_role') WITH CHECK (auth.role() = 'service_role');

-- 3. UNIQUE INDEX FOR ACTIVE RESERVATIONS
DROP INDEX IF EXISTS idx_unique_active_reservation_per_table;
CREATE UNIQUE INDEX idx_unique_active_reservation_per_table
  ON vip_reservations (event_id, event_vip_table_id)
  WHERE status IN ('pending', 'confirmed', 'checked_in');

-- 4. PERFORMANCE INDEXES
CREATE INDEX IF NOT EXISTS idx_vip_reservations_email ON vip_reservations (purchaser_email);
CREATE INDEX IF NOT EXISTS idx_vip_guest_passes_reservation ON vip_guest_passes (reservation_id);
CREATE INDEX IF NOT EXISTS idx_vip_guest_passes_qr_token ON vip_guest_passes (qr_code_token);

-- 5. SIGNATURE VERIFICATION FUNCTION
CREATE OR REPLACE FUNCTION verify_vip_pass_signature(
  p_qr_token VARCHAR,
  p_signature VARCHAR,
  p_reservation_id UUID DEFAULT NULL,
  p_guest_number INTEGER DEFAULT NULL
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_pass RECORD;
BEGIN
  SELECT gp.*, r.status as reservation_status, r.event_id
  INTO v_pass
  FROM vip_guest_passes gp
  JOIN vip_reservations r ON r.id = gp.reservation_id
  WHERE gp.qr_code_token = p_qr_token;

  IF NOT FOUND THEN
    RETURN json_build_object('valid', FALSE, 'error', 'PASS_NOT_FOUND', 'message', 'Guest pass not found');
  END IF;

  IF v_pass.qr_signature != p_signature THEN
    RETURN json_build_object('valid', FALSE, 'error', 'INVALID_SIGNATURE', 'message', 'QR code signature is invalid');
  END IF;

  IF p_reservation_id IS NOT NULL AND v_pass.reservation_id != p_reservation_id THEN
    RETURN json_build_object('valid', FALSE, 'error', 'RESERVATION_MISMATCH', 'message', 'Reservation ID does not match');
  END IF;

  IF p_guest_number IS NOT NULL AND v_pass.guest_number != p_guest_number THEN
    RETURN json_build_object('valid', FALSE, 'error', 'GUEST_NUMBER_MISMATCH', 'message', 'Guest number does not match');
  END IF;

  IF v_pass.status = 'checked_in' THEN
    RETURN json_build_object('valid', FALSE, 'error', 'ALREADY_CHECKED_IN', 'message', 'This pass has already been used', 'checked_in_at', v_pass.checked_in_at);
  END IF;

  IF v_pass.status = 'cancelled' THEN
    RETURN json_build_object('valid', FALSE, 'error', 'PASS_CANCELLED', 'message', 'This pass has been cancelled');
  END IF;

  IF v_pass.reservation_status NOT IN ('confirmed', 'checked_in') THEN
    RETURN json_build_object('valid', FALSE, 'error', 'RESERVATION_NOT_CONFIRMED', 'message', 'Reservation is not confirmed or paid');
  END IF;

  RETURN json_build_object('valid', TRUE, 'pass_id', v_pass.id, 'reservation_id', v_pass.reservation_id, 'guest_number', v_pass.guest_number, 'event_id', v_pass.event_id, 'status', v_pass.status);
END;
$$;

GRANT EXECUTE ON FUNCTION verify_vip_pass_signature TO authenticated;
GRANT EXECUTE ON FUNCTION verify_vip_pass_signature TO service_role;

-- 6. ATOMIC CHECK-IN FUNCTION
CREATE OR REPLACE FUNCTION check_in_vip_guest_atomic(
  p_pass_id UUID,
  p_checked_in_by VARCHAR DEFAULT 'system'
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_pass RECORD;
  v_reservation RECORD;
  v_checked_in_count INTEGER;
BEGIN
  SELECT * INTO v_pass FROM vip_guest_passes WHERE id = p_pass_id FOR UPDATE;

  IF NOT FOUND THEN
    RETURN json_build_object('success', FALSE, 'error', 'PASS_NOT_FOUND', 'message', 'Guest pass not found');
  END IF;

  IF v_pass.status = 'checked_in' THEN
    RETURN json_build_object('success', FALSE, 'error', 'ALREADY_CHECKED_IN', 'message', 'This pass has already been checked in', 'checked_in_at', v_pass.checked_in_at);
  END IF;

  IF v_pass.status = 'cancelled' THEN
    RETURN json_build_object('success', FALSE, 'error', 'PASS_CANCELLED', 'message', 'This pass has been cancelled');
  END IF;

  SELECT * INTO v_reservation FROM vip_reservations WHERE id = v_pass.reservation_id FOR UPDATE;

  IF v_reservation.status NOT IN ('confirmed', 'checked_in') THEN
    RETURN json_build_object('success', FALSE, 'error', 'RESERVATION_NOT_CONFIRMED', 'message', 'Reservation is not confirmed');
  END IF;

  UPDATE vip_guest_passes SET status = 'checked_in', checked_in_at = NOW(), checked_in_by = p_checked_in_by, updated_at = NOW() WHERE id = p_pass_id;

  SELECT COUNT(*) INTO v_checked_in_count FROM vip_guest_passes WHERE reservation_id = v_pass.reservation_id AND status = 'checked_in';

  UPDATE vip_reservations SET checked_in_guests = v_checked_in_count, checked_in_at = COALESCE(checked_in_at, NOW()), status = 'checked_in', updated_at = NOW() WHERE id = v_pass.reservation_id;

  RETURN json_build_object('success', TRUE, 'pass_id', p_pass_id, 'reservation_id', v_pass.reservation_id, 'guest_number', v_pass.guest_number, 'checked_in_guests', v_checked_in_count, 'checked_in_at', NOW());
END;
$$;

GRANT EXECUTE ON FUNCTION check_in_vip_guest_atomic TO authenticated;
GRANT EXECUTE ON FUNCTION check_in_vip_guest_atomic TO service_role;

-- Record this migration as applied
INSERT INTO supabase_migrations.schema_migrations (version, name)
VALUES ('20260122000000', '20260122000000_fix_vip_race_condition_and_rls.sql')
ON CONFLICT (version) DO NOTHING;

-- Done!
SELECT 'VIP Race Condition and RLS Fix applied successfully!' as result;</textarea>
      </div>
    </div>

    <div class="step">
      <h2><span>3</span> Run & Verify</h2>
      <p>Click the <strong>Run</strong> button in the editor. You should see <code>Success. No rows returned</code> or
        <code>applied successfully!</code>.</p>
    </div>
  </div>

  <script>
    function copySQL() {
      const sql = document.getElementById('sql');
      sql.select();
      document.execCommand('copy');

      const btn = document.querySelector('.copy-btn');
      const originalText = btn.textContent;
      btn.textContent = 'âœ… Copied!';
      btn.classList.add('copied');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('copied');
      }, 2000);
    }
  </script>
</body>

</html>