<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Migration - Re-entry Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #3ecf8e;
            margin-bottom: 10px;
        }
        .step {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .step h2 {
            color: #3ecf8e;
            margin-bottom: 15px;
        }
        .sql-container {
            background: #1e1e1e;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        .sql-container textarea {
            width: 100%;
            min-height: 400px;
            background: #1e1e1e;
            color: #e0e0e0;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            padding: 10px;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3ecf8e;
            color: #1a1a1a;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }
        .copy-btn:hover {
            background: #2db876;
        }
        .copy-btn.copied {
            background: #3ecf8e;
            opacity: 0.7;
        }
        .link {
            color: #3ecf8e;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .success {
            background: #2a5a2a;
            border-color: #3ecf8e;
            color: #3ecf8e;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Apply Re-entry Tracking Migration</h1>
        <p style="color: #888; margin-bottom: 30px;">Follow these steps to apply the database migration</p>

        <div class="step">
            <h2>Step 1: Open Supabase Dashboard</h2>
            <p>Go to: <a href="https://supabase.com/dashboard" target="_blank" class="link">https://supabase.com/dashboard</a></p>
            <p>Select your project: <code>djbzjasdrwvbsoifxqzd</code></p>
        </div>

        <div class="step">
            <h2>Step 2: Open SQL Editor</h2>
            <p>In the left sidebar, click on <strong>SQL Editor</strong></p>
            <p>Click <strong>New Query</strong> button</p>
        </div>

        <div class="step">
            <h2>Step 3: Copy Migration SQL</h2>
            <p>Click the "Copy SQL" button below, then paste into the SQL Editor:</p>
            <div class="sql-container">
                <button class="copy-btn" onclick="copySQL()">ðŸ“‹ Copy SQL</button>
                <textarea id="sql" readonly>-- Migration: Add Re-entry Tracking Support
-- Creates scan_history table and adds re-entry columns to tickets table

-- Create scan_history table for tracking entry/exit logs
CREATE TABLE IF NOT EXISTS scan_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket_id UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  scan_type TEXT NOT NULL CHECK (scan_type IN ('entry', 'exit')),
  scanned_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  scanned_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  device_id TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_scan_history_ticket_id ON scan_history(ticket_id);
CREATE INDEX IF NOT EXISTS idx_scan_history_scanned_at ON scan_history(scanned_at DESC);
CREATE INDEX IF NOT EXISTS idx_scan_history_scan_type ON scan_history(scan_type);

-- Add re-entry tracking columns to tickets table
ALTER TABLE tickets 
  ADD COLUMN IF NOT EXISTS current_status TEXT DEFAULT 'outside' CHECK (current_status IN ('inside', 'outside', 'left')),
  ADD COLUMN IF NOT EXISTS entry_count INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS exit_count INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS last_entry_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS last_exit_at TIMESTAMPTZ;

-- Create index for current_status queries
CREATE INDEX IF NOT EXISTS idx_tickets_current_status ON tickets(current_status);

-- Update existing scanned tickets to have current_status = 'inside' if they were scanned
UPDATE tickets 
SET current_status = 'inside', entry_count = 1, last_entry_at = scanned_at
WHERE status = 'scanned' AND scanned_at IS NOT NULL AND current_status IS NULL;

-- Enable RLS on scan_history table
ALTER TABLE scan_history ENABLE ROW LEVEL SECURITY;

-- RLS Policies for scan_history
-- Allow authenticated users to read scan history
CREATE POLICY "Allow authenticated users to read scan history"
  ON scan_history
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow authenticated users to insert scan history
CREATE POLICY "Allow authenticated users to insert scan history"
  ON scan_history
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Allow service role to do everything (for backend operations)
CREATE POLICY "Allow service role full access to scan_history"
  ON scan_history
  FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- Add comment to table
COMMENT ON TABLE scan_history IS 'Tracks entry and exit scans for re-entry tracking';
COMMENT ON COLUMN tickets.current_status IS 'Current location status: inside, outside, or left';
COMMENT ON COLUMN tickets.entry_count IS 'Number of times ticket holder has entered';
COMMENT ON COLUMN tickets.exit_count IS 'Number of times ticket holder has exited';</textarea>
            </div>
        </div>

        <div class="step">
            <h2>Step 4: Execute Migration</h2>
            <p>In the SQL Editor, click the <strong>Run</strong> button (or press Cmd/Ctrl + Enter)</p>
            <p>You should see: <code>Success. No rows returned</code></p>
        </div>

        <div class="step">
            <h2>Step 5: Verify Migration</h2>
            <p>Go to <strong>Table Editor</strong> in the left sidebar</p>
            <p>Verify:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li><code>scan_history</code> table exists</li>
                <li><code>tickets</code> table has columns: <code>current_status</code>, <code>entry_count</code>, <code>exit_count</code></li>
            </ul>
        </div>

        <div class="step">
            <h2>Step 6: Run Tests</h2>
            <p>After applying the migration, run:</p>
            <code style="display: block; padding: 10px; margin-top: 10px;">npx tsx test-all-features.ts</code>
        </div>
    </div>

    <script>
        function copySQL() {
            const sql = document.getElementById('sql');
            sql.select();
            document.execCommand('copy');
            
            const btn = document.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = 'âœ… Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }
    </script>
</body>
</html>

